\input cwebmac
\hypertextrue\srcloctrue
\datethis
\hyphenation{pre-selected pre-select pre-selection}


\N[14 sat11.w]{1}{1}Intro. This program is part of a series of ``SAT-solvers''
that I'm putting
together for my own education as I prepare to write Section 7.2.2.2 of
{\sl The Art of Computer Programming}. My intent is to have a variety of
compatible programs on which I can run experiments to learn how different
approaches work in practice.

Many of the previous implementations in this series---{\mc SAT0}, {\mc SAT3},
{\mc SAT4}, {\mc SAT5}, and {\mc SAT10}---were based on a natural backtracking
approach that has come to be known in the {\mc SAT} community as the DPLL
paradigm, honoring the pioneering work of
Davis, Putnam, Logemann, and Loveland. Several decades of experience with
that paradigm have led to an extremely efficient class of programs
now called {\it lookahead solvers}, which devote considerable time
to choosing the variables on which to branch. The extra work of making
that choice might cost us a factor of a thousand, say, at every branch node;
yet we might also decrease the number of nodes by a factor
of a million, thus making a net thousand-fold gain. Somewhat to my surprise,
this rosy prediction (contrary to what I had believed for many years)
actually does work in practice: There are many {\mc SAT} problems
(especially those based on combinatorial tasks, as well as the
academic yet appealing cases of unsatisfiable random {\mc3SAT})
for which judicious lookaheads outperform any other known method.

Consequently {\mc SAT11} is intended to represent a modern lookahead solver.
I've based it largely on Marijn Heule's {\mc MARCH}, which has been
regularly classed with the world's best lookahead solvers for the last decade
or so. I expect {\mc SAT11} to be the most ambitious program of this series,
because it combines many advanced ideas that I wish to understand and to
explain to the readers of {\sl TAOCP}. On the other hand, I have not included
all of the bells and whistles of {\mc MARCH}; in particular, I've omitted
the separate treatment of clause sets that represent linear equations mod~2,
as well as the ``limited discrepancy search'' technique by which branches
of the search tree are explored in a nonstandard order.

This basic {\mc SAT11} program, like the earliest versions of {\mc MARCH},
is intended for {\mc 3SAT} problems only: All clauses must have size
3 or less. However, a changefile converts this program to {\mc SAT11K},
which has no such restriction. A good understanding of the {\mc 3SAT}
version presented below will make it easier to understand the modifications by
which the algorithms can be adapted to handle clauses of any length.

If you have already read {\mc SAT10} (or some other program of this
series), you might as well skip now past all the code for the
``I/O wrapper,'' because you have seen it before.

The input on \PB{\\{stdin}} is a series of lines with one clause per line. Each
clause is a sequence of literals separated by spaces. Each literal is
a sequence of one to eight ASCII characters between \.{!} and \.{\}},
inclusive, not beginning with \.{\~},
optionally preceded by \.{\~} (which makes the literal ``negative'').
For example, Rivest's famous clauses on four variables,
found in 6.5--(13) and 7.1.1--(32) of {\sl TAOCP}, can be represented by the
following eight lines of input:
$$\chardef~=`\~
\vcenter{\halign{\tt#\cr
x2 x3 ~x4\cr
x1 x3 x4\cr
~x1 x2 x4\cr
~x1 ~x2 x3\cr
~x2 ~x3 x4\cr
~x1 ~x3 ~x4\cr
x1 ~x2 ~x4\cr
x1 x2 ~x3\cr}}$$
Input lines that begin with \.{\~\ } are ignored (treated as comments).
The output will be `\.{\~}' if the input clauses are unsatisfiable.
Otherwise it will be a list of noncontradictory literals that cover each
clause, separated by spaces. (``Noncontradictory'' means that we don't
have both a literal and its negation.) The input above would, for example,
yield `\.{\~}'; but if the final clause were omitted, the output would
be `\.{\~x1} \.{\~x2} \.{x3}', in some order, possibly together
with either \.{x4} or \.{\~x4} (but not both). No attempt is made to
find all solutions; at most one solution is given.

The running time in ``mems'' is also reported, together with the approximate
number of bytes needed for data storage. One ``mem'' essentially means a
memory access to a 64-bit word.
(These totals don't include the time or space needed to parse the
input or to format the output.)

\fi

\M[93 sat11.w]{2}So here's the structure of the program. (Skip ahead if you are
impatient to see the interesting stuff.)

\Y\B\4\D$\|o$ \5
$\\{mems}\PP{}$\C{ count one mem }\par
\B\4\D$\\{oo}$ \5
$\\{mems}\MRL{+{\K}}{}$\T{2}\C{ count two mems }\par
\B\4\D$\\{ooo}$ \5
$\\{mems}\MRL{+{\K}}{}$\T{3}\C{ count three mems }\par
\B\4\D$\|O$ \5
\.{"\%"}\C{ used for percent signs in format strings }\par
\Y\B\8\#\&{include} \.{<stdio.h>}\6
\8\#\&{include} \.{<stdlib.h>}\6
\8\#\&{include} \.{<string.h>}\6
\8\#\&{include} \.{"gb\_flip.h"}\6
\&{typedef} \&{unsigned} \&{int} \&{uint};\C{ a convenient abbreviation }\6
\&{typedef} \&{unsigned} \&{long} \&{long} \&{ullng};\C{ ditto }\7
\X5:Type definitions\X;\6
\X3:Global variables\X;\6
\X29:Subroutines\X;\7
\\{main}(\&{int} \\{argc}${},\39{}$\&{char} ${}{*}\\{argv}[\,]){}$\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \\{au}${},{}$ \\{av}${},{}$ \\{aw}${},{}$ \|h${},{}$ %
\|i${},{}$ \|j${},{}$ \\{jj}${},{}$ \|k${},{}$ \\{kk}${},{}$ \|l${},{}$ %
\\{ll}${},{}$ \|p${},{}$ \\{pp}${},{}$ \|q${},{}$ \\{qq}${},{}$ \|r${},{}$ \|s;%
\6
\&{register} \&{int} \|c${},{}$ \\{cc}${},{}$ \\{hh}${},{}$ \\{la}${},{}$ %
\\{lp}${},{}$ \\{ls}${},{}$ \\{ola}${},{}$ \\{ols}${},{}$ \\{tla}${},{}$ %
\\{tls}${},{}$ \\{tll}${},{}$ \\{sl}${},{}$ \\{su}${},{}$ \\{sv}${},{}$ \\{sw};%
\6
\&{register} \&{int} \|t${},{}$ \\{tt}${},{}$ \|u${},{}$ \\{uu}${},{}$ %
\\{v0}${},{}$ \|v${},{}$ \\{vv}${},{}$ \|w${},{}$ \\{ww}${},{}$ \|x${},{}$ %
\|y${},{}$ \\{xl}${},{}$ \\{pu}${},{}$ \\{aa}${},{}$ \\{ss}${},{}$ %
\\{pv}${},{}$ \\{ua}${},{}$ \\{va};\7
\X4:Process the command line\X;\6
\X8:Initialize everything\X;\6
\X9:Input the clauses\X;\6
\&{if} ${}(\\{verbose}\AND\\{show\_basics}){}$\1\5
\X22:Report the successful completion of the input phase\X;\2\6
\X37:Set up the main data structures\X;\6
${}\\{imems}\K\\{mems},\39\\{mems}\K\T{0};{}$\6
\X150:Solve the problem\X;\6
\4\\{done}:\5
\&{if} ${}(\\{verbose}\AND\\{show\_basics}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"Altogether\ "}\|O\.{"llu+"}\|O\.{"llu\ mems,\
"}\|O\.{"llu\ bytes,\ "}\|O\.{"llu\ nodes.\\n"},\39\\{imems},\39\\{mems},\39%
\\{bytes},\39\\{nodes});{}$\2\6
\4${}\}{}$\2\par
\fi

\M[129 sat11.w]{3}The default values of parameters below have been tuned for
random {\mc 3SAT} instances, based on tests by Holger Hoos in 2015.

\Y\B\4\D$\\{show\_basics}$ \5
\T{1}\C{ \PB{\\{verbose}} code for basic stats }\par
\B\4\D$\\{show\_choices}$ \5
\T{2}\C{ \PB{\\{verbose}} code for backtrack logging }\par
\B\4\D$\\{show\_details}$ \5
\T{4}\C{ \PB{\\{verbose}} code for further commentary }\par
\B\4\D$\\{show\_gory\_details}$ \5
\T{8}\C{ \PB{\\{verbose}} code for more yet }\par
\B\4\D$\\{show\_doubly\_gory\_details}$ \5
\T{16}\C{ \PB{\\{verbose}} code for still more }\par
\B\4\D$\\{show\_unused\_vars}$ \5
\T{32}\C{ \PB{\\{verbose}} code to list variables not in solution }\par
\B\4\D$\\{show\_scores}$ \5
\T{64}\C{ \PB{\\{verbose}} code to show the prelookahead scores }\par
\B\4\D$\\{show\_strong\_comps}$ \5
\T{128}\C{ \PB{\\{verbose}} code to show strong components }\par
\B\4\D$\\{show\_looks}$ \5
\T{256}\C{ \PB{\\{verbose}} code to show the lookahead forest }\par
\Y\B\4\X3:Global variables\X${}\E{}$\6
\&{int} \\{random\_seed}${}\K\T{0}{}$;\C{ seed for the random words of \PB{%
\\{gb\_rand}} }\6
\&{int} \\{verbose}${}\K\\{show\_basics}+\\{show\_unused\_vars}{}$;\C{ level of
verbosity }\6
\&{int} \\{show\_choices\_max}${}\K\T{1000000}{}$;\C{ above this level, \PB{%
\\{show\_choices}} is ignored }\6
\&{int} \\{hbits}${}\K\T{8}{}$;\C{ logarithm of the number of the hash lists }\6
\&{int} \\{print\_state\_cutoff}${}\K\T{32}*\T{80}{}$;\C{ don't print more than
this many hists }\6
\&{int} \\{buf\_size}${}\K\T{1024}{}$;\C{ must exceed the length of the longest
input line }\6
\&{FILE} ${}{*}\\{out\_file}{}$;\C{ file for optional output }\6
\&{char} ${}{*}\\{out\_name}{}$;\C{ its name }\6
\&{FILE} ${}{*}\\{primary\_file}{}$;\C{ file for optional input }\6
\&{char} ${}{*}\\{primary\_name}{}$;\C{ its name }\6
\&{int} \\{primary\_vars};\C{ the number of primary variables }\6
\&{ullng} \\{imems}${},{}$ \\{mems};\C{ mem counts }\6
\&{ullng} \\{bytes};\C{ memory used by main data structures }\6
\&{ullng} \\{nodes};\C{ the number of nodes entered }\6
\&{ullng} \\{thresh}${}\K\T{0}{}$;\C{ report when \PB{\\{mems}} exceeds this,
if \PB{$\\{delta}\I\T{0}$} }\6
\&{ullng} \\{delta}${}\K\T{0}{}$;\C{ report every \PB{\\{delta}} or so mems }\6
\&{ullng} \\{timeout}${}\K\T{\^1fffffffffffffff}{}$;\C{ give up after this many
mems }\6
\&{uint} \\{memk\_max}${}\K\\{memk\_max\_default}{}$;\C{ binary log of the
maximum size of \PB{\\{mem}} }\6
\&{float} \\{alpha}${}\K\T{3.5}{}$;\C{ magic constant for heuristic scores }\6
\&{float} \\{max\_score}${}\K\T{20.0}{}$;\C{ heuristic scores will be at most
this }\6
\&{int} \\{hlevel\_max}${}\K\T{50}{}$;\C{ saved levels of heuristic scores }\6
\&{int} \\{levelcand}${}\K\T{600}{}$;\C{ preselected candidates times levels }\6
\&{int} \\{mincutoff}${}\K\T{30}{}$;\C{ don't cut off fewer than this many
candidates }\6
\&{int} \\{max\_prelook\_arcs}${}\K\T{1000}{}$;\C{ space available for arcs re
strong components }\6
\&{int} \\{dl\_max\_iter}${}\K\T{32}{}$;\C{ maximum iterations of double-look }%
\6
\&{float} \\{dl\_rho}${}\K\T{0.9995}{}$;\C{ damping factor for the double-look
trigger }\par
\As7, 24, 36, 48, 60, 67, 89, 91, 107, 119, 123, 131\ETs139.
\U2.\fi

\M[170 sat11.w]{4}On the command line one can specify any or all of the
following options:
\smallskip
\item{$\bullet$}
`\.v$\langle\,$integer$\,\rangle$' to enable various levels of verbose
output on \PB{\\{stderr}}.
\item{$\bullet$}
`\.c$\langle\,$positive integer$\,\rangle$' to limit the levels on which
clauses are shown.
\item{$\bullet$}
`\.h$\langle\,$positive integer$\,\rangle$' to adjust the hash table size.
\item{$\bullet$}
\item{$\bullet$}
`\.H$\langle\,$positive integer$\,\rangle$' to limit the literals whose
histories are shown by \PB{\\{print\_state}}.
`\.b$\langle\,$positive integer$\,\rangle$' to adjust the size of the input
buffer.
\item{$\bullet$}
`\.s$\langle\,$integer$\,\rangle$' to define the seed for any random numbers
that are used.
\item{$\bullet$}
`\.d$\langle\,$integer$\,\rangle$' to set \PB{\\{delta}} for periodic state
reports.
(See \PB{\\{print\_state}}.)
\item{$\bullet$}
`\.m$\langle\,$positive integer$\,\rangle$' to adjust the maximum memory size.
(The binary logarithm is specified; it must be at most 31.)
\item{$\bullet$}
`\.a$\langle\,$positive float$\,\rangle$' to adjust the magic constant
$\alpha$ in heuristic scores.
\item{$\bullet$}
`\.t$\langle\,$positive float$\,\rangle$' to adjust the maximum permissible
heuristic score.
\item{$\bullet$}
`\.l$\langle\,$positive integer$\,\rangle$' to adjust the number of levels
of heuristic scores that are remembered.
\item{$\bullet$}
`\.p$\langle\,$positive integer$\,\rangle$' to adjust the parameter
\PB{\\{levelcand}}, approximating ``candidates times levels'' during the
preselection phase.
\item{$\bullet$}
`\.q$\langle\,$positive integer$\,\rangle$' to adjust the parameter
\PB{\\{mincutoff}}, the minimum cutoff on the number of candidates during
preselection.
\item{$\bullet$}
`\.z$\langle\,$positive integer$\,\rangle$' to adjust \PB{\\{max\_prelook%
\_arcs}}, the
maximum number of arcs retained when studying the reduced digraph during
preselection.
\item{$\bullet$}
`\.i$\langle\,$positive integer$\,\rangle$' to adjust \PB{\\{dl\_max\_iter}},
the
maximum number of iterations allowed during a double-lookahead.
\item{$\bullet$}
`\.r$\langle\,$positive float$\,\rangle$' to adjust \PB{\\{dl\_rho}}, the
damping factor for \PB{\\{dl\_trigger}}.
\item{$\bullet$}
`\.x$\langle\,$filename$\,\rangle$' to copy the input plus a
solution-eliminating clause to the specified file. If the given problem is
satisfiable in more than one way, a different solution can be obtained by
inputting that file.
\item{$\bullet$}
`\.V$\langle\,$filename$\,\rangle$' to input a file that lists the names
of all ``primary'' variables. A nonprimary variable will not be used for
branching unless its value is forced, or unless all of the primary variables
have already been assigned a value.
\item{$\bullet$}
`\.T$\langle\,$integer$\,\rangle$' to set \PB{\\{timeout}}: This program will
abruptly terminate, when it discovers that \PB{$\\{mems}>\\{timeout}$}.

\Y\B\4\X4:Process the command line\X${}\E{}$\6
\&{for} ${}(\|j\K\\{argc}-\T{1},\39\|k\K\T{0};{}$ \|j; ${}\|j\MM){}$\1\6
\&{switch} (\\{argv}[\|j][\T{0}])\5
${}\{{}$\1\6
\4\&{case} \.{'v'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{verbose})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'c'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{show\_choices\_max})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'H'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{print\_state\_cutoff})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'h'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{hbits})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'b'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{buf\_size})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'s'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{random\_seed})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'d'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"lld"},\39{%
\AND}\\{delta})-\T{1}){}$;\5
${}\\{thresh}\K\\{delta}{}$;\5
\&{break};\6
\4\&{case} \.{'m'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{memk\_max})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'a'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"f"},\39{%
\AND}\\{alpha})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'t'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"f"},\39{%
\AND}\\{max\_score})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'l'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{hlevel\_max})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'p'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{levelcand})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'q'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{mincutoff})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'z'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{max\_prelook\_arcs})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'i'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"d"},\39{%
\AND}\\{dl\_max\_iter})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'r'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"f"},\39{%
\AND}\\{dl\_rho})-\T{1}){}$;\5
\&{break};\6
\4\&{case} \.{'x'}:\5
${}\\{out\_name}\K\\{argv}[\|j]+\T{1},\39\\{out\_file}\K\\{fopen}(\\{out%
\_name},\39\.{"w"});{}$\6
\&{if} ${}(\R\\{out\_file}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"I\ can't\ open\ file\ `}\)\.{"}\|O\.{"s'\ for\
output!\\n"},\39\\{out\_name});{}$\2\6
\&{break};\6
\4\&{case} \.{'V'}:\5
${}\\{primary\_name}\K\\{argv}[\|j]+\T{1},\39\\{primary\_file}\K\\{fopen}(%
\\{primary\_name},\39\.{"r"});{}$\6
\&{if} ${}(\R\\{primary\_file}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"I\ can't\ open\ file\ `}\)\.{"}\|O\.{"s'\ for\
input!\\n"},\39\\{primary\_name});{}$\2\6
\&{break};\6
\4\&{case} \.{'T'}:\5
${}\|k\MRL{{\OR}{\K}}(\\{sscanf}(\\{argv}[\|j]+\T{1},\39\.{""}\|O\.{"lld"},\39{%
\AND}\\{timeout})-\T{1}){}$;\5
\&{break};\6
\4\&{default}:\5
${}\|k\K\T{1}{}$;\C{ unrecognized command-line option }\6
\4${}\}{}$\2\2\6
\&{if} ${}(\|k\V\\{hbits}<\T{0}\V\\{hbits}>\T{30}\V\\{buf\_size}\Z\T{0}\V%
\\{memk\_max}<\T{2}\V\\{memk\_max}>\T{31}\V\\{alpha}\Z\T{0.0}\V\\{max\_score}\Z%
\T{0.0}\V\\{hlevel\_max}<\T{3}\V\\{levelcand}\Z\T{0}\V\\{mincutoff}\Z\T{0}\V%
\\{max\_prelook\_arcs}\Z\T{0}\V\\{dl\_max\_iter}\Z\T{0}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Usage:\ "}\|O\.{"s\ [v<n>]\ [c<n>]\ [h<}\)%
\.{n>]\ [b<n>]\ [s<n>]\ [d}\)\.{<n>]\ [m<n>]"},\39\\{argv}[\T{0}]);{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"\ [H<n>]\ [a<f>]\ [t<f}\)\.{>]\ [l<n>]\ [p<n>]%
\ [q<}\)\.{n]\ [z<n>]"});{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"\ [i<n>]\ [r<f>]\ [x<f}\)\.{oo>]\ [V<foo>]\
[T<n>]}\)\.{\ <\ foo.sat\\n"});{}$\6
${}\\{exit}({-}\T{1});{}$\6
\4${}\}{}$\2\par
\U2.\fi

\N[274 sat11.w]{1}{5}The I/O wrapper. The following routines read the input and
absorb it into
temporary data areas from which all of the ``real'' data structures
can readily be initialized. My intent is to incorporate these routines into all
of the SAT-solvers in this series. Therefore I've tried to make the code
short and simple, yet versatile enough so that almost no restrictions are
placed on the sizes of problems that can be handled. These routines are
supposed to work properly unless there are more than
$2^{32}-1=4$,294,967,295 occurrences of literals in clauses,
or more than $2^{31}-1=2$,147,483,647 variables or clauses.

In these temporary tables, each variable is represented by four things:
its unique name; its serial number; the clause number (if any) in which it has
most recently appeared; and a pointer to the previous variable (if any)
with the same hash address. Several variables at a time
are represented sequentially in small chunks of memory called ``vchunks,''
which are allocated as needed (and freed later).

\Y\B\4\D$\\{vars\_per\_vchunk}$ \5
\T{341}\C{ preferably $(2^k-1)/3$ for some $k$ }\par
\Y\B\4\X5:Type definitions\X${}\E{}$\6
\&{typedef} \&{union} ${}\{{}$\1\6
\&{char} \\{ch8}[\T{8}];\6
\&{uint} \\{u2}[\T{2}];\6
\&{long} \&{long} \\{lng};\2\6
${}\}{}$ \&{octa};\6
\&{typedef} \&{struct} \&{tmp\_var\_struct} ${}\{{}$\1\6
\&{octa} \\{name};\C{ the name (one to eight ASCII characters) }\6
\&{uint} \\{serial};\C{ 0 for the first variable, 1 for the second, etc. }\6
\&{int} \\{stamp};\C{ \PB{\|m} if positively in clause \PB{\|m}; \PB{${-}\|m$}
if negatively there }\6
\&{struct} \&{tmp\_var\_struct} ${}{*}\\{next}{}$;\C{ pointer for hash list }\2%
\6
${}\}{}$ \&{tmp\_var};\7
\&{typedef} \&{struct} \&{vchunk\_struct} ${}\{{}$\1\6
\&{struct} \&{vchunk\_struct} ${}{*}\\{prev}{}$;\C{ previous chunk allocated
(if any) }\6
\&{tmp\_var} \\{var}[\\{vars\_per\_vchunk}];\2\6
${}\}{}$ \&{vchunk};\par
\As6, 26, 27, 28, 34, 35, 88, 106\ETs118.
\U2.\fi

\M[311 sat11.w]{6}Each clause in the temporary tables is represented by a
sequence of
one or more pointers to the \PB{\&{tmp\_var}} nodes of the literals involved.
A negated literal is indicated by adding~1 to such a pointer.
The first literal of a clause is indicated by adding~2.
Several of these pointers are represented sequentially in chunks
of memory, which are allocated as needed and freed later.

\Y\B\4\D$\\{cells\_per\_chunk}$ \5
\T{511}\C{ preferably $2^k-1$ for some $k$ }\par
\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{chunk\_struct} ${}\{{}$\1\6
\&{struct} \&{chunk\_struct} ${}{*}\\{prev}{}$;\C{ previous chunk allocated (if
any) }\6
\&{tmp\_var} ${}{*}\\{cell}[\\{cells\_per\_chunk}];{}$\2\6
${}\}{}$ \&{chunk};\par
\fi

\M[326 sat11.w]{7}\B\X3:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{buf}{}$;\C{ buffer for reading the lines (clauses) of \PB{%
\\{stdin}} }\6
\&{tmp\_var} ${}{*}{*}\\{hash}{}$;\C{ heads of the hash lists }\6
\&{uint} \\{hash\_bits}[\T{93}][\T{8}];\C{ random bits for universal hash
function }\6
\&{vchunk} ${}{*}\\{cur\_vchunk}{}$;\C{ the vchunk currently being filled }\6
\&{vchunk} ${}{*}\\{last\_vchunk}{}$;\C{ another pointer for vchunk
manipulation }\6
\&{tmp\_var} ${}{*}\\{cur\_tmp\_var}{}$;\C{ current place to create new \PB{%
\&{tmp\_var}} entries }\6
\&{tmp\_var} ${}{*}\\{bad\_tmp\_var}{}$;\C{ the \PB{\\{cur\_tmp\_var}} when we
need a new \PB{\&{vchunk}} }\6
\&{chunk} ${}{*}\\{cur\_chunk}{}$;\C{ the chunk currently being filled }\6
\&{tmp\_var} ${}{*}{*}\\{cur\_cell}{}$;\C{ current place to create new elements
of a clause }\6
\&{tmp\_var} ${}{*}{*}\\{bad\_cell}{}$;\C{ the \PB{\\{cur\_cell}} when we need
a new \PB{\&{chunk}} }\6
\&{ullng} \\{vars};\C{ how many distinct variables have we seen? }\6
\&{ullng} \\{clauses};\C{ how many clauses have we seen? }\6
\&{ullng} \\{nullclauses};\C{ how many of them were null? }\6
\&{int} \\{ternaries};\C{ how many were ternary? }\6
\&{ullng} \\{cells};\C{ how many occurrences of literals in clauses? }\6
\&{int} \\{non\_clause};\C{ is the current clause ignorable? }\par
\fi

\M[344 sat11.w]{8}\B\X8:Initialize everything\X${}\E{}$\6
\\{gb\_init\_rand}(\\{random\_seed});\6
${}\\{buf}\K{}$(\&{char} ${}{*}){}$ \\{malloc}${}(\\{buf\_size}*\&{sizeof}(%
\&{char}));{}$\6
\&{if} ${}(\R\\{buf}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Couldn't\ allocate\ t}\)\.{he\ input\ buffer\
(buf}\)\.{\_size="}\|O\.{"d)!\\n"},\39\\{buf\_size});{}$\6
${}\\{exit}({-}\T{2});{}$\6
\4${}\}{}$\2\6
${}\\{hash}\K{}$(\&{tmp\_var} ${}{*}{*}){}$ \\{malloc}${}(\&{sizeof}(\&{tmp%
\_var})\LL\\{hbits});{}$\6
\&{if} ${}(\R\\{hash}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Couldn't\ allocate\ "}\|O\.{"d\ hash\ list\
heads\ (}\)\.{hbits="}\|O\.{"d)!\\n"},\39\T{1}\LL\\{hbits},\39\\{hbits});{}$\6
${}\\{exit}({-}\T{3});{}$\6
\4${}\}{}$\2\6
\&{for} ${}(\|h\K\T{0};{}$ ${}\|h<\T{1}\LL\\{hbits};{}$ ${}\|h\PP){}$\1\5
${}\\{hash}[\|h]\K\NULL{}$;\2\par
\A15.
\U2.\fi

\M[360 sat11.w]{9}The hash address of each variable name has $h$ bits, where
$h$ is the
value of the adjustable parameter \PB{\\{hbits}}.
Thus the average number of variables per hash list is $n/2^h$ when there
are $n$ different variables. A warning is printed if this average number
exceeds 10. (For example, if $h$ has its default value, 8, the program will
suggest that you might want to increase $h$ if your input has 2560
different variables or more.)

All the hashing takes place at the very beginning,
and the hash tables are actually recycled before any SAT-solving takes place;
therefore the setting of this parameter is by no means crucial. But I didn't
want to bother with fancy coding that would determine $h$ automatically.

\Y\B\4\X9:Input the clauses\X${}\E{}$\6
\&{if} (\\{primary\_file})\1\5
\X10:Input the primary variables\X;\2\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\R\\{fgets}(\\{buf},\39\\{buf\_size},\39\\{stdin})){}$\1\5
\&{break};\2\6
${}\\{clauses}\PP;{}$\6
\&{if} ${}(\\{buf}[\\{strlen}(\\{buf})-\T{1}]\I\.{'\\n'}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"The\ clause\ on\ line\ }\)\.{"}\|O\.{"lld\ ("}%
\|O\.{".20s...)\ is\ too\ lon}\)\.{g\ for\ me;\\n"},\39\\{clauses},\39%
\\{buf});{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"\ my\ buf\_size\ is\ onl}\)\.{y\ "}\|O\.{"d!%
\\n"},\39\\{buf\_size});{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"Please\ use\ the\ comm}\)\.{and-line\ option\
b<ne}\)\.{wsize>.\\n"});{}$\6
${}\\{exit}({-}\T{4});{}$\6
\4${}\}{}$\2\6
\X11:Input the clause in \PB{\\{buf}}\X;\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{primary\_file}){}$\1\5
${}\\{primary\_vars}\K\\{vars};{}$\2\6
\&{if} ${}((\\{vars}\GG\\{hbits})\G\T{10}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"There\ are\ "}\|O\.{"lld\ variables\ but\ o}\)%
\.{nly\ "}\|O\.{"d\ hash\ tables;\\n"},\39\\{vars},\39\T{1}\LL\\{hbits});{}$\6
\&{while} ${}((\\{vars}\GG\\{hbits})\G\T{10}){}$\1\5
${}\\{hbits}\PP;{}$\2\6
${}\\{fprintf}(\\{stderr},\39\.{"\ maybe\ you\ should\ u}\)\.{se\ command-line\
opti}\)\.{on\ h"}\|O\.{"d?\\n"},\39\\{hbits});{}$\6
\4${}\}{}$\2\6
${}\\{clauses}\MRL{-{\K}}\\{nullclauses};{}$\6
\&{if} ${}(\\{clauses}\E\T{0}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"No\ clauses\ were\ inp}\)\.{ut!\\n"});{}$\6
${}\\{exit}({-}\T{77});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{vars}\G\T{\^80000000}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Whoa,\ the\ input\ had}\)\.{\ "}\|O\.{"llu\
variables!\\n"},\39\\{cells});{}$\6
${}\\{exit}({-}\T{664});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{clauses}\G\T{\^80000000}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Whoa,\ the\ input\ had}\)\.{\ "}\|O\.{"llu\
clauses!\\n"},\39\\{cells});{}$\6
${}\\{exit}({-}\T{665});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cells}\G\T{\^100000000}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Whoa,\ the\ input\ had}\)\.{\ "}\|O\.{"llu\
occurrences\ of\ }\)\.{literals!\\n"},\39\\{cells});{}$\6
${}\\{exit}({-}\T{666});{}$\6
\4${}\}{}$\2\par
\U2.\fi

\M[412 sat11.w]{10}We input from \PB{\\{primary\_file}} just as if it were the
standard input
file, except that all ``clauses'' are discarded. (Line numbers in
error messages are zero.) The effect is to place
the primary variables first in the list of all variables: A variable
is primary if and only if its index is \PB{$\Z$ \\{primary\_vars}}.

\Y\B\4\X10:Input the primary variables\X${}\E{}$\6
${}\{{}$\1\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{if} ${}(\R\\{fgets}(\\{buf},\39\\{buf\_size},\39\\{primary\_file})){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{buf}[\\{strlen}(\\{buf})-\T{1}]\I\.{'\\n'}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"The\ clause\ on\ line\ }\)\.{"}\|O\.{"lld\ ("}%
\|O\.{".20s...)\ is\ too\ lon}\)\.{g\ for\ me;\\n"},\39\\{clauses},\39%
\\{buf});{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"\ my\ buf\_size\ is\ onl}\)\.{y\ "}\|O\.{"d!%
\\n"},\39\\{buf\_size});{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"Please\ use\ the\ comm}\)\.{and-line\ option\
b<ne}\)\.{wsize>.\\n"});{}$\6
${}\\{exit}({-}\T{4});{}$\6
\4${}\}{}$\2\6
\X11:Input the clause in \PB{\\{buf}}\X;\6
\X19:Remove all variables of the current clause\X;\6
\4${}\}{}$\2\6
${}\\{cells}\K\\{nullclauses}\K\T{0};{}$\6
${}\\{primary\_vars}\K\\{vars};{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_basics}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"("}\|O\.{"d\ primary\ variables}\)\.{\ read\
from\ "}\|O\.{"s)\\n"},\39\\{primary\_vars},\39\\{primary\_name});{}$\2\6
\4${}\}{}$\2\par
\U9.\fi

\M[439 sat11.w]{11}\B\X11:Input the clause in \PB{\\{buf}}\X${}\E{}$\6
\&{for} ${}(\|j\K\|k\K\\{non\_clause}\K\T{0};{}$ ${}\R\\{non\_clause};{}$ \,)\5
${}\{{}$\1\6
\&{while} ${}(\\{buf}[\|j]\E\.{'\ '}){}$\1\5
${}\|j\PP{}$;\C{ scan to nonblank }\2\6
\&{if} ${}(\\{buf}[\|j]\E\.{'\\n'}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{buf}[\|j]<\.{'\ '}\V\\{buf}[\|j]>\.{'\~'}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Illegal\ character\ (}\)\.{code\ \#"}\|O\.{"x)%
\ in\ the\ clause\ on}\)\.{\ line\ "}\|O\.{"lld!\\n"},\39\\{buf}[\|j],\39%
\\{clauses});{}$\6
${}\\{exit}({-}\T{5});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{buf}[\|j]\E\.{'\~'}){}$\1\5
${}\|i\K\T{1},\39\|j\PP;{}$\2\6
\&{else}\1\5
${}\|i\K\T{0};{}$\2\6
\X12:Scan and record a variable; negate it if \PB{$\|i\E\T{1}$}\X;\6
\4${}\}{}$\2\6
\&{if} ${}(\|k\E\T{0}\W\R\\{non\_clause}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"(Empty\ line\ "}\|O\.{"lld\ is\ being\ ignore}%
\)\.{d)\\n"},\39\\{clauses});{}$\6
${}\\{nullclauses}\PP{}$;\C{ strictly speaking it would be unsatisfiable }\6
\4${}\}{}$\2\6
\&{if} (\\{non\_clause})\1\5
\X19:Remove all variables of the current clause\X\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\|k>\T{3}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Sorry:\ This\ program}\)\.{\ accepts\ unary,\
bina}\)\.{ry,\ and\ ternary\ clau}\)\.{ses\ only!"});{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"\ (line\ "}\|O\.{"lld)\\n"},\39%
\\{clauses});{}$\6
${}\\{exit}({-}\T{1});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|k\E\T{3}){}$\1\5
${}\\{ternaries}\PP;{}$\2\6
\4${}\}{}$\2\6
${}\\{cells}\MRL{+{\K}}\|k{}$;\par
\Us9\ET10.\fi

\M[468 sat11.w]{12}We need a hack to insert the bit codes 1 and/or 2 into a
pointer value.

\Y\B\4\D$\\{hack\_in}(\|q,\|t)$ \5
(\&{tmp\_var} ${}{*})(\|t\OR{}$(\&{ullng}) \|q)\par
\Y\B\4\X12:Scan and record a variable; negate it if \PB{$\|i\E\T{1}$}\X${}\E{}$%
\6
${}\{{}$\1\6
\&{register} \&{tmp\_var} ${}{*}\|p;{}$\7
\&{if} ${}(\\{cur\_tmp\_var}\E\\{bad\_tmp\_var}){}$\1\5
\X13:Install a new \PB{\&{vchunk}}\X;\2\6
\X16:Put the variable name beginning at \PB{\\{buf}[\|j]} in \PB{$\\{cur\_tmp%
\_var}\MG\\{name}$} and compute its hash code \PB{\|h}\X;\6
\&{if} ${}(\R\\{non\_clause}){}$\5
${}\{{}$\1\6
\X17:Find \PB{$\\{cur\_tmp\_var}\MG\\{name}$} in the hash table at \PB{\|p}\X;\6
\&{if} ${}(\\{clauses}\W(\|p\MG\\{stamp}\E\\{clauses}\V\|p\MG\\{stamp}\E{-}%
\\{clauses})){}$\1\5
\X18:Handle a duplicate literal\X\2\6
\&{else}\5
${}\{{}$\1\6
${}\|p\MG\\{stamp}\K(\|i\?{-}\\{clauses}:\\{clauses});{}$\6
\&{if} ${}(\\{cur\_cell}\E\\{bad\_cell}){}$\1\5
\X14:Install a new \PB{\&{chunk}}\X;\2\6
${}{*}\\{cur\_cell}\K\|p;{}$\6
\&{if} ${}(\|i\E\T{1}){}$\1\5
${}{*}\\{cur\_cell}\K\\{hack\_in}({*}\\{cur\_cell},\39\T{1});{}$\2\6
\&{if} ${}(\|k\E\T{0}){}$\1\5
${}{*}\\{cur\_cell}\K\\{hack\_in}({*}\\{cur\_cell},\39\T{2});{}$\2\6
${}\\{cur\_cell}\PP,\39\|k\PP;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U11.\fi

\M[493 sat11.w]{13}\B\X13:Install a new \PB{\&{vchunk}}\X${}\E{}$\6
${}\{{}$\1\6
\&{register} \&{vchunk} ${}{*}\\{new\_vchunk};{}$\7
${}\\{new\_vchunk}\K{}$(\&{vchunk} ${}{*}){}$ \\{malloc}(\&{sizeof}(%
\&{vchunk}));\6
\&{if} ${}(\R\\{new\_vchunk}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Can't\ allocate\ a\ ne}\)\.{w\ vchunk!%
\\n"});{}$\6
${}\\{exit}({-}\T{6});{}$\6
\4${}\}{}$\2\6
${}\\{new\_vchunk}\MG\\{prev}\K\\{cur\_vchunk},\39\\{cur\_vchunk}\K\\{new%
\_vchunk};{}$\6
${}\\{cur\_tmp\_var}\K{\AND}\\{new\_vchunk}\MG\\{var}[\T{0}];{}$\6
${}\\{bad\_tmp\_var}\K{\AND}\\{new\_vchunk}\MG\\{var}[\\{vars\_per%
\_vchunk}];{}$\6
\4${}\}{}$\2\par
\U12.\fi

\M[506 sat11.w]{14}\B\X14:Install a new \PB{\&{chunk}}\X${}\E{}$\6
${}\{{}$\1\6
\&{register} \&{chunk} ${}{*}\\{new\_chunk};{}$\7
${}\\{new\_chunk}\K{}$(\&{chunk} ${}{*}){}$ \\{malloc}(\&{sizeof}(\&{chunk}));\6
\&{if} ${}(\R\\{new\_chunk}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Can't\ allocate\ a\ ne}\)\.{w\ chunk!%
\\n"});{}$\6
${}\\{exit}({-}\T{7});{}$\6
\4${}\}{}$\2\6
${}\\{new\_chunk}\MG\\{prev}\K\\{cur\_chunk},\39\\{cur\_chunk}\K\\{new%
\_chunk};{}$\6
${}\\{cur\_cell}\K{\AND}\\{new\_chunk}\MG\\{cell}[\T{0}];{}$\6
${}\\{bad\_cell}\K{\AND}\\{new\_chunk}\MG\\{cell}[\\{cells\_per\_chunk}];{}$\6
\4${}\}{}$\2\par
\U12.\fi

\M[519 sat11.w]{15}The hash code is computed via ``universal hashing,'' using
the following
precomputed tables of random bits.

\Y\B\4\X8:Initialize everything\X${}\mathrel+\E{}$\6
\&{for} ${}(\|j\K\T{92};{}$ \|j; ${}\|j\MM){}$\1\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\T{8};{}$ ${}\|k\PP){}$\1\5
${}\\{hash\_bits}[\|j][\|k]\K\\{gb\_next\_rand}(\,){}$;\2\2\par
\fi

\M[526 sat11.w]{16}\B\X16:Put the variable name beginning at \PB{\\{buf}[\|j]}
in \PB{$\\{cur\_tmp\_var}\MG\\{name}$} and compute its hash code \PB{\|h}\X${}%
\E{}$\6
$\\{cur\_tmp\_var}\MG\\{name}.\\{lng}\K\T{0};{}$\6
\&{for} ${}(\|h\K\|l\K\T{0};{}$ ${}\\{buf}[\|j+\|l]>\.{'\ '}\W\\{buf}[\|j+\|l]%
\Z\.{'\~'};{}$ ${}\|l\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\|l>\T{7}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Variable\ name\ "}\|O\.{".9s...\ in\ the\
claus}\)\.{e\ on\ line\ "}\|O\.{"lld\ is\ too\ long!\\n"},\39\\{buf}+\|j,\39%
\\{clauses});{}$\6
${}\\{exit}({-}\T{8});{}$\6
\4${}\}{}$\2\6
${}\|h\MRL{{\XOR}{\K}}\\{hash\_bits}[\\{buf}[\|j+\|l]-\.{'!'}][\|l];{}$\6
${}\\{cur\_tmp\_var}\MG\\{name}.\\{ch8}[\|l]\K\\{buf}[\|j+\|l];{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|l\E\T{0}){}$\1\5
${}\\{non\_clause}\K\T{1}{}$;\C{ `\.\~' by itself is like `true' }\2\6
\&{else}\1\5
${}\|j\MRL{+{\K}}\|l,\39\|h\MRL{\AND{\K}}(\T{1}\LL\\{hbits})-\T{1}{}$;\2\par
\U12.\fi

\M[541 sat11.w]{17}\B\X17:Find \PB{$\\{cur\_tmp\_var}\MG\\{name}$} in the hash
table at \PB{\|p}\X${}\E{}$\6
\&{for} ${}(\|p\K\\{hash}[\|h];{}$ \|p; ${}\|p\K\|p\MG\\{next}){}$\1\6
\&{if} ${}(\|p\MG\\{name}.\\{lng}\E\\{cur\_tmp\_var}\MG\\{name}.\\{lng}){}$\1\5
\&{break};\2\2\6
\&{if} ${}(\R\|p){}$\5
${}\{{}$\C{ new variable found }\1\6
${}\|p\K\\{cur\_tmp\_var}\PP;{}$\6
${}\|p\MG\\{next}\K\\{hash}[\|h],\39\\{hash}[\|h]\K\|p;{}$\6
${}\|p\MG\\{serial}\K\\{vars}\PP;{}$\6
${}\|p\MG\\{stamp}\K\T{0};{}$\6
\4${}\}{}$\2\par
\U12.\fi

\M[551 sat11.w]{18}The most interesting aspect of the input phase is probably
the ``unwinding''
that we might need to do when encountering a literal more than once
in the same clause.

\Y\B\4\X18:Handle a duplicate literal\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}((\|p\MG\\{stamp}>\T{0})\E(\|i>\T{0})){}$\1\5
${}\\{non\_clause}\K\T{1}{}$;\C{ tautology }\2\6
\4${}\}{}$\2\par
\U12.\fi

\M[560 sat11.w]{19}An input line that begins with `\.{\~\ }' is silently
treated as a comment.
Otherwise redundant clauses are logged, in case they were unintentional.
(One can, however, intentionally
use redundant clauses to force the order of the variables.)

\Y\B\4\X19:Remove all variables of the current clause\X${}\E{}$\6
${}\{{}$\1\6
\&{while} (\|k)\5
${}\{{}$\1\6
\X20:Move \PB{\\{cur\_cell}} backward to the previous cell\X;\6
${}\|k\MM;{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{non\_clause}\W((\\{buf}[\T{0}]\I\.{'\~'})\V(\\{buf}[\T{1}]\I\.{'\
'}))){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"(The\ clause\ on\ line}\)\.{\ "}\|O\.{"lld\ is%
\ always\ satis}\)\.{fied)\\n"},\39\\{clauses});{}$\2\6
${}\\{nullclauses}\PP;{}$\6
\4${}\}{}$\2\par
\Us10\ET11.\fi

\M[576 sat11.w]{20}\B\X20:Move \PB{\\{cur\_cell}} backward to the previous cell%
\X${}\E{}$\6
\&{if} ${}(\\{cur\_cell}>{\AND}\\{cur\_chunk}\MG\\{cell}[\T{0}]){}$\1\5
${}\\{cur\_cell}\MM;{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{register} \&{chunk} ${}{*}\\{old\_chunk}\K\\{cur\_chunk};{}$\7
${}\\{cur\_chunk}\K\\{old\_chunk}\MG\\{prev}{}$;\5
\\{free}(\\{old\_chunk});\6
${}\\{bad\_cell}\K{\AND}\\{cur\_chunk}\MG\\{cell}[\\{cells\_per\_chunk}];{}$\6
${}\\{cur\_cell}\K\\{bad\_cell}-\T{1};{}$\6
\4${}\}{}$\2\par
\Us19\ET41.\fi

\M[585 sat11.w]{21}Here I must omit `\PB{\\{free}(\\{old\_vchunk})}' from the
code that's usually
in this section, because the variable data will be used later.

\Y\B\4\X21:Move \PB{\\{cur\_tmp\_var}} backward to the previous temporary
variable\X${}\E{}$\6
\&{if} ${}(\\{cur\_tmp\_var}>{\AND}\\{cur\_vchunk}\MG\\{var}[\T{0}]){}$\1\5
${}\\{cur\_tmp\_var}\MM;{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{register} \&{vchunk} ${}{*}\\{old\_vchunk}\K\\{cur\_vchunk};{}$\7
${}\\{cur\_vchunk}\K\\{old\_vchunk}\MG\\{prev}{}$;\C{ and don't \PB{\\{free}(%
\\{old\_vchunk})} }\6
${}\\{bad\_tmp\_var}\K{\AND}\\{cur\_vchunk}\MG\\{var}[\\{vars\_per%
\_vchunk}];{}$\6
${}\\{cur\_tmp\_var}\K\\{bad\_tmp\_var}-\T{1};{}$\6
\4${}\}{}$\2\par
\U46.\fi

\M[597 sat11.w]{22}\B\X22:Report the successful completion of the input phase%
\X${}\E{}$\6
$\\{fprintf}(\\{stderr},\39\.{"("}\|O\.{"lld\ variables,\ "}\|O\.{"lld\
clauses,\ "}\|O\.{"llu\ literals\ succes}\)\.{sfully\ read)\\n"},\39\\{vars},%
\39\\{clauses},\39\\{cells}){}$;\par
\U2.\fi

\N[602 sat11.w]{1}{23}SAT solving, version 11.
A lookahead solver explores a binary tree of possibilities by choosing, at
every decision node, a variable $x$ for which the node's subtrees correspond
to asserting $x$ or $\bar x$. Several more-or-less independent activities are
part of this process:
\smallskip
%(0) {\it Preprocessing}. We simplify the original clauses and put them into a
%canonical form before the main search begins.
%\smallskip
(1) {\it Preselection}. At each decision node we choose a subset $P$ of the
unassigned variables, based on our best guess as to which of them might be
good candidates for further exploration.
\smallskip
(2) {\it Selection}. We look ahead at the immediate consequences of asserting
the truth and falsity of each variable in~$P$. Then we choose the variable
that appears to reduce the problem most efficiently.
\smallskip
(3) {\it Propagation}. We update the current state of the problem by
incorporating all consequences of a new assertion.
\smallskip
(4) {\it Backtracking}. When a contradiction arises in some branch, we must
undo the effects of propagation and move to an unexplored branch of the tree.
\smallskip\noindent
Each of these activities, except thankfully the last, involves many individual
steps.

In some sense this program represents an attitude: We're not afraid to
throw code at the problem.

\fi

\M[631 sat11.w]{24}Quite a few cooperating data structures are needed to do all
these things at
high speed. I shall therefore try to summarize the main ones here.

First, we need to represent the fact that variable $x$ is true, false,
or unknown. In fact, we must also deal with intermediate stages by which $x$
is known with various degrees of certainty, based on tentative assumptions
that we've made during the lookahead or propagation process. Every variable
therefore has an integer {\it stamp}, which is even if $x$ is true, odd if $x$
is false, and relatively large if the value is relatively certain. Setting the
stamp to~0 makes $x$ absolutely unknown; setting the stamp to the highest
possible values \PB{\\{real\_truth}} or \PB{$\\{real\_truth}+\T{1}$} makes it
absolutely true or
false. Setting the stamp to an intermediate value like 100 makes $x$ true when
the ``current stamp'' \PB{\\{cs}} is 2, 4, \dots, 100, but unknown when \PB{$%
\\{cs}>\T{100}$}.
(The value of \PB{\\{cs}} is always even, and it never exceeds \PB{\\{known}}.)

Second, we need quick access to the consequences of binary clauses.
A binary clause $l\lor l'$ is equivalent to two direct implications
$\bar l\to l'$ and $\bar l'\to l$, and the set of all such implications forms
a digraph called the implication graph. The \PB{\\{bimp}} data structure makes
it
easy to find all literals that are directly implied by any given literal.
(And since $\bar l\to l'$ if and only if $\bar l'\to l$, it's equally
easy to find all literals that {\it directly imply\/} any given literal.)
New binary implications are learned and added to \PB{\\{bimp}} as computation
proceeds, and they are stored sequentially in memory; therefore the
individual lists are allocated dynamically, within a large array
called~\PB{\\{mem}}, using the ``buddy system'' (Algorithm 2.5R).

Third, there's also a \PB{\\{timp}} data structure. Each ternary clause
$l\lor l'\lor l''$ means that $\bar l\to l'\lor l''$, $\bar l'\to l''\lor l$,
$\bar l''\to l\lor l'$; and \PB{\\{timp}} records the binary clauses implied by
any
given literal. (Preprocessing has ensured that each ternary clause appears in a
canonical order $l<l'<l''$; thus we won't have both $\bar l\to l'\lor l''$
and $\bar l\to l''\lor l'$ within \PB{\\{timp}}.) New ternary implications are
{\it not\/} added to \PB{\\{timp}} during the computation; therefore the \PB{%
\\{timp}}
structure is allocated once and for all at the beginning.
When a ternary clause becomes satisfied, it is swapped to an inactive
part of \PB{\\{timp}} so that it will not slow down the analysis
of active clauses.

Fourth, there's a sequential list \PB{\\{freevar}} of all variables not
currently
assigned, and an inverse list \PB{\\{freeloc}} to tell where a particular
variable
appears in \PB{\\{freevar}}.

Fifth, sixth, etc., there are a bunch of more conventional data structures:
Attributes of literal~\PB{\|l} appear in \PB{\\{lmem}[\|l]}; attributes of
variable~\PB{\|x}
appear in \PB{\\{vmem}[\|x]}.
The \PB{\\{rstack}} holds the names of literals in the order they have been
(tentatively) set. The \PB{\\{istack}} holds the names of variables whose \PB{%
\\{bimp}}
entries have grown, together with the value needed to ungrow them
when we undo a decision. The \PB{\\{nstack}} contains information about nodes
of the decision tree that have led to the current state.
Later we will define a number of special data structures for use in
parts of this program that are essentially self-contained.

\Y\B\4\X3:Global variables\X${}\mathrel+\E{}$\6
\&{uint} ${}{*}\\{stamp}{}$;\C{ the current levels of truth, falsity, and
uncertainty }\6
\&{uint} ${}{*}\\{mem}{}$;\C{ master array of buddy-allocated blocks for \PB{%
\\{bimp}} lists }\6
\&{bdata} ${}{*}\\{bimp}{}$;\C{ indexes into \PB{\\{mem}} for lists of binary
implications }\6
\&{tpair} ${}{*}\\{tmem}{}$;\C{ master array of blocks for \PB{\\{timp}} lists
}\6
\&{tdata} ${}{*}\\{timp}{}$;\C{ indexes into \PB{\\{tmem}} for lists of ternary
implications }\6
\&{uint} ${}{*}\\{freevar},{}$ ${}{*}\\{freeloc}{}$;\C{ perm of the variables
from free to assigned }\6
\&{int} \\{freevars};\C{ how many of the variables are still free (unassigned)?
}\6
\&{uint} ${}{*}\\{rstack}{}$;\C{ stack and queue for backtracking and unit
propagation }\6
\&{int} \\{rptr};\C{ the number of elements used in \PB{\\{rstack}} }\6
\&{idata} ${}{*}\\{istack}{}$;\C{ \PB{\\{bimp}} sizes to be undone if necessary
}\6
\&{int} \\{iptr};\C{ the number of elements used in \PB{\\{istack}} }\6
\&{int} \\{iptr\_max};\C{ largest \PB{\\{iptr}} currently allocated in virtual
memory }\6
\&{ndata} ${}{*}\\{nstack}{}$;\C{ node information }\6
\&{int} \\{level};\C{ current depth in the decision tree }\6
\&{literal} ${}{*}\\{lmem}{}$;\C{ attributes of literals }\6
\&{variable} ${}{*}\\{vmem}{}$;\C{ attributes of variables }\par
\fi

\M[703 sat11.w]{25}The variables are numbered 1, 2, \dots, $n$, and the
literals corresponding
to variable~$x$ are $2x$ and $2x+1$ (namely $x$ and $\bar x$). Thus the
variable that corresponds to literal~$l$ is \PB{$\|l\GG\T{1}$}, and the
complement
of literal~$l$ is \PB{$\|l\XOR\T{1}$}. (Previous
programs of this series started the numbering at~0, not~1, in accord with
Dijkstra's famous dictum. But we shall find it convenient to reserve the
value~0 for use as a sentinel.)

Some arrays (like \PB{\\{stamp}} and \PB{\\{freevar}}) are indexed by variable
numbers,
while others (like \PB{\\{bimp}} and \PB{\\{timp}}) are indexed by literal
numbers. In order
to reduce the chance of confusion between the two numbering schemes,
variables in the code below will generally be represented by the letters \PB{%
\|x},
\PB{\|y}, or \PB{\|z}; literals will generally be represented by \PB{\|l}, \PB{%
\|u}, \PB{\|v}, or \PB{\|w}.

\Y\B\4\D$\\{thevar}(\|l)$ \5
$((\|l)\GG\T{1}{}$)\C{ the variable that corresponds to \PB{\|l} }\par
\B\4\D$\\{bar}(\|l)$ \5
$((\|l)\XOR\T{1}{}$)\C{ the complement of \PB{\|l} }\par
\B\4\D$\\{poslit}(\|x)$ \5
$((\|x)\LL\T{1}{}$)\C{ the literal $x$ }\par
\B\4\D$\\{neglit}(\|x)$ \5
$(((\|x)\LL\T{1})+\T{1}{}$)\C{ the literal $\bar x$ }\par
\fi

\M[722 sat11.w]{26}An entry in the \PB{\\{bimp}} table has four parts: \PB{%
\\{addr}} is the address in \PB{\\{mem}}
where the list of implications begins; \PB{\\{size}} is the current length of
that list; \PB{\\{alloc}} is the number of memory positions currently available
at the given address; and \PB{\\{alloc}} always equals $2^k$, where \PB{\|k} is
the fourth field. (Thus we always have \PB{$\\{size}\Z\\{alloc}$}. The value of
\PB{\|k} is
always at least~2, hence \PB{\\{alloc}} is always at least~4. As the
computation
proceeds, \PB{\\{alloc}} might increase, but it never will decrease.)

When \PB{\\{mems}} are counted, we assume that \PB{\\{addr}} and \PB{\\{size}}
are fetched or
stored together; hence we can access them both at the cost of just one~mem.
Similarly, \PB{\\{alloc}} and \PB{\|k} are assumed to be in the same octabyte
of memory.

An entry in the \PB{\\{istack}} has two parts: \PB{\\{lit}} is the literal~$l$
whose \PB{\\{bimp}}
entry is to be restored; \PB{\\{size}} is the amount to be placed in \PB{$%
\\{bimp}[\|l].\\{size}$}.

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{bdata\_struct} ${}\{{}$\1\6
\&{uint} \\{addr};\C{ starting place of a sequential list in \PB{\\{mem}} }\6
\&{uint} \\{size};\C{ its current length }\6
\&{uint} \\{alloc};\C{ maximum length before reallocation is necessary }\6
\&{uint} \|k;\C{ lg \PB{\\{alloc}} }\2\6
${}\}{}$ \&{bdata};\6
\&{typedef} \&{struct} \&{idata\_struct} ${}\{{}$\1\6
\&{uint} \\{lit};\C{ the \PB{\|l} whose \PB{\\{size}} in \PB{\\{bimp}} was
changed }\6
\&{uint} \\{size};\C{ its previous size }\2\6
${}\}{}$ \&{idata};\par
\fi

\M[749 sat11.w]{27}An entry in \PB{\\{timp}} has two parts: \PB{\\{addr}} is
the address in \PB{\\{tmem}} where
the list of implication pairs begins; \PB{\\{size}} is the current length
of that list.

An entry in \PB{\\{tmem}} has two parts, \PB{\|u} and \PB{\|v}, for the two
literals
$l'$ and $l''$ whose {\mc OR} is implied by a given literal~$l$.
It also has a \PB{\\{link}} field, which points to the next \PB{\\{tmem}} entry
in the triad
that corresponds to an original ternary clause.

(Each original clause $l\lor l'\lor l''$ leads to \PB{\\{timp}} entries for $%
\bar l$,
$\bar l'$, and $\bar l''$. These three entries are circularly linked.)

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{tdata\_struct} ${}\{{}$\1\6
\&{uint} \\{addr};\C{ starting place of a sequential list in \PB{\\{mem}} }\6
\&{uint} \\{size};\C{ its current length }\2\6
${}\}{}$ \&{tdata};\C{ one octabyte }\6
\&{typedef} \&{struct} \&{tpair\_struct} ${}\{{}$\1\6
\&{uint} \|u${},{}$ \|v;\C{ a pair of literals }\6
\&{uint} \\{link};\C{ the successor pair of a triad }\6
\&{uint} \\{spare};\C{ used only when reading the initial data }\2\6
${}\}{}$ \&{tpair};\C{ two octabytes }\par
\fi

\M[772 sat11.w]{28}An entry in \PB{\\{nstack}} has the following fields:
\PB{\\{decision}} records the literal whose truth is being tentatively
asserted;
\PB{\\{branch}} is 0 in the first branch, or 1 if that branch failed;
\PB{\\{rptr}} and \PB{\\{iptr}} record the initial values of those stack
pointers
when the node was initialized;
\PB{\\{lptr}} records the initial value of \PB{\\{rptr}} when lookahead for the
next level began.

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{ndata\_struct} ${}\{{}$\1\6
\&{uint} \\{decision};\C{ the literal chosen at this branch }\6
\&{int} \\{branch};\C{ did we try and fail to set it the other way? }\6
\&{int} \\{rptr}${},{}$ \\{iptr}${},{}$ \\{lptr};\C{ initial values of stack
pointers }\2\6
${}\}{}$ \&{ndata};\par
\fi

\M[787 sat11.w]{29}Here is a subroutine that prints the binary implicant data
for
a given literal. (Used only when debugging.)

\Y\B\4\X29:Subroutines\X${}\E{}$\6
\&{void} \\{print\_bimp}(\&{int} \|l)\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{uint} \\{la}${},{}$ \\{ls};\7
${}\\{printf}(\.{""}\|O\.{"s"}\|O\.{".8s\ ->"},\39\\{litname}(\|l));{}$\6
\&{for} ${}(\\{la}\K\\{bimp}[\|l].\\{addr},\39\\{ls}\K\\{bimp}[\|l].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\1\5
${}\\{printf}(\.{"\ "}\|O\.{"s"}\|O\.{".8s"},\39\\{litname}(\\{mem}[%
\\{la}]));{}$\2\6
\\{printf}(\.{"\\n"});\6
\4${}\}{}$\2\par
\As30, 31, 33, 50, 61, 93\ETs152.
\U2.\fi

\M[799 sat11.w]{30}Similarly, the current ternary implicant data gives useful
diagnostic info.

\Y\B\4\X29:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{print\_timp}(\&{int} \|l)\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{uint} \\{la}${},{}$ \\{ls};\7
${}\\{printf}(\.{""}\|O\.{"s"}\|O\.{".8s\ ->"},\39\\{litname}(\|l));{}$\6
\&{for} ${}(\\{la}\K\\{timp}[\|l].\\{addr},\39\\{ls}\K\\{timp}[\|l].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\1\5
${}\\{printf}(\.{"\ "}\|O\.{"s"}\|O\.{".8s|"}\|O\.{"s"}\|O\.{".8s"},\39%
\\{litname}(\\{tmem}[\\{la}].\|u),\39\\{litname}(\\{tmem}[\\{la}].\|v));{}$\2\6
\\{printf}(\.{"\\n"});\6
\4${}\}{}$\2\7
\&{void} \\{print\_full\_timp}(\&{int} \|l)\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{uint} \\{la}${},{}$ \|k;\7
${}\\{printf}(\.{""}\|O\.{"s"}\|O\.{".8s\ ->"},\39\\{litname}(\|l));{}$\6
\&{for} ${}(\\{la}\K\\{timp}[\|l].\\{addr},\39\|k\K\T{0};{}$ ${}\|k<\\{timp}[%
\|l].\\{size};{}$ ${}\|k\PP){}$\1\5
${}\\{printf}(\.{"\ "}\|O\.{"s"}\|O\.{".8s|"}\|O\.{"s"}\|O\.{".8s"},\39%
\\{litname}(\\{tmem}[\\{la}+\|k].\|u),\39\\{litname}(\\{tmem}[\\{la}+\|k].%
\|v));{}$\2\6
\&{if} ${}(\\{la}+\|k\I\\{timp}[\|l-\T{1}].\\{addr}){}$\5
${}\{{}$\1\6
\\{printf}(\.{"\ \#"});\C{ show also the inactive implicants }\6
\&{for} ( ; ${}\\{la}+\|k<\\{timp}[\|l-\T{1}].\\{addr};{}$ ${}\|k\PP){}$\1\5
${}\\{printf}(\.{"\ "}\|O\.{"s"}\|O\.{".8s|"}\|O\.{"s"}\|O\.{".8s"},\39%
\\{litname}(\\{tmem}[\\{la}+\|k].\|u),\39\\{litname}(\\{tmem}[\\{la}+\|k].%
\|v));{}$\2\6
\4${}\}{}$\2\6
\\{printf}(\.{"\\n"});\6
\4${}\}{}$\2\par
\fi

\M[823 sat11.w]{31}Speaking of debugging, here's a routine to check if the
redundant
parts of our data structure have gone awry.

\Y\B\4\D$\\{sanity\_checking}$ \5
\T{0}\C{ set this to 1 if you suspect a bug }\par
\Y\B\4\X29:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{sanity}(\&{void})\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \|j${},{}$ \|k${},{}$ \|l${},{}$ \\{la}${},{}$ %
\\{ls}${},{}$ \\{los}${},{}$ \|p${},{}$ \|q${},{}$ \|u${},{}$ \|v;\7
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{vars};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{freevar}[\\{freeloc}[\|k+\T{1}]]\I\|k+\T{1}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"freeloc["}\|O\.{"d]\ is\ wrong!\\n"},\39\|k+%
\T{1});{}$\2\6
\&{if} ${}(\\{freeloc}[\\{freevar}[\|k]]\I\|k){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"freevar["}\|O\.{"d]\ is\ wrong!\\n"},\39%
\|k);{}$\2\6
\4${}\}{}$\2\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{rptr};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\|l\K\\{rstack}[\|k];{}$\6
\&{if} ${}(\\{freeloc}[\\{thevar}(\|l)]<\\{freevars}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"literal\ "}\|O\.{"d\ on\ rstack\ is\ free}\)%
\.{!\\n"},\39\|l);{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{rptr}+\\{freevars}\I\\{vars}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"rptr="}\|O\.{"d,\ freevars="}\|O\.{"d,\
vars="}\|O\.{"lld\\n"},\39\\{rptr},\39\\{freevars},\39\\{vars});{}$\2\6
\X49:Check the sanity of \PB{\\{bimp}} and \PB{\\{mem}}\X;\6
\X32:Check the sanity of \PB{\\{timp}} and \PB{\\{tmem}}\X;\6
\4${}\}{}$\2\par
\fi

\M[848 sat11.w]{32}\B\X32:Check the sanity of \PB{\\{timp}} and \PB{\\{tmem}}%
\X${}\E{}$\6
\&{for} ${}(\|l\K\T{2};{}$ ${}\|l<\\{badlit};{}$ ${}\|l\PP){}$\5
${}\{{}$\1\6
${}\\{la}\K\\{timp}[\|l].\\{addr},\39\\{ls}\K\\{timp}[\|l].\\{size},\39\\{los}%
\K\\{timp}[\|l-\T{1}].\\{addr}-\\{la};{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{los};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{tmem}[\\{tmem}[\\{tmem}[\\{la}+\|k].\\{link}].\\{link}].\\{link}%
\I\\{la}+\|k){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"links\ clobbered\ in\ }\)\.{tmem[0x"}\|O%
\.{"x]!\\n"},\39\\{la}+\|k);{}$\2\6
${}\|u\K\\{tmem}[\\{la}+\|k].\|u,\39\|v\K\\{tmem}[\\{la}+\|k].\|v;{}$\6
\&{if} ${}(\|k<\\{ls}){}$\5
${}\{{}$\C{ active area, shouldn't contain assigned variables }\1\6
\&{if} ${}(\\{stamp}[\\{thevar}(\|l)]<\\{real\_truth}){}$\5
${}\{{}$\C{ unless \PB{\|l} itself is assigned }\1\6
\&{if} ${}(\\{stamp}[\\{thevar}(\|u)]\G\\{real\_truth}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"active\ timp\ u\ for\ f}\)\.{ree\ lit\ "}\|O%
\.{"d\ has\ assigned\ lit\ }\)\.{"}\|O\.{"d!\\n"},\39\|l,\39\|u);{}$\2\6
\&{if} ${}(\\{stamp}[\\{thevar}(\|v)]\G\\{real\_truth}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"active\ timp\ v\ for\ f}\)\.{ree\ lit\ "}\|O%
\.{"d\ has\ assigned\ lit\ }\)\.{"}\|O\.{"d!\\n"},\39\|l,\39\|v);{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\\{stamp}[\\{thevar}(\|u)]<\\{real\_truth}\W\\{stamp}[%
\\{thevar}(\|v)]<\\{real\_truth}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"inactive\ timp\ entry}\)\.{\ for\ "}\|O\.{"d\
has\ unassigned\ "}\|O\.{"d\ and\ "}\|O\.{"d!\\n"},\39\|l,\39\|u,\39\|v);{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U31.\fi

\M[871 sat11.w]{33}In long runs it's helpful to know how far we've gotten. A
numeric code
summarizes each decision made so far:
0 or 1 means that we're trying to set a variable
true or false, on the first branch of a node (``branch~0'');
2 or 3 is similar, but on the second branch (``branch~1'');
4 or 5 is similar, but when the decision was forced by
the decision at the previous branch node;
6 or 7 is similar, but when
the decision was found to be forced while looking ahead for the
next literal on which to branch.

\Y\B\4\X29:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{print\_state}(\&{int} \\{lev})\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \|k${},{}$ \|r;\7
${}\\{fprintf}(\\{stderr},\39\.{"\ after\ "}\|O\.{"lld\ mems:"},\39%
\\{mems});{}$\6
\&{for} ${}(\|k\K\|r\K\T{0};{}$ ${}\|k<\\{lev};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{for} ( ; ${}\|r<\\{nstack}[\|k].\\{rptr};{}$ ${}\|r\PP){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{""}\|O\.{"c"},\39\.{'6'}+(\\{rstack}[\|r]\AND%
\T{1}));{}$\2\6
\&{if} ${}(\\{nstack}[\|k].\\{branch}<\T{0}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"|"});{}$\2\6
\&{else}\1\5
${}\\{fprintf}(\\{stderr},\39\.{""}\|O\.{"c"},\39\.{'0'}+(\\{rstack}[\|r\PP]%
\AND\T{1})+(\\{nstack}[\|k].\\{branch}\LL\T{1}));{}$\2\6
\&{for} ( ; ${}\|r<\\{nstack}[\|k+\T{1}].\\{lptr};{}$ ${}\|r\PP){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{""}\|O\.{"c"},\39\.{'4'}+(\\{rstack}[\|r]\AND%
\T{1}));{}$\2\6
\&{if} ${}(\|k\G\\{print\_state\_cutoff}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"..."}){}$;\5
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{fprintf}(\\{stderr},\39\.{"\\n"});{}$\6
\\{fflush}(\\{stderr});\6
\4${}\}{}$\2\par
\fi

\M[901 sat11.w]{34}Each literal has an entry in \PB{\\{lmem}}, containing many
fields.
We will introduce them from time to time as we use them.

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{lit\_struct} ${}\{{}$\1\6
\&{int} \\{rank};\C{ order of appearance in Tarjan's algorithm }\6
\&{int} \\{link};\C{ pointer to another literal }\6
\&{int} \\{untagged};\C{ progress record in Tarjan's algorithm }\6
\&{int} \\{min};\C{ magically important data for Tarjan's algorithm }\6
\&{int} \\{parent};\C{ predecessor in Tarjan's algorithm }\6
\&{int} \\{vcomp};\C{ component representation in Tarjan's algorithm }\6
\&{int} \\{arcs};\C{ pointer to the first successor entry in the \PB{\\{cand%
\_arc}} array }\6
\&{uint} \\{bstamp};\C{ stamped with \PB{\\{bstamp}} when processing new
binaries }\6
\&{uint} \\{dl\_fail};\C{ stamped with \PB{\\{istamp}} when doublelook didn't
force this }\6
\&{uint} \\{istamp};\C{ stamped with \PB{\\{istamp}} when making an entry for %
\PB{\\{istack}} }\6
\&{float} \\{wnb};\C{ total weighted new binaries, including implied literals }%
\6
\&{uint} \\{filler};\C{ extra space to fill six octabytes }\2\6
${}\}{}$ \&{literal};\par
\fi

\M[920 sat11.w]{35}Similarly, each variable has an entry in \PB{\\{vmem}},
where three fields appear.

\Y\B\4\D$\\{litname}(\|l)$ \5
$(\|l)\AND\T{1}\?\.{"\~"}:\.{""},\39\\{vmem}[\\{thevar}(\|l)].\\{name}.{}$%
\\{ch8}\C{ used in printouts }\par
\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{var\_struct} ${}\{{}$\1\6
\&{octa} \\{name};\C{ the variable's symbolic name }\6
\&{int} \\{pfx}${},{}$ \\{len};\C{ prefix of its first useful appearance in the
search tree }\2\6
${}\}{}$ \&{variable};\par
\fi

\N[930 sat11.w]{1}{36}Initializing the real data structures.
We're ready now to convert the temporary chunks of data into the
form we want, and to recycle those chunks. The code below is, of course,
similar to what has worked in previous programs of this series.

\Y\B\4\X3:Global variables\X${}\mathrel+\E{}$\6
\&{uint} \\{lits};\C{ how many literals are present? }\6
\&{uint} \\{badlit};\C{ one more than the highest literal number }\par
\fi

\M[939 sat11.w]{37}\B\X37:Set up the main data structures\X${}\E{}$\6
$\\{lits}\K\\{vars}\LL\T{1},\39\\{badlit}\K\\{lits}+\T{2};{}$\6
${}\\{last\_vchunk}\K\\{cur\_vchunk};{}$\6
\X38:Allocate the main arrays\X;\6
\X46:Copy all the temporary variable nodes to the \PB{\\{vmem}} array in proper
format\X;\6
\X40:Copy all the temporary cells to the \PB{\\{bimp}}, \PB{\\{mem}}, \PB{%
\\{timp}}, and \PB{\\{tmem}} arrays in proper format\X;\6
\X47:Check consistency\X;\6
\X58:Allocate special arrays\X;\par
\U2.\fi

\M[948 sat11.w]{38}We randomize the initial order of \PB{\\{freevars}}, so that
different seeds
can produce different results (for instance on satisfiable problems).

\Y\B\4\X38:Allocate the main arrays\X${}\E{}$\6
$\\{stamp}\K{}$(\&{uint} ${}{*}){}$ \\{malloc}${}((\\{vars}+\T{1})*\&{sizeof}(%
\&{uint}));{}$\6
\&{if} ${}(\R\\{stamp}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ stamp\
array!}\)\.{\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\\{vars}+\T{1})*\&{sizeof}(\&{uint}){}$;\7
${}\\{bimp}\K{}$(\&{bdata} ${}{*}){}$ \\{malloc}${}(\\{badlit}*\&{sizeof}(%
\&{bdata}));{}$\6
\&{if} ${}(\R\\{bimp}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ bimp\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{badlit}*\&{sizeof}(\&{bdata});{}$\6
\X57:Initialize \PB{\\{mem}} with empty \PB{\\{bimp}} lists\X;\7
${}\\{timp}\K{}$(\&{tdata} ${}{*}){}$ \\{malloc}${}(\\{badlit}*\&{sizeof}(%
\&{tdata}));{}$\6
\&{if} ${}(\R\\{timp}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ timp\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{badlit}*\&{sizeof}(\&{tdata});{}$\6
${}\\{tmem}\K{}$(\&{tpair} ${}{*}){}$ \\{malloc}${}(\T{3}*\\{ternaries}*%
\&{sizeof}(\&{tpair}));{}$\6
\&{if} ${}(\R\\{tmem}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ tmem\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\T{3}*\\{ternaries}*\&{sizeof}(\&{tpair}){}$;\7
${}\\{freevar}\K{}$(\&{uint} ${}{*}){}$ \\{malloc}${}(\\{vars}*\&{sizeof}(%
\&{uint}));{}$\6
\&{if} ${}(\R\\{freevar}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ freevar\
arra}\)\.{y!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{vars}*\&{sizeof}(\&{uint});{}$\6
${}\\{freeloc}\K{}$(\&{uint} ${}{*}){}$ \\{malloc}${}((\\{vars}+\T{1})*%
\&{sizeof}(\&{uint}));{}$\6
\&{if} ${}(\R\\{freeloc}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ freeloc\
arra}\)\.{y!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\\{vars}+\T{1})*\&{sizeof}(\&{uint});{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{vars};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{mems}\MRL{+{\K}}\T{4},\39\|j\K\\{gb\_unif\_rand}(\|k+\T{1});{}$\6
\&{if} ${}(\|j\I\|k){}$\5
${}\{{}$\1\6
${}\|o,\39\|i\K\\{freevar}[\|j];{}$\6
${}\\{oo},\39\\{freevar}[\|k]\K\|i,\39\\{freeloc}[\|i]\K\|k;{}$\6
${}\\{oo},\39\\{freevar}[\|j]\K\|k+\T{1},\39\\{freeloc}[\|k+\T{1}]\K\|j;{}$\6
\4${}\}{}$\5
\2\&{else}\1\5
${}\\{oo},\39\\{freevar}[\|k]\K\|k+\T{1},\39\\{freeloc}[\|k+\T{1}]\K\|k;{}$\2\6
\4${}\}{}$\2\6
${}\\{freevars}\K\\{vars}{}$;\par
\A39.
\U37.\fi

\M[1002 sat11.w]{39}Although the \PB{\\{rstack}} is used rather heavily, for
breadth-first
searches, a literal and its complement never both appear. Therefore
the total size of the \PB{\\{rstack}} should never exceed the number of
variables.

\Y\B\4\X38:Allocate the main arrays\X${}\mathrel+\E{}$\6
$\\{rstack}\K{}$(\&{uint} ${}{*}){}$ \\{malloc}${}((\\{vars}+\T{1})*\&{sizeof}(%
\&{uint}));{}$\6
\&{if} ${}(\R\\{rstack}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ rstack\
array}\)\.{!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\\{vars}+\T{1})*\&{sizeof}(\&{uint}){}$;\7
${}\\{nstack}\K{}$(\&{ndata} ${}{*}){}$ \\{malloc}${}((\\{vars}+\T{1})*%
\&{sizeof}(\&{ndata}));{}$\6
\&{if} ${}(\R\\{nstack}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ nstack\
array}\)\.{!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\\{vars}+\T{1})*\&{sizeof}(\&{ndata}){}$;\7
${}\\{lmem}\K{}$(\&{literal} ${}{*}){}$ \\{malloc}${}(\\{badlit}*\&{sizeof}(%
\&{literal}));{}$\6
\&{if} ${}(\R\\{lmem}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ lmem\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{badlit}*\&{sizeof}(\&{literal});{}$\6
\&{for} ${}(\|l\K\T{2};{}$ ${}\|l<\\{badlit};{}$ ${}\|l\PP){}$\1\5
${}\\{oo},\39\\{lmem}[\|l].\\{dl\_fail}\K\\{lmem}[\|l].\\{bstamp}\K\\{lmem}[%
\|l].\\{istamp}\K\T{0}{}$;\2\7
${}\\{vmem}\K{}$(\&{variable} ${}{*}){}$ \\{malloc}${}((\\{vars}+\T{1})*%
\&{sizeof}(\&{variable}));{}$\6
\&{if} ${}(\R\\{vmem}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ vmem\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\\{vars}+\T{1})*\&{sizeof}(\&{variable}){}$;\7
${}\\{forcedlit}\K{}$(\&{uint} ${}{*}){}$ \\{malloc}${}(\\{vars}*\&{sizeof}(%
\&{uint}));{}$\6
\&{if} ${}(\R\\{forcedlit}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\
forcedlit\ ar}\)\.{ray!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{vars}*\&{sizeof}(\&{uint}){}$;\par
\fi

\M[1043 sat11.w]{40}\B\X40:Copy all the temporary cells to the \PB{\\{bimp}}, %
\PB{\\{mem}}, \PB{\\{timp}}, and \PB{\\{tmem}} arrays in proper format\X${}%
\E{}$\6
$\\{forcedlits}\K\T{0}{}$;\C{ prepare for possible unary clauses }\6
\&{for} ${}(\|l\K\T{2};{}$ ${}\|l<\\{badlit};{}$ ${}\|l\PP){}$\1\5
${}\|o,\39\\{timp}[\|l].\\{addr}\K\\{timp}[\|l].\\{size}\K\T{0}{}$;\C{ clear
the counts }\2\6
\&{for} ${}(\|c\K\\{clauses},\39\|k\K\T{0};{}$ \|c; ${}\|c\MM){}$\5
${}\{{}$\1\6
\X41:Insert the cells for the literals of clause \PB{\|c}\X;\6
\4${}\}{}$\2\6
\X45:Build \PB{\\{timp}} and \PB{\\{tmem}} from the stored ternary clauses\X;\6
\&{if} (\\{out\_file})\1\5
\\{fflush}(\\{out\_file});\C{ complete the copy of input clauses }\2\par
\U37.\fi

\M[1053 sat11.w]{41}The basic idea is to ``unwind'' the steps that we went
through while
building up the chunks.

\Y\B\4\D$\\{hack\_out}(\|q)$ \5
(((\&{ullng}) \|q)${}\AND\T{\^3}{}$)\par
\B\4\D$\\{hack\_clean}(\|q)$ \5
((\&{tmp\_var} ${}{*})({}$(\&{ullng}) \|q${}\AND{-}\T{4}){}$)\par
\Y\B\4\X41:Insert the cells for the literals of clause \PB{\|c}\X${}\E{}$\6
\&{for} ${}(\|i\K\|j\K\T{0};{}$ ${}\|i<\T{2};{}$ \,)\5
${}\{{}$\1\6
\X20:Move \PB{\\{cur\_cell}} backward to the previous cell\X;\6
${}\|i\K\\{hack\_out}({*}\\{cur\_cell});{}$\6
${}\|p\K\\{hack\_clean}({*}\\{cur\_cell})\MG\\{serial};{}$\6
${}\|p\MRL{+{\K}}\|p+(\|i\AND\T{1});{}$\6
${}\\{rstack}[\|j\PP]\K\|p+\T{2}{}$;\C{ the clause is first assembled in \PB{%
\\{rstack}} }\C{ but no mems are charged, because three registers could be used
}\6
\4${}\}{}$\2\6
${}\|u\K\\{rstack}[\T{0}],\39\|v\K\\{rstack}[\T{1}],\39\|w\K\\{rstack}[%
\T{2}]{}$;\C{ see? }\6
\&{if} (\\{out\_file})\5
${}\{{}$\1\6
\&{for} ${}(\\{jj}\K\T{0};{}$ ${}\\{jj}<\|j;{}$ ${}\\{jj}\PP){}$\1\5
${}\\{fprintf}(\\{out\_file},\39\.{"\ "}\|O\.{"s"}\|O\.{".8s"},\39\\{litname}(%
\\{rstack}[\\{jj}]));{}$\2\6
${}\\{fprintf}(\\{out\_file},\39\.{"\\n"});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|j\E\T{1}){}$\1\5
\X42:Store a unary clause in \PB{\\{forcedlit}}\X\2\6
\&{else} \&{if} ${}(\|j\E\T{2}){}$\1\5
\X43:Store a binary clause in \PB{\\{bimp}}\X\2\6
\&{else}\1\5
\X44:Store a ternary clause in \PB{\\{tmem}}\X;\2\par
\U40.\fi

\M[1077 sat11.w]{42}Unary clauses in the input might be repeated or
contradictory.
Thus we must be careful not to overstep the bounds of the \PB{\\{forcedlit}}
array.
The \PB{\\{addr}} fields in \PB{\\{timp}} are borrowed here, temporarily, so
that no variable
is forced twice.

\Y\B\4\X42:Store a unary clause in \PB{\\{forcedlit}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\|o,\39\\{timp}[\|u].\\{addr}\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|o,\39\\{timp}[\\{bar}(\|u)].\\{addr}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_choices}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"Unary\ clause\ "}\|O\.{"d\ contradicts\ unary}%
\)\.{\ clause\ "}\|O\.{"d\\n"},\39\|c,\39\\{timp}[\\{bar}(\|u)].\\{addr});{}$\2%
\6
\&{goto} \\{unsat};\6
\4${}\}{}$\2\6
${}\|o,\39\\{timp}[\|u].\\{addr}\K\|c;{}$\6
${}\|o,\39\\{forcedlit}[\\{forcedlits}\PP]\K\|u;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U41.\fi

\M[1096 sat11.w]{43}\B\X43:Store a binary clause in \PB{\\{bimp}}\X${}\E{}$\6
${}\{{}$\1\6
${}\|o,\39\\{la}\K\\{bimp}[\\{bar}(\|u)].\\{addr},\39\\{ls}\K\\{bimp}[\\{bar}(%
\|u)].\\{size};{}$\6
\&{if} ${}(\|o,\39\\{ls}\E\\{bimp}[\\{bar}(\|u)].\\{alloc}){}$\1\5
${}\\{resize}(\\{bar}(\|u)),\39\|o,\39\\{la}\K\\{bimp}[\\{bar}(\|u)].%
\\{addr};{}$\2\6
${}\\{oo},\39\\{mem}[\\{la}+\\{ls}]\K\|v,\39\\{bimp}[\\{bar}(\|u)].\\{size}\K%
\\{ls}+\T{1};{}$\6
${}\|o,\39\\{la}\K\\{bimp}[\\{bar}(\|v)].\\{addr},\39\\{ls}\K\\{bimp}[\\{bar}(%
\|v)].\\{size};{}$\6
\&{if} ${}(\|o,\39\\{ls}\E\\{bimp}[\\{bar}(\|v)].\\{alloc}){}$\1\5
${}\\{resize}(\\{bar}(\|v)),\39\|o,\39\\{la}\K\\{bimp}[\\{bar}(\|v)].%
\\{addr};{}$\2\6
${}\\{oo},\39\\{mem}[\\{la}+\\{ls}]\K\|u,\39\\{bimp}[\\{bar}(\|v)].\\{size}\K%
\\{ls}+\T{1};{}$\6
\4${}\}{}$\2\par
\U41.\fi

\M[1108 sat11.w]{44}During the preliminary ``counting'' pass,
we put ternary clauses sequentially into the spare slots of \PB{\\{tmem}}.

\Y\B\4\X44:Store a ternary clause in \PB{\\{tmem}}\X${}\E{}$\6
${}\{{}$\1\6
${}\\{oo},\39\\{timp}[\\{bar}(\|u)].\\{size}\PP;{}$\6
${}\\{oo},\39\\{timp}[\\{bar}(\|v)].\\{size}\PP;{}$\6
${}\\{oo},\39\\{timp}[\\{bar}(\|w)].\\{size}\PP;{}$\6
${}\\{ooo},\39\\{tmem}[\|k].\\{spare}\K\|u,\39\\{tmem}[\|k+\T{1}].\\{spare}\K%
\|v,\39\\{tmem}[\|k+\T{2}].\\{spare}\K\|w;{}$\6
${}\|k\MRL{+{\K}}\T{3};{}$\6
\4${}\}{}$\2\par
\U41.\fi

\M[1120 sat11.w]{45}\B\X45:Build \PB{\\{timp}} and \PB{\\{tmem}} from the
stored ternary clauses\X${}\E{}$\6
\&{for} ${}(\|j\K\T{0},\39\|l\K\\{badlit}-\T{1};{}$ ${}\|l\G\T{2};{}$ ${}\|l%
\MM){}$\5
${}\{{}$\1\6
${}\\{oo},\39\\{timp}[\|l].\\{addr}\K\|j,\39\|j\MRL{+{\K}}\\{timp}[\|l].%
\\{size},\39\\{timp}[\|l].\\{size}\K\T{0};{}$\6
\4${}\}{}$\2\6
${}\|o,\39\\{timp}[\|l].\\{addr}\K\|j{}$;\C{ we'll have \PB{$\\{timp}[\|l].%
\\{addr}+\\{timp}[\|l].\\{size}\K\\{timp}[\|l-\T{1}].\\{addr}$} }\6
\&{if} ${}(\|k\I\|j\V\|k\I\T{3}*\\{ternaries}){}$\1\5
\\{confusion}(\.{"ternaries"});\2\6
\&{while} (\|k)\5
${}\{{}$\1\6
${}\|k\MRL{-{\K}}\T{3};{}$\6
${}\\{ooo},\39\|u\K\\{tmem}[\|k].\\{spare},\39\|v\K\\{tmem}[\|k+\T{1}].%
\\{spare},\39\|w\K\\{tmem}[\|k+\T{2}].\\{spare};{}$\6
${}\|o,\39\\{la}\K\\{timp}[\\{bar}(\|u)].\\{addr},\39\\{ls}\K\\{timp}[\\{bar}(%
\|u)].\\{size},\39\\{uu}\K\\{la}+\\{ls};{}$\6
${}\|o,\39\\{timp}[\\{bar}(\|u)].\\{size}\K\\{ls}+\T{1};{}$\6
${}\|o,\39\\{tmem}[\\{uu}].\|u\K\|v,\39\\{tmem}[\\{uu}].\|v\K\|w;{}$\6
${}\|o,\39\\{la}\K\\{timp}[\\{bar}(\|v)].\\{addr},\39\\{ls}\K\\{timp}[\\{bar}(%
\|v)].\\{size},\39\\{vv}\K\\{la}+\\{ls};{}$\6
${}\|o,\39\\{tmem}[\\{uu}].\\{link}\K\\{vv};{}$\6
${}\|o,\39\\{timp}[\\{bar}(\|v)].\\{size}\K\\{ls}+\T{1};{}$\6
${}\|o,\39\\{tmem}[\\{vv}].\|u\K\|w,\39\\{tmem}[\\{vv}].\|v\K\|u;{}$\6
${}\|o,\39\\{la}\K\\{timp}[\\{bar}(\|w)].\\{addr},\39\\{ls}\K\\{timp}[\\{bar}(%
\|w)].\\{size},\39\\{ww}\K\\{la}+\\{ls};{}$\6
${}\|o,\39\\{tmem}[\\{vv}].\\{link}\K\\{ww};{}$\6
${}\|o,\39\\{timp}[\\{bar}(\|w)].\\{size}\K\\{ls}+\T{1};{}$\6
${}\|o,\39\\{tmem}[\\{ww}].\|u\K\|u,\39\\{tmem}[\\{ww}].\|v\K\|v;{}$\6
${}\|o,\39\\{tmem}[\\{ww}].\\{link}\K\\{uu};{}$\6
\4${}\}{}$\2\par
\U40.\fi

\M[1143 sat11.w]{46}\B\X46:Copy all the temporary variable nodes to the \PB{%
\\{vmem}} array in proper format\X${}\E{}$\6
\&{for} ${}(\|c\K\\{vars};{}$ \|c; ${}\|c\MM){}$\5
${}\{{}$\1\6
\X21:Move \PB{\\{cur\_tmp\_var}} backward to the previous temporary variable\X;%
\6
${}\|o,\39\\{vmem}[\|c].\\{name}.\\{lng}\K\\{cur\_tmp\_var}\MG\\{name}.%
\\{lng};{}$\6
${}\|o,\39\\{vmem}[\|c].\\{len}\K\\{vars}+\T{1}{}$;\C{ ``infinitely long''
prefix }\6
\4${}\}{}$\2\par
\U37.\fi

\M[1150 sat11.w]{47}We should now have unwound all the temporary data chunks
back to their
beginnings.

\Y\B\4\X47:Check consistency\X${}\E{}$\6
\&{if} ${}(\\{cur\_cell}\I{\AND}\\{cur\_chunk}\MG\\{cell}[\T{0}]\V\\{cur%
\_chunk}\MG\\{prev}\I\NULL\V\3{-1}\\{cur\_tmp\_var}\I{\AND}\\{cur\_vchunk}\MG%
\\{var}[\T{0}]\V\\{cur\_vchunk}\MG\\{prev}\I\NULL){}$\1\5
\\{confusion}(\.{"consistency"});\2\6
\\{free}(\\{cur\_chunk});\6
\&{for} ${}(\\{cur\_vchunk}\K\\{last\_vchunk};{}$ \\{cur\_vchunk}; ${}\\{cur%
\_vchunk}\K\\{last\_vchunk}){}$\5
${}\{{}$\1\6
${}\\{last\_vchunk}\K\\{cur\_vchunk}\MG\\{prev};{}$\6
\\{free}(\\{cur\_vchunk});\6
\4${}\}{}$\2\par
\U37.\fi

\N[1164 sat11.w]{1}{48}Buddy system redux. Here's a version of Algorithms 2.5R
and 2.5D that
is appropriate for the operations we need to do in \PB{\\{bimp}}.

Each block of \PB{\\{mem}} has size $2^k$ for some $k>1$, and it begins at
an address that is a multiple of~$2^k$. A reserved block begins with
an unsigned \PB{\&{int}} that is less than~$2^{31}$; a free block begins with
an unsigned \PB{\&{int}} that is $\ge2^{31}$ (thus its ``sign'' bit is 1).
In fact, the first two words of the free block starting at \PB{\|b} are
the complements of pointers in a doubly linked list, and we call them
\PB{\\{linkf}} and \PB{\\{linkb}}. The third word of such a block, called \PB{%
\\{kval}},
contains the value of~$k$ when the block size is~$2^k$; and the
``buddy'' of such a block~\PB{\|b} begins at location \PB{$\|b\XOR(\T{1}\LL%
\|k)$}.
There is a doubly linked list for free blocks of
each possible size~$2^k$, with header node \PB{\\{mem}[\\{avail}(\|k)]}.

When \PB{\\{mems}} are counted, we assume that \PB{\\{linkf}} and \PB{%
\\{linkb}} are
accessed simultaneously as part of the same octabyte.

We begin by allocating \PB{$\T{1}\LL\\{memk\_max}$} entries to the \PB{\\{mem}}
array.
But we maintain a variable \PB{\\{memk}} to record the fact that
at most \PB{$\T{1}\LL\\{memk}$} of those entries have been used so far.
The lists of available space are relevant only for \PB{$\T{1}<\|k<\\{memk}$},
and the statistics reported at the end of a run are calculated
as if only \PB{$\T{1}\LL\\{memk}$} entries had been allocated. The user should
increase \PB{\\{memk\_max}} (with the `\.m' command-line parameter) when trying
to
solve a problem that needs an unusually large \PB{\\{mem}}.

\Y\B\4\D$\\{linkf}(\|b)$ \5
\\{mem}[\|b]\par
\B\4\D$\\{linkb}(\|b)$ \5
$\\{mem}[(\|b)+\T{1}{}$]\par
\B\4\D$\\{kval}(\|b)$ \5
$\\{mem}[(\|b)+\T{2}{}$]\par
\B\4\D$\\{avail}(\|k)$ \5
$(((\|k)-\T{2})\LL\T{2}{}$)\par
\B\4\D$\\{memfree}(\|b)$ \5
((\&{int}) \\{mem}[\|b]${}<\T{0}{}$)\par
\B\4\D$\\{memk\_max\_default}$ \5
\T{22}\C{ allow 4 million items in \PB{\\{mem}} by default }\par
\Y\B\4\X3:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{memk};\C{ binary log of the number of spaces used so far in \PB{%
\\{mem}} }\par
\fi

\M[1201 sat11.w]{49}\B\X49:Check the sanity of \PB{\\{bimp}} and \PB{\\{mem}}%
\X${}\E{}$\6
\&{for} ${}(\|l\K\T{2};{}$ ${}\|l<\\{badlit};{}$ ${}\|l\PP){}$\5
${}\{{}$\1\6
${}\\{la}\K\\{bimp}[\|l].\\{addr},\39\|k\K\\{bimp}[\|l].\|k;{}$\6
\&{if} ${}(\\{la}\AND((\T{1}\LL\|k)-\T{1})){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"addr\ of\ bimp["}\|O\.{"d]\ is\ clobbered\
(0x}\)\.{"}\|O\.{"x,\ k="}\|O\.{"d)!\\n"},\39\|l,\39\\{la},\39\|k);{}$\2\6
\&{else} \&{if} ${}(\\{bimp}[\|l].\\{alloc}\I\T{1}\LL\|k){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"alloc\ of\ bimp["}\|O\.{"d]\ is\ clobbered\
("}\|O\.{"d,\ k="}\|O\.{"d)!\\n"},\39\|l,\39\\{bimp}[\|l].\\{alloc},\39\|k);{}$%
\2\6
\&{else} \&{if} ${}(\\{bimp}[\|l].\\{size}>\\{bimp}[\|l].\\{alloc}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"size\ of\ bimp["}\|O\.{"d]\ is\ clobbered\ ("}%
\|O\.{"d>"}\|O\.{"d)!\\n"},\39\|l,\39\\{bimp}[\|l].\\{size},\39\\{bimp}[\|l].%
\\{alloc});{}$\2\6
\&{else} \&{if} ${}(\\{la}\G\T{1}\LL\\{memk}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"addr\ of\ bimp["}\|O\.{"d]\ is\ out\ of\
bounds}\)\.{\ (0x"}\|O\.{"d>0x"}\|O\.{"d)!\\n"},\39\|l,\39\\{la},\39\T{1}\LL%
\\{memk});{}$\2\6
\&{else} \&{if} (\\{memfree}(\\{la}))\1\5
${}\\{fprintf}(\\{stderr},\39\.{"block\ 0x"}\|O\.{"x\ of\ bimp["}\|O\.{"d]\
isn't\ reserved!\\}\)\.{n"},\39\\{la},\39\|l);{}$\2\6
\&{else}\1\6
\&{for} ${}(\|j\K\\{bimp}[\|l].\\{size}-\T{1};{}$ ${}\|j\G\T{0};{}$ ${}\|j%
\MM){}$\1\6
\&{if} ${}(\\{mem}[\\{la}+\|j]<\T{2}\V\\{mem}[\\{la}+\|j]\G\\{badlit}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"literal\ "}\|O\.{"d\ in\ bimp["}\|O\.{"d]\ is\
out\ of\ bounds}\)\.{!\\n"},\39\\{mem}[\\{la}+\|j],\39\|l);{}$\2\2\2\6
\4${}\}{}$\2\6
\&{for} ${}(\|k\K\T{2};{}$ ${}\|k<\\{memk};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{for} ${}(\|p\K\CM\\{mem}[\\{avail}(\|k)];{}$  ; ${}\|p\K\CM\\{linkf}(%
\|p)){}$\5
${}\{{}$\1\6
\&{if} ${}((\|p\AND((\T{1}\LL\|k)-\T{1}))\W\|p\I\\{avail}(\|k)){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"link\ in\ avail("}\|O\.{"d)\ is\ clobbered\
(0x}\)\.{"}\|O\.{"x)!\\n"},\39\|k,\39\|p);{}$\2\6
\&{else} \&{if} ${}(\|p\G\T{1}\LL\\{memk}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"link\ in\ avail("}\|O\.{"d)\ is\ out\ of\
bounds}\)\.{\ (0x"}\|O\.{"d>0x"}\|O\.{"d)!\\n"},\39\|k,\39\|p,\39\T{1}\LL%
\\{memk});{}$\2\6
\&{else} \&{if} ${}(\\{kval}(\|p)\I\|k){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"kval\ of\ 0x"}\|O\.{"x\ in\ avail("}\|O\.{"d)\
is\ "}\|O\.{"d!\\n"},\39\|p,\39\|k,\39\\{kval}(\|p));{}$\2\6
\&{else} \&{if} ${}(\\{memfree}(\|p\XOR(\T{1}\LL\|k))\W\\{kval}(\|p\XOR(\T{1}%
\LL\|k))\E\|k){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"buddy\ of\ 0x"}\|O\.{"x\ in\ avail("}\|O\.{"d)%
\ is\ also\ in\ that\ }\)\.{list!\\n"},\39\|p,\39\|k);{}$\2\6
\&{else} \&{if} ${}(\CM\\{linkf}(\CM\\{linkb}(\|p))\I\|p){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"linking\ anomaly\ at\ }\)\.{0x"}\|O\.{"x\ in\
avail("}\|O\.{"d)!\\n"},\39\|p,\39\|k);{}$\2\6
\&{if} ${}(\CM\\{linkf}(\|p)\E\\{avail}(\|k)){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U31.\fi

\M[1244 sat11.w]{50}The \PB{\\{resize}} procedure does the main work of dynamic
storage allocation.
Given a literal~\PB{\|l}, it doubles the current allocation \PB{$\\{bimp}[\|l].%
\\{alloc}$}.

Two cases are distinguished, depending on whether the buddy of \PB{\|l}'s
current list is presently free or reserved. The buddy of a reserved block
of size~\PB{$\T{1}\LL\|k$} might have been split up into smaller blocks, but it
won't be any bigger.

\Y\B\4\X29:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{resize}(\&{register} \&{int} \|l)\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{uint} \|a${},{}$ \|j${},{}$ \|k${},{}$ \\{kk}${},{}$ \|n${},{}$
\|p${},{}$ \|q${},{}$ \|r${},{}$ \|s;\7
${}\\{mems}\MRL{+{\K}}\T{4}{}$;\C{ pay the cost of subroutine linkage }\6
${}\\{oo},\39\|a\K\\{bimp}[\|l].\\{addr},\39\|n\K\\{bimp}[\|l].\\{size},\39\|k%
\K\\{bimp}[\|l].\|k,\39\|s\K\T{1}\LL\|k,\39\|p\K\|a\XOR\|s;{}$\6
\&{if} ${}((\|o,\39\\{memfree}(\|p))\W(\|o,\39\\{kval}(\|p)\E\|k)){}$\1\5
\X51:Resize when the buddy is free\X\2\6
\&{else}\1\5
\X53:Resize when the buddy is reserved\X;\2\6
\4\\{finish}:\5
${}\|o,\39\\{bimp}[\|l].\\{alloc}\K\|s+\|s,\39\\{bimp}[\|l].\|k\K\|k+\T{1};{}$\6
\4${}\}{}$\2\par
\fi

\M[1262 sat11.w]{51}Here the buddy of block \PB{\|a} is \PB{\|p}, and it has
turned out to be free.
In the most favorable case, \PB{\|p} will actually be in exactly the right
place so
that we won't have to recopy any data.

\Y\B\4\X51:Resize when the buddy is free\X${}\E{}$\6
${}\{{}$\1\6
\X52:Remove \PB{\|p} from its \PB{\\{avail}} list\X;\6
\&{if} ${}((\|a\AND\|s)\E\T{0}){}$\1\5
\&{goto} \\{finish};\C{ we lucked out }\2\6
${}\\{oo},\39\\{mem}[\|p]\K\\{mem}[\|a]{}$;\C{ ensure that \PB{\\{mem}[\|p]}
isn't negative }\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j<\|n;{}$ ${}\|j\PP){}$\1\5
${}\\{oo},\39\\{mem}[\|p+\|j]\K\\{mem}[\|a+\|j]{}$;\C{ copy the rest of the
data }\2\6
${}\|o,\39\\{bimp}[\|l].\\{addr}\K\|p;{}$\6
\4${}\}{}$\2\par
\U50.\fi

\M[1275 sat11.w]{52}\B\X52:Remove \PB{\|p} from its \PB{\\{avail}} list\X${}%
\E{}$\6
$\|q\K\CM\\{linkb}(\|p),\39\|r\K\CM\\{linkf}(\|p){}$;\C{ no mem cost, we've
already accessed \PB{\\{mem}[\|p]} }\6
${}\\{oo},\39\\{linkf}(\|q)\K\CM\|r,\39\\{linkb}(\|r)\K\CM\|q{}$;\par
\Us51\ET54.\fi

\M[1279 sat11.w]{53}In the more difficult case, we must find a block of twice
the size,
and copy the data there; then we free up the present block.

\Y\B\4\X53:Resize when the buddy is reserved\X${}\E{}$\6
${}\{{}$\1\6
\X54:Allocate a block \PB{\|p} of size \PB{$\|s+\|s$}\X;\6
${}\\{oo},\39\\{mem}[\|p]\K\\{mem}[\|a]{}$;\C{ ensure that \PB{\\{mem}[\|p]}
isn't negative }\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j<\|n;{}$ ${}\|j\PP){}$\1\5
${}\\{oo},\39\\{mem}[\|p+\|j]\K\\{mem}[\|a+\|j]{}$;\C{ copy the rest of the
data }\2\6
\X56:Make \PB{\|a} a free block of size \PB{$\T{1}\LL\|k$}\X;\6
${}\|o,\39\\{bimp}[\|l].\\{addr}\K\|p;{}$\6
\4${}\}{}$\2\par
\U50.\fi

\M[1291 sat11.w]{54}\B\X54:Allocate a block \PB{\|p} of size \PB{$\|s+\|s$}%
\X${}\E{}$\6
\&{for} ${}(\\{kk}\K\|k+\T{1};{}$ ${}\\{kk}<\\{memk};{}$ ${}\\{kk}\PP){}$\1\6
\&{if} ${}(\|o,\39\\{linkf}(\\{avail}(\\{kk}))\I\CM\\{avail}(\\{kk})){}$\5
${}\{{}$\C{ nonempty list found }\1\6
${}\|p\K\CM\\{linkf}(\\{avail}(\\{kk}));{}$\6
\|o;\5
\X52:Remove \PB{\|p} from its \PB{\\{avail}} list\X;\6
\&{goto} \\{found};\6
\4${}\}{}$\2\2\6
\&{if} ${}(\\{memk}\E\\{memk\_max}){}$\5
${}\{{}$\C{ oops, we're outta room }\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Sorry...\ more\ memor}\)\.{y\ is\ needed!\
(Try\ op}\)\.{tion\ m"}\|O\.{"d.)\\n"},\39\\{memk\_max}+\T{1});{}$\6
${}\\{fprintf}(\\{stderr},\39\.{"Job\ aborted\ after\ "}\|O\.{"llu\ mems,\ "}%
\|O\.{"llu\ nodes.\\n"},\39\\{mems},\39\\{nodes});{}$\6
${}\\{exit}({-}\T{666});{}$\6
\4${}\}{}$\2\6
${}\|p\K\T{1}\LL\\{memk};{}$\6
${}\|o,\39\\{linkf}(\\{avail}(\\{memk}))\K\\{linkb}(\\{avail}(\\{memk}))\K\CM%
\\{avail}(\\{memk}){}$;\C{ empty \PB{\\{avail}} list }\6
${}\|o,\39\\{kval}(\\{avail}(\\{memk}))\K\\{memk};{}$\6
${}\\{bytes}\MRL{+{\K}}\|p*\&{sizeof}(\&{uint}),\39\\{memk}\PP;{}$\6
\4\\{found}:\C{ location \PB{\|p} begins an available block of size \PB{$\T{1}%
\LL\\{kk}$} }\6
\&{while} ${}(\MM\\{kk}>\|k){}$\1\5
\X55:Make \PB{$\|p+(\T{1}\LL\\{kk})$} a free block of size \PB{$\T{1}\LL%
\\{kk}$}\X;\2\par
\U53.\fi

\M[1311 sat11.w]{55}\B\X55:Make \PB{$\|p+(\T{1}\LL\\{kk})$} a free block of
size \PB{$\T{1}\LL\\{kk}$}\X${}\E{}$\6
${}\{{}$\1\6
${}\|o,\39\|q\K\CM\\{linkf}(\\{avail}(\\{kk})),\39\|r\K\|p+(\T{1}\LL\\{kk});{}$%
\6
${}\\{oo},\39\\{linkf}(\\{avail}(\\{kk}))\K\\{linkb}(\|q)\K\CM\|r;{}$\6
${}\\{oo},\39\\{linkb}(\|r)\K\CM\\{avail}(\\{kk}),\39\\{linkf}(\|r)\K\CM\|q,\39%
\\{kval}(\|r)\K\\{kk};{}$\6
\4${}\}{}$\2\par
\U54.\fi

\M[1318 sat11.w]{56}Since the buddy of \PB{\|a} is not free, we needn't try to
``collapse'' adjacent
buddies together.

\Y\B\4\X56:Make \PB{\|a} a free block of size \PB{$\T{1}\LL\|k$}\X${}\E{}$\6
$\|o,\39\|q\K\CM\\{linkf}(\\{avail}(\|k));{}$\6
${}\\{oo},\39\\{linkf}(\\{avail}(\|k))\K\\{linkb}(\|q)\K\CM\|a;{}$\6
${}\\{oo},\39\\{linkb}(\|a)\K\CM\\{avail}(\|k),\39\\{linkf}(\|a)\K\CM\|q,\39%
\\{kval}(\|a)\K\|k{}$;\par
\U53.\fi

\M[1326 sat11.w]{57}We need to get these data structures off to a good start at
the very
beginning. Here's how that is done, given \PB{\\{lits}} and \PB{\\{memk\_max}},
after the arrays \PB{\\{mem}} and \PB{\\{bimp}} have been allocated:

\Y\B\4\X57:Initialize \PB{\\{mem}} with empty \PB{\\{bimp}} lists\X${}\E{}$\6
\&{for} ${}(\\{memk}\K\T{4};{}$ ${}\T{1}\LL\\{memk}<\T{4}*(\\{memk\_max}-\T{2}+%
\\{lits});{}$ ${}\\{memk}\PP){}$\1\5
;\2\6
\&{if} ${}(\\{memk}>\\{memk\_max}){}$\5
${}\{{}$\C{ \PB{\\{memk\_max}} is too small even for empty lists! }\1\6
${}\\{fprintf}(\\{stderr},\39\.{"The\ value\ of\ memk\_m}\)\.{ax\ is\ way\ too\
small\ }\)\.{for\ "}\|O\.{"d\ literals!\\n"},\39\\{lits});{}$\6
${}\\{exit}({-}\T{667});{}$\6
\4${}\}{}$\2\6
${}\\{mem}\K{}$(\&{uint} ${}{*}){}$ \\{malloc}${}((\T{1}\LL\\{memk\_max})*%
\&{sizeof}(\&{uint}));{}$\6
\&{if} ${}(\R\\{mem}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ mem\
array!\\n}\)\.{"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\T{1}\LL\\{memk})*\&{sizeof}(\&{uint}){}$;\C{ we'll
update \PB{\\{bytes}} if we use more }\6
${}\|j\K\\{avail}(\\{memk\_max}){}$;\C{ the first \PB{\\{bimp}} list starts
here }\6
\&{for} ${}(\|l\K\T{2};{}$ ${}\|l<\\{badlit};{}$ ${}\|l\PP){}$\5
${}\{{}$\1\6
${}\\{oo},\39\\{mem}[\|j]\K\T{0},\39\\{bimp}[\|l].\\{addr}\K\|j,\39\\{bimp}[%
\|l].\\{size}\K\T{0},\39\|j\MRL{+{\K}}\T{4}{}$;\C{ reserve an empty block }\6
${}\|o,\39\\{bimp}[\|l].\\{alloc}\K\T{4},\39\\{bimp}[\|l].\|k\K\T{2}{}$;\C{
give it the minimum size }\6
\4${}\}{}$\2\6
\&{for} ${}(\|k\K\T{2};{}$ ${}\|k<\\{memk};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\|j\AND(\T{1}\LL\|k)){}$\5
${}\{{}$\C{ make a free block of size \PB{$\T{1}\LL\|k$} at \PB{\|j} }\1\6
${}\|o,\39\\{linkf}(\\{avail}(\|k))\K\\{linkb}(\\{avail}(\|k))\K\CM\|j;{}$\6
${}\|o,\39\\{linkf}(\|j)\K\\{linkb}(\|j)\K\CM\\{avail}(\|k);{}$\6
${}\\{oo},\39\\{kval}(\\{avail}(\|k))\K\\{kval}(\|j)\K\|k;{}$\6
${}\|j\MRL{+{\K}}\T{1}\LL\|k;{}$\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\C{ there are no free blocks of size \PB{$\T{1}\LL\|k$} initially }\1\6
${}\|o,\39\\{linkf}(\\{avail}(\|k))\K\\{linkb}(\\{avail}(\|k))\K\CM\\{avail}(%
\|k);{}$\6
${}\|o,\39\\{kval}(\\{avail}(\|k))\K\|k;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U38.\fi

\M[1360 sat11.w]{58}The \PB{\\{istack}} can grow rather large in the worst
case. But
it can't exceed the size of \PB{\\{mem}}, since each entry in \PB{\\{istack}}
represents
an increase in a \PB{\\{bimp}} table entry.
Therefore we allocate it with the same kludge that we used for \PB{\\{mem}}.

\Y\B\4\X58:Allocate special arrays\X${}\E{}$\6
$\\{istack}\K{}$(\&{idata} ${}{*}){}$ \\{malloc}${}((\T{1}\LL\\{memk\_max})*%
\&{sizeof}(\&{idata}));{}$\6
\&{if} ${}(\R\\{istack}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ istack\
array}\)\.{!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\T{1}\LL\\{memk})*\&{sizeof}(\&{idata}){}$;\C{ we'll
update \PB{\\{bytes}} if we use more }\6
${}\\{iptr\_max}\K\T{1}\LL\\{memk}{}$;\par
\As90, 92, 108, 120\ETs132.
\U37.\fi

\N[1374 sat11.w]{1}{59}Updating the data structures.
When we've decided to assign a value to a literal, we must deduce and record
all of the consequences of that decision. The following part of the
program comes into play when we're beginning the calculation at a new
node of the decision tree.

Sometimes \PB{\\{bestlit}} turns out to be zero, because the favorite literal
of
the lookahead process has already become true by forcing.
Then we have a ``dummy'' level, which does no branching and inaugurates a new
node from which we can look further ahead.

\Y\B\4\X59:Begin the processing of a new node\X${}\E{}$\6
$\\{nstack}[\\{level}].\\{lptr}\K\\{rptr},\39\\{nodes}\PP{}$;\C{ for
diagnostics only (no mem charged) }\6
\&{if} ${}(\\{delta}\W(\\{mems}\G\\{thresh})){}$\1\5
${}\\{thresh}\MRL{+{\K}}\\{delta},\39\\{print\_state}(\\{level});{}$\2\6
\&{if} ${}(\\{mems}>\\{timeout}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"TIMEOUT!\\n"});{}$\6
\&{goto} \\{done};\6
\4${}\}{}$\2\6
${}\|o,\39\\{nstack}[\\{level}].\\{branch}\K{-}\T{1},\39\\{plevel}\K%
\\{level};{}$\6
\X122:Look ahead and gather data about how to make the next branch; but \PB{%
\&{goto} \\{look\_bad}} if a contradiction arises\X;\6
\&{if} (\\{forcedlits})\1\5
\X64:Update data structures for all consequences of the forced literals
discovered during the lookahead; but \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\2\6
\4\\{chooseit}:\5
\X138:Choose \PB{\\{bestlit}}, which will be the next branch tried\X;\6
${}\|o,\39\\{nstack}[\\{level}].\\{rptr}\K\\{rptr},\39\\{nstack}[\\{level}].%
\\{iptr}\K\\{iptr}{}$;\C{ backup pointers }\6
\&{if} (\\{bestlit})\5
${}\{{}$\1\6
${}\|o,\39\\{nstack}[\\{level}].\\{decision}\K\\{bestlit},\39\\{nstack}[%
\\{level}].\\{branch}\K\T{0};{}$\6
\4\\{tryit}:\5
${}\|l\K\\{bestlit},\39\\{plevel}\K\\{level}+\T{1};{}$\6
\&{if} ${}((\\{verbose}\AND\\{show\_choices})\W\\{level}\Z\\{show\_choices%
\_max}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"Level\ "}\|O\.{"d"}\|O\.{"s:\ "}\|O\.{"s"}\|O%
\.{".8s\ ("}\|O\.{"lld\ mems)\\n"},\39\\{level},\39\\{nstack}[\\{level}].%
\\{branch}\?\.{"'"}:\.{""},\39\\{litname}(\|l),\39\\{mems});{}$\2\6
\X62:Update data structures for all consequences of \PB{\|l}; but \PB{\&{goto} %
\\{conflict}} if a contradiction arises\X;\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}((\\{verbose}\AND\\{show\_choices})\W\\{level}\Z\\{show%
\_choices\_max}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"Level\ "}\|O\.{"d:\ no\ branch\\n"},\39%
\\{level}){}$;\2\par
\U150.\fi

\M[1412 sat11.w]{60}Recall that the ``current stamp'' \PB{\\{cs}} is an even
number that represents
the level of truth for assignments that are currently being made.
Any variable \PB{\|x} with \PB{$\\{stamp}[\|x]<\\{cs}$} is assumed to be free
(unassigned);
otherwise \PB{\|x} is assumed to be true, in the context of level~\PB{\\{cs}},
when \PB{\\{stamp}[\|x]} is even, false when \PB{\\{stamp}[\|x]} is odd.

The highest level of truth is called \PB{\\{real\_truth}}; the next highest
is \PB{\\{near\_truth}}; the next highest is \PB{\\{proto\_truth}}; and lower
values
2, 4, \dots, \PB{$\\{proto\_truth}-\T{2}$} are used during lookahead.

\Y\B\4\D$\\{real\_truth}$ \5
\T{\^fffffffe}\par
\B\4\D$\\{near\_truth}$ \5
\T{\^fffffffc}\par
\B\4\D$\\{proto\_truth}$ \5
\T{\^fffffffa}\par
\B\4\D$\\{isfixed}(\|l)$ \5
$(\|o,\39\\{stamp}[\\{thevar}(\|l)]\G\\{cs}{}$)\par
\B\4\D$\\{isfree}(\|l)$ \5
$(\|o,\39\\{stamp}[\\{thevar}(\|l)]<\\{real\_truth}{}$)\par
\B\4\D$\\{iscontrary}(\|l)$ \5
$((\\{stamp}[\\{thevar}(\|l)]\XOR\|l)\AND\T{1}{}$)\C{ test this after \PB{%
\\{isfixed}(\|l)} }\par
\B\4\D$\\{stamptrue}(\|l)$ \5
$(\|o,\39\\{stamp}[\\{thevar}(\|l)]\K\\{cs}+(\|l\AND\T{1}){}$)\par
\Y\B\4\X3:Global variables\X${}\mathrel+\E{}$\6
\&{uint} \\{bestlit};\C{ literal chosen for branching by lookahead routines }\6
\&{uint} \\{cs};\C{ the current level of truth (always even) }\6
\&{uint} \\{look\_cs}${},{}$ \\{dlook\_cs};\C{ saved values of \PB{\\{cs}} }\6
\&{int} \\{fptr}${},{}$ \\{eptr}${},{}$ \\{lfptr};\C{ queue pointers for
breadth-first search }\par
\fi

\M[1436 sat11.w]{61}Here's a simple routine for use in debugging. It prints out
all literals that are true with respect to a given stamping level.

\Y\B\4\X29:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{print\_truths}(\&{uint} \\{cs})\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \|x;\7
\&{if} ${}(\\{cs}\G\\{proto\_truth}){}$\5
${}\{{}$\1\6
\&{switch} ${}((\\{cs}-\\{proto\_truth})\GG\T{1}){}$\5
${}\{{}$\1\6
\4\&{case} \T{0}:\5
${}\\{fprintf}(\\{stderr},\39\.{"proto\_truths\ or\ bet}\)\.{ter:"}){}$;\5
\&{break};\6
\4\&{case} \T{1}:\5
${}\\{fprintf}(\\{stderr},\39\.{"near\_truths\ or\ bett}\)\.{er:"}){}$;\5
\&{break};\6
\4\&{case} \T{2}:\5
${}\\{fprintf}(\\{stderr},\39\.{"real\_truths:"}){}$;\5
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\1\5
${}\\{fprintf}(\\{stderr},\39\.{"truths\ at\ least\ "}\|O\.{"d:"},\39%
\\{cs});{}$\2\6
\&{for} ${}(\|x\K\T{1};{}$ ${}\|x\Z\\{vars};{}$ ${}\|x\PP){}$\1\6
\&{if} ${}(\\{stamp}[\|x]\G\\{cs}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ "}\|O\.{"s"}\|O\.{".8s"},\39\\{stamp}[\|x]%
\AND\T{1}\?\.{"\~"}:\.{""},\39\\{vmem}[\|x].\\{name}.\\{ch8});{}$\2\2\6
${}\\{fprintf}(\\{stderr},\39\.{"\\n"});{}$\6
\4${}\}{}$\2\7
\&{void} \\{print\_proto\_truths}(\&{void})\1\1\2\2\6
${}\{{}$\1\6
\\{print\_truths}(\\{proto\_truth});\6
\4${}\}{}$\2\7
\&{void} \\{print\_near\_truths}(\&{void})\1\1\2\2\6
${}\{{}$\1\6
\\{print\_truths}(\\{near\_truth});\6
\4${}\}{}$\2\7
\&{void} \\{print\_real\_truths}(\&{void})\1\1\2\2\6
${}\{{}$\1\6
\\{print\_truths}(\\{real\_truth});\6
\4${}\}{}$\2\par
\fi

\M[1468 sat11.w]{62}In the present part of the program, we set \PB{$\\{cs}\K%
\\{near\_truth}$}. This
level means that the literal is on the \PB{\\{rstack}} but its full
consequences
haven't yet been explored.

We do a breadth-first search, using \PB{\\{rstack}} to contain the
literals that are being asserted---first at level \PB{\\{near\_truth}},
then at level \PB{\\{real\_truth}}. Pointers \PB{\\{fptr}} and \PB{\\{eptr}}
point to the front
and end of the queue that governs the search.

\Y\B\4\X62:Update data structures for all consequences of \PB{\|l}; but \PB{%
\&{goto} \\{conflict}} if a contradiction arises\X${}\E{}$\6
$\\{cs}\K\\{near\_truth};{}$\6
${}\\{fptr}\K\\{eptr}\K\\{rptr};{}$\6
\X65:Bump \PB{\\{istamp}} to a unique value\X;\6
\X68:Propagate binary implications of \PB{\|l}; \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\6
\4\\{promote}:\5
\X63:Promote near-truth to real-truth; but \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\6
\&{if} ${}(\|o,\39\\{nstack}[\\{level}].\\{branch}<\T{0}){}$\5
${}\{{}$\C{ we've finished the forced literals }\1\6
\&{if} (\\{level})\1\5
\&{goto} \\{chooseit};\2\6
${}\\{forcedlits}\K\T{0};{}$\6
\&{goto} \\{enter\_level};\C{ at the root, it's back to square zero }\6
\4${}\}{}$\2\par
\U59.\fi

\M[1492 sat11.w]{63}\B\X63:Promote near-truth to real-truth; but \PB{\&{goto} %
\\{conflict}} if a contradiction arises\X${}\E{}$\6
\&{while} ${}(\\{fptr}<\\{eptr}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{ll}\K\\{rstack}[\\{fptr}\PP];{}$\6
\X69:Update data structures for the real truth of \PB{\\{ll}}; but \PB{\&{goto}
\\{conflict}} if a contradiction arises\X;\6
\4${}\}{}$\2\6
${}\\{rptr}\K\\{eptr}{}$;\C{ accept all the propagations }\par
\U62.\fi

\M[1500 sat11.w]{64}The forced literals act as ``seeds'' for another
bread-first search.

If the input had unary clauses, the computation actually begins here,
so that the implications of those clauses are perceived early.

\Y\B\4\X64:Update data structures for all consequences of the forced literals
discovered during the lookahead; but \PB{\&{goto} \\{conflict}} if a
contradiction arises\X${}\E{}$\6
${}\{{}$\1\6
\4\\{special\_start}:\5
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"(lookahead\ for\ leve}\)\.{l\ "}\|O\.{"d\
forces\ "}\|O\.{"d)\\n"},\39\\{level},\39\\{forcedlits});{}$\2\6
${}\\{cs}\K\\{near\_truth};{}$\6
${}\\{fptr}\K\\{eptr}\K\\{rptr};{}$\6
\X65:Bump \PB{\\{istamp}} to a unique value\X;\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{forcedlits};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{forcedlit}[\|i];{}$\6
\X68:Propagate binary implications of \PB{\|l}; \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\6
\4${}\}{}$\2\6
\&{goto} \\{promote};\6
\4${}\}{}$\2\par
\U59.\fi

\M[1520 sat11.w]{65}The \PB{\\{istamp}} field of literal \PB{\|l} is marked
with the current value of the
global variable \PB{\\{istamp}} when
\PB{\|l} gets its first \PB{\\{istack}} entry during a particular phase of the
search;
then we can be sure that there's at most one \PB{\\{istack}} entry per literal
during any particular phase.

The loop here is ``never'' needed, except in problems that are well beyond
what I ever imagine trying to solve. But I'm including it anyway, because it
makes me feel virtuous.

\Y\B\4\X65:Bump \PB{\\{istamp}} to a unique value\X${}\E{}$\6
\&{if} ${}(\PP\\{istamp}\E\T{0}){}$\5
${}\{{}$\C{ overflow has occurred after $2^{32}$ times }\1\6
${}\\{istamp}\K\T{1};{}$\6
\&{for} ${}(\|l\K\T{2};{}$ ${}\|l<\\{badlit};{}$ ${}\|l\PP){}$\1\5
${}\|o,\39\\{lmem}[\|l].\\{istamp}\K\T{0};{}$\2\6
\4${}\}{}$\2\par
\Us62\ET64.\fi

\M[1536 sat11.w]{66}The \PB{\\{bstamp}} field of literal \PB{\|l} is similar to
\PB{\\{istamp}}, but it is used
for a different purpose: We mark it when \PB{\|l} is known to be implied
by some other literal of interest.

\Y\B\4\X66:Bump \PB{\\{bstamp}} to a unique value\X${}\E{}$\6
\&{if} ${}(\PP\\{bstamp}\E\T{0}){}$\5
${}\{{}$\C{ overflow has occurred after $2^{32}$ times }\1\6
${}\\{bstamp}\K\T{1};{}$\6
\&{for} ${}(\|l\K\T{2};{}$ ${}\|l<\\{badlit};{}$ ${}\|l\PP){}$\1\5
${}\|o,\39\\{lmem}[\|l].\\{bstamp}\K\T{0};{}$\2\6
\4${}\}{}$\2\par
\Us73\ET105.\fi

\M[1546 sat11.w]{67}\B\X3:Global variables\X${}\mathrel+\E{}$\6
\&{uint} \\{istamp};\C{ used for unique identifications }\6
\&{uint} \\{bstamp}${}\K\T{32}{}$;\C{ used for unique identifications of
another kind }\par
\fi

\M[1550 sat11.w]{68}The code in this section is part of the inner loop, so we
want it to be fast.
Fortunately the task is fairly simple: When one literal is asserted to be true
at the current \PB{\\{cs}} level, all the literals in its \PB{\\{bimp}} list
are also asserted. And we continue until no more can be asserted,
unless a contradiction arises first.

Our data structures contain both
binary implications and ternary implications. We examine only
the binary ones here, because they're simpler. By focusing on them first, we
have a better chance of detecting contradictions sooner.

\Y\B\4\X68:Propagate binary implications of \PB{\|l}; \PB{\&{goto} %
\\{conflict}} if a contradiction arises\X${}\E{}$\6
\&{if} (\\{isfixed}(\|l))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|l))\1\5
\&{goto} \\{conflict};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"nearfixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\|l));{}$\2\6
\\{stamptrue}(\|l);\6
${}\\{lfptr}\K\\{eptr};{}$\6
${}\|o,\39\\{rstack}[\\{eptr}\PP]\K\|l;{}$\6
\&{while} ${}(\\{lfptr}<\\{eptr}){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{rstack}[\\{lfptr}\PP];{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\|l].\\{addr},\39\\{ls}\K\\{bimp}[\|l].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lp}\K\\{mem}[\\{la}];{}$\6
\&{if} (\\{isfixed}(\\{lp}))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\\{lp}))\1\5
\&{goto} \\{conflict};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ nearfixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\\{lp}));{}$\2\6
\\{stamptrue}(\\{lp});\6
${}\|o,\39\\{rstack}[\\{eptr}\PP]\K\\{lp};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\Us62, 64, 72\ETs73.\fi

\M[1588 sat11.w]{69}We get to this part of the program when a literal loses its
freedom and
becomes fully assigned to truth or falsity at the highest possible level.

\Y\B\4\X69:Update data structures for the real truth of \PB{\\{ll}}; but \PB{%
\&{goto} \\{conflict}} if a contradiction arises\X${}\E{}$\6
$\|o,\39\\{stamp}[\\{thevar}(\\{ll})]\K\\{real\_truth}+(\\{ll}\AND\T{1});{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"fixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\\{ll}));{}$\2\6
\X70:Remove \PB{\\{thevar}(\\{ll})} from the \PB{\\{freevar}} list\X;\6
${}\\{tll}\K\\{ll}\AND{-}\T{2}{}$;\5
\X71:Swap out inactive ternaries implied by \PB{\\{tll}}\X;\6
${}\\{tll}\PP{}$;\5
\X71:Swap out inactive ternaries implied by \PB{\\{tll}}\X;\6
\&{for} ${}(\|o,\39\\{tla}\K\\{timp}[\\{ll}].\\{addr},\39\\{tls}\K\\{timp}[%
\\{ll}].\\{size};{}$ \\{tls}; ${}\\{tla}\PP,\39\\{tls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{tmem}[\\{tla}].\|u,\39\|v\K\\{tmem}[\\{tla}].\|v;{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ \ "}\|O\.{"s"}\|O\.{".8s->"}\|O\.{"s"}\|O%
\.{".8s|"}\|O\.{"s"}\|O\.{".8s\\n"},\39\\{litname}(\\{ll}),\39\\{litname}(\|u),%
\39\\{litname}(\|v));{}$\2\6
\X86:Record \PB{\\{thevar}(\|u)} and \PB{\\{thevar}(\|v)} as participants\X;\6
\X72:Update for a potentially new binary clause $u\lor v$\X;\6
\4${}\}{}$\2\par
\U63.\fi

\M[1608 sat11.w]{70}\B\X70:Remove \PB{\\{thevar}(\\{ll})} from the \PB{%
\\{freevar}} list\X${}\E{}$\6
$\|x\K\\{thevar}(\\{ll});{}$\6
${}\|o,\39\|y\K\\{freevar}[\MM\\{freevars}];{}$\6
\&{if} ${}(\|x\I\|y){}$\5
${}\{{}$\1\6
${}\|o,\39\\{xl}\K\\{freeloc}[\|x];{}$\6
${}\|o,\39\\{freevar}[\\{xl}]\K\|y;{}$\6
${}\|o,\39\\{freeloc}[\|y]\K\\{xl};{}$\6
${}\|o,\39\\{freeloc}[\|x]\K\\{freevars};{}$\6
${}\|o,\39\\{freevar}[\\{freevars}]\K\|x;{}$\6
\4${}\}{}$\2\par
\U69.\fi

\M[1619 sat11.w]{71}The pairs in \PB{\\{timp}} become inactive when any of
their variables
become ``really'' fixed (whether true or false). Here we run through all
active occurrences of \PB{\\{tll}} or its complement, moving them to the
inactive
parts of their \PB{\\{timp}} lists and putting active pairs in their place.

(Hint for decoding this code: If \PB{\|u} and \PB{\|v} are an active pair in %
\PB{\\{timp}[\\{tll}]},
then \PB{\|v} and \PB{\\{bar}(\\{tll})} are an active pair in \PB{\\{timp}[%
\\{bar}(\|u)]};
also \PB{\\{bar}(\\{tll})} and \PB{\|u} are an active pair in \PB{\\{timp}[%
\\{bar}(\|v)]}.)

When \PB{\\{tll}} becomes fixed, we do not, however, make the pairs in
\PB{\\{timp}[\\{tll}]} and \PB{\\{timp}[\\{bar}(\\{tll})]} inactive. We keep
those lists
intact, because we won't be referring to them again until
it's time to undo the operations of the present step.

Subtle point: Inactive \PB{\\{timp}} entries for positive literals are swapped
out
before the inactive \PB{\\{timp}} entries for negative literals. This tends to
increase the likelihood that swapping won't be needed on subsequent branches.

\Y\B\4\X71:Swap out inactive ternaries implied by \PB{\\{tll}}\X${}\E{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{timp}[\\{tll}].\\{addr},\39\\{ls}\K\\{timp}[%
\\{tll}].\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{tmem}[\\{la}].\|u,\39\|v\K\\{tmem}[\\{la}].\|v;{}$\6
${}\|o,\39\\{pu}\K\\{tmem}[\\{la}].\\{link}{}$;\C{ pointer to a pair in \PB{%
\\{timp}[\\{bar}(\|u)]} }\6
${}\|o,\39\\{pv}\K\\{tmem}[\\{pu}].\\{link}{}$;\C{ pointer to a pair in \PB{%
\\{timp}[\\{bar}(\|v)]} }\6
${}\|o,\39\\{aa}\K\\{timp}[\\{bar}(\|u)].\\{addr},\39\\{ss}\K\\{timp}[\\{bar}(%
\|u)].\\{size}-\T{1};{}$\6
${}\|o,\39\\{timp}[\\{bar}(\|u)].\\{size}\K\\{ss};{}$\6
\&{if} ${}(\\{pu}\I\\{aa}+\\{ss}){}$\5
${}\{{}$\C{ need to swap }\1\6
${}\|o,\39\\{uu}\K\\{tmem}[\\{aa}+\\{ss}].\|u,\39\\{vv}\K\\{tmem}[\\{aa}+%
\\{ss}].\|v;{}$\6
${}\\{oo},\39\|q\K\\{tmem}[\\{aa}+\\{ss}].\\{link},\39\\{qq}\K\\{tmem}[\|q].%
\\{link}{}$;\C{ \PB{\\{qq}} links to \PB{$\\{aa}+\\{ss}$} }\6
${}\\{oo},\39\\{tmem}[\\{qq}].\\{link}\K\\{pu},\39\\{tmem}[\\{la}].\\{link}\K%
\\{aa}+\\{ss};{}$\6
${}\\{oo},\39\\{tmem}[\\{pu}].\|u\K\\{uu},\39\\{tmem}[\\{pu}].\|v\K\\{vv},\39%
\\{tmem}[\\{pu}].\\{link}\K\|q;{}$\6
${}\\{pu}\K\\{aa}+\\{ss};{}$\6
${}\\{oo},\39\\{tmem}[\\{pu}].\|u\K\|v,\39\\{tmem}[\\{pu}].\|v\K\\{bar}(%
\\{tll}),\39\\{tmem}[\\{pu}].\\{link}\K\\{pv};{}$\6
\4${}\}{}$\2\6
${}\|o,\39\\{aa}\K\\{timp}[\\{bar}(\|v)].\\{addr},\39\\{ss}\K\\{timp}[\\{bar}(%
\|v)].\\{size}-\T{1};{}$\6
${}\|o,\39\\{timp}[\\{bar}(\|v)].\\{size}\K\\{ss};{}$\6
\&{if} ${}(\\{pv}\I\\{aa}+\\{ss}){}$\5
${}\{{}$\C{ need to swap }\1\6
${}\|o,\39\\{uu}\K\\{tmem}[\\{aa}+\\{ss}].\|u,\39\\{vv}\K\\{tmem}[\\{aa}+%
\\{ss}].\|v;{}$\6
${}\\{oo},\39\|q\K\\{tmem}[\\{aa}+\\{ss}].\\{link},\39\\{qq}\K\\{tmem}[\|q].%
\\{link}{}$;\C{ \PB{\\{qq}} links to \PB{$\\{aa}+\\{ss}$} }\6
${}\\{oo},\39\\{tmem}[\\{qq}].\\{link}\K\\{pv},\39\\{tmem}[\\{pu}].\\{link}\K%
\\{aa}+\\{ss};{}$\6
${}\\{oo},\39\\{tmem}[\\{pv}].\|u\K\\{uu},\39\\{tmem}[\\{pv}].\|v\K\\{vv},\39%
\\{tmem}[\\{pv}].\\{link}\K\|q;{}$\6
${}\\{pv}\K\\{aa}+\\{ss};{}$\6
${}\\{oo},\39\\{tmem}[\\{pv}].\|u\K\\{bar}(\\{tll}),\39\\{tmem}[\\{pv}].\|v\K%
\|u,\39\\{tmem}[\\{pv}].\\{link}\K\\{la};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U69.\fi

\M[1664 sat11.w]{72}When a ternary clause reduces to the binary clause $u\lor
v$,
the ``real'' truth status of \PB{\|u} and \PB{\|v} is not yet known; but they
might be ``nearly'' true or false. (In the latter case, we'll be
setting them really true or false as we continue our
breadth-first search in the queue on the \PB{\\{rstack}}.) There are
five possibilities:
\smallskip
\item{$\bullet$}
If either \PB{\|u} or \PB{\|v} is near-true, the binary clause is satisfied
and we needn't do anything.
\smallskip
\item{$\bullet$}
If both \PB{\|u} and \PB{\|v} are near-false, we've reached a contradiction.
\smallskip
\item{$\bullet$}
If \PB{\|u} is near-false but \PB{\|v} is unknown, we can make \PB{\|v}
near-true.
\smallskip
\item{$\bullet$}
If \PB{\|u} is unknown but \PB{\|v} is near-false, we can make \PB{\|u}
near-true.
\smallskip
\item{$\bullet$}
Otherwise \PB{\|u} and \PB{\|v} are both unknown, and we've deduced the clause
$u\lor v$.

\Y\B\4\X72:Update for a potentially new binary clause $u\lor v$\X${}\E{}$\6
\&{if} (\\{isfixed}(\|u))\5
${}\{{}$\C{ equivalently, \PB{\&{if} ${}(\|o,\\{stamp}[\\{thevar}(\|u)]\G%
\\{near\_truth})$} }\1\6
\&{if} (\\{iscontrary}(\|u))\5
${}\{{}$\C{ \PB{\|u} is stamped false }\1\6
\&{if} (\\{isfixed}(\|v))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|v))\1\5
\&{goto} \\{conflict};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|v} is unknown }\1\6
${}\|l\K\|v;{}$\6
\X68:Propagate binary implications of \PB{\|l}; \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|u} is unknown }\1\6
\&{if} (\\{isfixed}(\|v))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|v))\5
${}\{{}$\1\6
${}\|l\K\|u;{}$\6
\X68:Propagate binary implications of \PB{\|l}; \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\1\5
\X73:Update for a new binary clause $u\lor v$\X;\2\6
\4${}\}{}$\2\par
\U69.\fi

\M[1707 sat11.w]{73}Now we've made some definite progress, by deducing a
``new'' binary
clause $u\lor v$, and we hope to capitalize on it. Three
opportunities, not mutually exclusive, may present themselves at this point:
\smallskip
\item{$\bullet$}
If $\bar u\lor v$ is already in our \PB{\\{bimp}} table, we can make \PB{\|v}
near-true.
\smallskip
\item{$\bullet$}
If $u\lor\bar v$ is already in our \PB{\\{bimp}} table, we can make \PB{\|u}
near-true.
\smallskip
\item{$\bullet$}
If $u\lor v$ is not already in our \PB{\\{bimp}} table, we can insert it.
\smallskip\noindent
Furthermore, we might also know the clause $\bar v\lor w$, say, in which case
the binary clause $u\lor w$ is also true. Experience shows that such
``compensation resolvents'' are useful, so we add them to our \PB{\\{bimp}}
collection.

This is the part of the program where we use \PB{\\{bstamp}} to mark everything
that's presently implied by $\bar u$. And then we use it to mark everything
that's presently implied by $\bar v$.

An attentive reader will notice that, if $\bar u\lor v$ and $u\lor\bar v$
are both already in \PB{\\{bimp}}, we'll make $u$ near-true and the propagation
routine will take care of~$v$.

\Y\B\4\X73:Update for a new binary clause $u\lor v$\X${}\E{}$\6
${}\{{}$\1\6
\X66:Bump \PB{\\{bstamp}} to a unique value\X;\6
${}\|o,\39\\{lmem}[\\{bar}(\|u)].\\{bstamp}\K\\{bstamp};{}$\6
\&{for} ${}(\|o,\39\\{au}\K\\{bimp}[\\{bar}(\|u)].\\{addr},\39\|k\K\\{su}\K%
\\{bimp}[\\{bar}(\|u)].\\{size};{}$ \|k; ${}\\{au}\PP,\39\|k\MM){}$\1\5
${}\\{oo},\39\\{lmem}[\\{mem}[\\{au}]].\\{bstamp}\K\\{bstamp};{}$\2\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|v)].\\{bstamp}\E\\{bstamp}){}$\5
${}\{{}$\C{ we already have $u\lor\bar v$ }\1\6
\4\\{fix\_u}:\5
${}\|l\K\|u{}$;\5
\X68:Propagate binary implications of \PB{\|l}; \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\|o,\39\\{lmem}[\|v].\\{bstamp}\I\\{bstamp}){}$\5
${}\{{}$\C{ we don't have $u\lor v$ }\1\6
${}\|o,\39\\{ua}\K\\{bimp}[\\{bar}(\|u)].\\{alloc};{}$\6
\X74:Make sure that \PB{\\{bar}(\|u)} has an \PB{\\{istack}} entry\X;\6
\X76:Add compensation resolvents from \PB{\\{bar}(\|u)}; but \PB{\&{goto} %
\\{fix\_u}} if \PB{\|u} is forced true\X;\6
\X66:Bump \PB{\\{bstamp}} to a unique value\X;\6
${}\|o,\39\\{lmem}[\\{bar}(\|v)].\\{bstamp}\K\\{bstamp};{}$\6
\&{for} ${}(\|o,\39\\{av}\K\\{bimp}[\\{bar}(\|v)].\\{addr},\39\|k\K\\{sv}\K%
\\{bimp}[\\{bar}(\|v)].\\{size};{}$ \|k; ${}\\{av}\PP,\39\|k\MM){}$\1\5
${}\\{oo},\39\\{lmem}[\\{mem}[\\{av}]].\\{bstamp}\K\\{bstamp};{}$\2\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|u)].\\{bstamp}\E\\{bstamp}){}$\5
${}\{{}$\C{ we already have $\bar u\lor v$ }\1\6
\4\\{fix\_v}:\5
${}\|l\K\|v{}$;\5
\X68:Propagate binary implications of \PB{\|l}; \PB{\&{goto} \\{conflict}} if a
contradiction arises\X;\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
${}\|o,\39\\{va}\K\\{bimp}[\\{bar}(\|v)].\\{alloc};{}$\6
\X77:Make sure that \PB{\\{bar}(\|v)} has an \PB{\\{istack}} entry\X;\6
\X79:Add compensation resolvents from \PB{\\{bar}(\|v)}; but \PB{\&{goto} %
\\{fix\_v}} if \PB{\|v} is forced true\X;\6
\&{if} ${}(\\{su}\E\\{ua}){}$\1\5
${}\\{resize}(\\{bar}(\|u)),\39\\{ua}\MRL{+{\K}}\\{ua},\39\|o,\39\\{au}\K%
\\{bimp}[\\{bar}(\|u)].\\{addr}+\\{su};{}$\2\6
${}\\{oo},\39\\{mem}[\\{au}]\K\|v,\39\\{bimp}[\\{bar}(\|u)].\\{size}\K\\{su}+%
\T{1}{}$;\C{ $\bar u$ implies $v$ }\6
\&{if} ${}(\\{sv}\E\\{va}){}$\1\5
${}\\{resize}(\\{bar}(\|v)),\39\\{va}\MRL{+{\K}}\\{va},\39\|o,\39\\{av}\K%
\\{bimp}[\\{bar}(\|v)].\\{addr}+\\{sv};{}$\2\6
${}\\{oo},\39\\{mem}[\\{av}]\K\|u,\39\\{bimp}[\\{bar}(\|v)].\\{size}\K\\{sv}+%
\T{1}{}$;\C{ $\bar v$ implies $u$ }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U72.\fi

\M[1765 sat11.w]{74}At this point \PB{$\\{su}\K\\{bimp}[\\{bar}(\|u)].%
\\{size}$}.

\Y\B\4\X74:Make sure that \PB{\\{bar}(\|u)} has an \PB{\\{istack}} entry\X${}%
\E{}$\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|u)].\\{istamp}\I\\{istamp}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lmem}[\\{bar}(\|u)].\\{istamp}\K\\{istamp};{}$\6
${}\|o,\39\\{istack}[\\{iptr}].\\{lit}\K\\{bar}(\|u),\39\\{istack}[\\{iptr}].%
\\{size}\K\\{su};{}$\6
\X75:Increase \PB{\\{iptr}}\X;\6
\4${}\}{}$\2\par
\Us73, 127\ETs135.\fi

\M[1774 sat11.w]{75}\B\X75:Increase \PB{\\{iptr}}\X${}\E{}$\6
$\\{iptr}\PP;{}$\6
\&{if} ${}(\\{iptr}\E\\{iptr\_max}){}$\5
${}\{{}$\1\6
${}\\{bytes}\MRL{+{\K}}\\{iptr}*\&{sizeof}(\&{idata});{}$\6
${}\\{iptr\_max}\MRL{{\LL}{\K}}\T{1};{}$\6
\4${}\}{}$\2\par
\Us74, 77, 78\ETs136.\fi

\M[1781 sat11.w]{76}At this point all implications of \PB{\\{bar}(\|u)} are
stamped with \PB{\\{bstamp}},
including \PB{\\{bar}(\|u)} itself. And since $u\lor v$ is true, we know that
$v$ is also implied by \PB{\\{bar}(\|u)}. Therefore any literal~$w$ implied
by~$v$
is a potentially new consequence of \PB{\\{bar}(\|u)}, called a ``compensation
resolvent.'' (It can be obtained by resolving $u\lor v$ with $\bar v\lor w$.)
Notice that $w$ cannot be near-false; otherwise the propagation routine
would have made $v$ near-false, since $v\to w$ implies $\bar w\to\bar v$.

We maintain the values \PB{$\\{au}\K\\{bimp}[\\{bar}(\|u)].\\{addr}+\\{su}$},
\PB{$\\{su}\K\\{bimp}[\\{bar}(\|u)].\\{size}$}, \PB{$\\{ua}\K\\{bimp}[\\{bar}(%
\|u)].\\{alloc}$}.

\Y\B\4\X76:Add compensation resolvents from \PB{\\{bar}(\|u)}; but \PB{\&{goto}
\\{fix\_u}} if \PB{\|u} is forced true\X${}\E{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\|v].\\{addr},\39\\{ls}\K\\{bimp}[\|v].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|w\K\\{mem}[\\{la}];{}$\6
\&{if} ${}(\R\\{isfixed}(\|w)){}$\5
${}\{{}$\1\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|w)].\\{bstamp}\E\\{bstamp}){}$\1\5
\&{goto} \\{fix\_u};\C{ $\bar u$ implies $w$ and $\bar w$ }\2\6
\&{if} ${}(\|o,\39\\{lmem}[\|w].\\{bstamp}\I\\{bstamp}){}$\5
${}\{{}$\C{ $u\lor w$ is new }\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ \ \ ->"}\|O\.{"s"}\|O\.{".8s|"}\|O\.{"s"}\|O%
\.{".8s\\n"},\39\\{litname}(\|u),\39\\{litname}(\|w));{}$\2\6
\&{if} ${}(\\{su}\E\\{ua}){}$\1\5
${}\\{resize}(\\{bar}(\|u)),\39\\{ua}\MRL{+{\K}}\\{ua},\39\|o,\39\\{au}\K%
\\{bimp}[\\{bar}(\|u)].\\{addr}+\\{su};{}$\2\6
${}\\{oo},\39\\{mem}[\\{au}\PP]\K\|w,\39\\{bimp}[\\{bar}(\|u)].\\{size}\K\PP%
\\{su}{}$;\C{ $\bar u$ implies $w$ }\6
${}\|o,\39\\{aw}\K\\{bimp}[\\{bar}(\|w)].\\{addr},\39\\{sw}\K\\{bimp}[\\{bar}(%
\|w)].\\{size};{}$\6
\X78:Make sure that \PB{\\{bar}(\|w)} has an \PB{\\{istack}} entry\X;\6
\&{if} ${}(\|o,\39\\{sw}\E\\{bimp}[\\{bar}(\|w)].\\{alloc}){}$\1\5
${}\\{resize}(\\{bar}(\|w)),\39\|o,\39\\{aw}\K\\{bimp}[\\{bar}(\|w)].%
\\{addr};{}$\2\6
${}\|o,\39\\{bimp}[\\{bar}(\|w)].\\{size}\K\\{sw}+\T{1};{}$\6
${}\|o,\39\\{mem}[\\{aw}+\\{sw}]\K\|u{}$;\C{ $\bar w$ implies $u$ }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U73.\fi

\M[1813 sat11.w]{77}At this point \PB{$\\{sv}\K\\{bimp}[\\{bar}(\|v)].%
\\{size}$}; we do for \PB{\|v} as we did for \PB{\|u}.

\Y\B\4\X77:Make sure that \PB{\\{bar}(\|v)} has an \PB{\\{istack}} entry\X${}%
\E{}$\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|v)].\\{istamp}\I\\{istamp}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lmem}[\\{bar}(\|v)].\\{istamp}\K\\{istamp};{}$\6
${}\|o,\39\\{istack}[\\{iptr}].\\{lit}\K\\{bar}(\|v),\39\\{istack}[\\{iptr}].%
\\{size}\K\\{sv};{}$\6
\X75:Increase \PB{\\{iptr}}\X;\6
\4${}\}{}$\2\par
\U73.\fi

\M[1822 sat11.w]{78}Here \PB{$\\{sw}\K\\{bimp}[\\{bar}(\|w)].\\{size}$}.

\Y\B\4\X78:Make sure that \PB{\\{bar}(\|w)} has an \PB{\\{istack}} entry\X${}%
\E{}$\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|w)].\\{istamp}\I\\{istamp}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lmem}[\\{bar}(\|w)].\\{istamp}\K\\{istamp};{}$\6
${}\|o,\39\\{istack}[\\{iptr}].\\{lit}\K\\{bar}(\|w),\39\\{istack}[\\{iptr}].%
\\{size}\K\\{sw};{}$\6
\X75:Increase \PB{\\{iptr}}\X;\6
\4${}\}{}$\2\par
\Us76\ET79.\fi

\M[1831 sat11.w]{79}This is the kind of program that cannot be written well
when loud music
is playing.

\Y\B\4\X79:Add compensation resolvents from \PB{\\{bar}(\|v)}; but \PB{\&{goto}
\\{fix\_v}} if \PB{\|v} is forced true\X${}\E{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\|u].\\{addr},\39\\{ls}\K\\{bimp}[\|u].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|w\K\\{mem}[\\{la}];{}$\6
\&{if} ${}(\R\\{isfixed}(\|w)){}$\5
${}\{{}$\1\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|w)].\\{bstamp}\E\\{bstamp}){}$\1\5
\&{goto} \\{fix\_v};\C{ $\bar v$ implies $w$ and $\bar w$ }\2\6
\&{if} ${}(\|o,\39\\{lmem}[\|w].\\{bstamp}\I\\{bstamp}){}$\5
${}\{{}$\C{ $v\lor w$ is new }\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ \ \ ->"}\|O\.{"s"}\|O\.{".8s|"}\|O\.{"s"}\|O%
\.{".8s\\n"},\39\\{litname}(\|v),\39\\{litname}(\|w));{}$\2\6
\&{if} ${}(\\{sv}\E\\{va}){}$\1\5
${}\\{resize}(\\{bar}(\|v)),\39\\{va}\MRL{+{\K}}\\{va},\39\|o,\39\\{av}\K%
\\{bimp}[\\{bar}(\|v)].\\{addr}+\\{sv};{}$\2\6
${}\\{oo},\39\\{mem}[\\{av}\PP]\K\|w,\39\\{bimp}[\\{bar}(\|v)].\\{size}\K\PP%
\\{sv}{}$;\C{ $\bar v$ implies $w$ }\6
${}\|o,\39\\{aw}\K\\{bimp}[\\{bar}(\|w)].\\{addr},\39\\{sw}\K\\{bimp}[\\{bar}(%
\|w)].\\{size};{}$\6
\X78:Make sure that \PB{\\{bar}(\|w)} has an \PB{\\{istack}} entry\X;\6
\&{if} ${}(\|o,\39\\{sw}\E\\{bimp}[\\{bar}(\|w)].\\{alloc}){}$\1\5
${}\\{resize}(\\{bar}(\|w)),\39\|o,\39\\{aw}\K\\{bimp}[\\{bar}(\|w)].%
\\{addr};{}$\2\6
${}\|o,\39\\{bimp}[\\{bar}(\|w)].\\{size}\K\\{sw}+\T{1};{}$\6
${}\|o,\39\\{mem}[\\{aw}+\\{sw}]\K\|v{}$;\C{ $\bar w$ implies $v$ }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U73.\fi

\N[1855 sat11.w]{1}{80}Downdating the data structures. When a contradiction
arises, backtracking
becomes necessary: Everything that went up must come down.

Fortunately the task of undoing isn't too tough.
The \PB{\\{istack}} contains all the information needed to discard any binary
implications that no longer hold; and the \PB{\\{rstack}} records every literal
that has been made nearly or really true.

Let's look at the \PB{\\{istack}} entries first, because they're so easy.
The code almost writes itself.

\Y\B\4\X80:Discard binary implications at the current level\X${}\E{}$\6
\&{if} ${}(\|o,\39\\{nstack}[\\{level}].\\{branch}\G\T{0}){}$\5
${}\{{}$\1\6
\&{for} ${}(\|o,\39\|j\K\\{nstack}[\\{level}].\\{iptr};{}$ ${}\\{iptr}>\|j;{}$
${}\\{iptr}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{istack}[\\{iptr}-\T{1}].\\{lit},\39\\{sl}\K\\{istack}[%
\\{iptr}-\T{1}].\\{size};{}$\6
${}\|o,\39\\{bimp}[\|l].\\{size}\K\\{sl};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U84.\fi

\M[1874 sat11.w]{81}The \PB{\\{rstack}} entries come in two parts, one easy and
the other
a bit tricky. The literals on \PB{\\{rstack}[\|j]} for
\PB{$\\{fptr}\Z\|j<\\{eptr}$} are the nice guys; they've become nearly true,
but we haven't
updated any serious consequences of that near-truth. Thus we merely need to
unset those tentative assignments.

\Y\B\4\X81:Unset the nearly true literals\X${}\E{}$\6
\&{for} ${}(\|j\K\\{fptr};{}$ ${}\|j<\\{eptr};{}$ ${}\|j\PP){}$\1\5
${}\\{oo},\39\\{stamp}[\\{thevar}(\\{rstack}[\|j])]\K\T{0}{}$;\2\par
\U84.\fi

\M[1883 sat11.w]{82}The literals on \PB{\\{rstack}[\|j]} for \PB{$\\{rptr}\Z%
\|j<\\{fptr}$} have become really true,
and the ripple effects of those settings require more attention.
Of principal importance is the fact that the ternary clauses in which
those literals or their complements appear have become inactive,
and they've been swapped to the ``invisible'' part of the relevant
\PB{\\{timp}} lists.

There's good news here: We don't need to unswap any of the \PB{\\{timp}}
entries while
we're backtracking! The order of those entries isn't important; only
the state, active versus inactive, matters. The active entries are
those that appear among the first \PB{\\{size}} entries, beginning at \PB{%
\\{addr}}.
The inactive ones follow, in precisely the order in which they were
swapped out, because a pair never participates in swaps after it
has become inactive. Therefore we can reactivate the most-recently-swapped-out
item in any particular list by simply increasing \PB{\\{size}} by~1.

Two or three literals of the same clause may have all become really
true or really false. The hocus pocus in the preceding paragraph works
correctly only if we are careful to do the virtual unswapping in
precisely the reverse order from which we've done the swapping.

Similar reasoning applies to the list of free variables. When a literal
left that list, we moved it from wherever it was in the early
part of that list, by swapping it with the last currently free item, and
then we decreased \PB{\\{freevars}} by~1. To undo this operation, we simply
increase \PB{\\{freevars}} by~1. (The ordering isn't actually as critical here;
it would suffice to change \PB{\\{freevars}} once and for all by setting it to
the value it had at the beginning of the node. But any savings in
running time would be negligible.)

\Y\B\4\X82:Unset the really true literals\X${}\E{}$\6
\&{for} ${}(\|j\K\\{fptr}-\T{1};{}$ ${}\|j\G\\{rptr};{}$ ${}\|j\MM){}$\5
${}\{{}$\C{ decreasing order is important }\1\6
${}\|o,\39\\{ll}\K\\{rstack}[\|j];{}$\6
${}\\{tll}\K\\{ll}\OR\T{1}{}$;\5
\X83:Reactivate the inactive ternaries implied by \PB{\\{tll}}\X;\6
${}\\{tll}\MM{}$;\5
\X83:Reactivate the inactive ternaries implied by \PB{\\{tll}}\X;\6
${}\\{freevars}\PP;{}$\6
${}\|o,\39\\{stamp}[\\{thevar}(\\{ll})]\K\T{0};{}$\6
\4${}\}{}$\2\par
\U84.\fi

\M[1922 sat11.w]{83}\B\X83:Reactivate the inactive ternaries implied by \PB{%
\\{tll}}\X${}\E{}$\6
\&{for} ${}(\|o,\39\\{ls}\K\\{timp}[\\{tll}].\\{size},\39\\{la}\K\\{timp}[%
\\{tll}].\\{addr}+\\{ls}-\T{1};{}$ \\{ls}; ${}\\{ls}\MM,\39\\{la}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{tmem}[\\{la}].\|u,\39\|v\K\\{tmem}[\\{la}].\|v;{}$\6
${}\\{oo},\39\\{timp}[\\{bar}(\|u)].\\{size}\PP;{}$\6
${}\\{oo},\39\\{timp}[\\{bar}(\|v)].\\{size}\PP;{}$\6
\4${}\}{}$\2\par
\U82.\fi

\M[1929 sat11.w]{84}\B\X84:Recover from conflicts\X${}\E{}$\6
\4\\{dl\_contra}:\5
\X146:Recover from a double lookahead contradiction\X;\6
\4\\{contra}:\5
\X129:Recover from a lookahead contradiction\X;\6
\&{goto} \\{look\_bad};\C{ a conflict has arisen during lookahead }\6
\4\\{conflict}:\5
\X81:Unset the nearly true literals\X;\6
\4\\{backtrack}:\5
\X82:Unset the really true literals\X;\6
\X80:Discard binary implications at the current level\X;\6
\&{if} ${}(\|o,\39\\{nstack}[\\{level}].\\{branch}\E\T{0}){}$\1\5
\X85:Move to branch 1\X;\2\6
\4\\{look\_bad}:\5
\&{if} (\\{level})\5
${}\{{}$\1\6
${}\\{level}\MM;{}$\6
\&{if} ${}(\\{level}<\T{31}){}$\1\5
${}\\{prefix}\MRL{\AND{\K}}{-}(\T{1}\LL(\T{31}-\\{level})){}$;\C{ see below }\2%
\6
${}\\{fptr}\K\\{rptr};{}$\6
${}\|o,\39\\{rptr}\K\\{nstack}[\\{level}].\\{rptr};{}$\6
\&{goto} \\{backtrack};\6
\4${}\}{}$\2\6
\4\\{unsat}:\5
\&{if} (\T{1})\5
${}\{{}$\1\6
\\{printf}(\.{"\~\\n"});\C{ the formula was unsatisfiable }\6
\&{if} ${}(\\{verbose}\AND\\{show\_basics}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"UNSAT\\n"});{}$\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\4\\{satisfied}:\5
\&{if} ${}(\\{verbose}\AND\\{show\_basics}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"!SAT!\\n"});{}$\2\6
\X151:Print the solution found\X;\6
\4${}\}{}$\2\par
\U150.\fi

\M[1952 sat11.w]{85}A binary string is implicitly associated with every node of
the search tree:
At level~0, before we've done any branching at all, the string is empty.
Branch~0 of every node appends 0 to the parent string, and branch~1 appends~1.
The length of the string is therefore \PB{\\{level}}. We also maintain the
first 32 bits of the current string in the global variable \PB{\\{prefix}},
left-justified within a 32-bit word. (This prefix is used to help guide
locality of search, by identifying ``participants''
as explained in the preselection algorithm below.)

\Y\B\4\X85:Move to branch 1\X${}\E{}$\6
${}\{{}$\1\6
${}\\{bestlit}\K\\{bar}(\\{nstack}[\\{level}].\\{decision});{}$\6
${}\|o,\39\\{nstack}[\\{level}].\\{decision}\K\\{bestlit},\39\\{nstack}[%
\\{level}].\\{branch}\K\T{1};{}$\6
\&{if} ${}(\\{level}<\T{32}){}$\1\5
${}\\{prefix}\MRL{+{\K}}\T{1}\LL(\T{31}-\\{level});{}$\2\6
\&{goto} \\{tryit};\C{ if at first you don't succeed, try the other branch }\6
\4${}\}{}$\2\par
\U84.\fi

\M[1969 sat11.w]{86}A variable $x$ is said to ``participate'' at a branch node
if it
occurs in one of the nonbinary clauses that is produced in that node or in
one of that node's ancestors. If $x$ has already become a participant, the
string specified by \PB{$\\{vmem}[\|x].\\{pfx}$} and \PB{$\\{vmem}[\|x].%
\\{len}$} will be a
prefix of the current string.

In this step we update the \PB{\\{pfx}} and \PB{\\{lev}} fields of variables
that
are participating in the current activity. Notice that this
information does not need to be changed when backtracking.

(At levels above 31 this program accepts cousins as well as ancestors.)

\Y\B\4\X86:Record \PB{\\{thevar}(\|u)} and \PB{\\{thevar}(\|v)} as participants%
\X${}\E{}$\6
$\|x\K\\{thevar}(\|u);{}$\6
${}\|o,\39\|p\K\\{vmem}[\|x].\\{pfx},\39\|q\K\\{vmem}[\|x].\\{len};{}$\6
\&{if} ${}(\|q<\\{plevel}){}$\5
${}\{{}$\1\6
${}\|t\K\\{prefix};{}$\6
\&{if} ${}(\|q<\T{32}){}$\1\5
${}\|t\MRL{\AND{\K}}{-}(\T{1\$L\$L}\LL(\T{32}-\|q)){}$;\C{ zero out irrelevant
bits }\2\6
\&{if} ${}(\|p\I\|t){}$\1\5
${}\|o,\39\\{vmem}[\|x].\\{pfx}\K\\{prefix},\39\\{vmem}[\|x].\\{len}\K%
\\{plevel};{}$\2\6
\4${}\}{}$\5
\2\&{else}\1\5
${}\|o,\39\\{vmem}[\|x].\\{pfx}\K\\{prefix},\39\\{vmem}[\|x].\\{len}\K%
\\{plevel};{}$\2\6
${}\|x\K\\{thevar}(\|v);{}$\6
${}\|o,\39\|p\K\\{vmem}[\|x].\\{pfx},\39\|q\K\\{vmem}[\|x].\\{len};{}$\6
\&{if} ${}(\|q<\\{plevel}){}$\5
${}\{{}$\1\6
${}\|t\K\\{prefix};{}$\6
\&{if} ${}(\|q<\T{32}){}$\1\5
${}\|t\MRL{\AND{\K}}{-}(\T{1\$L\$L}\LL(\T{32}-\|q)){}$;\C{ zero out irrelevant
bits }\2\6
\&{if} ${}(\|p\I\|t){}$\1\5
${}\|o,\39\\{vmem}[\|x].\\{pfx}\K\\{prefix},\39\\{vmem}[\|x].\\{len}\K%
\\{plevel};{}$\2\6
\4${}\}{}$\5
\2\&{else}\1\5
${}\|o,\39\\{vmem}[\|x].\\{pfx}\K\\{prefix},\39\\{vmem}[\|x].\\{len}\K%
\\{plevel}{}$;\2\par
\U69.\fi

\N[1997 sat11.w]{1}{87}Preselection. The main purpose of lookahead is to choose
the best
free variable on which to branch. Of course we have limited foreknowledge,
so we must make guesses. And we don't have time to explore {\it every\/}
variable that remains free, except in trivial ways, unless
we're near the root of the search tree.

So we begin the lookahead task by identifying a set of candidate
variables that appear to be the most promising among all those that
are currently free. That's called {\it preselection}.

\Y\B\4\X87:Do the prelookahead\X${}\E{}$\6
\&{if} ${}(\\{freevars}\E\T{0}){}$\1\5
\&{goto} \\{satisfied};\2\6
\X96:Preselect a set of candidate variables for lookahead\X;\6
\X103:Determine the strong components; \PB{\&{goto} \\{look\_bad}} if there's a
contradiction\X;\6
\X116:Construct a suitable forest\X;\par
\U122.\fi

\M[2013 sat11.w]{88}The candidates are collected and identified in an array %
\PB{\\{cand}}, whose
entries have two fields, \PB{\\{var}} and \PB{\\{rating}}.

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{cdata\_struct} ${}\{{}$\1\6
\&{uint} \\{var};\C{ the variable that's a candidate }\6
\&{float} \\{rating};\C{ its estimated importance }\2\6
${}\}{}$ \&{cdata};\par
\fi

\M[2022 sat11.w]{89}\B\X3:Global variables\X${}\mathrel+\E{}$\6
\&{cdata} ${}{*}\\{cand}{}$;\C{ list of candidates for lookahead }\6
\&{int} \\{cands};\C{ the number of candidates in \PB{\\{cand}} }\6
\&{float} \\{sum};\C{ accumulator for computing the ratings }\6
\&{int} \\{no\_newbies};\C{ are candidates restricted to participants? }\6
\&{float} ${}{*}\\{rating}{}$;\C{ estimates of how useful each variable will be
for branching }\6
\&{uint} \\{prefix};\C{ first 32 bits of the current prefix string }\6
\&{int} \\{plevel};\C{ length of the current prefix string }\6
\&{int} \\{maxcand};\C{ the maximum number of candidates desired at the current
node }\par
\fi

\M[2032 sat11.w]{90}\B\X58:Allocate special arrays\X${}\mathrel+\E{}$\6
$\\{cand}\K{}$(\&{cdata} ${}{*}){}$ \\{malloc}${}(\\{vars}*\&{sizeof}(%
\&{cdata}));{}$\6
\&{if} ${}(\R\\{cand}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ cand\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{vars}*\&{sizeof}(\&{cdata});{}$\6
${}\\{rating}\K{}$(\&{float} ${}{*}){}$ \\{malloc}${}((\\{vars}+\T{1})*%
\&{sizeof}(\&{float}));{}$\6
\&{if} ${}(\R\\{rating}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ rating\
array}\)\.{!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}(\\{vars}+\T{1})*\&{sizeof}(\&{float}){}$;\par
\fi

\M[2046 sat11.w]{91}The first stage of preselection {\it does\/} examine all
the free
variables, in order to get enough data to choose the candidates.
Thus it constitutes one of the inner loops for which we
hope to do everything rapidly. The general idea is to compute a
heuristic score $h(l)$ for each free literal $l$, which estimates
the relative amount by which asserting $l$ will reduce the current
problem.

Suppose there are $n$ free variables. Then there are $2n$ free literals,
and $2n$ scores $h(l)$ to compute. Experiments have shown that we tend
to get good estimates if these scores approximately satisfy the
nonlinear equations
$$h(l)=0.1+\alpha\sum_{l\to l'}\hat h(l')+
\sum_{l\to l'\lor l''}\hat h(l')\,\hat h(l''),$$
where $\alpha$ is a magic constant and where $\hat h(l)$ is a
multiple of~$h(l)$ such that $\sum_l\hat h(l)=2n$. (In other
words, we ``normalize'' the $h$'s so that the average score is~1.)
The default value $\alpha=3.3$ is recommended, but of course other
magic values can be tried by using the command-line parameter~`\.a'
to change~$\alpha$.

Given a set of $h(l)$ scores, we can get a refined set $h'(l)$ by
computing
$$h'(l)=0.1+\alpha\sum_{l\to l'}{h(l')\over\overline h}+
\sum_{l\to l'\lor l''}{h(l')\over\overline h}\,{h(l'')\over\overline h},
\qquad \overline h={1\over2n}\sum_l h(l).$$
At the root of the tree, we start with $h(l)=1$ for all $l$ and
then refine it several times. At deeper levels, we start with
the $h(l)$ values from the parent node and refine them (once).

A large array \PB{\\{hmem}} holds all these values for the first \PB{\\{hlevel%
\_max}} levels
of the search tree. When \PB{$\\{level}\G\\{hlevel\_max}$}, we revert to
the most recent information that was saved. Inaccurate scores are
obviously most troublesome near the root, so we prefer expediency to
accuracy when \PB{\\{level}} gets large. If the problem has $n$ variables,
the score $h(l)$ for level $j$ is stored in \PB{$\\{hmem}[\T{2}*\|n*\|j+\|l-%
\T{2}]$}.

\Y\B\4\X3:Global variables\X${}\mathrel+\E{}$\6
\&{float} ${}{*}\\{hmem}{}$;\C{ heuristic scores on the first levels of the
search tree }\6
\&{int} \\{hmem\_alloc\_level};\C{ how much of \PB{\\{hmem}} have we gotten
into? }\6
\&{float} ${}{*}\\{heur}{}$;\C{ the currently relevant block within \PB{%
\\{hmem}} }\par
\fi

\M[2088 sat11.w]{92}\B\X58:Allocate special arrays\X${}\mathrel+\E{}$\6
$\\{hmem}\K{}$(\&{float} ${}{*}){}$ \\{malloc}${}(\\{lits}*(\\{hlevel\_max}+%
\T{1})*\&{sizeof}(\&{float}));{}$\6
\&{if} ${}(\R\\{hmem}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ hmem\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{hmem\_alloc\_level}\K\T{2};{}$\6
${}\\{bytes}\MRL{+{\K}}\\{lits}*\T{3}*\&{sizeof}(\&{float});{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{lits};{}$ ${}\|k\PP){}$\1\5
${}\|o,\39\\{hmem}[\|k]\K\T{1.0}{}$;\2\par
\fi

\M[2098 sat11.w]{93}The subroutine \PB{\\{hscores}} converts $h$ values to $h'$
values according
to the equation above. It also makes sure that $h'(l)$ doesn't
exceed \PB{\\{max\_score}} (which is 25.0 by default). Furthermore, it computes
\PB{$\\{rating}[\\{thevar}(\|l)]\K\\{hp}(\|l)*\\{hp}(\\{bar}(\|l))$}, a number
that will be used to select
the final list of candidates.

\Y\B\4\D$\\{htable}(\\{lev})$ \5
${\AND}\\{hmem}[(\\{lev})*{}$(\&{int}) \\{lits}${}-\T{2}{}$]\par
\Y\B\4\X29:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{hscores}(\&{float} ${}{*}\|h,\39{}$\&{float} ${}{*}\\{hp}){}$\1\1\2%
\2\6
${}\{{}$\1\6
\&{register} \&{int} \|j${},{}$ \|l${},{}$ \\{la}${},{}$ \\{ls}${},{}$ %
\|u${},{}$ \|v;\6
\&{register} \&{float} \\{sum}${},{}$ \\{tsum}${},{}$ \\{factor}${},{}$ %
\\{sqfactor}${},{}$ \\{afactor}${},{}$ \\{pos}${},{}$ \\{neg};\7
\&{for} ${}(\\{sum}\K\T{0.0},\39\|j\K\T{0};{}$ ${}\|j<\\{freevars};{}$ ${}\|j%
\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{poslit}(\\{freevar}[\|j]);{}$\6
${}\|o,\39\\{sum}\MRL{+{\K}}\|h[\|l]+\|h[\\{bar}(\|l)];{}$\6
\4${}\}{}$\2\6
${}\\{factor}\K\T{2.0}*\\{freevars}/\\{sum};{}$\6
${}\\{sqfactor}\K\\{factor}*\\{factor};{}$\6
${}\\{afactor}\K\\{alpha}*\\{factor};{}$\6
\&{for} ${}(\|j\K\T{0};{}$ ${}\|j<\\{freevars};{}$ ${}\|j\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{poslit}(\\{freevar}[\|j]);{}$\6
\X94:Compute \PB{\\{sum}}, the score of \PB{\|l}\X;\6
${}\\{pos}\K\\{sum},\39\|l\PP;{}$\6
\X94:Compute \PB{\\{sum}}, the score of \PB{\|l}\X;\6
${}\\{neg}\K\\{sum};{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_scores}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"("}\|O\.{".8s:\ pos\ "}\|O\.{".2f\ neg\ "}\|O%
\.{".2f\ r="}\|O\.{".4g)\\n"},\39\\{vmem}[\|l\GG\T{1}].\\{name}.\\{ch8},\39%
\\{pos},\39\\{neg},\39(\\{pos}<\\{max\_score}\?\\{pos}:\\{max\_score})*(%
\\{neg}<\\{max\_score}\?\\{neg}:\\{max\_score}));{}$\2\6
\&{if} ${}(\\{pos}>\\{max\_score}){}$\1\5
${}\\{pos}\K\\{max\_score};{}$\2\6
\&{if} ${}(\\{neg}>\\{max\_score}){}$\1\5
${}\\{neg}\K\\{max\_score};{}$\2\6
${}\|o,\39\\{hp}[\|l-\T{1}]\K\\{pos},\39\\{hp}[\|l]\K\\{neg};{}$\6
${}\|o,\39\\{rating}[\\{thevar}(\|l)]\K\\{pos}*\\{neg};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M[2134 sat11.w]{94}\B\X94:Compute \PB{\\{sum}}, the score of \PB{\|l}\X${}%
\E{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\|l].\\{addr},\39\\{ls}\K\\{bimp}[\|l].%
\\{size},\39\\{sum}\K\T{0.0};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{mem}[\\{la}];{}$\6
\&{if} (\\{isfree}(\|u))\1\5
${}\|o,\39\\{sum}\MRL{+{\K}}\|h[\|u];{}$\2\6
\4${}\}{}$\2\6
\&{for} ${}(\|o,\39\\{la}\K\\{timp}[\|l].\\{addr},\39\\{ls}\K\\{timp}[\|l].%
\\{size},\39\\{tsum}\K\T{0.0};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{tmem}[\\{la}].\|u,\39\|v\K\\{tmem}[\\{la}].\|v;{}$\6
${}\\{oo},\39\\{tsum}\MRL{+{\K}}\|h[\|u]*\|h[\|v];{}$\6
\4${}\}{}$\2\6
${}\\{sum}\K\T{0.1}+\\{sum}*\\{afactor}+\\{tsum}*\\{sqfactor}{}$;\par
\U93.\fi

\M[2145 sat11.w]{95}Here we compute the relevant scores, and set the global
variable \PB{\\{heur}}
to point within \PB{\\{hmem}} in such a way that \PB{\\{heur}[\|l]} will be the
appropriate $h(l)$ for the lookahead we're about to do.

\Y\B\4\X95:Put the scores in \PB{\\{heur}}\X${}\E{}$\6
\&{if} ${}(\\{level}\Z\T{1}){}$\5
${}\{{}$\1\6
${}\\{hscores}(\\{htable}(\T{0}),\39\\{htable}(\T{1})){}$;\C{ refine the all-1
heuristic }\6
${}\\{hscores}(\\{htable}(\T{1}),\39\\{htable}(\T{2})){}$;\C{ and refine that
one }\6
${}\\{hscores}(\\{htable}(\T{2}),\39\\{htable}(\T{1})){}$;\C{ and refine that
one }\6
${}\\{hscores}(\\{htable}(\T{1}),\39\\{htable}(\T{2})){}$;\C{ and refine that
one }\6
${}\\{hscores}(\\{htable}(\T{2}),\39\\{htable}(\T{1})){}$;\C{ and refine that
one }\6
${}\\{heur}\K\\{htable}(\T{1}){}$;\C{ use the fifth refinement }\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\\{level}<\\{hlevel\_max}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{level}>\\{hmem\_alloc\_level}){}$\1\5
${}\\{hmem\_alloc\_level}\PP,\39\\{bytes}\MRL{+{\K}}\\{lits}*\&{sizeof}(%
\&{float});{}$\2\6
${}\\{hscores}(\\{htable}(\\{level}-\T{1}),\39\\{htable}(\\{level})){}$;\C{
refine the parent's heuristic }\6
${}\\{heur}\K\\{htable}(\\{level}){}$;\C{ and use it }\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{hlevel\_max}>\\{hmem\_alloc\_level}){}$\1\5
${}\\{hmem\_alloc\_level}\PP,\39\\{bytes}\MRL{+{\K}}\\{lits}*\&{sizeof}(%
\&{float});{}$\2\6
${}\\{hscores}(\\{htable}(\\{hlevel\_max}-\T{1}),\39\\{htable}(\\{hlevel%
\_max})){}$;\C{ refine ancestral heuristic }\6
${}\\{heur}\K\\{htable}(\\{hlevel\_max}){}$;\C{ and use it }\6
\4${}\}{}$\2\par
\U96.\fi

\M[2168 sat11.w]{96}The maximum number of candidates permitted, in this
implementation,
depends on the current level rather than on the number of variables
or clauses in the problem: We calculate \PB{\\{maxcand}} = the maximum
of \PB{$\\{levelcand}/\\{level}$} and \PB{\\{mincutoff}}, where \PB{$%
\\{levelcand}\K\T{600}$} and
\PB{$\\{mincutoff}\K\T{30}$} by default. (At level~0, for example, \PB{%
\\{maxcand}} is
infinite; at level~5 it is~120; at levels 20 or more it is~30.)
Then, while \PB{$\\{cands}\G\T{2}*\\{maxcand}$}, we repeatedly remove all
candidates whose
rating is less than the mean; quite a few really weak candidates might
therefore go away if a few strong ones dominate. Finally, if
\PB{$\\{maxcand}<\\{cands}<\T{2}*\\{maxcand}$}, we eliminate the \PB{$%
\\{cands}-\\{maxcand}$}
candidates with smallest ratings.

That policy might seem peculiar, but it reflects the reality of
combinatorial search problems: If the problem is easy, we don't
care if we solve it in 2 seconds or .00002 seconds. On the other hand
if the problem is so difficult that it can only be solved
by looking ahead more than we can accomplish in a reasonable time,
we might as well face the fact that we won't solve it anyway.
(There's no point in looking ahead at 60 variables at depth 60,
because we won't be able to deal with more than $2^{50}$ or so
nodes in any reasonable search tree.)

\Y\B\4\X96:Preselect a set of candidate variables for lookahead\X${}\E{}$\6
\X95:Put the scores in \PB{\\{heur}}\X;\6
${}\\{maxcand}\K(\\{level}\E\T{0}\?\\{freevars}:\\{levelcand}/\\{level});{}$\6
\&{if} ${}(\\{maxcand}<\\{mincutoff}){}$\1\5
${}\\{maxcand}\K\\{mincutoff};{}$\2\6
\X97:Put all free participants into the initial list of candidates\X;\6
\X100:Pare down the candidates to at most \PB{\\{maxcand}}\X;\par
\U87.\fi

\M[2197 sat11.w]{97}The next stage in this winnowing-down process tries to
avoid any variable
that hasn't participated in a ternary clause that has been reduced;
otherwise we might find ourselves trying to solve several independent
problems at the same time. In order to weed out ``newbies'' (nonparticipants),
we allow \PB{\|x} to be a candidate only if \PB{$\\{vmem}[\|x].\\{pfx}$} and %
\PB{$\\{vmem}[\|x].\\{len}$}
specify a string that's a prefix of the current node's string.
(However, we rescind this restriction if it gives us no candidates. For
example, at level~0 there are no participants, because we haven't reduced any
clauses.)

If the \.V option is being used, to distinguish ``primary'' variables,
we consider a nonprimary variable to be a nonparticipant (so that it
will not normally become a candidate).

\Y\B\4\X97:Put all free participants into the initial list of candidates\X${}%
\E{}$\6
$\\{no\_newbies}\K(\\{plevel}>\T{0});{}$\6
\4\\{init\_cand}:\5
\&{for} ${}(\\{cands}\K\|k\K\T{0},\39\\{sum}\K\T{0.0};{}$ ${}\|k<%
\\{freevars};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|x\K\\{freevar}[\|k];{}$\6
${}\|o,\39\\{stamp}[\|x]\K\T{0}{}$;\C{ erase all former assignments }\6
\&{if} (\\{no\_newbies})\5
${}\{{}$\1\6
\&{if} ${}(\|x>\\{primary\_vars}){}$\1\5
\&{continue};\2\6
${}\|o,\39\|t\K\\{vmem}[\|x].\\{pfx},\39\|l\K\\{vmem}[\|x].\\{len};{}$\6
\&{if} ${}(\|l\E\\{plevel}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|t\I\\{prefix}){}$\1\5
\&{continue};\C{ not a participant }\2\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\|l>\\{plevel}){}$\1\5
\&{continue};\2\6
\&{else} \&{if} ${}(\|t\I(\|l<\T{32}\?\\{prefix}\AND{-}(\&{uint})(\T{1\$L\$L}%
\LL(\T{32}-\|l)):\\{prefix})){}$\1\5
\&{continue};\2\6
\4${}\}{}$\2\6
${}\\{oo},\39\\{cand}[\\{cands}].\\{var}\K\|x,\39\\{cand}[\\{cands}].\\{rating}%
\K\\{rating}[\|x];{}$\6
${}\\{cands}\PP,\39\\{sum}\MRL{+{\K}}\\{rating}[\|x];{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cands}\E\T{0}){}$\5
${}\{{}$\1\6
\X98:If all clauses are satisfied, \PB{\&{goto} \\{satisfied}}\X;\6
${}\\{no\_newbies}\K\T{0};{}$\6
\&{goto} \\{init\_cand};\C{ if there are no participants, accept all comers }\6
\4${}\}{}$\2\par
\U96.\fi

\M[2233 sat11.w]{98}\B\X98:If all clauses are satisfied, \PB{\&{goto} %
\\{satisfied}}\X${}\E{}$\6
\&{for} ${}(\|j\K\T{0};{}$ ${}\|j<\\{freevars};{}$ ${}\|j\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|x\K\\{freevar}[\|j];{}$\6
${}\|l\K\\{poslit}(\|x);{}$\6
\X99:If \PB{\|l} implies any unsatisfied clauses, \PB{\&{goto} \\{nogood}}\X;\6
${}\|l\PP;{}$\6
\X99:If \PB{\|l} implies any unsatisfied clauses, \PB{\&{goto} \\{nogood}}\X;\6
\4${}\}{}$\2\6
\&{goto} \\{satisfied};\6
\4\\{nogood}:\par
\U97.\fi

\M[2244 sat11.w]{99}\B\X99:If \PB{\|l} implies any unsatisfied clauses, \PB{%
\&{goto} \\{nogood}}\X${}\E{}$\6
\&{if} ${}(\|o,\39\\{timp}[\|l].\\{size}){}$\1\5
\&{goto} \\{nogood};\C{ all active timps are unsatisfied }\2\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\|l].\\{addr},\39\\{ls}\K\\{bimp}[\|l].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{mem}[\\{la}];{}$\6
\&{if} ${}(\|o,\39\\{stamp}[\\{thevar}(\|u)]\I\\{real\_truth}+(\|u\AND%
\T{1})){}$\1\5
\&{goto} \\{nogood};\2\6
\4${}\}{}$\2\par
\U98.\fi

\M[2251 sat11.w]{100}At this point we've got \PB{\\{cands}} candidates in the %
\PB{\\{cand}} array,
and \PB{\\{sum}} is the sum of their ratings. The next task is to eliminate
low-rated candidates, if we have too many to handle.

\Y\B\4\X100:Pare down the candidates to at most \PB{\\{maxcand}}\X${}\E{}$\6
\&{for} ${}(\|k\K\T{1};{}$ ${}\\{cands}\G\T{2}*\\{maxcand}\W\|k;{}$ \,)\5
${}\{{}$\1\6
\&{register} \&{float} \\{mean}${}\K\T{0.9999}*\\{sum}/{}$(\&{double}) %
\\{cands};\7
\&{for} ${}(\|j\K\|k\K\T{0},\39\\{sum}\K\T{0.0};{}$ ${}\|j<\\{cands};{}$ \,)\5
${}\{{}$\1\6
\&{if} ${}(\|o,\39\\{cand}[\|j].\\{rating}\G\\{mean}){}$\1\5
${}\\{sum}\MRL{+{\K}}\\{cand}[\|j].\\{rating},\39\|j\PP;{}$\2\6
\&{else}\1\5
${}\\{oo},\39\|k\K\T{1},\39\\{cand}[\|j]\K\\{cand}[\MM\\{cands}]{}$;\C{ don't
advance \PB{\|j}, discard a loser }\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{cands}>\\{maxcand}){}$\1\5
\X101:Select the \PB{\\{maxcand}} best-rated candidates\X;\2\6
\&{if} ${}(\\{cands}\E\T{0}){}$\1\5
\\{confusion}(\.{"cands"});\2\par
\U96.\fi

\M[2266 sat11.w]{101}Here we make the \PB{\\{cand}} array into a heap, with
low-rated elements
in the lowest positions. Then we delete the ones we don't want.
(See Algorithm 5.2.3H. The heap condition is
$$\hbox{\PB{$\\{cand}[\|i].\\{rating}\Z\\{cand}[\T{2}*\|i+\T{1}].\\{rating}$}%
\qquad
and\qquad \PB{$\\{cand}[\|i].\\{rating}\Z\\{cand}[\T{2}*\|i+\T{2}].%
\\{rating}$}}$$
whenever the subscripts are nonnegative and less than~\PB{\\{cands}}.)

\Y\B\4\X101:Select the \PB{\\{maxcand}} best-rated candidates\X${}\E{}$\6
${}\{{}$\1\6
${}\|j\K\\{cands}\GG\T{1}{}$;\C{ the heap condition holds for \PB{$\|i\G\|j$} }%
\6
\&{while} ${}(\|j>\T{0}){}$\5
${}\{{}$\1\6
${}\|j\MM;{}$\6
\X102:Sift \PB{\\{cand}[\|j]} up\X;\6
\4${}\}{}$\2\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\\{oo},\39\\{cand}[\T{0}]\K\\{cand}[\MM\\{cands}]{}$;\C{ discard a loser }\6
\&{if} ${}(\\{cands}\E\\{maxcand}){}$\1\5
\&{break};\2\6
\X102:Sift \PB{\\{cand}[\|j]} up\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U100.\fi

\M[2287 sat11.w]{102}\B\X102:Sift \PB{\\{cand}[\|j]} up\X${}\E{}$\6
${}\{{}$\1\6
\&{register} \&{float} \|r;\6
\&{cdata} \|c;\7
${}\|o,\39\|c\K\\{cand}[\|j],\39\|r\K\|c.\\{rating};{}$\6
\&{for} ${}(\|i\K\|j,\39\\{jj}\K(\|j\LL\T{1})+\T{1};{}$ ${}\\{jj}<\\{cands};{}$
${}\|i\K\\{jj},\39\\{jj}\K(\\{jj}\LL\T{1})+\T{1}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{jj}+\T{1}<\\{cands}\W(\|o,\39\\{cand}[\\{jj}+\T{1}].\\{rating}<%
\\{cand}[\\{jj}].\\{rating})){}$\1\5
${}\\{jj}\PP;{}$\2\6
\&{if} ${}(\|o,\39\|r\Z\\{cand}[\\{jj}].\\{rating}){}$\1\5
\&{break};\2\6
${}\|o,\39\\{cand}[\|i]\K\\{cand}[\\{jj}];{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\|i>\|j){}$\1\5
${}\|o,\39\\{cand}[\|i]\K\|c;{}$\2\6
\4${}\}{}$\2\par
\U101.\fi

\N[2300 sat11.w]{1}{103}Strong components. If the binary implication graph has
a nontrivial
strong component, all literals in that component are locked together:
Any one of their values determines all the rest. Therefore we don't want
to bother looking ahead on two variables that have literals in the
same strong component.

Robert Tarjan has devised a beautiful algorithm that finds the strong
components very efficiently [{\sl SIAM Journal on Computing\/ \bf1} (1972),
146--160]; and his algorithm also produces a topological sort on the
representatives of those components, as an extra bonus. We are going to want
the preselected candidates to be topologically sorted, because that will speed
up the lookaheads that we'll be doing. Therefore Tarjan's algorithm
is a perfect fit for our present situation.

Note: We are going to restrict ourselves to direct implications between
candidates, instead of considering indirect chains of implications
$l_0\to l_1\to \cdots\to l_k$ with $k>1$,
where $l_0$ and $l_k$ are candidates but the intermediate literals
$l_1$, \dots,~$l_{k-1}$ are not. The efficiency of Tarjan's algorithm
suggests that we could consider the full digraph instead of its
restriction to candidates only, perhaps before deciding on the
list of candidates. However, cases in which indirect implications provide
significant information appear to be rare. (At least, the author has yet
to see a single instance where two chosen candidates, in the most
time-consuming parts of a search tree, are implicitly linked without
also being explicitly linked.) It seems that the variables chosen to
be candidates almost never have important non-candidate neighbors.

The following implementation of Tarjan's algorithm follows the
steps that appear on pages 513--519 of {\sl The Stanford GraphBase}.
The reader is referred to that book, which explains the procedure in terms of
an explorer who searches the rooms of a cave, for full details and proofs of
correctness.

The algorithm uses five integer fields in each literal's \PB{\\{lmem}} record:
\smallskip
\PB{\\{rank}} is initially 0, then positive, finally $\infty$, when \PB{\|l} is
respectively unseen, then active, finally settled.
\smallskip
\PB{\\{parent}} points to a lower-ranked literal in the current oriented tree
of
active literals (or to 0 at the root), when \PB{\|l} is active; it points
to the component representative when \PB{\|l} is settled.
\smallskip
\PB{\\{untagged}} tells how many of \PB{\|l}'s successors haven't been
explored.
\smallskip
\PB{\\{link}} is a link in the stack of active vertices or the stack of settled
vertices.
\smallskip
\PB{\\{min}} is Tarjan's brilliant invention that makes everything work fast.
\smallskip\noindent
We add also a sixth field, \PB{\\{vcomp}}, which is a component member
of maximum rating.

Our instrumentation counts \PB{\\{mems}} by assuming that \PB{\\{rank}} and %
\PB{\\{link}} are
accessed simultaneously as an octabyte, as are \PB{\\{untagged}} and \PB{%
\\{min}},
\PB{\\{parent}} and \PB{\\{vcomp}}.

\Y\B\4\X103:Determine the strong components; \PB{\&{goto} \\{look\_bad}} if
there's a contradiction\X${}\E{}$\6
\X105:Make all vertices unseen and all arcs untagged\X;\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{cands};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{poslit}(\\{cand}[\|i].\\{var});{}$\6
\4\\{check\_rank}:\5
\&{if} ${}(\|o,\39\\{lmem}[\|l].\\{rank}\E\T{0}){}$\1\5
\X111:Perform a depth-first search with \PB{\|l} as root, finding the strong
components of all vertices reachable from \PB{\|l}\X;\2\6
\&{if} ${}((\|l\AND\T{1})\E\T{0}){}$\5
${}\{{}$\1\6
${}\|l\PP{}$;\5
\&{goto} \\{check\_rank};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{verbose}\AND\\{show\_strong\_comps}){}$\1\5
\X104:Print the strong components\X;\2\par
\U87.\fi

\M[2370 sat11.w]{104}\B\X104:Print the strong components\X${}\E{}$\6
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Strong\ components:\\}\)\.{n"});{}$\6
\&{for} ${}(\|l\K\\{settled};{}$ \|l; ${}\|l\K\\{lmem}[\|l].\\{link}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"\ "}\|O\.{"s"}\|O\.{".8s\ "},\39\\{litname}(%
\|l));{}$\6
\&{if} ${}(\\{lmem}[\|l].\\{parent}\I\|l){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"with\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\\{lmem}[\|l].\\{parent}));{}$\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{lmem}[\|l].\\{vcomp}\I\|l){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"->\ "}\|O\.{"s"}\|O\.{".8s\ "},\39\\{litname}(%
\\{lmem}[\|l].\\{vcomp}));{}$\2\6
${}\\{fprintf}(\\{stderr},\39\.{""}\|O\.{".4g\\n"},\39\\{rating}[\\{thevar}(%
\\{lmem}[\|l].\\{vcomp})]);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U103.\fi

\M[2387 sat11.w]{105}Candidates are marked with \PB{\\{bstamp}} here so that
they can be distinguished
from non-candidates. Then we make a new copy of the \PB{\\{bimp}} data,
abbreviating it so that only the candidates are listed.

An arbitrary upper bound is placed on the total number of arcs in this
reduced digraph, because perfect accuracy is not important at this stage.
The default limit, \PB{$\\{max\_prelook\_arcs}\K\T{10000}$}, can be changed if
desired.
Care is needed when we stick to such a limit, because we want the arc
$u\to v$ to be present if and only if its dual $\bar v\to\bar u$ is
also present.

\Y\B\4\X105:Make all vertices unseen and all arcs untagged\X${}\E{}$\6
\X66:Bump \PB{\\{bstamp}} to a unique value\X;\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{cands};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{poslit}(\\{cand}[\|i].\\{var});{}$\6
${}\\{oo},\39\\{lmem}[\|l].\\{rank}\K\T{0},\39\\{lmem}[\|l].\\{arcs}\K{-}\T{1},%
\39\\{lmem}[\|l].\\{bstamp}\K\\{bstamp};{}$\6
${}\\{oo},\39\\{lmem}[\|l+\T{1}].\\{rank}\K\T{0},\39\\{lmem}[\|l+\T{1}].%
\\{arcs}\K{-}\T{1},\39\\{lmem}[\|l+\T{1}].\\{bstamp}\K\\{bstamp};{}$\6
\4${}\}{}$\2\6
\X109:Copy all the relevant arcs to \PB{\\{cand\_arc}}\X;\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{cands};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{poslit}(\\{cand}[\|i].\\{var});{}$\6
${}\\{oo},\39\\{lmem}[\|l].\\{untagged}\K\\{lmem}[\|l].\\{arcs};{}$\6
${}\\{oo},\39\\{lmem}[\|l+\T{1}].\\{untagged}\K\\{lmem}[\|l+\T{1}].\\{arcs};{}$%
\6
\4${}\}{}$\2\6
${}\|k\K\T{0}{}$;\C{ this is the number of vertices ``seen'' by Tarjan's
algorithm }\6
${}\\{active}\K\\{settled}\K\T{0}{}$;\C{ the active and settled stacks are
empty }\par
\U103.\fi

\M[2414 sat11.w]{106}\B\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{arc\_struct} ${}\{{}$\1\6
\&{uint} \\{tip};\C{ the implied literal }\6
\&{int} \\{next};\C{ next arc from the implier literal, or $-1$ }\2\6
${}\}{}$ \&{arc};\par
\fi

\M[2420 sat11.w]{107}\B\X3:Global variables\X${}\mathrel+\E{}$\6
\&{arc} ${}{*}\\{cand\_arc}{}$;\C{ the arcs in a reduced digraph }\6
\&{int} \\{cand\_arc\_alloc};\C{ how many arc slots have we used so far? }\6
\&{int} \\{active};\C{ top of the linked stack of active vertices }\6
\&{int} \\{settled};\C{ top of the linked stack of settled vertices }\par
\fi

\M[2426 sat11.w]{108}The number of \PB{\\{bytes}} used will be adjusted
dynamically.

\Y\B\4\X58:Allocate special arrays\X${}\mathrel+\E{}$\6
$\\{max\_prelook\_arcs}\MRL{\AND{\K}}{-}\T{2}{}$;\C{ make sure \PB{\\{max%
\_prelook\_arcs}} is even }\6
${}\\{cand\_arc}\K{}$(\&{arc} ${}{*}){}$ \\{malloc}${}(\\{max\_prelook\_arcs}*%
\&{sizeof}(\&{arc}));{}$\6
\&{if} ${}(\R\\{cand\_arc}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ cand%
\_arc\ arr}\)\.{ay!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\par
\fi

\M[2436 sat11.w]{109}\B\X109:Copy all the relevant arcs to \PB{\\{cand\_arc}}%
\X${}\E{}$\6
\&{for} ${}(\|j\K\|i\K\T{0};{}$ ${}\|i<\\{cands};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{poslit}(\\{cand}[\|i].\\{var});{}$\6
\X110:Copy the arcs from \PB{\|l} into the \PB{\\{cand\_arc}} array\X;\6
${}\|l\PP;{}$\6
\X110:Copy the arcs from \PB{\|l} into the \PB{\\{cand\_arc}} array\X;\6
\4${}\}{}$\2\6
\4\\{arcs\_done}:\5
\&{if} ${}(\|j>\\{cand\_arc\_alloc}{}$)\C{ we've copied more arcs than ever
before }\1\6
${}\\{bytes}\MRL{+{\K}}(\|j-\\{cand\_arc\_alloc})*\&{sizeof}(\&{arc}),\39%
\\{cand\_arc\_alloc}\K\|j{}$;\2\par
\U105.\fi

\M[2446 sat11.w]{110}Beware: We {\it reverse\/} the ordering here, placing an
arc $u\to v$ into \PB{\\{cand\_arc}} when there's an implication $v\to u$
in the \PB{\\{bimp}} table. This switcheroo will produce strong components
in a more desirable order.

\Y\B\4\X110:Copy the arcs from \PB{\|l} into the \PB{\\{cand\_arc}} array\X${}%
\E{}$\6
\&{for} ${}(\\{oo},\39\\{la}\K\\{bimp}[\|l].\\{addr},\39\\{ls}\K\\{bimp}[\|l].%
\\{size},\39\|p\K\\{lmem}[\\{bar}(\|l)].\\{arcs};{}$ \\{ls}; ${}\\{la}\PP,\39%
\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{mem}[\\{la}];{}$\6
\&{if} ${}(\|u<\|l){}$\1\5
\&{continue};\C{ we enter arcs in pairs, only when \PB{$\|l<\|u$} }\2\6
\&{if} ${}(\|o,\39\\{lmem}[\|u].\\{bstamp}\I\\{bstamp}){}$\1\5
\&{continue};\C{ not a candidate }\C{ now $l\to u$ is an implication, and $u>l$
}\2\6
${}\|o,\39\\{cand\_arc}[\|j].\\{tip}\K\\{bar}(\|u),\39\\{cand\_arc}[\|j].%
\\{next}\K\|p,\39\|p\K\|j{}$;\C{ make arc $\bar l\to\bar u$ }\6
${}\\{oo},\39\\{cand\_arc}[\|j+\T{1}].\\{tip}\K\|l,\39\\{cand\_arc}[\|j+\T{1}].%
\\{next}\K\\{lmem}[\|u].\\{arcs};{}$\6
${}\|o,\39\\{lmem}[\|u].\\{arcs}\K\|j+\T{1},\39\|j\MRL{+{\K}}\T{2}{}$;\C{ make
arc $u\to l$ }\6
\&{if} ${}(\|j\E\\{max\_prelook\_arcs}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"prelook\ arcs\ cut\ of}\)\.{f\ at\ "}\|O\.{"d;%
\ see\ option\ z\\n"},\39\\{max\_prelook\_arcs});{}$\2\6
${}\|o,\39\\{lmem}[\\{bar}(\|l)].\\{arcs}\K\\{lmem}[\\{bar}(\|l)].\\{untagged}%
\K\|p;{}$\6
\&{goto} \\{arcs\_done};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|o,\39\\{lmem}[\\{bar}(\|l)].\\{arcs}\K\\{lmem}[\\{bar}(\|l)].\\{untagged}%
\K\|p{}$;\par
\U109.\fi

\M[2471 sat11.w]{111}\B\X111:Perform a depth-first search with \PB{\|l} as
root, finding the strong components of all vertices reachable from \PB{\|l}%
\X${}\E{}$\6
${}\{{}$\1\6
${}\|v\K\|l;{}$\6
${}\|o,\39\\{lmem}[\|l].\\{parent}\K\T{0};{}$\6
\X112:Make vertex \PB{\|v} active\X;\6
\&{do}\5
\X113:Explore one step from the current vertex \PB{\|v}, possibly moving to
another current vertex and calling it~\PB{\|v}\X\5
\&{while} ${}(\|v>\T{0});{}$\6
\4${}\}{}$\2\par
\U103.\fi

\M[2481 sat11.w]{112}\B\X112:Make vertex \PB{\|v} active\X${}\E{}$\6
$\|o,\39\\{lmem}[\|v].\\{rank}\K\PP\|k;{}$\6
${}\\{lmem}[\|v].\\{link}\K\\{active},\39\\{active}\K\|v;{}$\6
${}\|o,\39\\{lmem}[\|v].\\{min}\K\|v{}$;\par
\Us111\ET113.\fi

\M[2486 sat11.w]{113}Minor point: No mem is charged for setting \PB{$\\{lmem}[%
\|v].\\{min}\K\|u$} here,
because \PB{$\\{lmem}[\|v].\\{untagged}$} could have been set at the same time.

\Y\B\4\X113:Explore one step from the current vertex \PB{\|v}, possibly moving
to another current vertex and calling it~\PB{\|v}\X${}\E{}$\6
${}\{{}$\1\6
${}\|o,\39\\{vv}\K\\{lmem}[\|v].\\{untagged},\39\\{ll}\K\\{lmem}[\|v].%
\\{min};{}$\6
\&{if} ${}(\\{vv}\G\T{0}){}$\5
${}\{{}$\C{ still more to explore from \PB{\|v} }\1\6
${}\|o,\39\|u\K\\{cand\_arc}[\\{vv}].\\{tip},\39\\{vv}\K\\{cand\_arc}[\\{vv}].%
\\{next};{}$\6
${}\|o,\39\\{lmem}[\|v].\\{untagged}\K\\{vv};{}$\6
${}\|o,\39\|j\K\\{lmem}[\|u].\\{rank};{}$\6
\&{if} (\|j)\5
${}\{{}$\C{ we've seen \PB{\|u} already }\1\6
\&{if} ${}(\|o,\39\|j<\\{lmem}[\\{ll}].\\{rank}){}$\1\5
${}\\{lmem}[\|v].\\{min}\K\|u{}$;\C{ nontree arc, just update \PB{\|v}'s min }%
\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|u} is newly seen }\1\6
${}\\{lmem}[\|u].\\{parent}\K\|v{}$;\C{ a new tree arc goes $v\to u$ }\6
${}\|v\K\|u{}$;\C{ \PB{\|u} will now be the current vertex }\6
\X112:Make vertex \PB{\|v} active\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|v} becomes mature }\1\6
${}\|o,\39\|u\K\\{lmem}[\|v].\\{parent};{}$\6
\&{if} ${}(\|v\E\\{ll}){}$\1\5
\X114:Remove \PB{\|v} and all its successors on the active stack from the tree,
and mark them as a strong component of the digraph\X\2\6
\&{else}\5
${}\{{}$\C{ the arc $u\to v$ has matured, making \PB{\|v}'s min visible from %
\PB{\|u} }\1\6
\&{if} ${}(\\{ooo},\39\\{lmem}[\\{ll}].\\{rank}<\\{lmem}[\\{lmem}[\|u].%
\\{min}].\\{rank}){}$\1\5
${}\|o,\39\\{lmem}[\|u].\\{min}\K\\{ll};{}$\2\6
\4${}\}{}$\2\6
${}\|v\K\|u{}$;\C{ the former parent of \PB{\|v} becomes the new current vertex
\PB{\|v} }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U111.\fi

\M[2517 sat11.w]{114}When \PB{\|v} is the representative of a strong component,
all vertices of
that component henceforth regard \PB{\|v} as their parent.

If \PB{\|v} represents the strong component of \PB{\|u} and if \PB{\|w}
represents the
strong component of \PB{\\{bar}(\|u)}, we won't always have \PB{$\|w\K\\{bar}(%
\|v)$}.
But we take pains to ensure that \PB{$\\{lmem}[\|v].\\{vcomp}\K\\{bar}(%
\\{lmem}[\|w].\\{vcomp})$}.

\Y\B\4\D$\\{infty}$ \5
\\{badlit}\par
\Y\B\4\X114:Remove \PB{\|v} and all its successors on the active stack from the
tree, and mark them as a strong component of the digraph\X${}\E{}$\6
${}\{{}$\1\6
\&{float} \|r${},{}$ \\{rr};\7
${}\|t\K\\{active};{}$\6
${}\|o,\39\|r\K\\{rating}[\\{thevar}(\|v)],\39\|w\K\|v;{}$\6
${}\|o,\39\\{active}\K\\{lmem}[\|v].\\{link};{}$\6
${}\|o,\39\\{lmem}[\|v].\\{rank}\K\\{infty}{}$;\C{ settle \PB{\|v} }\6
${}\\{lmem}[\|v].\\{link}\K\\{settled},\39\\{settled}\K\|t{}$;\C{ move the
component from \PB{\\{active}} to \PB{\\{settled}} }\6
\&{while} ${}(\|t\I\|v){}$\5
${}\{{}$\1\6
\&{if} ${}(\|t\E\\{bar}(\|v)){}$\5
${}\{{}$\C{ component contains complementary literals }\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"the\ binary\ clauses\ }\)\.{are\ inconsistent%
\\n"});{}$\2\6
\&{goto} \\{look\_bad};\6
\4${}\}{}$\2\6
${}\|o,\39\\{lmem}[\|t].\\{rank}\K\\{infty}{}$;\C{ now \PB{\|t} is settled }\6
${}\|o,\39\\{lmem}[\|t].\\{parent}\K\|v{}$;\C{ and its strong component is
represented by \PB{\|v} }\6
${}\|o,\39\\{rr}\K\\{rating}[\\{thevar}(\|t)];{}$\6
\&{if} ${}(\\{rr}>\|r){}$\1\5
${}\|r\K\\{rr},\39\|w\K\|t;{}$\2\6
${}\|o,\39\|t\K\\{lmem}[\|t].\\{link};{}$\6
\4${}\}{}$\2\6
${}\|o,\39\\{lmem}[\|v].\\{parent}\K\|v,\39\\{lmem}[\|v].\\{vcomp}\K\|w{}$;\C{ %
\PB{\|v} represents itself }\6
\&{if} ${}(\|o,\39\\{lmem}[\\{bar}(\|v)].\\{rank}\E\\{infty}){}$\1\5
${}\\{oo},\39\\{lmem}[\|v].\\{vcomp}\K\\{bar}(\\{lmem}[\\{lmem}[\\{bar}(\|v)].%
\\{parent}].\\{vcomp});{}$\2\6
\4${}\}{}$\2\par
\U113.\fi

\N[2552 sat11.w]{1}{115}The lookahead forest.
Now we come to what is probably the nicest part of this whole program,
an elegant mechanism by which much of the potential lookahead computation
is avoided.

Suppose we've decided to look ahead on the consequences of literals
$l_1$, $l_2$, \dots, $l_n$, in that order. The current binary implications
tell us that, if $l_j$ is true, then also $l_i$ must be true for certain~$i$.
If $i<j$, we've already deduced the consequences of $l_i$, so we prefer
not to do that again. On the other hand $l_j$ probably doesn't imply
all of $l_1$, \dots,~$l_{i-1}$; so we want to be selective, to reuse
only part of the information that we've already discovered.

The stamping principle provides a way to do that. Suppose $p_1p_2\ldots p_n$
is a permutation of $\{1,\ldots,n\}$, and suppose we stamp true/false values
at level~$p_j$ when we are looking at consequences of~$l_j$. Then, when
$l_j$ is current, the value of a literal will be considered unknown if its
stamp is less than~$p_j$, but it will be implied by $l_j$ if it has been
deduced by any of the previous literals $l_i$ with $i<j$ and $p_i>p_j$.

If, for example, $n=4$ and $p_1p_2p_3p_4=3\,1\,4\,2$, then $l_2$
can assume all consequences of~$l_1$ (because $p_1>p_2$); and $l_4$ can
assume all of the consequences of $l_1$ and $l_3$, but not $l_2$
(because $p_1>p_4$ and $p_3>p_4$ but $p_2<p_4$). This permutation
captures the shortcuts that are legitimate when we have the
implications $l_2\to l_1$, $l_4\to l_1$, and $l_4\to l_3$.

A set of implications that can be defined by a permutation in this way is
called a ``permutation poset.'' When I first noticed this connection between
permutation posets and stamping, I excitedly thought, ``Aha! Permutation
posets are ideal for lookahead in a {\mc SAT} solver.'' Unfortunately,
however, I soon learned that lookahead is much more subtle than I'd
realized, and I was compelled to abandon that optimistic sentiment;
my current thinking is, ``Alas! Only a few permutation posets will work
well for lookahead in a {\mc SAT} solver.''

The example above, which is based on the notorious pi-mutation $3\,1\,4\,2$,
illustrates the problem if we examine it closely: When literal~$l_3$ is
processed, we don't want occurrences of $\bar l_1$ to be removed from the
current clauses, because $l_3$ doesn't imply~$l_1$. But when $l_4$ is
processed, we do want $\bar l_1$ to be suppressed, as well as $\bar l_3$,
because $l_4\to l_1$ and $l_4\to l_3$.

On the other hand the permutation $4\,1\,3\,2$ does lead to a good scenario.
It corresponds to the dependencies $l_2\to l_1$, $l_3\to l_1$, $l_4\to l_3$
(hence also $l_4\to l_1$). Now $l_3$ can assume the consequences of~$l_1$
(but not~$l_2$), and we can remove $\bar l_1$ from the clauses when we work
on~$l_3$. Again $l_4$ can assume the consequences of $l_1$ and~$l_3$ (but
not~$l_2$); and this time it's convenient to remove $\bar l_3$ from the
clauses that have already been purged of $\bar l_1$. The point is that
the purging of negative literals has the same implicit recursive structure
as the visibility of stamps.

The permutations that work properly are those that don't contain a
substring $a\,b\,c$ with $c<a<b$ (like the substring $3\,4\,2$ in
$3\,1\,4\,2$). And such permutations are well known: They are the so-called
{\it stack permutations\/}. [See {\sl The Art of Computer Programming},
exercise 2.2.1--5. Actually our permutations are the reverses or the
inverses of the stack permutations described there.] Moreover, they correspond
precisely to dependencies that form an oriented forest, and the correspondence
is also well known and quite nice: ``If $u$ and $v$ are nodes of a forest,
$u$ is a proper ancestor of~$v$ if and only if $u$ precedes~$v$ in
preorder and $u$ follows~$v$ in postorder'' [{\sl TAOCP\/} exercise
2.3.2--20].

In general we've chosen candidate literals with certain known dependencies.
We would like to find an oriented forest, contained within those
dependencies, having as many arcs as possible.

The task of finding the largest oriented forest contained in a given
partially ordered set is probably NP-complete.
But two things make our task feasible in practice.
First, the number of variables for which we need to study dependencies
is not very large, during the bulk of the calculations; it's at most a
few dozen, except at shallow depth. Second, the dependencies aren't usually
extensive; at most ten or so variables are in any connected component of the
typical digraphs that arise. So we need only come up with a decent way to
handle small examples. It doesn't matter if our subforests are crude
in unusual cases.

\fi

\M[2632 sat11.w]{116}When the program below begins its work, we will have
reduced the
strong components of the candidates' digraph and placed the component
representatives into topological order. That order isn't necessarily
the one we seek for the oriented forest, but it facilitates the
computations we need to do. We use it to rank the literals in yet
another way, this time by ``height,'' namely by
the length of a longest path from a source vertex.
Then every literal~$u$ of height~$h>0$ has a predecessor vertex~$v$
of height~$h-1$. We will use the oriented forest that is defined by those
predecessor links---using the fact that $v\to u$ is an implication
in \PB{\\{bimp}[\|v]} when $u$ has an arc to $v$ in the \PB{\\{cand\_arc}}
digraph.

\Y\B\4\X116:Construct a suitable forest\X${}\E{}$\6
\X117:Find the heights and the child/sibling links\X;\6
\X121:Construct the \PB{\\{look}} table\X;\par
\U87.\fi

\M[2648 sat11.w]{117}If \PB{\|u} represents a strong component we will change %
\PB{$\\{lmem}[\|u].\\{untagged}$} to a
height value; and we'll also make \PB{$\\{lmem}[\|u].\\{min}$} point to child
of~\PB{\|u}
in the forest being constructed.
Those fields are therefore renamed \PB{\\{height}} and \PB{\\{child}}, to
reflect their new
function. The \PB{\\{link}} fields will also acquire a new significance,
although
we'll keep calling them \PB{\\{link}}: They will point to siblings in the
forest,
namely to vertices with the same parent.

The dummy literal 1 will play the role of a global root, whose children
are all of the source vertices (the vertices of height~0).

\Y\B\4\D$\\{height}$ \5
\\{untagged}\par
\B\4\D$\\{child}$ \5
\\{min}\par
\B\4\D$\\{root}$ \5
\T{1}\par
\Y\B\4\X117:Find the heights and the child/sibling links\X${}\E{}$\6
$\|o,\39\\{lmem}[\\{root}].\\{child}\K\T{0},\39\\{lmem}[\\{root}].\\{height}%
\K{-}\T{1},\39\\{pp}\K\\{root};{}$\6
\&{for} ${}(\|u\K\\{settled};{}$ \|u; ${}\|u\K\\{uu}){}$\5
${}\{{}$\1\6
${}\\{oo},\39\\{uu}\K\\{lmem}[\|u].\\{link},\39\|p\K\\{lmem}[\|u].%
\\{parent};{}$\6
\&{if} ${}(\|p\I\\{pp}){}$\1\5
${}\|h\K\T{0},\39\|w\K\\{root},\39\\{pp}\K\|p{}$;\C{ \PB{\\{pp}} is previous
strong component representative }\2\6
\&{for} ${}(\|o,\39\|j\K\\{lmem}[\\{bar}(\|u)].\\{arcs};{}$ ${}\|j\G\T{0};{}$
${}\|j\K\\{cand\_arc}[\|j].\\{next}){}$\5
${}\{{}$\1\6
${}\|o,\39\|v\K\\{bar}(\\{cand\_arc}[\|j].\\{tip}){}$;\C{ we look at the
predecessors \PB{\|v} of \PB{\|u} }\6
${}\|o,\39\\{vv}\K\\{lmem}[\|v].\\{parent};{}$\6
\&{if} ${}(\\{vv}\E\|p){}$\1\5
\&{continue};\C{ ignore an arc within the current component }\2\6
${}\|o,\39\\{hh}\K\\{lmem}[\\{vv}].\\{height};{}$\6
\&{if} ${}(\\{hh}\G\|h){}$\1\5
${}\|h\K\\{hh}+\T{1},\39\|w\K\\{vv};{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|p\E\|u){}$\5
${}\{{}$\1\6
${}\|o,\39\|v\K\\{lmem}[\|w].\\{child};{}$\6
${}\\{oo},\39\\{lmem}[\|u].\\{height}\K\|h,\39\\{lmem}[\|u].\\{child}\K\T{0},%
\39\\{lmem}[\|u].\\{link}\K\|v;{}$\6
${}\|o,\39\\{lmem}[\|w].\\{child}\K\|u;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U116.\fi

\M[2683 sat11.w]{118}The results of our oriented forest computation are placed
into
an array of \PB{\\{ldata}} called \PB{\\{look}}.
The lookahead process will
examine literals \PB{$\\{look}[\T{0}].\\{lit}$}, \PB{$\\{look}[\T{1}].%
\\{lit}$},
\dots,~\PB{$\\{look}[\\{looks}-\T{1}].\\{lit}$},
in that order; and the current stamp while studying the implications
of \PB{$\\{look}[\|k].\\{lit}$} will be the even number \PB{$\\{base}+\\{look}[%
\|k].\\{offset}$}, where
\PB{\\{base}} is the smallest stamp in the current iteration.

(Cognoscenti will understand that there is one entry in this array
for each strong component that was found in the implication digraph
of candidates.)

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{ldata\_struct} ${}\{{}$\1\6
\&{uint} \\{lit};\C{ a literal for lookahead }\6
\&{uint} \\{offset};\C{ the offset of its stamp }\2\6
${}\}{}$ \&{ldata};\par
\fi

\M[2702 sat11.w]{119}\B\X3:Global variables\X${}\mathrel+\E{}$\6
\&{ldata} ${}{*}\\{look}{}$;\C{ specification of the oriented forest for
lookaheads }\6
\&{int} \\{looks};\C{ the number of current entries in \PB{\\{look}} }\par
\fi

\M[2706 sat11.w]{120}\B\X58:Allocate special arrays\X${}\mathrel+\E{}$\6
$\\{look}\K{}$(\&{ldata} ${}{*}){}$ \\{malloc}${}(\\{lits}*\&{sizeof}(%
\&{ldata}));{}$\6
\&{if} ${}(\R\\{look}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ look\
array!\\}\)\.{n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{lits}*\&{sizeof}(\&{ldata}){}$;\par
\fi

\M[2714 sat11.w]{121}Here's a standard ``double order'' traversal [{\sl TAOCP%
\/} exercise
2.3.1--18] as we list the literals in preorder while filling in their offsets
according to postorder.

We've constructed the tree using literals that are representatives of the
strong components produced by Tarjan's algorithm. But the lookahead
process will use the \PB{\\{vcomp}} representatives instead.

\Y\B\4\X121:Construct the \PB{\\{look}} table\X${}\E{}$\6
$\|o,\39\|u\K\\{lmem}[\\{root}].\\{child},\39\|j\K\|k\K\|v\K\T{0};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\\{oo},\39\\{look}[\|k].\\{lit}\K\\{lmem}[\|u].\\{vcomp};{}$\6
${}\|o,\39\\{lmem}[\|u].\\{rank}\K\|k\PP{}$;\C{ \PB{\|k} advances in preorder }%
\6
\&{if} ${}(\|o,\39\\{lmem}[\|u].\\{child}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lmem}[\|u].\\{parent}\K\|v{}$;\C{ fix parent temporarily for
traversal }\6
${}\|v\K\|u,\39\|u\K\\{lmem}[\|u].\\{child}{}$;\C{ descend to \PB{\|u}'s
descendants }\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\4\\{post}:\5
${}\|o,\39\|i\K\\{lmem}[\|u].\\{rank};{}$\6
${}\|o,\39\\{look}[\|i].\\{offset}\K\|j,\39\|j\MRL{+{\K}}\T{2}{}$;\C{ \PB{\|j}
advances in postorder }\6
\&{if} (\|v)\1\5
${}\\{oo},\39\\{lmem}[\|u].\\{parent}\K\\{lmem}[\|v].\\{vcomp}{}$;\C{ fix
parent for lookahead }\2\6
\&{else}\1\5
${}\|o,\39\\{lmem}[\|u].\\{parent}\K\T{0};{}$\2\6
\&{if} ${}(\|o,\39\\{lmem}[\|u].\\{link}){}$\1\5
${}\|u\K\\{lmem}[\|u].\\{link}{}$;\C{ move to \PB{\|u}'s next sibling }\2\6
\&{else} \&{if} (\|v)\5
${}\{{}$\1\6
${}\|o,\39\|u\K\|v,\39\|v\K\\{lmem}[\|u].\\{parent}{}$;\C{ after the last
sibling, move to \PB{\|u}'s parent }\6
\&{goto} \\{post};\6
\4${}\}{}$\5
\2\&{else}\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{looks}\K\|k;{}$\6
\&{if} ${}(\|j\I\|k+\|k){}$\1\5
\\{confusion}(\.{"looks"});\2\par
\U116.\fi

\N[2745 sat11.w]{1}{122}Looking ahead. The lookahead process has much in common
with what
we do when making a decision at a branch node, except that we
don't make drastic changes to the data structures. We don't
assign any truth values at levels higher than \PB{\\{proto\_truth}}; and
that level is reserved for literals that will be forced true if the
lookahead procedure finds no contradictions. We don't create
new binary implications when a ternary clause gets a false literal;
we estimate the potential benefit of such binary implications instead.

The literals that we want to study have been selected and placed in \PB{%
\\{look}}
by the prelookahead procedures discussed above. We run through them
repeatedly until making a full pass without finding any new forced literals.

\Y\B\4\X122:Look ahead and gather data about how to make the next branch; but %
\PB{\&{goto} \\{look\_bad}} if a contradiction arises\X${}\E{}$\6
\X87:Do the prelookahead\X;\6
\&{if} ${}(\\{verbose}\AND\\{show\_looks}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Looks\ at\ level\ "}\|O\.{"d:\\n"},\39%
\\{level});{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{looks};{}$ ${}\|i\PP){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ "}\|O\.{"s"}\|O\.{".8s\ "}\|O\.{"d\\n"},\39%
\\{litname}(\\{look}[\|i].\\{lit}),\39\\{look}[\|i].\\{offset});{}$\2\6
\4${}\}{}$\2\6
${}\\{fl}\K\\{forcedlits},\39\\{last\_change}\K{-}\T{1};{}$\6
${}\\{base}\K\T{2};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{for} ${}(\\{looki}\K\T{0};{}$ ${}\\{looki}<\\{looks};{}$ ${}\\{looki}\PP){}$%
\5
${}\{{}$\1\6
\&{if} ${}(\\{looki}\E\\{last\_change}){}$\1\5
\&{goto} \\{look\_done};\2\6
${}\|o,\39\|l\K\\{look}[\\{looki}].\\{lit},\39\\{cs}\K\\{base}+\\{look}[%
\\{looki}].\\{offset};{}$\6
\X125:Look ahead at consequences of \PB{\|l}, and \PB{\&{goto} \\{look\_bad}}
if a conflict is found\X;\6
\4\\{look\_on}:\5
\&{if} ${}(\\{forcedlits}>\\{fl}){}$\1\5
${}\\{fl}\K\\{forcedlits},\39\\{last\_change}\K\\{looki};{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{last\_change}\E{-}\T{1}){}$\1\5
\&{break};\2\6
${}\\{base}\MRL{+{\K}}\T{2}*\\{looks}{}$;\C{ forget small truths }\6
\&{if} ${}(\\{base}+\T{2}*\\{looks}\G\\{proto\_truth}){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\\{look\_done}:\par
\U59.\fi

\M[2783 sat11.w]{123}The \PB{\\{base}} keeps rising during a lookahead, never
decreasing again.
We had better use 64 bits for it, so that overflow won't be overlooked
in large instances.

\Y\B\4\X3:Global variables\X${}\mathrel+\E{}$\6
\&{ullng} \\{base}${},{}$ \\{last\_base};\C{ base address for stamps with
offsets from \PB{\\{look}} }\6
\&{uint} ${}{*}\\{forcedlit}{}$;\C{ array of forced literals }\6
\&{int} \\{forcedlits}${},{}$ \\{fl};\C{ the number of forced literals }\6
\&{int} \\{last\_change};\C{ where in the array did we last make progress? }\6
\&{int} \\{looki};\C{ index of our position in \PB{\\{look}} }\6
\&{uint} \\{looklit};\C{ the literal whose consequences we are exploring }\6
\&{uint} \\{old\_looklit};\C{ the literal whose consequences we were exploring
}\par
\fi

\M[2796 sat11.w]{124}Again we want a fast way to make literals ``snap into
place'' when they're directly implied by an assumption that we're making.

Here we clone the former binary propagation loop for purposes of lookahead:
Instead of going to \PB{\\{conflict}} if a contradiction arises, we go to \PB{%
\\{contra}},
because the contradiction of a tentative assumption does not
necessarily imply a real conflict.

Although the lookahead algorithms use \PB{\\{rstack}} for breadth-first search,
they never change \PB{\\{rptr}}, nor do they fix any literals at
more than the \PB{\\{proto\_truth}} level.

\Y\B\4\X124:Propagate binary lookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{contra}} if a contradiction arises\X${}\E{}$\6
\&{if} (\\{isfixed}(\|l))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|l))\1\5
\&{goto} \\{contra};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cs}\G\\{proto\_truth}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"protofixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\|l));{}$\2\6
\&{else}\1\5
${}\\{fprintf}(\\{stderr},\39\.{""}\|O\.{"dfixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},%
\39\\{cs},\39\\{litname}(\|l));{}$\2\6
\4${}\}{}$\2\6
\\{stamptrue}(\|l);\6
${}\\{lfptr}\K\\{eptr};{}$\6
${}\|o,\39\\{rstack}[\\{eptr}\PP]\K\|l;{}$\6
\&{while} ${}(\\{lfptr}<\\{eptr}){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{rstack}[\\{lfptr}\PP];{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\|l].\\{addr},\39\\{ls}\K\\{bimp}[\|l].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lp}\K\\{mem}[\\{la}];{}$\6
\&{if} (\\{isfixed}(\\{lp}))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\\{lp}))\1\5
\&{goto} \\{contra};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cs}\G\\{proto\_truth}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ protofixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\\{lp}));{}$\2\6
\&{else}\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ "}\|O\.{"dfixing\ "}\|O\.{"s"}\|O\.{".8s%
\\n"},\39\\{cs},\39\\{litname}(\\{lp}));{}$\2\6
\4${}\}{}$\2\6
\\{stamptrue}(\\{lp});\6
${}\|o,\39\\{rstack}[\\{eptr}\PP]\K\\{lp};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\Us130\ET134.\fi

\M[2842 sat11.w]{125}An example will make it easier to visualize the current
context.
Suppose the relevant binary clauses are
$(\bar b\lor a)\land(\bar c\lor a)\land(\bar d\lor c)$.
Then the \PB{\\{look}} array might contain the sequence $\bar b$, $a$, $b$,
$c$, $d$,
$\bar d$, $\bar c$, $\bar a$, with respective offsets 0, 8, 2, 6, 4, 14, 12,
10.
The parent of~$c$ is then~$a$; the parent of~$d$ is~$c$; the parent of~$\bar c$
is~$\bar d$; the parent of~$\bar a$ is~$\bar c$; and $a$, $\bar b$, $\bar d$
are roots with no parent.

\Y\B\4\X125:Look ahead at consequences of \PB{\|l}, and \PB{\&{goto} \\{look%
\_bad}} if a conflict is found\X${}\E{}$\6
$\\{looklit}\K\|l;{}$\6
${}\|o,\39\\{ll}\K\\{lmem}[\\{looklit}].\\{parent};{}$\6
\&{if} (\\{ll})\1\5
${}\\{oo},\39\\{lmem}[\\{looklit}].\\{wnb}\K\\{lmem}[\\{ll}].\\{wnb}{}$;\C{
inherit from parent }\2\6
\&{else}\1\5
${}\|o,\39\\{lmem}[\|l].\\{wnb}\K\T{0.0};{}$\2\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"looking\ at\ "}\|O\.{"s"}\|O\.{".8s\ ("}\|O%
\.{"d)\\n"},\39\\{litname}(\\{looklit}),\39\\{cs});{}$\2\6
\&{if} (\\{isfixed}(\|l))\5
${}\{{}$\1\6
\&{if} ${}(\\{iscontrary}(\|l)\W\\{stamp}[\\{thevar}(\|l)]<\\{proto\_truth}){}$%
\1\5
\X128:Force \PB{\\{looklit}} to be (proto) false, and complement it\X;\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\X130:Update lookahead data structures for consequences of \PB{\\{looklit}};
but \PB{\&{goto} \\{contra}} if a contradiction arises\X;\6
\&{if} ${}(\\{weighted\_new\_binaries}\E\T{0}){}$\1\5
\X126:Exploit an autarky\X\2\6
\&{else}\1\5
${}\|o,\39\\{lmem}[\\{looklit}].\\{wnb}\MRL{+{\K}}\\{weighted\_new%
\_binaries};{}$\2\6
\X140:Do a double lookahead from \PB{\\{looklit}}, if that seems advisable\X;\6
\X137:Check for necessary assignments\X;\6
\4${}\}{}$\2\par
\U122.\fi

\M[2872 sat11.w]{126}Here we implement an extension of the classical ``pure
literal'' rule:
We have just looked at all the consequences obtainable by repeated propagation
of unit clauses when \PB{\\{looklit}} is assumed to be true, and we've
found no contradiction. Suppose we've also
discovered no ``new weighted binaries''; this means that, whenever
we have reduced a clause from size~$s$ to size~$s'<s$ during this process,
the reduced size $s'$ is~1. (For if $s'=0$ we would have had a contradiction,
while if $1<s'<s$ we would have increased \PB{\\{new\_weighted\_binaries}}.)

In such a case, the set of literals deducible from \PB{\\{looklit}} is said to
form an {\it autarky}, and we are allowed to assume that \PB{\\{looklit}} is
true. Indeed, those literals $\{l_1,\ldots,l_k\}$ satisfy every clause that
contains either $\l_i$ or $\bar l_i$ for any~$i$. If the remaining
``untouched'' clauses are satisfiable, we can satisfy all the clauses by using
$\{l_1,\ldots,l_k\}$ in the clauses that are touched; and if we can
satisfy all the clauses, we can certainly satisfy the untouched ones.

(I learned this trick in January 2013 from Marijn Heule.)

\Y\B\4\X126:Exploit an autarky\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{lmem}[\\{looklit}].\\{wnb}\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ autarky\ at\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\\{looklit}));{}$\2\6
${}\\{looklit}\K\\{bar}(\\{looklit}){}$;\C{ complement \PB{\\{looklit}}
temporarily }\6
\X128:Force \PB{\\{looklit}} to be (proto) false, and complement it\X;\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
${}\\{ll}\K\\{lmem}[\\{looklit}].\\{parent};{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ autarky\ "}\|O\.{"s"}\|O\.{".8s\ ->\ "}\|O%
\.{"s"}\|O\.{".8s\\n"},\39\\{litname}(\\{ll}),\39\\{litname}(\\{looklit}));{}$%
\2\6
\X127:Make \PB{\\{ll}} equivalent to \PB{\\{looklit}}\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U125.\fi

\M[2908 sat11.w]{127}Furthermore, if \PB{$\\{lmem}[\\{looklit}].\\{wnb}$} is
nonzero, we know that we
set it to \PB{$\\{lmem}[\\{ll}].\\{wnb}$} where \PB{\\{ll}} is the parent of %
\PB{\\{looklit}}.
In that case, if the assertion of \PB{\\{looklit}} gives no new weighted
new binaries in addition to those obtained from \PB{\\{ll}}, the variables
deducible from \PB{\\{looklit}} are an autarky with respect to the
set of clauses that are reduced by~\PB{\\{ll}}; so we are allowed to
assume that \PB{\\{looklit}} itself is implied by~\PB{\\{ll}}. (Think about
it.)
In other words,
adding the additional clause $\lnot\hbox{\PB{\\{ll}}}\lor\hbox{\PB{%
\\{looklit}}}$
does not make the set of clauses any less satisfiable.

This additional clause is special, because it cannot in general
be derived by resolution.

We already have the clause $\lnot\hbox{\PB{\\{looklit}}}\lor\hbox{\PB{%
\\{ll}}}$,
because \PB{\\{ll}} is the parent of~\PB{\\{looklit}}. Thus we can conclude
that
both literals are equivalent in this case.

\Y\B\4\X127:Make \PB{\\{ll}} equivalent to \PB{\\{looklit}}\X${}\E{}$\6
${}\{{}$\1\6
${}\|u\K\\{bar}(\\{ll});{}$\6
${}\|o,\39\\{au}\K\\{bimp}[\\{ll}].\\{addr},\39\\{su}\K\\{bimp}[\\{ll}].%
\\{size};{}$\6
\X74:Make sure that \PB{\\{bar}(\|u)} has an \PB{\\{istack}} entry\X;\6
\&{if} ${}(\|o,\39\\{su}\E\\{bimp}[\\{ll}].\\{alloc}){}$\1\5
${}\\{resize}(\\{ll}),\39\|o,\39\\{au}\K\\{bimp}[\\{ll}].\\{addr};{}$\2\6
${}\\{oo},\39\\{mem}[\\{au}+\\{su}]\K\\{looklit},\39\\{bimp}[\\{ll}].\\{size}\K%
\\{su}+\T{1};{}$\6
${}\|u\K\\{looklit};{}$\6
${}\|o,\39\\{au}\K\\{bimp}[\\{bar}(\|u)].\\{addr},\39\\{su}\K\\{bimp}[\\{bar}(%
\|u)].\\{size};{}$\6
\X74:Make sure that \PB{\\{bar}(\|u)} has an \PB{\\{istack}} entry\X;\6
\&{if} ${}(\|o,\39\\{su}\E\\{bimp}[\\{bar}(\|u)].\\{alloc}){}$\1\5
${}\\{resize}(\\{bar}(\|u)),\39\|o,\39\\{au}\K\\{bimp}[\\{bar}(\|u)].%
\\{addr};{}$\2\6
${}\\{oo},\39\\{mem}[\\{au}+\\{su}]\K\\{bar}(\\{ll}),\39\\{bimp}[\\{bar}(\|u)].%
\\{size}\K\\{su}+\T{1};{}$\6
${}\\{oo},\39\\{stamp}[\\{thevar}(\\{looklit})]\K\\{stamp}[\\{thevar}(\\{ll})]%
\XOR((\\{looklit}\XOR\\{ll})\AND\T{1});{}$\6
\4${}\}{}$\2\par
\U126.\fi

\M[2941 sat11.w]{128}\B\X128:Force \PB{\\{looklit}} to be (proto) false, and
complement it\X${}\E{}$\6
${}\{{}$\1\6
${}\\{looklit}\K\\{bar}(\\{looklit});{}$\6
${}\\{forcedlit}[\\{forcedlits}\PP]\K\\{looklit};{}$\6
${}\\{look\_cs}\K\\{cs},\39\\{cs}\K\\{proto\_truth};{}$\6
\X130:Update lookahead data structures for consequences of \PB{\\{looklit}};
but \PB{\&{goto} \\{contra}} if a contradiction arises\X;\6
${}\\{cs}\K\\{look\_cs};{}$\6
\4${}\}{}$\2\par
\Us125, 126, 129\ETs137.\fi

\M[2950 sat11.w]{129}When we get to label \PB{\\{contra}}, we execute the
following
instructions, which will ``fall through'' to label \PB{\\{look\_bad}} if
\PB{$\\{cs}\K\\{proto\_truth}$}.

Roughly speaking, we've derived a contradiction after assuming
that \PB{\\{looklit}} is true. When that assumption fails, we make
\PB{\\{looklit}} proto-false. A second failure at the proto-false level
is a real conflict, and it will require backtracking.

\Y\B\4\X129:Recover from a lookahead contradiction\X${}\E{}$\6
\&{if} ${}(\\{cs}<\\{proto\_truth}){}$\5
${}\{{}$\1\6
\X128:Force \PB{\\{looklit}} to be (proto) false, and complement it\X;\6
\&{goto} \\{look\_on};\6
\4${}\}{}$\2\par
\U84.\fi

\M[2965 sat11.w]{130}A new breadth-first search is launched here, as we assert %
\PB{\\{looklit}}
at truth level~\PB{\\{cs}} and derive the ramifications of that assertion.
If, for example, \PB{$\\{cs}\K\T{50}$}, we will make \PB{\\{looklit}} (and all
other literals
that it implies) true at level~50, unless they're already true at
levels 52 or above.

The consequences of \PB{\\{looklit}} might include ``windfalls,'' which
are unfixed literals that are the only survivors of a clause whose
other literals have become false. Windfalls will be placed on the
\PB{\\{wstack}}, which is cleared here.

\Y\B\4\X130:Update lookahead data structures for consequences of \PB{%
\\{looklit}}; but \PB{\&{goto} \\{contra}} if a contradiction arises\X${}\E{}$\6
$\\{wptr}\K\T{0}{}$;\5
${}\\{fptr}\K\\{eptr}\K\\{rptr};{}$\6
${}\\{weighted\_new\_binaries}\K\T{0};{}$\6
${}\|l\K\\{looklit};{}$\6
\X124:Propagate binary lookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{contra}} if a contradiction arises\X;\6
\&{while} ${}(\\{fptr}<\\{eptr}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{ll}\K\\{rstack}[\\{fptr}\PP];{}$\6
\X133:Update lookahead data structures for the truth of \PB{\\{ll}}; but \PB{%
\&{goto} \\{contra}} if a contradiction arises\X;\6
\4${}\}{}$\2\6
\X135:Convert the windfalls to binary implications from \PB{\\{looklit}}\X;\par
\Us125\ET128.\fi

\M[2988 sat11.w]{131}\B\X3:Global variables\X${}\mathrel+\E{}$\6
\&{uint} ${}{*}\\{wstack}{}$;\C{ place to store windfalls that result from \PB{%
\\{looklit}} }\6
\&{int} \\{wptr};\C{ the number of entries currently in \PB{\\{wstack}} }\6
\&{float} \\{weighted\_new\_binaries};\C{ total weight of binaries that we
uncover }\par
\fi

\M[2993 sat11.w]{132}\B\X58:Allocate special arrays\X${}\mathrel+\E{}$\6
$\\{wstack}\K{}$(\&{uint} ${}{*}){}$ \\{malloc}${}(\\{lits}*\&{sizeof}(%
\&{uint}));{}$\6
\&{if} ${}(\R\\{wstack}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Oops,\ I\ can't\ alloc}\)\.{ate\ the\ wstack\
array}\)\.{!\\n"});{}$\6
${}\\{exit}({-}\T{10});{}$\6
\4${}\}{}$\2\6
${}\\{bytes}\MRL{+{\K}}\\{lits}*\&{sizeof}(\&{uint}){}$;\par
\fi

\M[3001 sat11.w]{133}\B\X133:Update lookahead data structures for the truth of %
\PB{\\{ll}}; but \PB{\&{goto} \\{contra}} if a contradiction arises\X${}\E{}$\6
\&{for} ${}(\|o,\39\\{tla}\K\\{timp}[\\{ll}].\\{addr},\39\\{tls}\K\\{timp}[%
\\{ll}].\\{size};{}$ \\{tls}; ${}\\{tla}\PP,\39\\{tls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{tmem}[\\{tla}].\|u,\39\|v\K\\{tmem}[\\{tla}].\|v;{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ \ looking\ "}\|O\.{"s"}\|O\.{".8s->"}\|O%
\.{"s"}\|O\.{".8s|"}\|O\.{"s"}\|O\.{".8s\\n"},\39\\{litname}(\\{ll}),\39%
\\{litname}(\|u),\39\\{litname}(\|v));{}$\2\6
\X134:Update lookahead structures for a potentially new binary clause $u\lor v$%
\X;\6
\4${}\}{}$\2\par
\U130.\fi

\M[3011 sat11.w]{134}Windfalls and the weighted potentials of new binaries are
discovered here.

\Y\B\4\X134:Update lookahead structures for a potentially new binary clause $u%
\lor v$\X${}\E{}$\6
\&{if} (\\{isfixed}(\|u))\5
${}\{{}$\C{ equivalently, \PB{\&{if} $(\|o,$ $\\{stamp}[\\{thevar}(\|u)]\G%
\\{cs}$} }\1\6
\&{if} (\\{iscontrary}(\|u))\5
${}\{{}$\C{ \PB{\|u} is stamped false }\1\6
\&{if} (\\{isfixed}(\|v))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|v))\1\5
\&{goto} \\{contra};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|v} is unknown }\1\6
${}\|l\K\|v;{}$\6
${}\\{wstack}[\\{wptr}\PP]\K\|l;{}$\6
\X124:Propagate binary lookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{contra}} if a contradiction arises\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|u} is unknown }\1\6
\&{if} (\\{isfixed}(\|v))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|v))\5
${}\{{}$\1\6
${}\|l\K\|u;{}$\6
${}\\{wstack}[\\{wptr}\PP]\K\|l;{}$\6
\X124:Propagate binary lookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{contra}} if a contradiction arises\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\1\5
${}\\{weighted\_new\_binaries}\MRL{+{\K}}\\{heur}[\|u]*\\{heur}[\|v];{}$\2\6
\4${}\}{}$\2\par
\U133.\fi

\M[3034 sat11.w]{135}Windfalls are analogous to the compensation resolvents we
saw before.

\Y\B\4\X135:Convert the windfalls to binary implications from \PB{\\{looklit}}%
\X${}\E{}$\6
\&{if} (\\{wptr})\5
${}\{{}$\1\6
${}\\{oo},\39\\{sl}\K\\{bimp}[\\{looklit}].\\{size},\39\\{ls}\K\\{bimp}[%
\\{looklit}].\\{alloc};{}$\6
\X136:Make sure that \PB{\\{looklit}} has an \PB{\\{istack}} entry\X;\6
\&{while} ${}(\\{sl}+\\{wptr}>\\{ls}){}$\1\5
${}\\{resize}(\\{looklit}),\39\\{ls}\MRL{{\LL}{\K}}\T{1};{}$\2\6
${}\|o,\39\\{bimp}[\\{looklit}].\\{size}\K\\{sl}+\\{wptr};{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\\{looklit}].\\{addr}+\\{sl};{}$ \\{wptr};
${}\\{wptr}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{wstack}[\\{wptr}-\T{1}];{}$\6
${}\|o,\39\\{mem}[\\{la}\PP]\K\|u;{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ windfall\ "}\|O\.{"s"}\|O\.{".8s->"}\|O%
\.{"s"}\|O\.{".8s\\n"},\39\\{litname}(\\{looklit}),\39\\{litname}(\|u));{}$\2\6
${}\|o,\39\\{au}\K\\{bimp}[\\{bar}(\|u)].\\{addr},\39\\{su}\K\\{bimp}[\\{bar}(%
\|u)].\\{size};{}$\6
\X74:Make sure that \PB{\\{bar}(\|u)} has an \PB{\\{istack}} entry\X;\6
\&{if} ${}(\|o,\39\\{su}\E\\{bimp}[\\{bar}(\|u)].\\{alloc}){}$\1\5
${}\\{resize}(\\{bar}(\|u)),\39\|o,\39\\{au}\K\\{bimp}[\\{bar}(\|u)].%
\\{addr};{}$\2\6
${}\|o,\39\\{mem}[\\{au}+\\{su}]\K\\{bar}(\\{looklit});{}$\6
${}\|o,\39\\{bimp}[\\{bar}(\|u)].\\{size}\K\\{su}+\T{1};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\Us130\ET141.\fi

\M[3056 sat11.w]{136}\B\X136:Make sure that \PB{\\{looklit}} has an \PB{%
\\{istack}} entry\X${}\E{}$\6
\&{if} ${}(\|o,\39\\{lmem}[\\{looklit}].\\{istamp}\I\\{istamp}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lmem}[\\{looklit}].\\{istamp}\K\\{istamp};{}$\6
${}\|o,\39\\{istack}[\\{iptr}].\\{lit}\K\\{looklit},\39\\{istack}[\\{iptr}].%
\\{size}\K\\{sl};{}$\6
\X75:Increase \PB{\\{iptr}}\X;\6
\4${}\}{}$\2\par
\U135.\fi

\M[3063 sat11.w]{137}Let \PB{$\|l\K\\{looklit}$}. If our assumption that $l$ is
true has allowed us
to conclude the truth of some other literal~$l'$, but only at a
level less than \PB{\\{proto\_truth}}, we are allowed to promote this to
\PB{\\{proto\_truth}} if we also have $\bar l\to l'$. If we're lucky,
that promotion will also trigger more consequences that we didn't
have to discover the hard way.

\Y\B\4\X137:Check for necessary assignments\X${}\E{}$\6
$\\{old\_looklit}\K\\{looklit};{}$\6
\&{for} ${}(\|o,\39\\{ola}\K\\{bimp}[\\{bar}(\\{looklit})].\\{addr},\39\\{ols}%
\K\\{bimp}[\\{bar}(\\{looklit})].\\{size};{}$ \\{ols}; ${}\\{ols}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\\{looklit}\K\\{bar}(\\{mem}[\\{ola}+\\{ols}-\T{1}]);{}$\6
\&{if} ${}((\\{isfixed}(\\{looklit}))\W(\\{stamp}[\\{thevar}(\\{looklit})]<%
\\{proto\_truth})\W\\{iscontrary}(\\{looklit})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ necessary\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\\{bar}(\\{looklit})));{}$\2\6
\X128:Force \PB{\\{looklit}} to be (proto) false, and complement it\X;\6
${}\|o,\39\\{ola}\K\\{bimp}[\\{bar}(\\{old\_looklit})].\\{addr}{}$;\C{ guard
against a change in \PB{\\{ola}} }\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U125.\fi

\M[3084 sat11.w]{138} Now we're ready to select \PB{\\{bestlit}}, representing
our guess about
the best literal on which to branch.

(More precisely, \PB{\\{thevar}(\\{bestlit})} is the variable on which we shall
branch. First we will try to make \PB{\\{bestlit}} true. If that fails,
we'll try to make it false. And if that fails, we'll backtrack
to a previous node.)

The lookahead process might have identified forced literals that
force the value of every variable for which we have \PB{\\{wnb}} scores.
If so, those literals are no longer free;
they are true at the \PB{\\{real\_truth}} level. And if one of them would
have been our choice for \PB{\\{bestlit}}, we set \PB{\\{bestlit}} to zero
because
we ought to do another lookahead before branching.

We might in fact
be lucky: If \PB{\\{freevars}} is zero, the clauses have been satisfied.

\Y\B\4\X138:Choose \PB{\\{bestlit}}, which will be the next branch tried\X${}%
\E{}$\6
${}\{{}$\1\6
\&{float} \\{best\_score};\7
\&{if} ${}(\\{freevars}\E\T{0}){}$\1\5
\&{goto} \\{satisfied};\2\6
\&{for} ${}(\|i\K\T{0},\39\\{best\_score}\K{-}\T{1.0},\39\\{bestlit}\K\T{0};{}$
${}\|i<\\{looks};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{look}[\|i].\\{lit};{}$\6
\&{if} ${}((\|l\AND\T{1})\E\T{0}){}$\5
${}\{{}$\1\6
\&{float} \\{pos}${},{}$ \\{neg}${},{}$ \\{score};\7
${}\\{oo},\39\\{pos}\K\\{lmem}[\|l].\\{wnb},\39\\{neg}\K\\{lmem}[\|l+\T{1}].%
\\{wnb};{}$\6
${}\\{score}\K(\\{pos}+\T{.1})*(\\{neg}+\T{.1});{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ "}\|O\.{".8s,\ "}\|O\.{".4g:"}\|O\.{".4g\
("}\|O\.{".4g)\\n"},\39\\{vmem}[\\{thevar}(\|l)].\\{name}.\\{ch8},\39\\{pos},%
\39\\{neg},\39\\{score});{}$\2\6
\&{if} ${}(\\{score}>\\{best\_score}){}$\5
${}\{{}$\1\6
${}\\{best\_score}\K\\{score};{}$\6
${}\\{bestlit}\K(\\{pos}>\\{neg}\?\|l+\T{1}:\|l);{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{isfree}(\\{bestlit})){}$\1\5
${}\\{bestlit}\K\T{0};{}$\2\6
\&{if} ${}(\\{bestlit}+\\{forcedlits}\E\T{0}){}$\1\5
\\{confusion}(\.{"choice"});\2\6
\4${}\}{}$\2\par
\U59.\fi

\N[3125 sat11.w]{1}{139}Double-looking ahead. Sometimes we really go out on a
limb and
look ahead {\it two\/} steps before making a decision. The goal of such a
second look is to detect a branch that dies off early, resulting
in a forced literal $\bar l$ when looking at sufficiently many consequences
of~$l$.

Of course an extra degree of looking takes time, and we don't want to
do it if the extra time isn't recouped by a better branching strategy.
Here I use an elegant feedback technique of Heule and van Maaren
[{\sl Lecture Notes in Computer Science\/ \bf4501} (2007), 258--271],
which responds adaptively to the conditions of a given problem:
A ``trigger'' starts at zero and increases when doublelook is unsuccessful,
but decreases slightly after each lookahead.

Double-lookahead has a weaker level of trustworthiness than
\PB{\\{proto\_truth}}. It is the dynamically specified level \PB{\\{dl%
\_truth}}, at the
top of a region of stamp space that allows for a maximum number of
permitted iterations. That maximum number, \PB{\\{dl\_max\_iter}}, is 8 by
default,
but of course users are allowed to fiddle with it to their hearts' content.
Literals that are true at level \PB{\\{dl\_truth}} are conditionally true under
the
hypothesis that \PB{\\{looklit}} is true.

\Y\B\4\X3:Global variables\X${}\mathrel+\E{}$\6
\&{float} \\{dl\_trigger};\C{ lower bound to adjust the frequency of
double-looking }\6
\&{uint} \\{dl\_truth};\C{ the doublelook analog of \PB{\\{proto\_truth}} }\6
\&{int} \\{dlooki};\C{ the doublelook analog of \PB{\\{looki}} }\6
\&{uint} \\{dlooklit};\C{ the doublelook analog of \PB{\\{looklit}} }\6
\&{uint} \\{dl\_last\_change};\C{ the last literal for which we forced some dl
truth }\par
\fi

\M[3154 sat11.w]{140}\B\X140:Do a double lookahead from \PB{\\{looklit}}, if
that seems advisable\X${}\E{}$\6
\&{if} ${}(\\{level}\W(\|o,\39\\{lmem}[\\{looklit}].\\{dl\_fail}\I%
\\{istamp})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{lmem}[\\{looklit}].\\{wnb}>\\{dl\_trigger}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cs}+\T{2}*\\{looks}*{}$((\&{ullng}) \\{dl\_max\_iter}${}+\T{1})<%
\\{proto\_truth}){}$\5
${}\{{}$\1\6
\X141:Double look ahead from \PB{\\{looklit}}; \PB{\&{goto} \\{contra}} if a
contradiction arises\X;\6
${}\|o,\39\\{dl\_trigger}\K\\{lmem}[\\{looklit}].\\{wnb}{}$;\C{ increase the
trigger, to discourage improbable double-looks }\6
${}\|o,\39\\{lmem}[\\{looklit}].\\{dl\_fail}\K\\{istamp}{}$;\C{ don't try this
literal again at this branch node }\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\1\5
${}\\{dl\_trigger}\MRL{*{\K}}\\{dl\_rho}{}$;\C{ decrease the trigger slightly,
so that it we'll eventually try again }\2\6
\4${}\}{}$\2\par
\U125.\fi

\M[3169 sat11.w]{141}The new settings of \PB{\\{base}}, \PB{\\{last\_base}},
and \PB{\\{dl\_truth}} in this step
are slightly subtle: On the first iteration, some literals may be fixed true
(stampwise) because of information gained before we've started to doublelook,
but only if they are implied by \PB{\\{looklit}}. Those literals will be
promoted
to truth at level \PB{\\{dl\_truth}} during the course of that iteration,
because a contradiction will arise when we try to set them false.
On subsequent iterations, and after doublelook finishes its work, the only
existing level of truth that is \PB{$\G$ \\{base}} and \PB{$<$ \\{proto%
\_truth}} will be \PB{\\{dl\_truth}}.

The propagation loop invoked here gets the ball rolling by making all
binary implications of \PB{\\{looklit}} true at level \PB{\\{dl\_truth}}. It
will
not actually \PB{\&{goto} \\{dl\_contra}} in spite of what it says; we have
simply copied the more general code into this section for convenience,
because such optimization isn't necessary at this point.

``Windfalls'' during a doublelook are different from those we saw before:
They now are literals that were forced to be true as a consequence
of \PB{\\{looklit}}.

\Y\B\4\X141:Double look ahead from \PB{\\{looklit}}; \PB{\&{goto} \\{contra}}
if a contradiction arises\X${}\E{}$\6
$\\{last\_base}\K\\{cs}+\T{2}*\\{looks}*\\{dl\_max\_iter};{}$\6
${}\\{dl\_truth}\K\\{last\_base}+\\{cs}-\\{base};{}$\6
${}\\{base}\K\\{cs};{}$\6
${}\\{cs}\K\\{dl\_truth},\39\|l\K\\{looklit};{}$\6
${}\\{wptr}\K\T{0}{}$;\5
${}\\{eptr}\K\\{rptr};{}$\6
\X143:Propagate binary doublelookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{dl\_contra}} if a contradiction arises\X;\6
\X142:Run through iterations of doublelook analogous to the iterations of
ordinary lookahead\X;\6
\X135:Convert the windfalls to binary implications from \PB{\\{looklit}}\X;\par
\U140.\fi

\M[3201 sat11.w]{142}The code here and in the following sections parallels the
corresponding
routines in lookahead and in the basic solver, but at an even hazier and more
tentative level---further removed from reality.

\Y\B\4\X142:Run through iterations of doublelook analogous to the iterations of
ordinary lookahead\X${}\E{}$\6
$\\{dl\_last\_change}\K\T{0};{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\&{for} ${}(\\{dlooki}\K\T{0};{}$ ${}\\{dlooki}<\\{looks};{}$ ${}\\{dlooki}%
\PP){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{look}[\\{dlooki}].\\{lit},\39\\{cs}\K\\{base}+\\{look}[%
\\{dlooki}].\\{offset};{}$\6
\&{if} ${}(\|l\E\\{dl\_last\_change}){}$\1\5
\&{goto} \\{dlook\_done};\2\6
\X144:Doublelook ahead at consequences of \PB{\|l}, and \PB{\&{goto} %
\\{contra}} if a contradiction is found\X;\6
\4\\{dlook\_on}:\5
\&{continue};\6
\4${}\}{}$\2\6
\&{if} ${}(\\{dl\_last\_change}\E\T{0}){}$\1\5
\&{break};\2\6
${}\\{base}\MRL{+{\K}}\T{2}*\\{looks}{}$;\C{ forget small truths }\6
\&{if} ${}(\\{base}\E\\{last\_base}){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\4\\{dlook\_done}:\5
${}\\{base}\K\\{last\_base},\39\\{cs}\K\\{dl\_truth}{}$;\C{ retain only \PB{%
\\{dl\_truth}} data }\par
\U141.\fi

\M[3222 sat11.w]{143}\B\X143:Propagate binary doublelookahead implications of %
\PB{\|l}; \PB{\&{goto} \\{dl\_contra}} if a contradiction arises\X${}\E{}$\6
\&{if} (\\{isfixed}(\|l))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|l))\1\5
\&{goto} \\{dl\_contra};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_doubly\_gory\_details}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cs}\G\\{dl\_truth}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"dlfixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\|l));{}$\2\6
\&{else}\1\5
${}\\{fprintf}(\\{stderr},\39\.{""}\|O\.{"dfixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},%
\39\\{cs},\39\\{litname}(\|l));{}$\2\6
\4${}\}{}$\2\6
\\{stamptrue}(\|l);\6
${}\\{lfptr}\K\\{eptr};{}$\6
${}\|o,\39\\{rstack}[\\{eptr}\PP]\K\|l;{}$\6
\&{while} ${}(\\{lfptr}<\\{eptr}){}$\5
${}\{{}$\1\6
${}\|o,\39\|l\K\\{rstack}[\\{lfptr}\PP];{}$\6
\&{for} ${}(\|o,\39\\{la}\K\\{bimp}[\|l].\\{addr},\39\\{ls}\K\\{bimp}[\|l].%
\\{size};{}$ \\{ls}; ${}\\{la}\PP,\39\\{ls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\\{lp}\K\\{mem}[\\{la}];{}$\6
\&{if} (\\{isfixed}(\\{lp}))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\\{lp}))\1\5
\&{goto} \\{dl\_contra};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_doubly\_gory\_details}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{cs}\G\\{dl\_truth}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ dlfixing\ "}\|O\.{"s"}\|O\.{".8s\\n"},\39%
\\{litname}(\\{lp}));{}$\2\6
\&{else}\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ "}\|O\.{"dfixing\ "}\|O\.{"s"}\|O\.{".8s%
\\n"},\39\\{cs},\39\\{litname}(\\{lp}));{}$\2\6
\4${}\}{}$\2\6
\\{stamptrue}(\\{lp});\6
${}\|o,\39\\{rstack}[\\{eptr}\PP]\K\\{lp};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\Us141, 147\ETs149.\fi

\M[3255 sat11.w]{144}\B\X144:Doublelook ahead at consequences of \PB{\|l}, and %
\PB{\&{goto} \\{contra}} if a contradiction is found\X${}\E{}$\6
$\\{dlooklit}\K\|l;{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_doubly\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"dlooking\ at\ "}\|O\.{"s"}\|O\.{".8s\ ("}\|O%
\.{"d)\\n"},\39\\{litname}(\\{dlooklit}),\39\\{cs});{}$\2\6
\&{if} (\\{isfixed}(\|l))\5
${}\{{}$\1\6
\&{if} ${}(\\{stamp}[\\{thevar}(\|l)]<\\{dl\_truth}\W\\{iscontrary}(\|l)){}$\1\5
\X145:Force \PB{\\{dlooklit}} to be (dl) false, and complement it\X;\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\X147:Update dlookahead data structures for consequences of \PB{\\{dlooklit}};
but \PB{\&{goto} \\{dl\_contra}} if a contradiction arises\X;\6
\4${}\}{}$\2\par
\U142.\fi

\M[3269 sat11.w]{145}The variable \PB{\\{dl\_last\_change}}, which keeps us
doublelooking,
changes only here.

\Y\B\4\X145:Force \PB{\\{dlooklit}} to be (dl) false, and complement it\X${}%
\E{}$\6
${}\{{}$\1\6
${}\\{dl\_last\_change}\K\\{dlooklit};{}$\6
${}\\{dlooklit}\K\\{bar}(\\{dlooklit});{}$\6
${}\\{dlook\_cs}\K\\{cs},\39\\{cs}\K\\{dl\_truth};{}$\6
\X147:Update dlookahead data structures for consequences of \PB{\\{dlooklit}};
but \PB{\&{goto} \\{dl\_contra}} if a contradiction arises\X;\6
${}\\{cs}\K\\{dlook\_cs};{}$\6
${}\\{wstack}[\\{wptr}\PP]\K\\{dlooklit};{}$\6
\4${}\}{}$\2\par
\Us144\ET146.\fi

\M[3282 sat11.w]{146}When we get to label \PB{\\{dl\_contra}}, we execute the
following
instructions, which will ``fall through'' to label \PB{\\{contra}} if
\PB{$\\{cs}\K\\{dl\_truth}$}.

Roughly speaking, we've derived a contradiction after assuming
that \PB{\\{looklit}} and \PB{\\{dlooklit}} are true. When that second
assumption fails, we
make \PB{\\{dlooklit}} dl-false, assuming \PB{\\{looklit}}.
A second failure at the dl-false level
tells us that \PB{\\{looklit}} must be false; in such a case we exit
the double lookahead process.

\Y\B\4\X146:Recover from a double lookahead contradiction\X${}\E{}$\6
\&{if} ${}(\\{cs}<\\{dl\_truth}){}$\5
${}\{{}$\1\6
\X145:Force \PB{\\{dlooklit}} to be (dl) false, and complement it\X;\6
\&{goto} \\{dlook\_on};\6
\4${}\}{}$\2\6
${}\\{base}\K\\{last\_base}{}$;\C{ forget all truths less than \PB{\\{dl%
\_truth}} }\par
\U84.\fi

\M[3300 sat11.w]{147}\B\X147:Update dlookahead data structures for consequences
of \PB{\\{dlooklit}}; but \PB{\&{goto} \\{dl\_contra}} if a contradiction
arises\X${}\E{}$\6
$\\{fptr}\K\\{eptr}\K\\{rptr};{}$\6
${}\|l\K\\{dlooklit};{}$\6
\X143:Propagate binary doublelookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{dl\_contra}} if a contradiction arises\X;\6
\&{while} ${}(\\{fptr}<\\{eptr}){}$\5
${}\{{}$\1\6
${}\|o,\39\\{ll}\K\\{rstack}[\\{fptr}\PP];{}$\6
\X148:Update dlookahead data structures for the truth of \PB{\\{ll}}; but \PB{%
\&{goto} \\{dl\_contra}} if a contradiction arises\X;\6
\4${}\}{}$\2\par
\Us144\ET145.\fi

\M[3310 sat11.w]{148}\B\X148:Update dlookahead data structures for the truth of
\PB{\\{ll}}; but \PB{\&{goto} \\{dl\_contra}} if a contradiction arises\X${}%
\E{}$\6
\&{for} ${}(\|o,\39\\{tla}\K\\{timp}[\\{ll}].\\{addr},\39\\{tls}\K\\{timp}[%
\\{ll}].\\{size};{}$ \\{tls}; ${}\\{tla}\PP,\39\\{tls}\MM){}$\5
${}\{{}$\1\6
${}\|o,\39\|u\K\\{tmem}[\\{tla}].\|u,\39\|v\K\\{tmem}[\\{tla}].\|v;{}$\6
\&{if} ${}(\\{verbose}\AND\\{show\_doubly\_gory\_details}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\ \ dlooking\ "}\|O\.{"s"}\|O\.{".8s->"}\|O%
\.{"s"}\|O\.{".8s|"}\|O\.{"s"}\|O\.{".8s\\n"},\39\\{litname}(\\{ll}),\39%
\\{litname}(\|u),\39\\{litname}(\|v));{}$\2\6
\X149:Update dlookahead structures for a potentially new binary clause $u\lor
v$\X;\6
\4${}\}{}$\2\par
\U147.\fi

\M[3321 sat11.w]{149}\B\X149:Update dlookahead structures for a potentially new
binary clause $u\lor v$\X${}\E{}$\6
\&{if} (\\{isfixed}(\|u))\5
${}\{{}$\C{ equivalently, \PB{\&{if} $(\|o,$ $\\{stamp}[\\{thevar}(\|u)]\G%
\\{cs}$} }\1\6
\&{if} (\\{iscontrary}(\|u))\5
${}\{{}$\C{ \PB{\|u} is stamped false }\1\6
\&{if} (\\{isfixed}(\|v))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|v))\1\5
\&{goto} \\{dl\_contra};\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|v} is unknown }\1\6
${}\|l\K\|v;{}$\6
\X143:Propagate binary doublelookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{dl\_contra}} if a contradiction arises\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\C{ \PB{\|u} is unknown }\1\6
\&{if} (\\{isfixed}(\|v))\5
${}\{{}$\1\6
\&{if} (\\{iscontrary}(\|v))\5
${}\{{}$\1\6
${}\|l\K\|u;{}$\6
\X143:Propagate binary doublelookahead implications of \PB{\|l}; \PB{\&{goto} %
\\{dl\_contra}} if a contradiction arises\X;\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U148.\fi

\N[3340 sat11.w]{1}{150}Doing it. Finally we just need to put the pieces of
this program together.

\Y\B\4\X150:Solve the problem\X${}\E{}$\6
$\\{level}\K\T{0};{}$\6
\&{if} (\\{forcedlits})\5
${}\{{}$\1\6
${}\|o,\39\\{nstack}[\T{0}].\\{branch}\K{-}\T{1};{}$\6
\&{goto} \\{special\_start};\C{ bootstrap the unary input clauses }\6
\4${}\}{}$\2\6
\4\\{enter\_level}:\6
\&{if} (\\{sanity\_checking})\1\5
\\{sanity}(\,);\2\6
\X59:Begin the processing of a new node\X;\6
${}\\{forcedlits}\K\T{0};{}$\6
${}\\{level}\PP;{}$\6
\&{goto} \\{enter\_level};\6
\X84:Recover from conflicts\X;\par
\U2.\fi

\M[3355 sat11.w]{151}\B\X151:Print the solution found\X${}\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{rptr};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
${}\\{printf}(\.{"\ "}\|O\.{"s"}\|O\.{".8s"},\39\\{litname}(\\{rstack}[%
\|k]));{}$\6
\&{if} (\\{out\_file})\1\5
${}\\{fprintf}(\\{out\_file},\39\.{"\ "}\|O\.{"s"}\|O\.{".8s"},\39\\{litname}(%
\\{bar}(\\{rstack}[\|k])));{}$\2\6
\4${}\}{}$\2\6
\\{printf}(\.{"\\n"});\6
\&{if} (\\{freevars})\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_unused\_vars}){}$\1\5
\\{printf}(\.{"(Unused:"});\2\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\\{freevars};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{verbose}\AND\\{show\_unused\_vars}){}$\1\5
${}\\{printf}(\.{"\ "}\|O\.{".8s"},\39\\{vmem}[\\{freevar}[\|k]].\\{name}.%
\\{ch8});{}$\2\6
\&{if} (\\{out\_file})\1\5
${}\\{fprintf}(\\{out\_file},\39\.{"\ "}\|O\.{".8s"},\39\\{vmem}[\\{freevar}[%
\|k]].\\{name}.\\{ch8});{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{verbose}\AND\\{show\_unused\_vars}){}$\1\5
\\{printf}(\.{")\\n"});\2\6
\4${}\}{}$\2\6
\&{if} (\\{out\_file})\1\5
${}\\{fprintf}(\\{out\_file},\39\.{"\\n"}){}$;\2\par
\U84.\fi

\M[3371 sat11.w]{152}\B\X29:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{confusion}(\&{char} ${}{*}\\{id}){}$\1\1\2\2\6
${}\{{}$\C{ an assertion has failed }\1\6
${}\\{fprintf}(\\{stderr},\39\.{"This\ can't\ happen\ (}\)\.{"}\|O\.{"s)!\\n"},%
\39\\{id});{}$\6
${}\\{exit}({-}\T{666});{}$\6
\4${}\}{}$\2\7
\&{void} \\{debugstop}(\&{int} \\{foo})\1\1\2\2\6
${}\{{}$\C{ can be inserted as a special breakpoint }\1\6
${}\\{fprintf}(\\{stderr},\39\.{"You\ rang("}\|O\.{"d)?\\n"},\39\\{foo});{}$\6
\4${}\}{}$\2\par
\fi

\N[3381 sat11.w]{1}{153}Index.
\fi

\inx
\fin
\con
