\input cwebmac
\hypertextrue\srcloctrue
% Copyright 1998 by Donald R Woods and Donald E Knuth
% Don't change this file without the authors' permission!

% If you have an old CWEB (version 3.42 or earlier), you will have to
% change "longest_name" from 1000 to 10000 in both ctangle.w and cweave.w
% and reinstall them. Otherwise you get error messages "string too long".

% This version (March 1999) corrects errors in the use of enum types
% and also adds ANSI C prototype definitions.

% See http://www.rickadams.org/adventure/ for related info.

% Here I redefine some macros of cwebmac for better formatting in this program.
% (1) One-letter uppercase identifiers to be in typewriter type;
%      then, for example, N, S, E, W will match NE, SE, NW, SW.
\def\|#1{\leavevmode\hbox{\ifnum`#1<`a\tentex#1\else$#1$\fi}}
% (2) Long strings to be broken only at newlines.
\def\fixnewline{\BS\fxnl}
\def\fxnl#1{\ifx#1\kern\let\next\kludge\else\if\noexpand#1n\let\next\newln
        \else\def\next{\char`#1}\fi\fi\next}
\def\kludge.05em{\aftergroup\kluj}
\def\kluj\)\.#1{\.{\fxnl#1}}
\def\newln{n\egroup\discretionary{\hbox{\tentex\BS}}{}{}\hbox\bgroup\ttmode}
\def\ttmode{\tentex \let\\=\BS \let\{=\LB \let\}=\RB \let\~=\TL \let\ =\SP
  \let\_=\UL \let\&=\AM \let\^=\CF \let\\=\fixnewline}
\def\.#1{\leavevmode\hbox{\ttmode#1\kern.05em}}
\def\){{\tentex\kern-.05em}}


\datethis

\N[34 advent.w]{1}{1}Introduction. The ur-game for computers --- Adventure ---
was originally
written by Will Crowther in 1975 or 1976 and significantly extended by
Don Woods in 1977. I have taken Woods's original {\mc FORTRAN} program
for Adventure Version~1.0 and recast it in the \.{CWEB} idiom.

I remember being fascinated by this game when John McCarthy showed it
to me in 1977. I started with no clues about the purpose of the game
or what I should do; just the computer's comment that I was at the
end of a forest road facing a small brick building. Little by little,
the game revealed its secrets, just as its designers had cleverly plotted.
What a thrill it was when I first got past the green snake! Clearly the
game was potentially addictive, so I forced myself to stop playing ---
reasoning that it was great fun, sure, but traditional computer science
research is great fun too, possibly even more so.

Now here I am, 21 years later, returning to the great Adventure after
having indeed had many exciting adventures in Computer Science. I~believe
people who have played this game will be able to extend their fun by
reading its once-secret program. Of course I urge everybody to {\it play the
game first, at least ten times}, before reading on. But you cannot
fully appreciate the astonishing brilliance of its design until
you have seen all of the surprises that have been built in.

I believe this program is entirely faithful to the behavior of Adventure
Version~1.0, except that I have slightly edited the computer messages
(mostly so that they use both lowercase and uppercase letters). I have also
omitted Woods's elaborate machinery for closing the cave during the hours
of prime-time computing; I believe John McCarthy insisted on this, when
he saw the productivity of his AI Lab falling off dramatically---although
it is rumored that he had a special version of the program that
allowed him to play whenever he wanted. And I have
not adopted the encryption scheme by which Woods made it difficult for
users to find any important clues in
the binary program file or core image; such
modifications would best be done by making a special version of \.{CTANGLE}.
All of the spelunking constraints and interactive behavior have
been retained, although the structure of this \.{CWEB} program is
naturally quite different from the {\mc FORTRAN} version that I began~with.

Many of the phrases in the following documentation have been lifted directly
from comments in the {\mc FORTRAN} code. Please regard me as merely
a translator of the program, not as an author. I thank Don Woods for
helping me check the validity of this translation.

By the way, if you don't like \PB{\&{goto}} statements, don't read this. (And
don't
read any other programs that simulate multistate systems.)

\smallskip\rightline{--- Don Knuth, September 1998}

\Y\B\vb{/*\ Copyright\ (C)\ 1998\ by\ Don\ Woods\ and\ Don\ Knuth;\ all\ rights%
\ reserved\ */}\par
\fi

\M[90 advent.w]{2}To run the program with, say, a {\mc UNIX} shell, just type `%
\.{advent}'
and follow instructions. (Many {\mc UNIX} systems come with an
almost identical program called `\.{adventure}' already built in;
you might want to try it too, for comparison.)

\Y\B\8\#\&{include} \.{<stdio.h>}\C{ basic input/output routines: \PB{%
\\{fgets}}, \PB{\\{printf}} }\6
\8\#\&{include} \.{<ctype.h>}\C{ \PB{\\{isspace}}, \PB{\\{tolower}}, and \PB{%
\\{toupper}} routines }\6
\8\#\&{include} \.{<string.h>}\C{ \PB{\\{strncmp}} and \PB{\\{strcpy}} to
compare and copy strings }\6
\8\#\&{include} \.{<time.h>}\C{ current \PB{\\{time}}, used as random number
seed }\6
\8\#\&{include} \.{<stdlib.h>}\C{ \PB{\\{exit}} }\6
\X3:Macros for subroutine prototypes\X\7
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\\{false},\39\\{true}{}$\2\6
${}\}{}$ \&{boolean};\7
\X5:Type definitions\X\6
\X7:Global variables\X\6
\X6:Subroutines\X\7
\\{main}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \|j${},{}$ \|k;\6
\&{register} \&{char} ${}{*}\|p;{}$\7
\X22:Additional local registers\X;\6
\X200:Initialize all tables\X;\6
\X75:Simulate an adventure, going to \PB{\\{quit}} when finished\X;\6
\X188:Deal with death and resurrection\X;\6
\4\\{quit}:\5
\X198:Print the score and say adieu\X;\6
\\{exit}(\T{0});\6
\4${}\}{}$\2\par
\fi

\M[120 advent.w]{3}The subroutines of this program are declared first with a
prototype,
as in {\mc ANSI C}, then with an old-style \CEE/ function definition.
The following preprocessor commands make this work correctly with both
new-style and old-style compilers.

\Y\B\4\X3:Macros for subroutine prototypes\X${}\E{}$\6
\8\#\&{ifdef} \.{\_\_STDC\_\_}\6
\8\#\&{define} \.{ARGS}(\\{list}) \5\\{list}\6
\8\#\&{else}\6
\8\#\&{define} \.{ARGS}(\\{list}) \5(\,)\6
\8\#\&{endif}\par
\U2.\fi

\N[133 advent.w]{1}{4}The vocabulary. Throughout the remainder of this
documentation, ``you'' are
the user and ``we'' are the game author and the computer. We don't tell you
what words to use, except indirectly; but we try to understand enough words of
English so that you can play without undue frustration. The first part of the
program specifies what we know about your language --- about 300 words.

\fi

\M[139 advent.w]{5}When you type a word, we first convert uppercase letters to
lowercase; then
we chop off all but the first five characters, if the word was longer than
that, and we look for your word in a small hash table. Each hash table entry
contains a string of length 5~or~less, and two additional bytes for the word's
type and meaning. Four types of words are distinguished: \PB{\\{motion\_type}},
\PB{\\{object\_type}}, \PB{\\{action\_type}}, and \PB{\\{message\_type}}.

\Y\B\4\X5:Type definitions\X${}\E{}$\6
\&{typedef} \&{enum}\5
${}\{{}$\1\6
${}\\{no\_type},\39\\{motion\_type},\39\\{object\_type},\39\\{action\_type},\39%
\\{message\_type}{}$\2\6
${}\}{}$ \&{wordtype};\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{char} \\{text}[\T{6}];\C{ string of length at most 5 }\6
\&{char} \\{word\_type};\C{ a \PB{\&{wordtype}} }\6
\&{char} \\{meaning};\2\6
${}\}{}$ \&{hash\_entry};\par
\As9, 11, 13, 18\ETs19.
\U2.\fi

\M[157 advent.w]{6}Here is the subroutine that puts words into our vocabulary,
when the
program is getting ready to run.

\Y\B\4\D$\\{hash\_prime}$ \5
\T{1009}\C{ the size of the hash table }\par
\Y\B\4\X6:Subroutines\X${}\E{}$\6
\&{void} \\{new\_word}\,\,\.{ARGS}((\&{char} ${}{*},\39\&{int}));{}$\7
\&{void} ${}\\{new\_word}(\|w,\39\|m){}$\1\1\6
\&{char} ${}{*}\|w{}$;\C{ a string of length 5 or less }\6
\&{int} \|m;\C{ its meaning }\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \|h${},{}$ \|k;\6
\&{register} \&{char} ${}{*}\|p;{}$\7
\&{for} ${}(\|h\K\T{0},\39\|p\K\|w;{}$ ${}{*}\|p;{}$ ${}\|p\PP){}$\1\5
${}\|h\K{*}\|p+\|h+\|h;{}$\2\6
${}\|h\MRL{{\MOD}{\K}}\\{hash\_prime};{}$\6
\&{while} ${}(\\{hash\_table}[\|h].\\{word\_type}){}$\5
${}\{{}$\1\6
${}\|h\PP{}$;\5
\&{if} ${}(\|h\E\\{hash\_prime}){}$\1\5
${}\|h\K\T{0};{}$\2\6
\4${}\}{}$\2\6
${}\\{strcpy}(\\{hash\_table}[\|h].\\{text},\39\|w);{}$\6
${}\\{hash\_table}[\|h].\\{word\_type}\K\\{current\_type};{}$\6
${}\\{hash\_table}[\|h].\\{meaning}\K\|m;{}$\6
\4${}\}{}$\2\par
\As8, 64, 65, 66, 71, 72, 154, 160, 194\ETs197.
\U2.\fi

\M[179 advent.w]{7}\B\X7:Global variables\X${}\E{}$\6
\&{hash\_entry} \\{hash\_table}[\\{hash\_prime}];\C{ the table of words we know
}\6
\&{wordtype} \\{current\_type};\C{ the kind of word we are dealing with }\par
\As15, 17, 20, 21, 63, 73, 74, 77, 81, 84, 87, 89, 96, 103, 137, 142, 155, 159,
165, 168, 171, 177, 185, 190, 193, 196\ETs199.
\U2.\fi

\M[183 advent.w]{8}While we're at it, let's write the program that will look up
a word.
It returns the location of the word in the hash table, or $-1$ if
you've given a word like `\.{tickle}' or `\.{terse}' that is unknown.

\Y\B\4\D$\\{streq}(\|a,\|b)$ \5
$(\\{strncmp}(\|a,\39\|b,\39\T{5})\E\T{0}{}$)\C{ strings agree up to five
letters }\par
\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{int} \\{lookup}\,\,\.{ARGS}((\&{char} ${}{*}));{}$\7
\&{int} \\{lookup}(\|w)\1\1\6
\&{char} ${}{*}\|w{}$;\C{ a string that you typed }\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \|h;\6
\&{register} \&{char} ${}{*}\|p;{}$\6
\&{register} \&{char} \|t;\7
${}\|t\K\|w[\T{5}];{}$\6
${}\|w[\T{5}]\K\.{'\\0'}{}$;\C{ truncate the word }\6
\&{for} ${}(\|h\K\T{0},\39\|p\K\|w;{}$ ${}{*}\|p;{}$ ${}\|p\PP){}$\1\5
${}\|h\K{*}\|p+\|h+\|h;{}$\2\6
${}\|h\MRL{{\MOD}{\K}}\\{hash\_prime}{}$;\C{ compute starting address }\6
${}\|w[\T{5}]\K\|t{}$;\C{ restore original word }\6
\&{if} ${}(\|h<\T{0}){}$\1\5
\&{return} ${}{-}\T{1}{}$;\C{ a negative character might screw us up }\2\6
\&{while} ${}(\\{hash\_table}[\|h].\\{word\_type}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{streq}(\|w,\39\\{hash\_table}[\|h].\\{text})){}$\1\5
\&{return} \|h;\2\6
${}\|h\PP{}$;\5
\&{if} ${}(\|h\E\\{hash\_prime}){}$\1\5
${}\|h\K\T{0};{}$\2\6
\4${}\}{}$\2\6
\&{return} ${}{-}\T{1};{}$\6
\4${}\}{}$\2\par
\fi

\M[207 advent.w]{9}The \PB{\&{motion}} words specify either a direction or a
simple action or a place.
Motion words take you from one location to another, when the motion is
permitted. Here is a list of their possible meanings.

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\|N,\39\|S,\39\|E,\39\|W,\39\.{NE},\39\.{SE},\39\.{NW},\39\.{SW},\39\|U,\39%
\|D,\39\|L,\39\|R,\39\.{IN},\39\.{OUT},\39\.{FORWARD},\39\.{BACK},{}$\6
\.{OVER}${},\39\.{ACROSS},\39\.{UPSTREAM},\39\.{DOWNSTREAM},{}$\6
\.{ENTER}${},\39\.{CRAWL},\39\.{JUMP},\39\.{CLIMB},\39\.{LOOK},\39\.{CROSS},{}$%
\6
\.{ROAD}${},\39\.{WOODS},\39\.{VALLEY},\39\.{HOUSE},\39\.{GULLY},\39\.{STREAM},%
\39\.{DEPRESSION},\39\.{ENTRANCE},\39\.{CAVE},{}$\6
\.{ROCK}${},\39\.{SLAB},\39\.{BED},\39\.{PASSAGE},\39\.{CAVERN},\39\.{CANYON},%
\39\.{AWKWARD},\39\.{SECRET},\39\.{BEDQUILT},\39\.{RESERVOIR},{}$\6
\.{GIANT}${},\39\.{ORIENTAL},\39\.{SHELL},\39\.{BARREN},\39\.{BROKEN},\39%
\.{DEBRIS},\39\.{VIEW},\39\.{FORK},{}$\6
\.{PIT}${},\39\.{SLIT},\39\.{CRACK},\39\.{DOME},\39\.{HOLE},\39\.{WALL},\39%
\.{HALL},\39\.{ROOM},\39\.{FLOOR},{}$\6
\.{STAIRS}${},\39\.{STEPS},\39\.{COBBLES},\39\.{SURFACE},\39\.{DARK},\39%
\.{LOW},\39\.{OUTDOORS},{}$\6
\.{Y2}${},\39\.{XYZZY},\39\.{PLUGH},\39\.{PLOVER},\39\.{OFFICE},\39%
\.{NOWHERE}{}$\2\6
${}\}{}$ \&{motion};\par
\fi

\M[226 advent.w]{10}And here is how they enter our vocabulary.

If I were writing this program,
I~would allow the word \.{woods}, but Don apparently didn't want to.

\Y\B\4\X10:Build the vocabulary\X${}\E{}$\6
$\\{current\_type}\K\\{motion\_type};{}$\6
${}\\{new\_word}(\.{"north"},\39\|N){}$;\5
${}\\{new\_word}(\.{"n"},\39\|N);{}$\6
${}\\{new\_word}(\.{"south"},\39\|S){}$;\5
${}\\{new\_word}(\.{"s"},\39\|S);{}$\6
${}\\{new\_word}(\.{"east"},\39\|E){}$;\5
${}\\{new\_word}(\.{"e"},\39\|E);{}$\6
${}\\{new\_word}(\.{"west"},\39\|W){}$;\5
${}\\{new\_word}(\.{"w"},\39\|W);{}$\6
${}\\{new\_word}(\.{"ne"},\39\.{NE});{}$\6
${}\\{new\_word}(\.{"se"},\39\.{SE});{}$\6
${}\\{new\_word}(\.{"nw"},\39\.{NW});{}$\6
${}\\{new\_word}(\.{"sw"},\39\.{SW});{}$\6
${}\\{new\_word}(\.{"upwar"},\39\|U){}$;\5
${}\\{new\_word}(\.{"up"},\39\|U){}$;\5
${}\\{new\_word}(\.{"u"},\39\|U){}$;\5
${}\\{new\_word}(\.{"above"},\39\|U){}$;\5
${}\\{new\_word}(\.{"ascen"},\39\|U);{}$\6
${}\\{new\_word}(\.{"downw"},\39\|D){}$;\5
${}\\{new\_word}(\.{"down"},\39\|D){}$;\5
${}\\{new\_word}(\.{"d"},\39\|D){}$;\5
${}\\{new\_word}(\.{"desce"},\39\|D);{}$\6
${}\\{new\_word}(\.{"left"},\39\|L);{}$\6
${}\\{new\_word}(\.{"right"},\39\|R);{}$\6
${}\\{new\_word}(\.{"inwar"},\39\.{IN}){}$;\5
${}\\{new\_word}(\.{"insid"},\39\.{IN}){}$;\5
${}\\{new\_word}(\.{"in"},\39\.{IN});{}$\6
${}\\{new\_word}(\.{"out"},\39\.{OUT}){}$;\5
${}\\{new\_word}(\.{"outsi"},\39\.{OUT});{}$\6
${}\\{new\_word}(\.{"exit"},\39\.{OUT});{}$\6
${}\\{new\_word}(\.{"leave"},\39\.{OUT});{}$\6
${}\\{new\_word}(\.{"forwa"},\39\.{FORWARD}){}$;\5
${}\\{new\_word}(\.{"conti"},\39\.{FORWARD}){}$;\5
${}\\{new\_word}(\.{"onwar"},\39\.{FORWARD});{}$\6
${}\\{new\_word}(\.{"back"},\39\.{BACK}){}$;\5
${}\\{new\_word}(\.{"retur"},\39\.{BACK}){}$;\5
${}\\{new\_word}(\.{"retre"},\39\.{BACK});{}$\6
${}\\{new\_word}(\.{"over"},\39\.{OVER});{}$\6
${}\\{new\_word}(\.{"acros"},\39\.{ACROSS});{}$\6
${}\\{new\_word}(\.{"upstr"},\39\.{UPSTREAM});{}$\6
${}\\{new\_word}(\.{"downs"},\39\.{DOWNSTREAM});{}$\6
${}\\{new\_word}(\.{"enter"},\39\.{ENTER});{}$\6
${}\\{new\_word}(\.{"crawl"},\39\.{CRAWL});{}$\6
${}\\{new\_word}(\.{"jump"},\39\.{JUMP});{}$\6
${}\\{new\_word}(\.{"climb"},\39\.{CLIMB});{}$\6
${}\\{new\_word}(\.{"look"},\39\.{LOOK}){}$;\5
${}\\{new\_word}(\.{"exami"},\39\.{LOOK}){}$;\5
${}\\{new\_word}(\.{"touch"},\39\.{LOOK}){}$;\5
${}\\{new\_word}(\.{"descr"},\39\.{LOOK});{}$\6
${}\\{new\_word}(\.{"cross"},\39\.{CROSS});{}$\6
${}\\{new\_word}(\.{"road"},\39\.{ROAD});{}$\6
${}\\{new\_word}(\.{"hill"},\39\.{ROAD});{}$\6
${}\\{new\_word}(\.{"fores"},\39\.{WOODS});{}$\6
${}\\{new\_word}(\.{"valle"},\39\.{VALLEY});{}$\6
${}\\{new\_word}(\.{"build"},\39\.{HOUSE}){}$;\5
${}\\{new\_word}(\.{"house"},\39\.{HOUSE});{}$\6
${}\\{new\_word}(\.{"gully"},\39\.{GULLY});{}$\6
${}\\{new\_word}(\.{"strea"},\39\.{STREAM});{}$\6
${}\\{new\_word}(\.{"depre"},\39\.{DEPRESSION});{}$\6
${}\\{new\_word}(\.{"entra"},\39\.{ENTRANCE});{}$\6
${}\\{new\_word}(\.{"cave"},\39\.{CAVE});{}$\6
${}\\{new\_word}(\.{"rock"},\39\.{ROCK});{}$\6
${}\\{new\_word}(\.{"slab"},\39\.{SLAB}){}$;\5
${}\\{new\_word}(\.{"slabr"},\39\.{SLAB});{}$\6
${}\\{new\_word}(\.{"bed"},\39\.{BED});{}$\6
${}\\{new\_word}(\.{"passa"},\39\.{PASSAGE}){}$;\5
${}\\{new\_word}(\.{"tunne"},\39\.{PASSAGE});{}$\6
${}\\{new\_word}(\.{"caver"},\39\.{CAVERN});{}$\6
${}\\{new\_word}(\.{"canyo"},\39\.{CANYON});{}$\6
${}\\{new\_word}(\.{"awkwa"},\39\.{AWKWARD});{}$\6
${}\\{new\_word}(\.{"secre"},\39\.{SECRET});{}$\6
${}\\{new\_word}(\.{"bedqu"},\39\.{BEDQUILT});{}$\6
${}\\{new\_word}(\.{"reser"},\39\.{RESERVOIR});{}$\6
${}\\{new\_word}(\.{"giant"},\39\.{GIANT});{}$\6
${}\\{new\_word}(\.{"orien"},\39\.{ORIENTAL});{}$\6
${}\\{new\_word}(\.{"shell"},\39\.{SHELL});{}$\6
${}\\{new\_word}(\.{"barre"},\39\.{BARREN});{}$\6
${}\\{new\_word}(\.{"broke"},\39\.{BROKEN});{}$\6
${}\\{new\_word}(\.{"debri"},\39\.{DEBRIS});{}$\6
${}\\{new\_word}(\.{"view"},\39\.{VIEW});{}$\6
${}\\{new\_word}(\.{"fork"},\39\.{FORK});{}$\6
${}\\{new\_word}(\.{"pit"},\39\.{PIT});{}$\6
${}\\{new\_word}(\.{"slit"},\39\.{SLIT});{}$\6
${}\\{new\_word}(\.{"crack"},\39\.{CRACK});{}$\6
${}\\{new\_word}(\.{"dome"},\39\.{DOME});{}$\6
${}\\{new\_word}(\.{"hole"},\39\.{HOLE});{}$\6
${}\\{new\_word}(\.{"wall"},\39\.{WALL});{}$\6
${}\\{new\_word}(\.{"hall"},\39\.{HALL});{}$\6
${}\\{new\_word}(\.{"room"},\39\.{ROOM});{}$\6
${}\\{new\_word}(\.{"floor"},\39\.{FLOOR});{}$\6
${}\\{new\_word}(\.{"stair"},\39\.{STAIRS});{}$\6
${}\\{new\_word}(\.{"steps"},\39\.{STEPS});{}$\6
${}\\{new\_word}(\.{"cobbl"},\39\.{COBBLES});{}$\6
${}\\{new\_word}(\.{"surfa"},\39\.{SURFACE});{}$\6
${}\\{new\_word}(\.{"dark"},\39\.{DARK});{}$\6
${}\\{new\_word}(\.{"low"},\39\.{LOW});{}$\6
${}\\{new\_word}(\.{"outdo"},\39\.{OUTDOORS});{}$\6
${}\\{new\_word}(\.{"y2"},\39\.{Y2});{}$\6
${}\\{new\_word}(\.{"xyzzy"},\39\.{XYZZY});{}$\6
${}\\{new\_word}(\.{"plugh"},\39\.{PLUGH});{}$\6
${}\\{new\_word}(\.{"plove"},\39\.{PLOVER});{}$\6
${}\\{new\_word}(\.{"main"},\39\.{OFFICE}){}$;\5
${}\\{new\_word}(\.{"offic"},\39\.{OFFICE});{}$\6
${}\\{new\_word}(\.{"null"},\39\.{NOWHERE}){}$;\5
${}\\{new\_word}(\.{"nowhe"},\39\.{NOWHERE}){}$;\par
\As12, 14\ETs16.
\U200.\fi

\M[339 advent.w]{11}The \PB{\&{object}} words refer to things like a lamp, a
bird, batteries, etc.;
objects have properties that will be described later.
Here is a list of the basic objects. Objects \PB{\.{GOLD}} and higher
are the ``treasures.'' Extremely large objects, which appear in more than one
location, are listed more than once using `\.{\char`\_}'.

\Y\B\4\D$\\{min\_treasure}$ \5
\.{GOLD}\par
\B\4\D$\\{is\_treasure}(\|t)$ \5
$(\|t\G\\{min\_treasure}{}$)\par
\B\4\D$\\{max\_obj}$ \5
\.{CHAIN}\par
\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\.{NOTHING},\39\.{KEYS},\39\.{LAMP},\39\.{GRATE},\39\.{GRATE\_},\39\.{CAGE},%
\39\.{ROD},\39\.{ROD2},\39\.{TREADS},\39\.{TREADS\_},{}$\6
\.{BIRD}${},\39\.{DOOR},\39\.{PILLOW},\39\.{SNAKE},\39\.{CRYSTAL},\39\.{CRYSTAL%
\_},\39\.{TABLET},\39\.{CLAM},\39\.{OYSTER},{}$\6
\.{MAG}${},\39\.{DWARF},\39\.{KNIFE},\39\.{FOOD},\39\.{BOTTLE},\39\.{WATER},\39%
\.{OIL},{}$\6
\.{MIRROR}${},\39\.{MIRROR\_},\39\.{PLANT},\39\.{PLANT2},\39\.{PLANT2\_},\39%
\.{STALACTITE},\39\.{SHADOW},\39\.{SHADOW\_},{}$\6
\.{AXE}${},\39\.{ART},\39\.{PIRATE},\39\.{DRAGON},\39\.{DRAGON\_},\39%
\.{BRIDGE},\39\.{BRIDGE\_},\39\.{TROLL},\39\.{TROLL\_},\39\.{TROLL2},\39%
\.{TROLL2\_},{}$\6
\.{BEAR}${},\39\.{MESSAGE},\39\.{GEYSER},\39\.{PONY},\39\.{BATTERIES},\39%
\.{MOSS},{}$\6
\.{GOLD}${},\39\.{DIAMONDS},\39\.{SILVER},\39\.{JEWELS},\39\.{COINS},\39%
\.{CHEST},\39\.{EGGS},\39\.{TRIDENT},\39\.{VASE},{}$\6
\.{EMERALD}${},\39\.{PYRAMID},\39\.{PEARL},\39\.{RUG},\39\.{RUG\_},\39%
\.{SPICES},\39\.{CHAIN}{}$\2\6
${}\}{}$ \&{object};\par
\fi

\M[364 advent.w]{12}Most of the objects correspond to words in our vocabulary.

\Y\B\4\X10:Build the vocabulary\X${}\mathrel+\E{}$\6
$\\{current\_type}\K\\{object\_type};{}$\6
${}\\{new\_word}(\.{"key"},\39\.{KEYS}){}$;\5
${}\\{new\_word}(\.{"keys"},\39\.{KEYS});{}$\6
${}\\{new\_word}(\.{"lamp"},\39\.{LAMP}){}$;\5
${}\\{new\_word}(\.{"lante"},\39\.{LAMP}){}$;\5
${}\\{new\_word}(\.{"headl"},\39\.{LAMP});{}$\6
${}\\{new\_word}(\.{"grate"},\39\.{GRATE});{}$\6
${}\\{new\_word}(\.{"cage"},\39\.{CAGE});{}$\6
${}\\{new\_word}(\.{"rod"},\39\.{ROD});{}$\6
${}\\{new\_word}(\.{"bird"},\39\.{BIRD});{}$\6
${}\\{new\_word}(\.{"door"},\39\.{DOOR});{}$\6
${}\\{new\_word}(\.{"pillo"},\39\.{PILLOW});{}$\6
${}\\{new\_word}(\.{"snake"},\39\.{SNAKE});{}$\6
${}\\{new\_word}(\.{"fissu"},\39\.{CRYSTAL});{}$\6
${}\\{new\_word}(\.{"table"},\39\.{TABLET});{}$\6
${}\\{new\_word}(\.{"clam"},\39\.{CLAM});{}$\6
${}\\{new\_word}(\.{"oyste"},\39\.{OYSTER});{}$\6
${}\\{new\_word}(\.{"magaz"},\39\.{MAG}){}$;\5
${}\\{new\_word}(\.{"issue"},\39\.{MAG}){}$;\5
${}\\{new\_word}(\.{"spelu"},\39\.{MAG}){}$;\5
${}\\{new\_word}(\.{"\\"spel"},\39\.{MAG});{}$\6
${}\\{new\_word}(\.{"dwarf"},\39\.{DWARF}){}$;\5
${}\\{new\_word}(\.{"dwarv"},\39\.{DWARF});{}$\6
${}\\{new\_word}(\.{"knife"},\39\.{KNIFE}){}$;\5
${}\\{new\_word}(\.{"knive"},\39\.{KNIFE});{}$\6
${}\\{new\_word}(\.{"food"},\39\.{FOOD}){}$;\5
${}\\{new\_word}(\.{"ratio"},\39\.{FOOD});{}$\6
${}\\{new\_word}(\.{"bottl"},\39\.{BOTTLE}){}$;\5
${}\\{new\_word}(\.{"jar"},\39\.{BOTTLE});{}$\6
${}\\{new\_word}(\.{"water"},\39\.{WATER}){}$;\5
${}\\{new\_word}(\.{"h2o"},\39\.{WATER});{}$\6
${}\\{new\_word}(\.{"oil"},\39\.{OIL});{}$\6
${}\\{new\_word}(\.{"mirro"},\39\.{MIRROR});{}$\6
${}\\{new\_word}(\.{"plant"},\39\.{PLANT}){}$;\5
${}\\{new\_word}(\.{"beans"},\39\.{PLANT});{}$\6
${}\\{new\_word}(\.{"stala"},\39\.{STALACTITE});{}$\6
${}\\{new\_word}(\.{"shado"},\39\.{SHADOW}){}$;\5
${}\\{new\_word}(\.{"figur"},\39\.{SHADOW});{}$\6
${}\\{new\_word}(\.{"axe"},\39\.{AXE});{}$\6
${}\\{new\_word}(\.{"drawi"},\39\.{ART});{}$\6
${}\\{new\_word}(\.{"pirat"},\39\.{PIRATE});{}$\6
${}\\{new\_word}(\.{"drago"},\39\.{DRAGON});{}$\6
${}\\{new\_word}(\.{"chasm"},\39\.{BRIDGE});{}$\6
${}\\{new\_word}(\.{"troll"},\39\.{TROLL});{}$\6
${}\\{new\_word}(\.{"bear"},\39\.{BEAR});{}$\6
${}\\{new\_word}(\.{"messa"},\39\.{MESSAGE});{}$\6
${}\\{new\_word}(\.{"volca"},\39\.{GEYSER}){}$;\5
${}\\{new\_word}(\.{"geyse"},\39\.{GEYSER});{}$\6
${}\\{new\_word}(\.{"vendi"},\39\.{PONY}){}$;\5
${}\\{new\_word}(\.{"machi"},\39\.{PONY});{}$\6
${}\\{new\_word}(\.{"batte"},\39\.{BATTERIES});{}$\6
${}\\{new\_word}(\.{"moss"},\39\.{MOSS}){}$;\5
${}\\{new\_word}(\.{"carpe"},\39\.{MOSS});{}$\6
${}\\{new\_word}(\.{"gold"},\39\.{GOLD}){}$;\5
${}\\{new\_word}(\.{"nugge"},\39\.{GOLD});{}$\6
${}\\{new\_word}(\.{"diamo"},\39\.{DIAMONDS});{}$\6
${}\\{new\_word}(\.{"silve"},\39\.{SILVER}){}$;\5
${}\\{new\_word}(\.{"bars"},\39\.{SILVER});{}$\6
${}\\{new\_word}(\.{"jewel"},\39\.{JEWELS});{}$\6
${}\\{new\_word}(\.{"coins"},\39\.{COINS});{}$\6
${}\\{new\_word}(\.{"chest"},\39\.{CHEST}){}$;\5
${}\\{new\_word}(\.{"box"},\39\.{CHEST}){}$;\5
${}\\{new\_word}(\.{"treas"},\39\.{CHEST});{}$\6
${}\\{new\_word}(\.{"eggs"},\39\.{EGGS}){}$;\5
${}\\{new\_word}(\.{"egg"},\39\.{EGGS}){}$;\5
${}\\{new\_word}(\.{"nest"},\39\.{EGGS});{}$\6
${}\\{new\_word}(\.{"tride"},\39\.{TRIDENT});{}$\6
${}\\{new\_word}(\.{"ming"},\39\.{VASE}){}$;\5
${}\\{new\_word}(\.{"vase"},\39\.{VASE}){}$;\5
${}\\{new\_word}(\.{"shard"},\39\.{VASE}){}$;\5
${}\\{new\_word}(\.{"potte"},\39\.{VASE});{}$\6
${}\\{new\_word}(\.{"emera"},\39\.{EMERALD});{}$\6
${}\\{new\_word}(\.{"plati"},\39\.{PYRAMID}){}$;\5
${}\\{new\_word}(\.{"pyram"},\39\.{PYRAMID});{}$\6
${}\\{new\_word}(\.{"pearl"},\39\.{PEARL});{}$\6
${}\\{new\_word}(\.{"persi"},\39\.{RUG}){}$;\5
${}\\{new\_word}(\.{"rug"},\39\.{RUG});{}$\6
${}\\{new\_word}(\.{"spice"},\39\.{SPICES});{}$\6
${}\\{new\_word}(\.{"chain"},\39\.{CHAIN}){}$;\par
\fi

\M[447 advent.w]{13}The \PB{\&{action}} words tell us to do something that's
usually nontrivial.

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\.{ABSTAIN},\39\.{TAKE},\39\.{DROP},\39\.{OPEN},\39\.{CLOSE},\39\.{ON},\39%
\.{OFF},\39\.{WAVE},\39\.{CALM},\39\.{GO},\39\.{RELAX},{}$\6
\.{POUR}${},\39\.{EAT},\39\.{DRINK},\39\.{RUB},\39\.{TOSS},\39\.{WAKE},\39%
\.{FEED},\39\.{FILL},\39\.{BREAK},\39\.{BLAST},\39\.{KILL},{}$\6
\.{SAY}${},\39\.{READ},\39\.{FEEFIE},\39\.{BRIEF},\39\.{FIND},\39\.{INVENTORY},%
\39\.{SCORE},\39\.{QUIT}{}$\2\6
${}\}{}$ \&{action};\par
\fi

\M[456 advent.w]{14}Many of the action words have several synonyms.
If an action does not meet special conditions, we will issue a default message.

\Y\B\4\D$\\{ok}$ \5
\\{default\_msg}[\.{RELAX}]\par
\Y\B\4\X10:Build the vocabulary\X${}\mathrel+\E{}$\6
$\\{current\_type}\K\\{action\_type};{}$\6
${}\\{new\_word}(\.{"take"},\39\.{TAKE}){}$;\5
${}\\{new\_word}(\.{"carry"},\39\.{TAKE}){}$;\5
${}\\{new\_word}(\.{"keep"},\39\.{TAKE}){}$;\5
${}\\{new\_word}(\.{"catch"},\39\.{TAKE}){}$;\5
${}\\{new\_word}(\.{"captu"},\39\.{TAKE}){}$;\5
${}\\{new\_word}(\.{"steal"},\39\.{TAKE}){}$;\5
${}\\{new\_word}(\.{"get"},\39\.{TAKE}){}$;\5
${}\\{new\_word}(\.{"tote"},\39\.{TAKE});{}$\6
${}\\{default\_msg}[\.{TAKE}]\K\.{"You\ are\ already\ car}\)\.{rying\ it!"};{}$%
\6
${}\\{new\_word}(\.{"drop"},\39\.{DROP}){}$;\5
${}\\{new\_word}(\.{"relea"},\39\.{DROP}){}$;\5
${}\\{new\_word}(\.{"free"},\39\.{DROP}){}$;\5
${}\\{new\_word}(\.{"disca"},\39\.{DROP}){}$;\5
${}\\{new\_word}(\.{"dump"},\39\.{DROP});{}$\6
${}\\{default\_msg}[\.{DROP}]\K\.{"You\ aren't\ carrying}\)\.{\ it!"};{}$\6
${}\\{new\_word}(\.{"open"},\39\.{OPEN}){}$;\5
${}\\{new\_word}(\.{"unloc"},\39\.{OPEN});{}$\6
${}\\{default\_msg}[\.{OPEN}]\K\.{"I\ don't\ know\ how\ to}\)\.{\ lock\ or\
unlock\ such}\)\.{\ a\ thing."};{}$\6
${}\\{new\_word}(\.{"close"},\39\.{CLOSE}){}$;\5
${}\\{new\_word}(\.{"lock"},\39\.{CLOSE});{}$\6
${}\\{default\_msg}[\.{CLOSE}]\K\\{default\_msg}[\.{OPEN}];{}$\6
${}\\{new\_word}(\.{"light"},\39\.{ON}){}$;\5
${}\\{new\_word}(\.{"on"},\39\.{ON});{}$\6
${}\\{default\_msg}[\.{ON}]\K\.{"You\ have\ no\ source\ }\)\.{of\ light."};{}$\6
${}\\{new\_word}(\.{"extin"},\39\.{OFF}){}$;\5
${}\\{new\_word}(\.{"off"},\39\.{OFF});{}$\6
${}\\{default\_msg}[\.{OFF}]\K\\{default\_msg}[\.{ON}];{}$\6
${}\\{new\_word}(\.{"wave"},\39\.{WAVE}){}$;\5
${}\\{new\_word}(\.{"shake"},\39\.{WAVE}){}$;\5
${}\\{new\_word}(\.{"swing"},\39\.{WAVE});{}$\6
${}\\{default\_msg}[\.{WAVE}]\K\.{"Nothing\ happens."};{}$\6
${}\\{new\_word}(\.{"calm"},\39\.{CALM}){}$;\5
${}\\{new\_word}(\.{"placa"},\39\.{CALM}){}$;\5
${}\\{new\_word}(\.{"tame"},\39\.{CALM});{}$\6
${}\\{default\_msg}[\.{CALM}]\K\.{"I'm\ game.\ \ Would\ yo}\)\.{u\ care\ to\
explain\ ho}\)\.{w?"};{}$\6
${}\\{new\_word}(\.{"walk"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"run"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"trave"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"go"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"proce"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"explo"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"goto"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"follo"},\39\.{GO}){}$;\5
${}\\{new\_word}(\.{"turn"},\39\.{GO});{}$\6
${}\\{default\_msg}[\.{GO}]\K\.{"Where?"};{}$\6
${}\\{new\_word}(\.{"nothi"},\39\.{RELAX});{}$\6
${}\\{default\_msg}[\.{RELAX}]\K\.{"OK."};{}$\6
${}\\{new\_word}(\.{"pour"},\39\.{POUR});{}$\6
${}\\{default\_msg}[\.{POUR}]\K\\{default\_msg}[\.{DROP}];{}$\6
${}\\{new\_word}(\.{"eat"},\39\.{EAT}){}$;\5
${}\\{new\_word}(\.{"devou"},\39\.{EAT});{}$\6
${}\\{default\_msg}[\.{EAT}]\K\.{"Don't\ be\ ridiculous}\)\.{!"};{}$\6
${}\\{new\_word}(\.{"drink"},\39\.{DRINK});{}$\6
${}\\{default\_msg}[\.{DRINK}]\K\.{"You\ have\ taken\ a\ dr}\)\.{ink\ from\ the%
\ stream.}\)\.{\ \ The\ water\ tastes\ s}\)\.{trongly\ of\\nminerals}\)\.{,\
but\ is\ not\ unpleas}\)\.{ant.\ \ It\ is\ extremel}\)\.{y\ cold."};{}$\6
${}\\{new\_word}(\.{"rub"},\39\.{RUB});{}$\6
${}\\{default\_msg}[\.{RUB}]\K\.{"Rubbing\ the\ electri}\)\.{c\ lamp\ is\ not\
partic}\)\.{ularly\ rewarding.\ \ A}\)\.{nyway,\\nnothing\ exci}\)\.{ting\
happens."};{}$\6
${}\\{new\_word}(\.{"throw"},\39\.{TOSS}){}$;\5
${}\\{new\_word}(\.{"toss"},\39\.{TOSS});{}$\6
${}\\{default\_msg}[\.{TOSS}]\K\.{"Peculiar.\ \ Nothing\ }\)\.{unexpected\
happens."};{}$\6
${}\\{new\_word}(\.{"wake"},\39\.{WAKE}){}$;\5
${}\\{new\_word}(\.{"distu"},\39\.{WAKE});{}$\6
${}\\{default\_msg}[\.{WAKE}]\K\\{default\_msg}[\.{EAT}];{}$\6
${}\\{new\_word}(\.{"feed"},\39\.{FEED});{}$\6
${}\\{default\_msg}[\.{FEED}]\K\.{"There\ is\ nothing\ he}\)\.{re\ to\
eat."};{}$\6
${}\\{new\_word}(\.{"fill"},\39\.{FILL});{}$\6
${}\\{default\_msg}[\.{FILL}]\K\.{"You\ can't\ fill\ that}\)\.{."};{}$\6
${}\\{new\_word}(\.{"break"},\39\.{BREAK}){}$;\5
${}\\{new\_word}(\.{"smash"},\39\.{BREAK}){}$;\5
${}\\{new\_word}(\.{"shatt"},\39\.{BREAK});{}$\6
${}\\{default\_msg}[\.{BREAK}]\K\.{"It\ is\ beyond\ your\ p}\)\.{ower\ to\ do\
that."};{}$\6
${}\\{new\_word}(\.{"blast"},\39\.{BLAST}){}$;\5
${}\\{new\_word}(\.{"deton"},\39\.{BLAST}){}$;\5
${}\\{new\_word}(\.{"ignit"},\39\.{BLAST}){}$;\5
${}\\{new\_word}(\.{"blowu"},\39\.{BLAST});{}$\6
${}\\{default\_msg}[\.{BLAST}]\K\.{"Blasting\ requires\ d}\)\.{ynamite."};{}$\6
${}\\{new\_word}(\.{"attac"},\39\.{KILL}){}$;\5
${}\\{new\_word}(\.{"kill"},\39\.{KILL}){}$;\5
${}\\{new\_word}(\.{"fight"},\39\.{KILL}){}$;\5
${}\\{new\_word}(\.{"hit"},\39\.{KILL}){}$;\5
${}\\{new\_word}(\.{"strik"},\39\.{KILL}){}$;\5
${}\\{new\_word}(\.{"slay"},\39\.{KILL});{}$\6
${}\\{default\_msg}[\.{KILL}]\K\\{default\_msg}[\.{EAT}];{}$\6
${}\\{new\_word}(\.{"say"},\39\.{SAY}){}$;\5
${}\\{new\_word}(\.{"chant"},\39\.{SAY}){}$;\5
${}\\{new\_word}(\.{"sing"},\39\.{SAY}){}$;\5
${}\\{new\_word}(\.{"utter"},\39\.{SAY}){}$;\5
${}\\{new\_word}(\.{"mumbl"},\39\.{SAY});{}$\6
${}\\{new\_word}(\.{"read"},\39\.{READ}){}$;\5
${}\\{new\_word}(\.{"perus"},\39\.{READ});{}$\6
${}\\{default\_msg}[\.{READ}]\K\.{"I'm\ afraid\ I\ don't\ }\)%
\.{understand."};{}$\6
${}\\{new\_word}(\.{"fee"},\39\.{FEEFIE}){}$;\5
${}\\{new\_word}(\.{"fie"},\39\.{FEEFIE}){}$;\5
${}\\{new\_word}(\.{"foe"},\39\.{FEEFIE}){}$;\5
${}\\{new\_word}(\.{"foo"},\39\.{FEEFIE}){}$;\5
${}\\{new\_word}(\.{"fum"},\39\.{FEEFIE});{}$\6
${}\\{default\_msg}[\.{FEEFIE}]\K\.{"I\ don't\ know\ how."};{}$\6
${}\\{new\_word}(\.{"brief"},\39\.{BRIEF});{}$\6
${}\\{default\_msg}[\.{BRIEF}]\K\.{"On\ what?"};{}$\6
${}\\{new\_word}(\.{"find"},\39\.{FIND}){}$;\5
${}\\{new\_word}(\.{"where"},\39\.{FIND});{}$\6
${}\\{default\_msg}[\.{FIND}]\K\.{"I\ can\ only\ tell\ you}\)\.{\ what\ you\
see\ as\ you}\)\.{\ move\ about\ and\ mani}\)\.{pulate\\nthings.\ \ I\ c}\)%
\.{annot\ tell\ you\ where}\)\.{\ remote\ things\ are."};{}$\6
${}\\{new\_word}(\.{"inven"},\39\.{INVENTORY});{}$\6
${}\\{default\_msg}[\.{INVENTORY}]\K\\{default\_msg}[\.{FIND}];{}$\6
${}\\{new\_word}(\.{"score"},\39\.{SCORE});{}$\6
${}\\{default\_msg}[\.{SCORE}]\K\.{"Eh?"};{}$\6
${}\\{new\_word}(\.{"quit"},\39\.{QUIT});{}$\6
${}\\{default\_msg}[\.{QUIT}]\K\\{default\_msg}[\.{SCORE}]{}$;\par
\fi

\M[577 advent.w]{15}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{default\_msg}[\T{30}]{}$;\C{ messages for untoward actions,
if nonzero }\par
\fi

\M[580 advent.w]{16}Finally, our vocabulary is rounded out by words like %
\.{help}, which
trigger the printing of fixed messages.

\Y\B\4\D$\\{new\_mess}(\|x)$ \5
$\\{message}[\|k\PP]\K{}$\|x\par
\B\4\D$\\{mess\_wd}(\|w)$ \5
$\\{new\_word}(\|w,\39\|k{}$)\par
\Y\B\4\X10:Build the vocabulary\X${}\mathrel+\E{}$\6
$\\{current\_type}\K\\{message\_type};{}$\6
${}\|k\K\T{0};{}$\6
\\{mess\_wd}(\.{"abra"});\5
\\{mess\_wd}(\.{"abrac"});\6
\\{mess\_wd}(\.{"opens"});\5
\\{mess\_wd}(\.{"sesam"});\5
\\{mess\_wd}(\.{"shaza"});\6
\\{mess\_wd}(\.{"hocus"});\5
\\{mess\_wd}(\.{"pocus"});\6
\\{new\_mess}(\.{"Good\ try,\ but\ that\ }\)\.{is\ an\ old\ worn-out\ m}\)%
\.{agic\ word."});\6
\\{mess\_wd}(\.{"help"});\5
\\{mess\_wd}(\.{"?"});\6
\\{new\_mess}(\.{"I\ know\ of\ places,\ a}\)\.{ctions,\ and\ things.\ }\)\.{\
Most\ of\ my\ vocabula}\)\.{ry\\ndescribes\ places}\)\.{\ and\ is\ used\ to\
move}\)\.{\ you\ there.\ \ To\ move}\)\.{,\ try\ words\\nlike\ fo}\)\.{rest,\
building,\ down}\)\.{stream,\ enter,\ east,}\)\.{\ west,\ north,\ south,}\)\.{%
\\nup,\ or\ down.\ \ I\ kn}\)\.{ow\ about\ a\ few\ speci}\)\.{al\ objects,\
like\ a\ b}\)\.{lack\ rod\\nhidden\ in\ }\)\.{the\ cave.\ \ These\ obj}\)%
\.{ects\ can\ be\ manipula}\)\.{ted\ using\ some\ of\\nt}\)\.{he\ action\ words%
\ that}\)\.{\ I\ know.\ \ Usually\ yo}\)\.{u\ will\ need\ to\ give\ }\)\.{both\
the\\nobject\ and}\)\.{\ action\ words\ (in\ ei}\)\.{ther\ order),\ but\ som}\)%
\.{etimes\ I\ can\ infer\\n}\)\.{the\ object\ from\ the\ }\)\.{verb\ alone.\ \
Some\ ob}\)\.{jects\ also\ imply\ ver}\)\.{bs;\ in\\nparticular,\ }\)\.{%
\\"inventory\\"\ implie}\)\.{s\ \\"take\ inventory\\"}\)\.{,\ which\ causes\ me%
\ to}\)\.{\\ngive\ you\ a\ list\ of}\)\.{\ what\ you're\ carryin}\)\.{g.\ \ The%
\ objects\ have}\)\.{\ side\\neffects;\ for\ }\)\.{instance,\ the\ rod\ sc}\)%
\.{ares\ the\ bird.\ \ Usua}\)\.{lly\ people\ having\\nt}\)\.{rouble\ moving\
just\ n}\)\.{eed\ to\ try\ a\ few\ mor}\)\.{e\ words.\ \ Usually\ pe}\)\.{ople%
\\ntrying\ unsucce}\)\.{ssfully\ to\ manipulat}\)\.{e\ an\ object\ are\ atte}\)%
\.{mpting\ something\\nbe}\)\.{yond\ their\ (or\ my!)\ }\)\.{capabilities\ and\
sho}\)\.{uld\ try\ a\ completely}\)\.{\\ndifferent\ tack.\ \ T}\)\.{o\ speed\
the\ game\ you}\)\.{\ can\ sometimes\ move\ }\)\.{long\\ndistances\ with}\)\.{\
a\ single\ word.\ \ For}\)\.{\ example,\ \\"building}\)\.{\\"\ usually\ gets%
\\nyou}\)\.{\ to\ the\ building\ fro}\)\.{m\ anywhere\ above\ gro}\)\.{und\
except\ when\ lost}\)\.{\ in\ the\\nforest.\ \ Al}\)\.{so,\ note\ that\ cave\
p}\)\.{assages\ turn\ a\ lot,\ }\)\.{and\ that\ leaving\ a\\n}\)\.{room\ to\
the\ north\ do}\)\.{es\ not\ guarantee\ ent}\)\.{ering\ the\ next\ from\ }\)%
\.{the\ south.\\nGood\ luc}\)\.{k!"});\6
\\{mess\_wd}(\.{"tree"});\5
\\{mess\_wd}(\.{"trees"});\6
\\{new\_mess}(\.{"The\ trees\ of\ the\ fo}\)\.{rest\ are\ large\ hardw}\)\.{ood%
\ oak\ and\ maple,\ w}\)\.{ith\ an\\noccasional\ g}\)\.{rove\ of\ pine\ or\
spru}\)\.{ce.\ \ There\ is\ quite\ }\)\.{a\ bit\ of\ under-\\ngro}\)\.{wth,\
largely\ birch\ a}\)\.{nd\ ash\ saplings\ plus}\)\.{\ nondescript\ bushes\ }\)%
\.{of\\nvarious\ sorts.\ \ }\)\.{This\ time\ of\ year\ vi}\)\.{sibility\ is\
quite\ re}\)\.{stricted\ by\\nall\ the}\)\.{\ leaves,\ but\ travel\ }\)\.{is\
quite\ easy\ if\ you}\)\.{\ detour\ around\ the\\n}\)\.{spruce\ and\ berry\
bus}\)\.{hes."});\6
\\{mess\_wd}(\.{"dig"});\5
\\{mess\_wd}(\.{"excav"});\6
\\{new\_mess}(\.{"Digging\ without\ a\ s}\)\.{hovel\ is\ quite\ impra}\)%
\.{ctical.\ \ Even\ with\ a}\)\.{\ shovel\\nprogress\ is}\)\.{\ unlikely."});\6
\\{mess\_wd}(\.{"lost"});\6
\\{new\_mess}(\.{"I'm\ as\ confused\ as\ }\)\.{you\ are."});\6
\\{new\_mess}(\.{"There\ is\ a\ loud\ exp}\)\.{losion\ and\ you\ are\ s}\)%
\.{uddenly\ splashed\ acr}\)\.{oss\ the\\nwalls\ of\ th}\)\.{e\ room."});\6
\\{new\_mess}(\.{"There\ is\ a\ loud\ exp}\)\.{losion\ and\ a\ twenty-}\)%
\.{foot\ hole\ appears\ in}\)\.{\ the\ far\\nwall,\ bury}\)\.{ing\ the\ snakes\
in\ th}\)\.{e\ rubble.\ \ A\ river\ o}\)\.{f\ molten\ lava\ pours\\}\)\.{nin\
through\ the\ hole}\)\.{,\ destroying\ everyth}\)\.{ing\ in\ its\ path,\ inc}\)%
\.{luding\ you!"});\6
\\{mess\_wd}(\.{"mist"});\6
\\{new\_mess}(\.{"Mist\ is\ a\ white\ vap}\)\.{or,\ usually\ water,\ s}\)\.{een%
\ from\ time\ to\ tim}\)\.{e\ in\\ncaverns.\ \ It\ c}\)\.{an\ be\ found\
anywhere}\)\.{\ but\ is\ frequently\ a}\)\.{\ sign\ of\ a\ deep\\npit}\)\.{\
leading\ down\ to\ wat}\)\.{er."});\6
\\{mess\_wd}(\.{"fuck"});\6
\\{new\_mess}(\.{"Watch\ it!"});\6
\\{new\_mess}(\.{"There\ is\ a\ loud\ exp}\)\.{losion,\ and\ a\ twenty}\)%
\.{-foot\ hole\ appears\ i}\)\.{n\ the\ far\\nwall,\ bur}\)\.{ying\ the\
dwarves\ in\ }\)\.{the\ rubble.\ \ You\ mar}\)\.{ch\ through\ the\ hole\\}\)%
\.{nand\ find\ yourself\ i}\)\.{n\ the\ main\ office,\ w}\)\.{here\ a\ cheering%
\ band}\)\.{\ of\\nfriendly\ elves\ }\)\.{carry\ the\ conquering}\)\.{\
adventurer\ off\ into}\)\.{\ the\ sunset."});\6
\\{mess\_wd}(\.{"stop"});\6
\\{new\_mess}(\.{"I\ don't\ know\ the\ wo}\)\.{rd\ \\"stop\\".\ \ Use\ \\"}\)%
\.{quit\\"\ if\ you\ want\ t}\)\.{o\ give\ up."});\6
\\{mess\_wd}(\.{"info"});\5
\\{mess\_wd}(\.{"infor"});\6
\\{new\_mess}(\.{"If\ you\ want\ to\ end\ }\)\.{your\ adventure\ early}\)\.{,\
say\ \\"quit\\".\ \ To\ }\)\.{get\ full\\ncredit\ for}\)\.{\ a\ treasure,\ you\
mus}\)\.{t\ have\ left\ it\ safel}\)\.{y\ in\ the\ building,\\n}\)\.{though\
you\ get\ parti}\)\.{al\ credit\ just\ for\ l}\)\.{ocating\ it.\ \ You\ los}\)%
\.{e\ points\\nfor\ gettin}\)\.{g\ killed,\ or\ for\ qui}\)\.{tting,\ though\
the\ fo}\)\.{rmer\ costs\ you\ more.}\)\.{\\nThere\ are\ also\ poi}\)\.{nts\
based\ on\ how\ muc}\)\.{h\ (if\ any)\ of\ the\ ca}\)\.{ve\ you've\\nmanaged\
t}\)\.{o\ explore;\ in\ partic}\)\.{ular,\ there\ is\ a\ lar}\)\.{ge\ bonus\
just\ for\\ng}\)\.{etting\ in\ (to\ distin}\)\.{guish\ the\ beginners\ }\)%
\.{from\ the\ rest\ of\ the}\)\.{\ pack),\\nand\ there\ a}\)\.{re\ other\ ways\
to\ det}\)\.{ermine\ whether\ you'v}\)\.{e\ been\ through\ some\\}\)\.{nof\ the%
\ more\ harrowi}\)\.{ng\ sections.\ \ If\ you}\)\.{\ think\ you've\ found\ }\)%
\.{all\ the\\ntreasures,\ }\)\.{just\ keep\ exploring\ }\)\.{for\ a\ while.\ \
If\ not}\)\.{hing\ interesting\\nha}\)\.{ppens,\ you\ haven't\ f}\)\.{ound\
them\ all\ yet.\ \ }\)\.{If\ something\ interes}\)\.{ting\\nDOES\ happen,\ i}\)%
\.{t\ means\ you're\ getti}\)\.{ng\ a\ bonus\ and\ have\ }\)\.{an\ opportunity%
\\nto\ g}\)\.{arner\ many\ more\ poin}\)\.{ts\ in\ the\ master's\ s}\)%
\.{ection.\\nI\ may\ occas}\)\.{ionally\ offer\ hints\ }\)\.{if\ you\ seem\ to\
be\ ha}\)\.{ving\ trouble.\\nIf\ I\ }\)\.{do,\ I'll\ warn\ you\ in}\)\.{\
advance\ how\ much\ it}\)\.{\ will\ affect\ your\ sc}\)\.{ore\\nto\ accept\ the%
\ h}\)\.{ints.\ \ Finally,\ to\ s}\)\.{ave\ paper,\ you\ may\ s}\)\.{pecify\ %
\\"brief\\",\\nw}\)\.{hich\ tells\ me\ never\ }\)\.{to\ repeat\ the\ full\ d}\)%
\.{escription\ of\ a\ plac}\)\.{e\\nunless\ you\ explic}\)\.{itly\ ask\ me\
to."});\6
\\{mess\_wd}(\.{"swim"});\6
\\{new\_mess}(\.{"I\ don't\ know\ how."});\par
\fi

\M[674 advent.w]{17}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{message}[\T{13}]{}$;\C{ messages tied to certain vocabulary
words }\par
\fi

\N[677 advent.w]{1}{18}Cave data. You might be in any of more than 100 places
as you wander
about in Colossal Cave. Let's enumerate them now, so that we can
build the data structures that define the travel restrictions.

A special negative value called \PB{\\{inhand}} is the location code for
objects that
you are carrying. But you yourself are always situated in a place that has a
nonnegative location code.

Nonnegative places \PB{$\Z$ \\{outside}} are outside the cave, while places %
\PB{$\G$ \\{inside}}
are inside.  The upper part of the cave, places \PB{$<$ \\{emist}}, is the
easiest part
to explore.  (We will see later that dwarves do not venture this close to the
surface; they stay \PB{$\G$ \\{emist}}.)

Places between \PB{\\{inside}} and \PB{\\{dead2}}, inclusive, form the main
cave;
the next places, up to and including \PB{\\{barr}}, form the hidden cave on the
other side of the troll bridge; then \PB{\\{neend}} and \PB{\\{swend}} are a
private cave.

The remaining places, \PB{$\G$ \\{crack}}, are dummy locations,
not really part of the maze. As soon as you arrive at a dummy
location, the program immediately sends you somewhere else.
In fact, the last three dummy locations aren't really even locations;
they invoke special code.
This device is a convenient way to provide a variety of features without
making the program logic any more cluttered than it already is.

\Y\B\4\D$\\{min\_in\_cave}$ \5
\\{inside}\par
\B\4\D$\\{min\_lower\_loc}$ \5
\\{emist}\par
\B\4\D$\\{min\_forced\_loc}$ \5
\\{crack}\par
\B\4\D$\\{max\_loc}$ \5
\\{didit}\par
\B\4\D$\\{max\_spec}$ \5
\\{troll}\par
\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\\{inhand}\K{-}\T{1},\39\\{limbo},{}$\6
\\{road}${},\39\\{hill},\39\\{house},\39\\{valley},\39\\{forest},\39\\{woods},%
\39\\{slit},\39\\{outside},{}$\6
\\{inside}${},\39\\{cobbles},\39\\{debris},\39\\{awk},\39\\{bird},\39%
\\{spit},{}$\6
\\{emist}${},\39\\{nugget},\39\\{efiss},\39\\{wfiss},\39\\{wmist},{}$\6
\\{like1}${},\39\\{like2},\39\\{like3},\39\\{like4},\39\\{like5},\39\\{like6},%
\39\\{like7},\39\\{like8},\39\\{like9},\39\\{like10},\39\\{like11},\39%
\\{like12},\39\\{like13},\39\\{like14},{}$\6
\\{brink}${},\39\\{elong},\39\\{wlong},{}$\6
\\{diff0}${},\39\\{diff1},\39\\{diff2},\39\\{diff3},\39\\{diff4},\39\\{diff5},%
\39\\{diff6},\39\\{diff7},\39\\{diff8},\39\\{diff9},\39\\{diff10},{}$\6
\\{pony}${},\39\\{cross},\39\\{hmk},\39\\{west},\39\\{south},\39\\{ns},\39%
\\{y2},\39\\{jumble},\39\\{windoe},{}$\6
\\{dirty}${},\39\\{clean},\39\\{wet},\39\\{dusty},\39\\{complex},{}$\6
\\{shell}${},\39\\{arch},\39\\{ragged},\39\\{sac},\39\\{ante},\39\\{witt},{}$\6
\\{bedquilt}${},\39\\{cheese},\39\\{soft},{}$\6
\\{e2pit}${},\39\\{w2pit},\39\\{epit},\39\\{wpit},{}$\6
\\{narrow}${},\39\\{giant},\39\\{block},\39\\{immense},\39\\{falls},\39%
\\{steep},{}$\6
\\{abovep}${},\39\\{sjunc},\39\\{tite},\39\\{low},\39\\{crawl},\39%
\\{window},{}$\6
\\{oriental}${},\39\\{misty},\39\\{alcove},\39\\{proom},\39\\{droom},{}$\6
\\{slab}${},\39\\{abover},\39\\{mirror},\39\\{res},{}$\6
\\{scan1}${},\39\\{scan2},\39\\{scan3},\39\\{secret},{}$\6
\\{wide}${},\39\\{tight},\39\\{tall},\39\\{boulders},{}$\6
\\{scorr}${},\39\\{swside},{}$\6
\\{dead0}${},\39\\{dead1},\39\\{dead2},\39\\{dead3},\39\\{dead4},\39\\{dead5},%
\39\\{dead6},\39\\{dead7},\39\\{dead8},\39\\{dead9},\39\\{dead10},\39%
\\{dead11},{}$\6
\\{neside}${},\39\\{corr},\39\\{fork},\39\\{warm},\39\\{view},\39\\{chamber},%
\39\\{lime},\39\\{fbarr},\39\\{barr},{}$\6
\\{neend}${},\39\\{swend},{}$\6
\\{crack}${},\39\\{neck},\39\\{lose},\39\\{cant},\39\\{climb},\39\\{check},\39%
\\{snaked},\39\\{thru},\39\\{duck},\39\\{sewer},\39\\{upnout},\39\\{didit},{}$\6
\\{ppass}${},\39\\{pdrop},\39\\{troll}{}$\2\6
${}\}{}$ \&{location};\par
\fi

\M[740 advent.w]{19}Speaking of program logic, the complex cave dynamics are
essentially
kept in a table. The table tells us what to do when you ask for a particular
motion in a particular location. Each entry of the table is called
an instruction; and each instruction has three parts: a motion,
a condition, and a destination.

The motion part of an instruction is one of the motion verbs enumerated
earlier.

The condition part $c$ is a small integer, interpreted as follows:
\xdef\instspecs{\secno}

\smallskip
\item{$\bullet$}if $c=0$, the condition is always true;
\item{$\bullet$}if $0<c<100$, the condition is true with probability $c/100$;
\item{$\bullet$}if $c=100$, the condition is always true, except for dwarves;
\item{$\bullet$}if $100<c<=200$, you must have object $c\bmod100$;
\item{$\bullet$}if $200<c<=300$, object $c\bmod100$ must be in the current
place;
\item{$\bullet$}if $300<c<=400$, $\PB{\\{prop}}[c\bmod100]$ must not be 0;
\item{$\bullet$}if $400<c<=500$, $\PB{\\{prop}}[c\bmod100]$ must not be 1;
\item{$\bullet$}if $500<c<=600$, $\PB{\\{prop}}[c\bmod100]$ must not be 2; etc.
\smallskip
\noindent (We will discuss properties of objects and the \PB{\\{prop}} array
later.)

The destination $d$ is either a location or a number greater than
\PB{\\{max\_loc}}. In the latter case, if \PB{$\|d\Z\\{max\_spec}$} we perform
a special
routine; otherwise we print \PB{$\\{remarks}[\|d-\\{max\_spec}]$} and
stay in the current place.

\def\getsecno#1#2{\getsecn#2}
\def\getsecn$\X#1:#2\X${#1}
If the motion matches what you said but the condition is not satisfied,
we move on to the next instruction that has a different destination and/or
condition from this one. The next instruction might itself be
conditional in the same way; but the motion is no longer checked after
it has first been matched. (Numerous examples appear below;
complete details of the table-driven logic can be found in section
\getsecno\PB{$\X146:Determine the next location, \PB{\\{newloc}}\X$}.)

\Y\B\4\X5:Type definitions\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} ${}\{{}$\1\6
\&{motion} \\{mot};\C{ a motion you might have requested }\6
\&{int} \\{cond};\C{ if you did, this condition must also hold }\6
\&{location} \\{dest};\C{ and if so, this is where you'll go next }\2\6
${}\}{}$ \&{instruction};\par
\fi

\M[787 advent.w]{20}Suppose you're at location $l$. Then \PB{\\{start}[\|l]} is
the first
relevant instruction, and \PB{$\\{start}[\|l+\T{1}]-\T{1}$} is the last. Also
\PB{\\{long\_desc}[\|l]} is a string that fully describes~$l$; \PB{\\{short%
\_desc}[\|l]}
is an optional abbreviated description; and \PB{\\{visits}[\|l]} tells how
many times you have been here. Special properties of this location,
such as whether a lantern is necessary or a hint might be advisable,
are encoded in the bits of \PB{\\{flags}[\|l]}.

\Y\B\4\D$\\{lighted}$ \5
\T{1}\C{ bit for a location that isn't dark }\par
\B\4\D$\\{oil}$ \5
\T{2}\C{ bit for presence of oil }\par
\B\4\D$\\{liquid}$ \5
\T{4}\C{ bit for presence of a liquid (oil or water) }\par
\B\4\D$\\{cave\_hint}$ \5
\T{8}\C{ bit for hint about trying to get in the cave }\par
\B\4\D$\\{bird\_hint}$ \5
\T{16}\C{ bit for hint about catching the bird }\par
\B\4\D$\\{snake\_hint}$ \5
\T{32}\C{ bit for hint about dealing with the snake }\par
\B\4\D$\\{twist\_hint}$ \5
\T{64}\C{ bit for hint about being lost in a maze }\par
\B\4\D$\\{dark\_hint}$ \5
\T{128}\C{ bit for hint about the dark room }\par
\B\4\D$\\{witt\_hint}$ \5
\T{256}\C{ bit for hint about Witt's End }\Y\par
\B\4\D$\\{travel\_size}$ \5
\T{740}\C{ at most this many instructions }\par
\B\4\D$\\{rem\_size}$ \5
\T{15}\C{ at most this many remarks }\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{instruction} \\{travels}[\\{travel\_size}];\C{ the table of instructions }\6
\&{instruction} ${}{*}\\{start}[\\{max\_loc}+\T{2}]{}$;\C{ references to
starting instruction }\6
\&{char} ${}{*}\\{long\_desc}[\\{max\_loc}+\T{1}]{}$;\C{ long-winded
descriptions of locations }\6
\&{char} ${}{*}\\{short\_desc}[\\{max\_loc}+\T{1}]{}$;\C{ short-winded
descriptions, or 0 }\6
\&{int} ${}\\{flags}[\\{max\_loc}+\T{1}]{}$;\C{ bitmaps for special properties
}\6
\&{char} ${}{*}\\{remarks}[\\{rem\_size}]{}$;\C{ comments made when staying put
}\6
\&{int} \\{rem\_count};\C{ we've made this many comments }\6
\&{int} ${}\\{visits}[\\{max\_loc}+\T{1}]{}$;\C{ how often have you been here?
}\par
\fi

\N[818 advent.w]{1}{21}Cave connections. Now we are ready to build the
fundamental table
of location and transition data, by filling in the arrays just declared.
We will fill them in strict order of their \PB{\&{location}} codes.

It is convenient to define several macros and constants.

\Y\B\4\D$\\{make\_loc}(\|x,\|l,\|s,\|f)$ \6
${}\{{}$\5
\1${}\\{long\_desc}[\|x]\K\|l{}$;\5
${}\\{short\_desc}[\|x]\K\|s{}$;\5
${}\\{flags}[\|x]\K\|f{}$;\5
${}\\{start}[\|x]\K\|q{}$;\5
${}\}{}$\2\par
\B\4\D$\\{make\_inst}(\|m,\|c,\|d)$ \6
${}\{{}$\5
\1${}\|q\MG\\{mot}\K\|m{}$;\5
${}\|q\MG\\{cond}\K\|c{}$;\5
${}\|q\MG\\{dest}\K\|d{}$;\5
${}\|q\PP{}$;\5
${}\}{}$\2\par
\B\4\D$\\{ditto}(\|m)$ \6
${}\{{}$\5
\1${}\|q\MG\\{mot}\K\|m{}$;\5
${}\|q\MG\\{cond}\K(\|q-\T{1})\MG\\{cond}{}$;\5
${}\|q\MG\\{dest}\K(\|q-\T{1})\MG\\{dest}{}$;\5
${}\|q\PP{}$;\5
${}\}{}$\2\par
\B\4\D$\\{holds}(\|o)$ \5
$(\T{100}+(\|o){}$)\C{ do instruction only if carrying object \PB{\|o} }\par
\B\4\D$\\{sees}(\|o)$ \5
$(\T{200}+(\|o){}$)\C{ do instruction only if object \PB{\|o} is present }\par
\B\4\D$\\{not}(\|o,\|k)$ \5
$(\T{300}+(\|o)+\T{100}*(\|k){}$)\C{ do instruction only if \PB{$\\{prop}[\|o]%
\I\|k$} }\par
\B\4\D$\\{remark}(\|m)$ \5
$\\{remarks}[\PP\\{rem\_count}]\K{}$\|m\par
\B\4\D$\\{sayit}$ \5
$(\\{max\_spec}+\\{rem\_count}{}$)\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{char} \\{all\_alike}[\,]${}\K\.{"You\ are\ in\ a\ maze\ o}\)\.{f\ twisty\
little\ pass}\)\.{ages,\ all\ alike."};{}$\6
\&{char} \\{dead\_end}[\,]${}\K\.{"Dead\ end."};{}$\6
\&{int} \\{slit\_rmk}${},{}$ \\{grate\_rmk}${},{}$ \\{bridge\_rmk}${},{}$ %
\\{loop\_rmk};\C{ messages used more than once }\par
\fi

\M[842 advent.w]{22}\B\X22:Additional local registers\X${}\E{}$\6
\&{register} \&{instruction} ${}{*}\|q,{}$ ${}{*}\\{qq}{}$;\par
\As68\ET144.
\U2.\fi

\M[845 advent.w]{23}The \PB{\\{road}} is where you start; its \PB{\\{long%
\_desc}} is now famous,
having been quoted by Steven Levy in his book {\sl Hackers}.

The instructions here say that if you want to go west, or up, or on the road,
we take you to \PB{\\{hill}}; if you want to go east, or in, or to the house,
or if you say `\.{enter}', we take you to \PB{\\{house}}; etc.
Of course you won't know about all the motions available at
this point until you have played the game for awhile.

\Y\B\4\X23:Build the travel table\X${}\E{}$\6
$\|q\K\\{travels};{}$\6
${}\\{make\_loc}(\\{road},{}$\6
\.{"You\ are\ standing\ at}\)\.{\ the\ end\ of\ a\ road\ b}\)\.{efore\ a\ small%
\ brick\ }\)\.{building.\\nAround\ yo}\)\.{u\ is\ a\ forest.\ \ A\ sm}\)\.{all\
stream\ flows\ out}\)\.{\ of\ the\ building\ and}\)\.{\\ndown\ a\
gully."}${},{}$\6
\.{"You're\ at\ end\ of\ ro}\)\.{ad\ again."}${},\39\\{lighted}+\\{liquid});{}$%
\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{hill}){}$;\5
\\{ditto}(\|U);\5
\\{ditto}(\.{ROAD});\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{house}){}$;\5
\\{ditto}(\.{IN});\5
\\{ditto}(\.{HOUSE});\5
\\{ditto}(\.{ENTER});\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{valley}){}$;\5
\\{ditto}(\|D);\5
\\{ditto}(\.{GULLY});\5
\\{ditto}(\.{STREAM});\5
\\{ditto}(\.{DOWNSTREAM});\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{forest}){}$;\5
\\{ditto}(\.{WOODS});\6
${}\\{make\_inst}(\.{DEPRESSION},\39\T{0},\39\\{outside}){}$;\par
\As24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,
43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61%
\ETs62.
\U200.\fi

\M[869 advent.w]{24}There's nothing up the hill, but a good explorer has to try
anyway.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{hill},{}$\6
\.{"You\ have\ walked\ up\ }\)\.{a\ hill,\ still\ in\ the}\)\.{\ forest.\ \ The%
\ road\ s}\)\.{lopes\ back\\ndown\ the}\)\.{\ other\ side\ of\ the\ h}\)\.{ill.%
\ \ There\ is\ a\ bui}\)\.{lding\ in\ the\ distanc}\)\.{e."}${},{}$\6
\.{"You're\ at\ hill\ in\ r}\)\.{oad."}${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\.{ROAD},\39\T{0},\39\\{road}){}$;\5
\\{ditto}(\.{HOUSE});\5
\\{ditto}(\.{FORWARD});\5
\\{ditto}(\|E);\5
\\{ditto}(\|D);\6
${}\\{make\_inst}(\.{WOODS},\39\T{0},\39\\{forest}){}$;\5
\\{ditto}(\|N);\5
\\{ditto}(\|S);\par
\fi

\M[879 advent.w]{25}The house initially contains several objects: keys, food, a
bottle, and
a lantern. We'll put them in there later.

Two magic words are understood in this house, to teleport spelunkers who have
been there and done that. (Crowther is said to have pronounced the
first one ``zizzy''; the pronunciation of the other one is unknown.)
% see Jerz article, paragraph 68

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{house},{}$\6
\.{"You\ are\ inside\ a\ bu}\)\.{ilding,\ a\ well\ house}\)\.{\ for\ a\ large\
spring.}\)\.{"}${},{}$\6
\.{"You're\ inside\ build}\)\.{ing."}${},\39\\{lighted}+\\{liquid});{}$\6
${}\\{make\_inst}(\.{ENTER},\39\T{0},\39\\{road}){}$;\5
\\{ditto}(\.{OUT});\5
\\{ditto}(\.{OUTDOORS});\5
\\{ditto}(\|W);\6
${}\\{make\_inst}(\.{XYZZY},\39\T{0},\39\\{debris});{}$\6
${}\\{make\_inst}(\.{PLUGH},\39\T{0},\39\\{y2});{}$\6
${}\\{make\_inst}(\.{DOWNSTREAM},\39\T{0},\39\\{sewer}){}$;\5
\\{ditto}(\.{STREAM});\par
\fi

\M[897 advent.w]{26}A foolish consistency is the hobgoblin of little minds.
(Emerson)

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{valley},{}$\6
\.{"You\ are\ in\ a\ valley}\)\.{\ in\ the\ forest\ besid}\)\.{e\ a\ stream\
tumbling\ }\)\.{along\ a\\nrocky\ bed."}${},{}$\6
\.{"You're\ in\ valley."}${},\39\\{lighted}+\\{liquid});{}$\6
${}\\{make\_inst}(\.{UPSTREAM},\39\T{0},\39\\{road}){}$;\5
\\{ditto}(\.{HOUSE});\5
\\{ditto}(\|N);\6
${}\\{make\_inst}(\.{WOODS},\39\T{0},\39\\{forest}){}$;\5
\\{ditto}(\|E);\5
\\{ditto}(\|W);\5
\\{ditto}(\|U);\6
${}\\{make\_inst}(\.{DOWNSTREAM},\39\T{0},\39\\{slit}){}$;\5
\\{ditto}(\|S);\5
\\{ditto}(\|D);\6
${}\\{make\_inst}(\.{DEPRESSION},\39\T{0},\39\\{outside}){}$;\par
\fi

\M[910 advent.w]{27}The instructions here keep you in the \PB{\\{forest}} with
probability 50\%,
otherwise they take you to the \PB{\\{woods}}. This gives the illusion that
we maintain more state information about you than we really do.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{forest},{}$\6
\.{"You\ are\ in\ open\ for}\)\.{est,\ with\ a\ deep\ val}\)\.{ley\ to\ one\
side."}${},{}$\6
\.{"You're\ in\ forest."}${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\.{VALLEY},\39\T{0},\39\\{valley}){}$;\5
\\{ditto}(\|E);\5
\\{ditto}(\|D);\6
${}\\{make\_inst}(\.{WOODS},\39\T{50},\39\\{forest}){}$;\5
\\{ditto}(\.{FORWARD});\5
\\{ditto}(\|N);\6
${}\\{make\_inst}(\.{WOODS},\39\T{0},\39\\{woods});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{forest}){}$;\5
\\{ditto}(\|S);\7
${}\\{make\_loc}(\\{woods},{}$\6
\.{"You\ are\ in\ open\ for}\)\.{est\ near\ both\ a\ vall}\)\.{ey\ and\ a\
road."}${},{}$\6
\\{short\_desc}[\\{forest}]${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\.{ROAD},\39\T{0},\39\\{road}){}$;\5
\\{ditto}(\|N);\6
${}\\{make\_inst}(\.{VALLEY},\39\T{0},\39\\{valley}){}$;\5
\\{ditto}(\|E);\5
\\{ditto}(\|W);\5
\\{ditto}(\|D);\6
${}\\{make\_inst}(\.{WOODS},\39\T{0},\39\\{forest}){}$;\5
\\{ditto}(\|S);\par
\fi

\M[930 advent.w]{28}You're getting closer. (But the program has forgotten that
\PB{\.{DEPRESSION}} leads \PB{\\{outside}}; it knew this when you were at
the \PB{\\{road}} or the \PB{\\{valley}}.)

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{slit},{}$\6
\.{"At\ your\ feet\ all\ th}\)\.{e\ water\ of\ the\ strea}\)\.{m\ splashes\
into\ a\ 2-}\)\.{inch\ slit\\nin\ the\ ro}\)\.{ck.\ \ Downstream\ the\ }\)%
\.{streambed\ is\ bare\ ro}\)\.{ck."}${},{}$\6
\.{"You're\ at\ slit\ in\ s}\)\.{treambed."}${},\39\\{lighted}+\\{liquid});{}$\6
${}\\{make\_inst}(\.{HOUSE},\39\T{0},\39\\{road});{}$\6
${}\\{make\_inst}(\.{UPSTREAM},\39\T{0},\39\\{valley}){}$;\5
\\{ditto}(\|N);\6
${}\\{make\_inst}(\.{WOODS},\39\T{0},\39\\{forest}){}$;\5
\\{ditto}(\|E);\5
\\{ditto}(\|W);\6
${}\\{make\_inst}(\.{DOWNSTREAM},\39\T{0},\39\\{outside}){}$;\5
\\{ditto}(\.{ROCK});\5
\\{ditto}(\.{BED});\5
\\{ditto}(\|S);\6
\\{remark}(\.{"You\ don't\ fit\ throu}\)\.{gh\ a\ two-inch\ slit!"});\6
${}\\{make\_inst}(\.{SLIT},\39\T{0},\39\\{sayit}){}$;\5
\\{ditto}(\.{STREAM});\5
\\{ditto}(\|D);\6
${}\\{slit\_rmk}\K\\{sayit}{}$;\par
\fi

\M[947 advent.w]{29}We'll see later that the \PB{\.{GRATE}} will change from
state 0 to state 1 if you
unlock it. So let's hope you have the \PB{\.{KEYS}}.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{outside},{}$\6
\.{"You\ are\ in\ a\ 20-foo}\)\.{t\ depression\ floored}\)\.{\ with\ bare\
dirt.\ \ Se}\)\.{t\ into\ the\\ndirt\ is\ }\)\.{a\ strong\ steel\ grate}\)\.{\
mounted\ in\ concrete}\)\.{.\ \ A\ dry\ streambed\\n}\)\.{leads\ into\ the\
depre}\)\.{ssion."}${},{}$\6
\.{"You're\ outside\ grat}\)\.{e."}${},\39\\{lighted}+\\{cave\_hint});{}$\6
${}\\{make\_inst}(\.{WOODS},\39\T{0},\39\\{forest}){}$;\5
\\{ditto}(\|E);\5
\\{ditto}(\|W);\5
\\{ditto}(\|S);\6
${}\\{make\_inst}(\.{HOUSE},\39\T{0},\39\\{road});{}$\6
${}\\{make\_inst}(\.{UPSTREAM},\39\T{0},\39\\{slit}){}$;\5
\\{ditto}(\.{GULLY});\5
\\{ditto}(\|N);\6
${}\\{make\_inst}(\.{ENTER},\39\\{not}(\.{GRATE},\39\T{0}),\39\\{inside}){}$;\5
\\{ditto}(\.{ENTER});\5
\\{ditto}(\.{IN});\5
\\{ditto}(\|D);\6
\\{remark}(\.{"You\ can't\ go\ throug}\)\.{h\ a\ locked\ steel\ gra}\)%
\.{te!"});\6
${}\\{grate\_rmk}\K\\{sayit};{}$\6
${}\\{make\_inst}(\.{ENTER},\39\T{0},\39\\{sayit}){}$;\par
\fi

\M[964 advent.w]{30}If you've come this far, you're probably hooked, although
your adventure
has barely begun.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{inside},{}$\6
\.{"You\ are\ in\ a\ small\ }\)\.{chamber\ beneath\ a\ 3x}\)\.{3\ steel\ grate\
to\ the}\)\.{\ surface.\\nA\ low\ cra}\)\.{wl\ over\ cobbles\ lead}\)\.{s\
inwards\ to\ the\ wes}\)\.{t."}${},{}$\6
\.{"You're\ below\ the\ gr}\)\.{ate."}${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\.{OUT},\39\\{not}(\.{GRATE},\39\T{0}),\39\\{outside}){}$;\5
\\{ditto}(\.{OUT});\5
\\{ditto}(\|U);\6
${}\\{make\_inst}(\.{OUT},\39\T{0},\39\\{grate\_rmk});{}$\6
${}\\{make\_inst}(\.{CRAWL},\39\T{0},\39\\{cobbles}){}$;\5
\\{ditto}(\.{COBBLES});\5
\\{ditto}(\.{IN});\5
\\{ditto}(\|W);\6
${}\\{make\_inst}(\.{PIT},\39\T{0},\39\\{spit});{}$\6
${}\\{make\_inst}(\.{DEBRIS},\39\T{0},\39\\{debris}){}$;\par
\fi

\M[978 advent.w]{31}Go West, young man. (If you've got a lamp.)

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{cobbles},{}$\6
\.{"You\ are\ crawling\ ov}\)\.{er\ cobbles\ in\ a\ low\ }\)\.{passage.\ \
There\ is\ a}\)\.{\ dim\ light\\nat\ the\ e}\)\.{ast\ end\ of\ the\ passa}\)%
\.{ge."}${},{}$\6
\.{"You're\ in\ cobble\ cr}\)\.{awl."}${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\.{OUT},\39\T{0},\39\\{inside}){}$;\5
\\{ditto}(\.{SURFACE});\5
\\{ditto}(\.{NOWHERE});\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\.{IN},\39\T{0},\39\\{debris}){}$;\5
\\{ditto}(\.{DARK});\5
\\{ditto}(\|W);\5
\\{ditto}(\.{DEBRIS});\6
${}\\{make\_inst}(\.{PIT},\39\T{0},\39\\{spit}){}$;\7
${}\\{make\_loc}(\\{debris},{}$\6
\.{"You\ are\ in\ a\ debris}\)\.{\ room\ filled\ with\ st}\)\.{uff\ washed\ in\
from\ t}\)\.{he\ surface.\\nA\ low\ w}\)\.{ide\ passage\ with\ cob}\)\.{bles\
becomes\ plugged}\)\.{\ with\ mud\ and\ debris}\)\.{\\nhere,\ but\ an\ awkwa}\)%
\.{rd\ canyon\ leads\ upwa}\)\.{rd\ and\ west.\ \ A\ note}\)\.{\ on\ the\ wall%
\\nsays\ \\}\)\.{"MAGIC\ WORD\ XYZZY\\".}\)\.{"}${},{}$\6
\.{"You're\ in\ debris\ ro}\)\.{om."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{DEPRESSION},\39\\{not}(\.{GRATE},\39\T{0}),\39%
\\{outside});{}$\6
${}\\{make\_inst}(\.{ENTRANCE},\39\T{0},\39\\{inside});{}$\6
${}\\{make\_inst}(\.{CRAWL},\39\T{0},\39\\{cobbles}){}$;\5
\\{ditto}(\.{COBBLES});\5
\\{ditto}(\.{PASSAGE});\5
\\{ditto}(\.{LOW});\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\.{CANYON},\39\T{0},\39\\{awk}){}$;\5
\\{ditto}(\.{IN});\5
\\{ditto}(\|U);\5
\\{ditto}(\|W);\6
${}\\{make\_inst}(\.{XYZZY},\39\T{0},\39\\{house});{}$\6
${}\\{make\_inst}(\.{PIT},\39\T{0},\39\\{spit}){}$;\7
${}\\{make\_loc}(\\{awk},{}$\6
\.{"You\ are\ in\ an\ awkwa}\)\.{rd\ sloping\ east/west}\)\.{\ canyon."}${},\39%
\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{DEPRESSION},\39\\{not}(\.{GRATE},\39\T{0}),\39%
\\{outside});{}$\6
${}\\{make\_inst}(\.{ENTRANCE},\39\T{0},\39\\{inside});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{debris}){}$;\5
\\{ditto}(\|E);\5
\\{ditto}(\.{DEBRIS});\6
${}\\{make\_inst}(\.{IN},\39\T{0},\39\\{bird}){}$;\5
\\{ditto}(\|U);\5
\\{ditto}(\|W);\6
${}\\{make\_inst}(\.{PIT},\39\T{0},\39\\{spit}){}$;\7
${}\\{make\_loc}(\\{bird},{}$\6
\.{"You\ are\ in\ a\ splend}\)\.{id\ chamber\ thirty\ fe}\)\.{et\ high.\ \ The\
walls\ }\)\.{are\ frozen\\nrivers\ o}\)\.{f\ orange\ stone.\ \ An\ }\)%
\.{awkward\ canyon\ and\ a}\)\.{\ good\ passage\ exit\\n}\)\.{from\ east\ and\
west\ s}\)\.{ides\ of\ the\ chamber.}\)\.{"}${},{}$\6
\.{"You're\ in\ bird\ cham}\)\.{ber."}${},\39\\{bird\_hint});{}$\6
${}\\{make\_inst}(\.{DEPRESSION},\39\\{not}(\.{GRATE},\39\T{0}),\39%
\\{outside});{}$\6
${}\\{make\_inst}(\.{ENTRANCE},\39\T{0},\39\\{inside});{}$\6
${}\\{make\_inst}(\.{DEBRIS},\39\T{0},\39\\{debris});{}$\6
${}\\{make\_inst}(\.{CANYON},\39\T{0},\39\\{awk}){}$;\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\.{PASSAGE},\39\T{0},\39\\{spit}){}$;\5
\\{ditto}(\.{PIT});\5
\\{ditto}(\|W);\7
${}\\{make\_loc}(\\{spit},{}$\6
\.{"At\ your\ feet\ is\ a\ s}\)\.{mall\ pit\ breathing\ t}\)\.{races\ of\ white%
\ mist.}\)\.{\ \ An\ east\\npassage\ e}\)\.{nds\ here\ except\ for\ }\)\.{a\
small\ crack\ leadin}\)\.{g\ on."}${},{}$\6
\.{"You're\ at\ top\ of\ sm}\)\.{all\ pit."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{DEPRESSION},\39\\{not}(\.{GRATE},\39\T{0}),\39%
\\{outside});{}$\6
${}\\{make\_inst}(\.{ENTRANCE},\39\T{0},\39\\{inside});{}$\6
${}\\{make\_inst}(\.{DEBRIS},\39\T{0},\39\\{debris});{}$\6
${}\\{make\_inst}(\.{PASSAGE},\39\T{0},\39\\{bird}){}$;\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\|D,\39\\{holds}(\.{GOLD}),\39\\{neck}){}$;\5
\\{ditto}(\.{PIT});\5
\\{ditto}(\.{STEPS});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{emist}){}$;\C{ good thing you weren't
loaded down with \PB{\.{GOLD}} }\6
${}\\{make\_inst}(\.{CRACK},\39\T{0},\39\\{crack}){}$;\5
\\{ditto}(\|W);\par
\fi

\M[1033 advent.w]{32}Welcome to the main caverns and a deeper level of
adventures.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{emist},{}$\6
\.{"You\ are\ at\ one\ end\ }\)\.{of\ a\ vast\ hall\ stret}\)\.{ching\ forward\
out\ of}\)\.{\ sight\ to\\nthe\ west.}\)\.{\ \ There\ are\ openings}\)\.{\ to\
either\ side.\ \ Ne}\)\.{arby,\ a\ wide\ stone\\n}\)\.{staircase\ leads\ down}%
\)\.{ward.\ \ The\ hall\ is\ f}\)\.{illed\ with\ wisps\ of\ }\)\.{white\ mist%
\\nswaying\ }\)\.{to\ and\ fro\ almost\ as}\)\.{\ if\ alive.\ \ A\ cold\ w}\)%
\.{ind\ blows\ up\ the\\nst}\)\.{aircase.\ \ There\ is\ a}\)\.{\ passage\ at\
the\ top\ }\)\.{of\ a\ dome\ behind\ you}\)\.{."}${},{}$\6
\.{"You're\ in\ Hall\ of\ M}\)\.{ists."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|L,\39\T{0},\39\\{nugget}){}$;\5
\\{ditto}(\|S);\6
${}\\{make\_inst}(\.{FORWARD},\39\T{0},\39\\{efiss}){}$;\5
\\{ditto}(\.{HALL});\5
\\{ditto}(\|W);\6
${}\\{make\_inst}(\.{STAIRS},\39\T{0},\39\\{hmk}){}$;\5
\\{ditto}(\|D);\5
\\{ditto}(\|N);\6
${}\\{make\_inst}(\|U,\39\\{holds}(\.{GOLD}),\39\\{cant}){}$;\5
\\{ditto}(\.{PIT});\5
\\{ditto}(\.{STEPS});\6
\\{ditto}(\.{DOME});\5
\\{ditto}(\.{PASSAGE});\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{spit});{}$\6
${}\\{make\_inst}(\.{Y2},\39\T{0},\39\\{jumble}){}$;\par
\fi

\M[1051 advent.w]{33}To the left or south of the misty threshold, you might
spot the first treasure.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{nugget},{}$\6
\.{"This\ is\ a\ low\ room\ }\)\.{with\ a\ crude\ note\ on}\)\.{\ the\ wall.\ \
The\ note}\)\.{\ says,\\n\\"You\ won't\ }\)\.{get\ it\ up\ the\ steps\\}\)%
\.{"."}${},{}$\6
\.{"You're\ in\ nugget\ of}\)\.{\ gold\ room."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{HALL},\39\T{0},\39\\{emist}){}$;\5
\\{ditto}(\.{OUT});\5
\\{ditto}(\|N);\par
\fi

\M[1060 advent.w]{34}Unless you take a circuitous route to the other side of
the Hall of Mists,
via the Hall of the Mountain King, you should make the \PB{\.{CRYSTAL}} bridge
appear (by getting it into state~1).

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{efiss},{}$\6
\.{"You\ are\ on\ the\ east}\)\.{\ bank\ of\ a\ fissure\ s}\)\.{licing\ clear\
across\ }\)\.{the\ hall.\\nThe\ mist\ }\)\.{is\ quite\ thick\ here,}\)\.{\ and\
the\ fissure\ is\ }\)\.{too\ wide\ to\ jump."}${},{}$\6
\.{"You're\ on\ east\ bank}\)\.{\ of\ fissure."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{HALL},\39\T{0},\39\\{emist}){}$;\5
\\{ditto}(\|E);\6
\\{remark}(\.{"I\ respectfully\ sugg}\)\.{est\ you\ go\ across\ th}\)\.{e\
bridge\ instead\ of\ }\)\.{jumping."});\6
${}\\{bridge\_rmk}\K\\{sayit};{}$\6
${}\\{make\_inst}(\.{JUMP},\39\\{not}(\.{CRYSTAL},\39\T{0}),\39\\{sayit});{}$\6
${}\\{make\_inst}(\.{FORWARD},\39\\{not}(\.{CRYSTAL},\39\T{1}),\39\\{lose});{}$%
\6
\\{remark}(\.{"There\ is\ no\ way\ acr}\)\.{oss\ the\ fissure."});\6
${}\\{make\_inst}(\.{OVER},\39\\{not}(\.{CRYSTAL},\39\T{1}),\39\\{sayit}){}$;\5
\\{ditto}(\.{ACROSS});\5
\\{ditto}(\|W);\5
\\{ditto}(\.{CROSS});\6
${}\\{make\_inst}(\.{OVER},\39\T{0},\39\\{wfiss}){}$;\7
${}\\{make\_loc}(\\{wfiss},{}$\6
\.{"You\ are\ on\ the\ west}\)\.{\ side\ of\ the\ fissure}\)\.{\ in\ the\ Hall\
of\ Mist}\)\.{s."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{JUMP},\39\\{not}(\.{CRYSTAL},\39\T{0}),\39\\{bridge%
\_rmk});{}$\6
${}\\{make\_inst}(\.{FORWARD},\39\\{not}(\.{CRYSTAL},\39\T{1}),\39\\{lose});{}$%
\6
${}\\{make\_inst}(\.{OVER},\39\\{not}(\.{CRYSTAL},\39\T{1}),\39\\{sayit}){}$;\5
\\{ditto}(\.{ACROSS});\5
\\{ditto}(\|E);\5
\\{ditto}(\.{CROSS});\6
${}\\{make\_inst}(\.{OVER},\39\T{0},\39\\{efiss});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{thru});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{wmist}){}$;\par
\fi

\M[1087 advent.w]{35}What you see here isn't exactly what you get; \.N takes
you east and
\.S sucks you in to an amazing maze.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{wmist},{}$\6
\.{"You\ are\ at\ the\ west}\)\.{\ end\ of\ the\ Hall\ of\ }\)\.{Mists.\ \ A\
low\ wide\ c}\)\.{rawl\\ncontinues\ west}\)\.{\ and\ another\ goes\ no}\)%
\.{rth.\ \ To\ the\ south\ i}\)\.{s\ a\ little\\npassage\ }\)\.{6\ feet\ off\
the\ floor}\)\.{."}${},{}$\6
\.{"You're\ at\ west\ end\ }\)\.{of\ Hall\ of\ Mists."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like1}){}$;\5
\\{ditto}(\|U);\5
\\{ditto}(\.{PASSAGE});\5
\\{ditto}(\.{CLIMB});\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{wfiss});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{duck});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{elong}){}$;\5
\\{ditto}(\.{CRAWL});\par
\fi

\M[1101 advent.w]{36}The twisty little passages of this maze are said to be all
alike,
but they respond differently to different motions. For example,
you can go north, east, south, or west from \PB{\\{like1}}, but you can't go
north
from \PB{\\{like2}}. In that way you can psych out the whole maze of 14 similar
locations. (And eventually you will want to know every place where treasure
might be hidden.) The only exits are to \PB{\\{wmist}} and \PB{\\{brink}}.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{like1},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{wmist});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{like1});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like2});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like4});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like11}){}$;\7
${}\\{make\_loc}(\\{like2},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like1});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like3});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like4}){}$;\7
${}\\{make\_loc}(\\{like3},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like2});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{dead5});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like6});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{dead9}){}$;\7
${}\\{make\_loc}(\\{like4},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like1});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{like2});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{dead3});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{dead4});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{like14}){}$;\5
\\{ditto}(\|D);\7
${}\\{make\_loc}(\\{like5},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like6});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like7}){}$;\7
${}\\{make\_loc}(\\{like6},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like3});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like5});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{like7});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like8}){}$;\7
${}\\{make\_loc}(\\{like7},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like5});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{like6});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like8});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like9}){}$;\7
${}\\{make\_loc}(\\{like8},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like6});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like7});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like8});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{like9});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{like10});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{dead11}){}$;\7
${}\\{make\_loc}(\\{like9},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like7});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{like8});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{dead6}){}$;\7
${}\\{make\_loc}(\\{like10},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like8});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{like10});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{dead7});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{brink}){}$;\7
${}\\{make\_loc}(\\{like11},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{like1});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like11}){}$;\5
\\{ditto}(\|S);\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{dead1}){}$;\7
${}\\{make\_loc}(\\{like12},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{brink});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like13});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{dead10}){}$;\7
${}\\{make\_loc}(\\{like13},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{brink});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like12});{}$\6
${}\\{make\_inst}(\.{NW},\39\T{0},\39\\{dead2}){}$;\C{ \PB{\.{NW}}: a dirty
trick! }\7
${}\\{make\_loc}(\\{like14},\39\\{all\_alike},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{like4}){}$;\5
\\{ditto}(\|D);\par
\fi

\M[1187 advent.w]{37}\B\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{brink},{}$\6
\.{"You\ are\ on\ the\ brin}\)\.{k\ of\ a\ thirty-foot\ p}\)\.{it\ with\ a\
massive\ or}\)\.{ange\ column\\ndown\ on}\)\.{e\ wall.\ \ You\ could\ c}\)%
\.{limb\ down\ here\ but\ y}\)\.{ou\ could\ not\ get\ bac}\)\.{k\\nup.\ \ The\
maze\ con}\)\.{tinues\ at\ this\ level}\)\.{."}${},{}$\6
\.{"You're\ at\ brink\ of\ }\)\.{pit."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{bird}){}$;\5
\\{ditto}(\.{CLIMB});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like10});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{dead8});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{like12});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like13}){}$;\par
\fi

\M[1199 advent.w]{38}Crawling west from \PB{\\{wmist}} instead of south, you
encounter this.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{elong},{}$\6
\.{"You\ are\ at\ the\ east}\)\.{\ end\ of\ a\ very\ long\ }\)\.{hall\
apparently\ with}\)\.{out\ side\\nchambers.\ }\)\.{\ To\ the\ east\ a\ low\ w}%
\)\.{ide\ crawl\ slants\ up.}\)\.{\ \ To\ the\ north\ a\\nro}\)\.{und\ two-foot%
\ hole\ sl}\)\.{ants\ down."}${},{}$\6
\.{"You're\ at\ east\ end\ }\)\.{of\ long\ hall."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{wmist}){}$;\5
\\{ditto}(\|U);\5
\\{ditto}(\.{CRAWL});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{wlong});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{cross}){}$;\5
\\{ditto}(\|D);\5
\\{ditto}(\.{HOLE});\7
${}\\{make\_loc}(\\{wlong},{}$\6
\.{"You\ are\ at\ the\ west}\)\.{\ end\ of\ a\ very\ long\ }\)\.{featureless\
hall.\ \ T}\)\.{he\ hall\\njoins\ up\ wi}\)\.{th\ a\ narrow\ north/so}\)\.{uth\
passage."}${},{}$\6
\.{"You're\ at\ west\ end\ }\)\.{of\ long\ hall."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{elong});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{cross});{}$\6
${}\\{make\_inst}(\|S,\39\T{100},\39\\{diff0}){}$;\par
\fi

\M[1219 advent.w]{39}Recall that the `100' on the last instruction above means,
``Dwarves
not permitted.'' It keeps them out of the following maze, which is
based on an $11\times11$ latin square. (Each of the eleven locations
leads to each of the others under the ten motions \PB{\|N}, \PB{\|S}, \PB{\|E},
\PB{\|W},
\PB{\.{NE}}, \PB{\.{SE}}, \PB{\.{NW}}, \PB{\.{SW}}, \PB{\|U}, \PB{\|D} ---
except that \PB{\\{diff0}} goes down to
the entrance location \PB{\\{wlong}} instead of to \PB{\\{diff10}}, and \PB{%
\\{diff10}} goes
south to the dead-end location \PB{\\{pony}} instead of to \PB{\\{diff0}}.
Furthermore,
each location is accessible from all ten possible directions.)

Incidentally, if you ever get into a ``little twisting maze of
passages,'' you're really lost.

\Y\B\4\D$\\{twist}(\|l,\|n,\|s,\|e,\|w,\\{ne},\\{se},\\{nw},\\{sw},\|u,\|d,%
\|m)$ \6
$\\{make\_loc}(\|l,\39\|m,\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\|n){}$;\5
${}\\{make\_inst}(\|S,\39\T{0},\39\|s){}$;\5
${}\\{make\_inst}(\|E,\39\T{0},\39\|e){}$;\5
${}\\{make\_inst}(\|W,\39\T{0},\39\|w);{}$\6
${}\\{make\_inst}(\.{NE},\39\T{0},\39\\{ne}){}$;\5
${}\\{make\_inst}(\.{SE},\39\T{0},\39\\{se}){}$;\5
${}\\{make\_inst}(\.{NW},\39\T{0},\39\\{nw}){}$;\5
${}\\{make\_inst}(\.{SW},\39\T{0},\39\\{sw});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\|u){}$;\5
${}\\{make\_inst}(\|D,\39\T{0},\39\|d){}$;\par
\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{twist}(\\{diff0},\39\\{diff9},\39\\{diff1},\39\\{diff7},\39\\{diff8},\39%
\\{diff3},\39\\{diff4},\39\\{diff6},\39\\{diff2},\39\\{diff5},\39\\{wlong},{}$\6
\.{"You\ are\ in\ a\ maze\ o}\)\.{f\ twisty\ little\ pass}\)\.{ages,\ all\
different.}\)\.{"});\6
${}\\{twist}(\\{diff1},\39\\{diff8},\39\\{diff9},\39\\{diff10},\39\\{diff0},\39%
\\{diff5},\39\\{diff2},\39\\{diff3},\39\\{diff4},\39\\{diff6},\39\\{diff7},{}$\6
\.{"You\ are\ in\ a\ maze\ o}\)\.{f\ twisting\ little\ pa}\)\.{ssages,\ all\
differen}\)\.{t."});\6
${}\\{twist}(\\{diff2},\39\\{diff3},\39\\{diff4},\39\\{diff8},\39\\{diff5},\39%
\\{diff7},\39\\{diff10},\39\\{diff0},\39\\{diff6},\39\\{diff1},\39\\{diff9},{}$%
\6
\.{"You\ are\ in\ a\ little}\)\.{\ maze\ of\ twisty\ pass}\)\.{ages,\ all\
different.}\)\.{"});\6
${}\\{twist}(\\{diff3},\39\\{diff7},\39\\{diff10},\39\\{diff6},\39\\{diff2},\39%
\\{diff4},\39\\{diff9},\39\\{diff8},\39\\{diff5},\39\\{diff0},\39\\{diff1},{}$\6
\.{"You\ are\ in\ a\ twisti}\)\.{ng\ maze\ of\ little\ pa}\)\.{ssages,\ all\
differen}\)\.{t."});\6
${}\\{twist}(\\{diff4},\39\\{diff1},\39\\{diff7},\39\\{diff5},\39\\{diff9},\39%
\\{diff0},\39\\{diff3},\39\\{diff2},\39\\{diff10},\39\\{diff8},\39\\{diff6},{}$%
\6
\.{"You\ are\ in\ a\ twisti}\)\.{ng\ little\ maze\ of\ pa}\)\.{ssages,\ all\
differen}\)\.{t."});\6
${}\\{twist}(\\{diff5},\39\\{diff0},\39\\{diff3},\39\\{diff4},\39\\{diff6},\39%
\\{diff8},\39\\{diff1},\39\\{diff9},\39\\{diff7},\39\\{diff10},\39\\{diff2},{}$%
\6
\.{"You\ are\ in\ a\ twisty}\)\.{\ little\ maze\ of\ pass}\)\.{ages,\ all\
different.}\)\.{"});\6
${}\\{twist}(\\{diff6},\39\\{diff10},\39\\{diff5},\39\\{diff0},\39\\{diff1},\39%
\\{diff9},\39\\{diff8},\39\\{diff7},\39\\{diff3},\39\\{diff2},\39\\{diff4},{}$\6
\.{"You\ are\ in\ a\ twisty}\)\.{\ maze\ of\ little\ pass}\)\.{ages,\ all\
different.}\)\.{"});\6
${}\\{twist}(\\{diff7},\39\\{diff6},\39\\{diff2},\39\\{diff9},\39\\{diff10},\39%
\\{diff1},\39\\{diff0},\39\\{diff5},\39\\{diff8},\39\\{diff4},\39\\{diff3},{}$\6
\.{"You\ are\ in\ a\ little}\)\.{\ twisty\ maze\ of\ pass}\)\.{ages,\ all\
different.}\)\.{"});\6
${}\\{twist}(\\{diff8},\39\\{diff5},\39\\{diff6},\39\\{diff1},\39\\{diff4},\39%
\\{diff2},\39\\{diff7},\39\\{diff10},\39\\{diff9},\39\\{diff3},\39\\{diff0},{}$%
\6
\.{"You\ are\ in\ a\ maze\ o}\)\.{f\ little\ twisting\ pa}\)\.{ssages,\ all\
differen}\)\.{t."});\6
${}\\{twist}(\\{diff9},\39\\{diff4},\39\\{diff8},\39\\{diff2},\39\\{diff3},\39%
\\{diff10},\39\\{diff6},\39\\{diff1},\39\\{diff0},\39\\{diff7},\39\\{diff5},{}$%
\6
\.{"You\ are\ in\ a\ maze\ o}\)\.{f\ little\ twisty\ pass}\)\.{ages,\ all\
different.}\)\.{"});\6
${}\\{twist}(\\{diff10},\39\\{diff2},\39\\{pony},\39\\{diff3},\39\\{diff7},\39%
\\{diff6},\39\\{diff5},\39\\{diff4},\39\\{diff1},\39\\{diff9},\39\\{diff8},{}$\6
\.{"You\ are\ in\ a\ little}\)\.{\ maze\ of\ twisting\ pa}\)\.{ssages,\ all\
differen}\)\.{t."});\7
${}\\{make\_loc}(\\{pony},\39\\{dead\_end},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{diff10}){}$;\5
\\{ditto}(\.{OUT});\par
\fi

\M[1282 advent.w]{40}Going north from the long hall, we come to the vicinity of
another large
room, with royal treasures nearby. (You probably first reached this part of the
cavern from the east, via the Hall of Mists.) Unfortunately, a vicious snake
is here too; the conditional instructions for getting past the snake are
worthy of study.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{cross},{}$\6
\.{"You\ are\ at\ a\ crosso}\)\.{ver\ of\ a\ high\ N/S\ pa}\)\.{ssage\ and\ a\
low\ E/W\ }\)\.{one."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{elong});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{dead0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{west});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{wlong}){}$;\7
${}\\{make\_loc}(\\{hmk},{}$\6
\.{"You\ are\ in\ the\ Hall}\)\.{\ of\ the\ Mountain\ Kin}\)\.{g,\ with\
passages\ off}\)\.{\ in\ all\\ndirections.}\)\.{"}${},{}$\6
\.{"You're\ in\ Hall\ of\ M}\)\.{t\ King."}${},\39\\{snake\_hint});{}$\6
${}\\{make\_inst}(\.{STAIRS},\39\T{0},\39\\{emist}){}$;\5
\\{ditto}(\|U);\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\|N,\39\\{not}(\.{SNAKE},\39\T{0}),\39\\{ns}){}$;\5
\\{ditto}(\|L);\6
${}\\{make\_inst}(\|S,\39\\{not}(\.{SNAKE},\39\T{0}),\39\\{south}){}$;\5
\\{ditto}(\|R);\6
${}\\{make\_inst}(\|W,\39\\{not}(\.{SNAKE},\39\T{0}),\39\\{west}){}$;\5
\\{ditto}(\.{FORWARD});\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{snaked});{}$\6
${}\\{make\_inst}(\.{SW},\39\T{35},\39\\{secret});{}$\6
${}\\{make\_inst}(\.{SW},\39\\{sees}(\.{SNAKE}),\39\\{snaked});{}$\6
${}\\{make\_inst}(\.{SECRET},\39\T{0},\39\\{secret}){}$;\7
${}\\{make\_loc}(\\{west},{}$\6
\.{"You\ are\ in\ the\ west}\)\.{\ side\ chamber\ of\ the}\)\.{\ Hall\ of\ the\
Mountai}\)\.{n\ King.\\nA\ passage\ c}\)\.{ontinues\ west\ and\ up}\)\.{\
here."}${},{}$\6
\.{"You're\ in\ west\ side}\)\.{\ chamber."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{HALL},\39\T{0},\39\\{hmk}){}$;\5
\\{ditto}(\.{OUT});\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{cross}){}$;\5
\\{ditto}(\|U);\7
${}\\{make\_loc}(\\{south},{}$\6
\.{"You\ are\ in\ the\ sout}\)\.{h\ side\ chamber."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{HALL},\39\T{0},\39\\{hmk}){}$;\5
\\{ditto}(\.{OUT});\5
\\{ditto}(\|N);\par
\fi

\M[1320 advent.w]{41}North of the mountain king's domain is a curious shuttle
station called~Y2,
with magic connections to two other places.

(Crowther led a team in 1974 that explored region ``Y'' of Colossal Cave;
``Y2'' was the second location to be named in this region.)

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{ns},{}$\6
\.{"You\ are\ in\ a\ low\ N/}\)\.{S\ passage\ at\ a\ hole\ }\)\.{in\ the\
floor.\ \ The\ h}\)\.{ole\ goes\\ndown\ to\ an}\)\.{\ E/W\ passage."}${},{}$\6
\.{"You're\ in\ N/S\ passa}\)\.{ge."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{HALL},\39\T{0},\39\\{hmk}){}$;\5
\\{ditto}(\.{OUT});\5
\\{ditto}(\|S);\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{y2}){}$;\5
\\{ditto}(\.{Y2});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{dirty}){}$;\5
\\{ditto}(\.{HOLE});\7
${}\\{make\_loc}(\\{y2},{}$\6
\.{"You\ are\ in\ a\ large\ }\)\.{room,\ with\ a\ passage}\)\.{\ to\ the\
south,\ a\ pas}\)\.{sage\ to\ the\\nwest,\ a}\)\.{nd\ a\ wall\ of\ broken\ }\)%
\.{rock\ to\ the\ east.\ \ T}\)\.{here\ is\ a\ large\ \\"Y2}\)\.{\\"\ on\\na\
rock\ in\ the}\)\.{\ room's\ center."}${},{}$\6
\.{"You're\ at\ \\"Y2\\"."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{PLUGH},\39\T{0},\39\\{house});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{ns});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{jumble}){}$;\5
\\{ditto}(\.{WALL});\5
\\{ditto}(\.{BROKEN});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{windoe});{}$\6
${}\\{make\_inst}(\.{PLOVER},\39\\{holds}(\.{EMERALD}),\39\\{pdrop});{}$\6
${}\\{make\_inst}(\.{PLOVER},\39\T{0},\39\\{proom}){}$;\7
${}\\{make\_loc}(\\{jumble},{}$\6
\.{"You\ are\ in\ a\ jumble}\)\.{\ of\ rock,\ with\ crack}\)\.{s\
everywhere."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{y2}){}$;\5
\\{ditto}(\.{Y2});\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{emist}){}$;\7
${}\\{make\_loc}(\\{windoe},{}$\6
\.{"You're\ at\ a\ low\ win}\)\.{dow\ overlooking\ a\ hu}\)\.{ge\ pit,\ which\
extend}\)\.{s\ up\ out\ of\\nsight.\ }\)\.{\ A\ floor\ is\ indistin}\)\.{ctly\
visible\ over\ 50}\)\.{\ feet\ below.\ \ Traces}\)\.{\ of\\nwhite\ mist\ cove}%
\)\.{r\ the\ floor\ of\ the\ p}\)\.{it,\ becoming\ thicker}\)\.{\ to\ the\
right.\\nMark}\)\.{s\ in\ the\ dust\ around}\)\.{\ the\ window\ would\ se}\)%
\.{em\ to\ indicate\ that\\}\)\.{nsomeone\ has\ been\ he}\)\.{re\ recently.\ \
Direct}\)\.{ly\ across\ the\ pit\ fr}\)\.{om\ you\ and\\n25\ feet\ }\)\.{away\
there\ is\ a\ simi}\)\.{lar\ window\ looking\ i}\)\.{nto\ a\ lighted\ room.\\}%
\)\.{nA\ shadowy\ figure\ ca}\)\.{n\ be\ seen\ there\ peer}\)\.{ing\ back\ at\
you."}${},{}$\6
\.{"You're\ at\ window\ on}\)\.{\ pit."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{y2}){}$;\5
\\{ditto}(\.{Y2});\6
${}\\{make\_inst}(\.{JUMP},\39\T{0},\39\\{neck}){}$;\par
\fi

\M[1365 advent.w]{42}Next let's consider the east/west passage below \PB{%
\\{ns}}.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{dirty},{}$\6
\.{"You\ are\ in\ a\ dirty\ }\)\.{broken\ passage.\ \ To\ }\)\.{the\ east\ is\
a\ crawl.}\)\.{\ \ To\ the\\nwest\ is\ a\ }\)\.{large\ passage.\ \ Abov}\)\.{e\
you\ is\ a\ hole\ to\ a}\)\.{nother\ passage."}${},{}$\6
\.{"You're\ in\ dirty\ pas}\)\.{sage."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{clean}){}$;\5
\\{ditto}(\.{CRAWL});\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{ns}){}$;\5
\\{ditto}(\.{HOLE});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{dusty});{}$\6
${}\\{make\_inst}(\.{BEDQUILT},\39\T{0},\39\\{bedquilt}){}$;\7
${}\\{make\_loc}(\\{clean},{}$\6
\.{"You\ are\ on\ the\ brin}\)\.{k\ of\ a\ small\ clean\ c}\)\.{limbable\ pit.\
\ A\ cra}\)\.{wl\ leads\\nwest."}${},{}$\6
\.{"You're\ by\ a\ clean\ p}\)\.{it."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{dirty}){}$;\5
\\{ditto}(\.{CRAWL});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{wet}){}$;\5
\\{ditto}(\.{PIT});\5
\\{ditto}(\.{CLIMB});\7
${}\\{make\_loc}(\\{wet},{}$\6
\.{"You\ are\ in\ the\ bott}\)\.{om\ of\ a\ small\ pit\ wi}\)\.{th\ a\ little\
stream,\ }\)\.{which\\nenters\ and\ ex}\)\.{its\ through\ tiny\ sli}\)%
\.{ts."}${},{}$\6
\.{"You're\ in\ pit\ by\ st}\)\.{ream."}${},\39\\{liquid});{}$\6
${}\\{make\_inst}(\.{CLIMB},\39\T{0},\39\\{clean}){}$;\5
\\{ditto}(\|U);\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\.{SLIT},\39\T{0},\39\\{slit\_rmk}){}$;\5
\\{ditto}(\.{STREAM});\5
\\{ditto}(\|D);\5
\\{ditto}(\.{UPSTREAM});\5
\\{ditto}(\.{DOWNSTREAM});\7
${}\\{make\_loc}(\\{dusty},{}$\6
\.{"You\ are\ in\ a\ large\ }\)\.{room\ full\ of\ dusty\ r}\)\.{ocks.\ \ There\
is\ a\ bi}\)\.{g\ hole\ in\\nthe\ floor}\)\.{.\ \ There\ are\ cracks\ }\)%
\.{everywhere,\ and\ a\ pa}\)\.{ssage\ leading\ east."}${},{}$\6
\.{"You're\ in\ dusty\ roc}\)\.{k\ room."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{dirty}){}$;\5
\\{ditto}(\.{PASSAGE});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{complex}){}$;\5
\\{ditto}(\.{HOLE});\5
\\{ditto}(\.{FLOOR});\6
${}\\{make\_inst}(\.{BEDQUILT},\39\T{0},\39\\{bedquilt}){}$;\7
${}\\{make\_loc}(\\{complex},{}$\6
\.{"You\ are\ at\ a\ comple}\)\.{x\ junction.\ \ A\ low\ h}\)\.{ands-and-knees\
passa}\)\.{ge\ from\ the\\nnorth\ j}\)\.{oins\ a\ higher\ crawl\ }\)\.{from\
the\ east\ to\ mak}\)\.{e\ a\ walking\ passage\\}\)\.{ngoing\ west.\ \ There\ }%
\)\.{is\ also\ a\ large\ room}\)\.{\ above.\ \ The\ air\ is\ }\)\.{damp\
here."}${},{}$\6
\.{"You're\ at\ complex\ j}\)\.{unction."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{dusty}){}$;\5
\\{ditto}(\.{CLIMB});\5
\\{ditto}(\.{ROOM});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{bedquilt}){}$;\5
\\{ditto}(\.{BEDQUILT});\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{shell}){}$;\5
\\{ditto}(\.{SHELL});\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{ante}){}$;\par
\fi

\M[1409 advent.w]{43}A more-or-less self-contained cavelet can be found north
of the complex
passage. Its connections are more vertical than horizontal.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{shell},{}$\6
\.{"You're\ in\ a\ large\ r}\)\.{oom\ carved\ out\ of\ se}\)\.{dimentary\ rock.%
\ \ The}\)\.{\ floor\\nand\ walls\ ar}\)\.{e\ littered\ with\ bits}\)\.{\ of\
shells\ embedded\ }\)\.{in\ the\ stone.\\nA\ sha}\)\.{llow\ passage\ proceed}\)%
\.{s\ downward,\ and\ a\ so}\)\.{mewhat\ steeper\ one\\n}\)\.{leads\ up.\ \ A\
low\ han}\)\.{ds-and-knees\ passage}\)\.{\ enters\ from\ the\ sou}\)%
\.{th."}${},{}$\6
\.{"You're\ in\ Shell\ Roo}\)\.{m."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{arch}){}$;\5
\\{ditto}(\.{HALL});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{ragged});{}$\6
\\{remark}(\.{"You\ can't\ fit\ this\ }\)\.{five-foot\ clam\ throu}\)\.{gh\
that\ little\ passa}\)\.{ge!"});\6
${}\\{make\_inst}(\|S,\39\\{holds}(\.{CLAM}),\39\\{sayit});{}$\6
\\{remark}(\.{"You\ can't\ fit\ this\ }\)\.{five-foot\ oyster\ thr}\)\.{ough\
that\ little\ pas}\)\.{sage!"});\6
${}\\{make\_inst}(\|S,\39\\{holds}(\.{OYSTER}),\39\\{sayit});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{complex}){}$;\7
${}\\{make\_loc}(\\{arch},{}$\6
\.{"You\ are\ in\ an\ arche}\)\.{d\ hall.\ \ A\ coral\ pas}\)\.{sage\ once\
continued\ }\)\.{up\ and\ east\\nfrom\ he}\)\.{re,\ but\ is\ now\ block}\)\.{ed%
\ by\ debris.\ \ The\ a}\)\.{ir\ smells\ of\ sea\ wat}\)\.{er."}${},{}$\6
\.{"You're\ in\ arched\ ha}\)\.{ll."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{shell}){}$;\5
\\{ditto}(\.{SHELL});\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{ragged},{}$\6
\.{"You\ are\ in\ a\ long\ s}\)\.{loping\ corridor\ with}\)\.{\ ragged\ sharp\
walls.}\)\.{"}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{shell}){}$;\5
\\{ditto}(\.{SHELL});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{sac}){}$;\7
${}\\{make\_loc}(\\{sac},{}$\6
\.{"You\ are\ in\ a\ cul-de}\)\.{-sac\ about\ eight\ fee}\)\.{t\ across."}${},%
\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{ragged}){}$;\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\.{SHELL},\39\T{0},\39\\{shell}){}$;\par
\fi

\M[1443 advent.w]{44}A dangerous section lies east of the complex junction.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{ante},{}$\6
\.{"You\ are\ in\ an\ anter}\)\.{oom\ leading\ to\ a\ lar}\)\.{ge\ passage\ to\
the\ ea}\)\.{st.\ \ Small\\npassages}\)\.{\ go\ west\ and\ up.\ \ Th}\)\.{e\
remnants\ of\ recent}\)\.{\ digging\ are\ evident}\)\.{.\\nA\ sign\ in\ midair\
}\)\.{here\ says\ \\"CAVE\ UND}\)\.{ER\ CONSTRUCTION\ BEYO}\)\.{ND\ THIS\
POINT.\\nPROC}\)\.{EED\ AT\ OWN\ RISK.\ \ [W}\)\.{ITT\ CONSTRUCTION\ COM}\)%
\.{PANY]\\""}${},{}$\6
\.{"You're\ in\ anteroom.}\)\.{"}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{complex});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{bedquilt});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{witt}){}$;\7
${}\\{make\_loc}(\\{witt},{}$\6
\.{"You\ are\ at\ Witt's\ E}\)\.{nd.\ \ Passages\ lead\ o}\)\.{ff\ in\ \\"all%
\\"\ direct}\)\.{ions."}${},{}$\6
\.{"You're\ at\ Witt's\ En}\)\.{d."}${},\39\\{witt\_hint});{}$\6
\\{remark}(\.{"You\ have\ crawled\ ar}\)\.{ound\ in\ some\ little\ }\)\.{holes\
and\ wound\ up\ b}\)\.{ack\ in\ the\\nmain\ pas}\)\.{sage."});\6
${}\\{loop\_rmk}\K\\{sayit};{}$\6
${}\\{make\_inst}(\|E,\39\T{95},\39\\{sayit}){}$;\5
\\{ditto}(\|N);\5
\\{ditto}(\|S);\6
\\{ditto}(\.{NE});\5
\\{ditto}(\.{SE});\5
\\{ditto}(\.{SW});\5
\\{ditto}(\.{NW});\5
\\{ditto}(\|U);\5
\\{ditto}(\|D);\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{ante}){}$;\C{ one chance in 20 }\6
\\{remark}(\.{"You\ have\ crawled\ ar}\)\.{ound\ in\ some\ little\ }\)\.{holes\
and\ found\ your}\)\.{\ way\\nblocked\ by\ a\ r}\)\.{ecent\ cave-in.\ \ You\ }%
\)\.{are\ now\ back\ in\ the\ }\)\.{main\ passage."});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{sayit}){}$;\par
\fi

\M[1469 advent.w]{45}Will Crowther, who actively explored and mapped many caves
in Kentucky
before inventing Adventure, named Bedquilt after the Bedquilt Entrance
to Colossal Cave. (The real Colossal Cave was discovered near Mammoth Cave
in 1895, and its Bedquilt Entrance was found in 1896; see {\sl The Longest
Cave\/} by Brucker and Watson (New York:\ Knopf, 1976) for further details.)

Random exploration is the name of the game here.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{bedquilt},{}$\6
\.{"You\ are\ in\ Bedquilt}\)\.{,\ a\ long\ east/west\ p}\)\.{assage\ with\
holes\ ev}\)\.{erywhere.\\nTo\ explor}\)\.{e\ at\ random\ select\ n}\)\.{orth,\
south,\ up,\ or\ }\)\.{down."}${},{}$\6
\.{"You're\ in\ Bedquilt.}\)\.{"}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{complex});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{cheese});{}$\6
${}\\{make\_inst}(\|S,\39\T{80},\39\\{loop\_rmk});{}$\6
${}\\{make\_inst}(\.{SLAB},\39\T{0},\39\\{slab});{}$\6
${}\\{make\_inst}(\|U,\39\T{80},\39\\{loop\_rmk});{}$\6
${}\\{make\_inst}(\|U,\39\T{50},\39\\{abovep});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{dusty});{}$\6
${}\\{make\_inst}(\|N,\39\T{60},\39\\{loop\_rmk});{}$\6
${}\\{make\_inst}(\|N,\39\T{75},\39\\{low});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{sjunc});{}$\6
${}\\{make\_inst}(\|D,\39\T{80},\39\\{loop\_rmk});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{ante}){}$;\7
${}\\{make\_loc}(\\{cheese},{}$\6
\.{"You\ are\ in\ a\ room\ w}\)\.{hose\ walls\ resemble\ }\)\.{Swiss\ cheese.\ %
\ Obvio}\)\.{us\ passages\\ngo\ west}\)\.{,\ east,\ NE,\ and\ NW.\ }\)\.{\ Part%
\ of\ the\ room\ is}\)\.{\ occupied\ by\ a\ large}\)\.{\\nbedrock\
block."}${},{}$\6
\.{"You're\ in\ Swiss\ che}\)\.{ese\ room."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{NE},\39\T{0},\39\\{bedquilt});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{e2pit});{}$\6
${}\\{make\_inst}(\|S,\39\T{80},\39\\{loop\_rmk});{}$\6
${}\\{make\_inst}(\.{CANYON},\39\T{0},\39\\{tall});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{soft});{}$\6
${}\\{make\_inst}(\.{NW},\39\T{50},\39\\{loop\_rmk});{}$\6
${}\\{make\_inst}(\.{ORIENTAL},\39\T{0},\39\\{oriental}){}$;\7
${}\\{make\_loc}(\\{soft},{}$\6
\.{"You\ are\ in\ the\ Soft}\)\.{\ Room.\ \ The\ walls\ ar}\)\.{e\ covered\
with\ heavy}\)\.{\ curtains,\\nthe\ floo}\)\.{r\ with\ a\ thick\ pile\ }\)%
\.{carpet.\ \ Moss\ covers}\)\.{\ the\ ceiling."}${},{}$\6
\.{"You're\ in\ Soft\ Room}\)\.{."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{cheese}){}$;\5
\\{ditto}(\.{OUT});\par
\fi

\M[1518 advent.w]{46}West of the quilt and the cheese is a room with two pits.

Why would you want
to descend into the pits? Keep playing and you'll find out.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{e2pit},{}$\6
\.{"You\ are\ at\ the\ east}\)\.{\ end\ of\ the\ Twopit\ R}\)\.{oom.\ \ The\
floor\ here}\)\.{\ is\\nlittered\ with\ t}\)\.{hin\ rock\ slabs,\ whic}\)\.{h\
make\ it\ easy\ to\ de}\)\.{scend\ the\ pits.\\nThe}\)\.{re\ is\ a\ path\ here\
by}\)\.{passing\ the\ pits\ to\ }\)\.{connect\ passages\ fro}\)\.{m\ east\\nand%
\ west.\ \ T}\)\.{here\ are\ holes\ all\ o}\)\.{ver,\ but\ the\ only\ bi}\)\.{g%
\ one\ is\ on\ the\\nwal}\)\.{l\ directly\ over\ the\ }\)\.{west\ pit\ where\
you\ c}\)\.{an't\ get\ to\ it."}${},{}$\6
\.{"You're\ at\ east\ end\ }\)\.{of\ Twopit\ Room."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{cheese});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{w2pit}){}$;\5
\\{ditto}(\.{ACROSS});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{epit}){}$;\5
\\{ditto}(\.{PIT});\7
${}\\{make\_loc}(\\{w2pit},{}$\6
\.{"You\ are\ at\ the\ west}\)\.{\ end\ of\ the\ Twopit\ R}\)\.{oom.\ \ There\
is\ a\ lar}\)\.{ge\ hole\ in\\nthe\ wall}\)\.{\ above\ the\ pit\ at\ th}\)\.{is%
\ end\ of\ the\ room."}${},{}$\6
\.{"You're\ at\ west\ end\ }\)\.{of\ Twopit\ Room."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{e2pit}){}$;\5
\\{ditto}(\.{ACROSS});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{slab}){}$;\5
\\{ditto}(\.{SLAB});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{wpit}){}$;\5
\\{ditto}(\.{PIT});\6
\\{remark}(\.{"It\ is\ too\ far\ up\ fo}\)\.{r\ you\ to\ reach."});\6
${}\\{make\_inst}(\.{HOLE},\39\T{0},\39\\{sayit}){}$;\7
${}\\{make\_loc}(\\{epit},{}$\6
\.{"You\ are\ at\ the\ bott}\)\.{om\ of\ the\ eastern\ pi}\)\.{t\ in\ the\
Twopit\ Room}\)\.{.\ \ There\ is\\na\ small}\)\.{\ pool\ of\ oil\ in\ one\ }\)%
\.{corner\ of\ the\ pit."}${},{}$\6
\.{"You're\ in\ east\ pit.}\)\.{"}${},\39\\{liquid}+\\{oil});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{e2pit}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{wpit},{}$\6
\.{"You\ are\ at\ the\ bott}\)\.{om\ of\ the\ western\ pi}\)\.{t\ in\ the\
Twopit\ Room}\)\.{.\ \ There\ is\\na\ large}\)\.{\ hole\ in\ the\ wall\ ab}\)%
\.{out\ 25\ feet\ above\ yo}\)\.{u."}${},{}$\6
\.{"You're\ in\ west\ pit.}\)\.{"}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{w2pit}){}$;\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\.{CLIMB},\39\\{not}(\.{PLANT},\39\T{4}),\39\\{check});{}$\6
${}\\{make\_inst}(\.{CLIMB},\39\T{0},\39\\{climb}){}$;\par
\fi

\M[1559 advent.w]{47}Oho, you climbed the plant in the west pit! Now you're in
another
scenic area with rare treasures---if you can get through the door.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{narrow},{}$\6
\.{"You\ are\ in\ a\ long,\ }\)\.{narrow\ corridor\ stre}\)\.{tching\ out\ of\
sight\ }\)\.{to\ the\\nwest.\ \ At\ th}\)\.{e\ eastern\ end\ is\ a\ h}\)\.{ole\
through\ which\ yo}\)\.{u\ can\ see\ a\\nprofusi}\)\.{on\ of\ leaves."}${},{}$\6
\.{"You're\ in\ narrow\ co}\)\.{rridor."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{wpit}){}$;\5
\\{ditto}(\.{CLIMB});\5
\\{ditto}(\|E);\6
${}\\{make\_inst}(\.{JUMP},\39\T{0},\39\\{neck});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{giant}){}$;\5
\\{ditto}(\.{GIANT});\7
${}\\{make\_loc}(\\{giant},{}$\6
\.{"You\ are\ in\ the\ Gian}\)\.{t\ Room.\ \ The\ ceiling}\)\.{\ here\ is\ too\
high\ up}\)\.{\ for\ your\\nlamp\ to\ s}\)\.{how\ it.\ \ Cavernous\ p}\)%
\.{assages\ lead\ east,\ n}\)\.{orth,\ and\ south.\ \ On}\)\.{\\nthe\ west\
wall\ is\ s}\)\.{crawled\ the\ inscript}\)\.{ion,\ \\"FEE\ FIE\ FOE\ F}\)\.{OO%
\\"\ [sic]."}${},{}$\6
\.{"You're\ in\ Giant\ Roo}\)\.{m."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{narrow});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{block});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{immense}){}$;\7
${}\\{make\_loc}(\\{block},{}$\6
\.{"The\ passage\ here\ is}\)\.{\ blocked\ by\ a\ recent}\)\.{\ cave-in."}${},%
\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{giant}){}$;\5
\\{ditto}(\.{GIANT});\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{immense},{}$\6
\.{"You\ are\ at\ one\ end\ }\)\.{of\ an\ immense\ north/}\)\.{south\
passage."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{giant}){}$;\5
\\{ditto}(\.{GIANT});\5
\\{ditto}(\.{PASSAGE});\6
${}\\{make\_inst}(\|N,\39\\{not}(\.{DOOR},\39\T{0}),\39\\{falls}){}$;\5
\\{ditto}(\.{ENTER});\5
\\{ditto}(\.{CAVERN});\6
\\{remark}(\.{"The\ door\ is\ extreme}\)\.{ly\ rusty\ and\ refuses}\)\.{\ to\
open."});\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{sayit}){}$;\7
${}\\{make\_loc}(\\{falls},{}$\6
\.{"You\ are\ in\ a\ magnif}\)\.{icent\ cavern\ with\ a\ }\)\.{rushing\ stream,%
\ whic}\)\.{h\ cascades\\nover\ a\ s}\)\.{parkling\ waterfall\ i}\)\.{nto\ a\
roaring\ whirlp}\)\.{ool\ that\ disappears\\}\)\.{nthrough\ a\ hole\ in\ t}\)%
\.{he\ floor.\ \ Passages\ }\)\.{exit\ to\ the\ south\ an}\)\.{d\
west."}${},{}$\6
\.{"You're\ in\ cavern\ wi}\)\.{th\ waterfall."}${},\39\\{liquid});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{immense}){}$;\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\.{GIANT},\39\T{0},\39\\{giant});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{steep}){}$;\7
${}\\{make\_loc}(\\{steep},{}$\6
\.{"You\ are\ at\ the\ top\ }\)\.{of\ a\ steep\ incline\ a}\)\.{bove\ a\ large\
room.\ \ }\)\.{You\ could\\nclimb\ dow}\)\.{n\ here,\ but\ you\ woul}\)\.{d\
not\ be\ able\ to\ cli}\)\.{mb\ up.\ \ There\ is\ a\\n}\)\.{passage\ leading\
back}\)\.{\ to\ the\ north."}${},{}$\6
\.{"You're\ at\ steep\ inc}\)\.{line\ above\ large\ roo}\)\.{m."}${},\39%
\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{falls}){}$;\5
\\{ditto}(\.{CAVERN});\5
\\{ditto}(\.{PASSAGE});\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{low}){}$;\5
\\{ditto}(\.{CLIMB});\par
\fi

\M[1609 advent.w]{48}Meanwhile let's backtrack to another part of the cave
possibly reachable
from Bedquilt.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{abovep},{}$\6
\.{"You\ are\ in\ a\ secret}\)\.{\ N/S\ canyon\ above\ a\ }\)\.{sizable\
passage."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{sjunc});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{bedquilt}){}$;\5
\\{ditto}(\.{PASSAGE});\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{tite}){}$;\7
${}\\{make\_loc}(\\{sjunc},{}$\6
\.{"You\ are\ in\ a\ secret}\)\.{\ canyon\ at\ a\ junctio}\)\.{n\ of\ three\
canyons,\ }\)\.{bearing\\nnorth,\ sout}\)\.{h,\ and\ SE.\ \ The\ nort}\)\.{h\
one\ is\ as\ tall\ as\ }\)\.{the\ other\ two\\ncombi}\)\.{ned."}${},{}$\6
\.{"You're\ at\ junction\ }\)\.{of\ three\ secret\ cany}\)\.{ons."}${},\39%
\T{0});{}$\6
${}\\{make\_inst}(\.{SE},\39\T{0},\39\\{bedquilt});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{abovep});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{window}){}$;\7
${}\\{make\_loc}(\\{tite},{}$\6
\.{"A\ large\ stalactite\ }\)\.{extends\ from\ the\ roo}\)\.{f\ and\ almost\
reaches}\)\.{\ the\ floor\\nbelow.\ \ }\)\.{You\ could\ climb\ down}\)\.{\ it,\
and\ jump\ from\ i}\)\.{t\ to\ the\ floor,\ but\\}\)\.{nhaving\ done\ so\ you\
}\)\.{would\ be\ unable\ to\ r}\)\.{each\ it\ to\ climb\ bac}\)\.{k\
up."}${},{}$\6
\.{"You're\ on\ top\ of\ st}\)\.{alactite."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{abovep});{}$\6
${}\\{make\_inst}(\|D,\39\T{40},\39\\{like6}){}$;\5
\\{ditto}(\.{JUMP});\5
\\{ditto}(\.{CLIMB});\6
${}\\{make\_inst}(\|D,\39\T{50},\39\\{like9});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{like4}){}$;\C{ oh dear, you're in a random
part of the maze }\7
${}\\{make\_loc}(\\{low},{}$\6
\.{"You\ are\ in\ a\ large\ }\)\.{low\ room.\ \ Crawls\ le}\)\.{ad\ north,\ SE,%
\ and\ SW}\)\.{."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{BEDQUILT},\39\T{0},\39\\{bedquilt});{}$\6
${}\\{make\_inst}(\.{SW},\39\T{0},\39\\{scorr});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{crawl});{}$\6
${}\\{make\_inst}(\.{SE},\39\T{0},\39\\{oriental}){}$;\5
\\{ditto}(\.{ORIENTAL});\7
${}\\{make\_loc}(\\{crawl},{}$\6
\.{"Dead\ end\ crawl."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{low}){}$;\5
\\{ditto}(\.{CRAWL});\5
\\{ditto}(\.{OUT});\par
\fi

\M[1649 advent.w]{49}The described view from the west window, \PB{\\{window}},
is identical to the view from the east window, \PB{\\{windoe}}, except for one
word.
What on earth do you see from those windows? (Don Woods has confided
that the shadowy figure is actually your own reflection, because
\PB{\\{mirror}} lies between the two window rooms. An intentional false clue.)

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{window},{}$\6
\.{"You're\ at\ a\ low\ win}\)\.{dow\ overlooking\ a\ hu}\)\.{ge\ pit,\ which\
extend}\)\.{s\ up\ out\ of\\nsight.\ }\)\.{\ A\ floor\ is\ indistin}\)\.{ctly\
visible\ over\ 50}\)\.{\ feet\ below.\ \ Traces}\)\.{\ of\\nwhite\ mist\ cove}%
\)\.{r\ the\ floor\ of\ the\ p}\)\.{it,\ becoming\ thicker}\)\.{\ to\ the\
left.\\nMarks}\)\.{\ in\ the\ dust\ around\ }\)\.{the\ window\ would\ see}\)%
\.{m\ to\ indicate\ that\\n}\)\.{someone\ has\ been\ her}\)\.{e\ recently.\ \
Directl}\)\.{y\ across\ the\ pit\ fro}\)\.{m\ you\ and\\n25\ feet\ a}\)\.{way\
there\ is\ a\ simil}\)\.{ar\ window\ looking\ in}\)\.{to\ a\ lighted\ room.\\n}%
\)\.{A\ shadowy\ figure\ can}\)\.{\ be\ seen\ there\ peeri}\)\.{ng\ back\ at\
you."}${},{}$\6
\\{short\_desc}[\\{windoe}]${},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{sjunc});{}$\6
${}\\{make\_inst}(\.{JUMP},\39\T{0},\39\\{neck}){}$;\par
\fi

\M[1669 advent.w]{50}More treasures await you via the \PB{\\{low}} corridor.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{oriental},{}$\6
\.{"This\ is\ the\ Orienta}\)\.{l\ Room.\ \ Ancient\ ori}\)\.{ental\ cave\
drawings\ }\)\.{cover\ the\\nwalls.\ \ A}\)\.{\ gently\ sloping\ pass}\)\.{age\
leads\ upward\ to\ }\)\.{the\ north,\ another\\n}\)\.{passage\ leads\ SE,\ an}%
\)\.{d\ a\ hands-and-knees\ }\)\.{crawl\ leads\ west."}${},{}$\6
\.{"You're\ in\ Oriental\ }\)\.{Room."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{SE},\39\T{0},\39\\{cheese});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{low}){}$;\5
\\{ditto}(\.{CRAWL});\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{misty}){}$;\5
\\{ditto}(\|N);\5
\\{ditto}(\.{CAVERN});\7
${}\\{make\_loc}(\\{misty},{}$\6
\.{"You\ are\ following\ a}\)\.{\ wide\ path\ around\ th}\)\.{e\ outer\ edge\
of\ a\ la}\)\.{rge\ cavern.\\nFar\ bel}\)\.{ow,\ through\ a\ heavy\ }\)\.{white%
\ mist,\ strange\ }\)\.{splashing\ noises\ can}\)\.{\ be\\nheard.\ \ The\ mis}%
\)\.{t\ rises\ up\ through\ a}\)\.{\ fissure\ in\ the\ ceil}\)\.{ing.\ \ The\
path\\nexit}\)\.{s\ to\ the\ south\ and\ w}\)\.{est."}${},{}$\6
\.{"You're\ in\ misty\ cav}\)\.{ern."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{oriental}){}$;\5
\\{ditto}(\.{ORIENTAL});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{alcove}){}$;\par
\fi

\M[1690 advent.w]{51}One of the darkest secrets is hidden here. You will
discover that
you must take the emerald from the Plover Room to the alcove. But you
don't learn the name of the Plover Room until the second time you've
been there, since your first visit will be lampless until you know the secret.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{alcove},{}$\6
\.{"You\ are\ in\ an\ alcov}\)\.{e.\ \ A\ small\ NW\ path\ }\)\.{seems\ to\
widen\ after}\)\.{\ a\ short\\ndistance.\ }\)\.{\ An\ extremely\ tight\ }\)%
\.{tunnel\ leads\ east.\ \ }\)\.{It\ looks\ like\ a\ very}\)\.{\\ntight\
squeeze.\ \ An}\)\.{\ eerie\ light\ can\ be\ }\)\.{seen\ at\ the\ other\ en}\)%
\.{d."}${},{}$\6
\.{"You're\ in\ alcove."}${},\39\\{dark\_hint});{}$\6
${}\\{make\_inst}(\.{NW},\39\T{0},\39\\{misty}){}$;\5
\\{ditto}(\.{CAVERN});\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{ppass}){}$;\5
\\{ditto}(\.{PASSAGE});\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{proom}){}$;\C{ never performed, but seen
by `\.{go} \.{back}' }\7
${}\\{make\_loc}(\\{proom},{}$\6
\.{"You're\ in\ a\ small\ c}\)\.{hamber\ lit\ by\ an\ eer}\)\.{ie\ green\
light.\ \ An\ }\)\.{extremely\\nnarrow\ tu}\)\.{nnel\ exits\ to\ the\ we}\)%
\.{st.\ \ A\ dark\ corridor}\)\.{\ leads\ NE."}${},{}$\6
\.{"You're\ in\ Plover\ Ro}\)\.{om."}${},\39\\{lighted}+\\{dark\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{ppass}){}$;\5
\\{ditto}(\.{PASSAGE});\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{alcove}){}$;\C{ never performed, but seen
by `\.{go} \.{back}' }\6
${}\\{make\_inst}(\.{PLOVER},\39\\{holds}(\.{EMERALD}),\39\\{pdrop});{}$\6
${}\\{make\_inst}(\.{PLOVER},\39\T{0},\39\\{y2});{}$\6
${}\\{make\_inst}(\.{NE},\39\T{0},\39\\{droom}){}$;\5
\\{ditto}(\.{DARK});\7
${}\\{make\_loc}(\\{droom},{}$\6
\.{"You're\ in\ the\ Dark-}\)\.{Room.\ \ A\ corridor\ le}\)\.{ading\ south\ is\
the\ o}\)\.{nly\ exit."}${},{}$\6
\.{"You're\ in\ Dark-Room}\)\.{."}${},\39\\{dark\_hint});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{proom}){}$;\5
\\{ditto}(\.{PLOVER});\5
\\{ditto}(\.{OUT});\par
\fi

\M[1720 advent.w]{52}We forgot to mention the circuitous passage leading west
from the
Twopit Room. It winds around and takes you to a somewhat more mundane
area, yet not without interest.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{slab},{}$\6
\.{"You\ are\ in\ a\ large\ }\)\.{low\ circular\ chamber}\)\.{\ whose\ floor\
is\ an\ i}\)\.{mmense\ slab\\nfallen\ }\)\.{from\ the\ ceiling\ (Sl}\)\.{ab\
Room).\ \ There\ onc}\)\.{e\ were\ large\ passage}\)\.{s\\nto\ the\ east\ and\
w}\)\.{est,\ but\ they\ are\ no}\)\.{w\ filled\ with\ boulde}\)\.{rs.\ \ Low%
\\nsmall\ pass}\)\.{ages\ go\ north\ and\ so}\)\.{uth,\ and\ the\ south\ o}\)%
\.{ne\ quickly\ bends\\nea}\)\.{st\ around\ the\ boulde}\)\.{rs."}${},{}$\C{
Woods originally said `\.{west}' }\6
\.{"You're\ in\ Slab\ Room}\)\.{."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{w2pit});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{abover}){}$;\5
\\{ditto}(\.{CLIMB});\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{bedquilt}){}$;\7
${}\\{make\_loc}(\\{abover},{}$\6
\.{"You\ are\ in\ a\ secret}\)\.{\ N/S\ canyon\ above\ a\ }\)\.{large\
room."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{slab}){}$;\5
\\{ditto}(\.{SLAB});\6
${}\\{make\_inst}(\|S,\39\\{not}(\.{DRAGON},\39\T{0}),\39\\{scan2});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{scan1});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{mirror});{}$\6
${}\\{make\_inst}(\.{RESERVOIR},\39\T{0},\39\\{res}){}$;\7
${}\\{make\_loc}(\\{mirror},{}$\6
\.{"You\ are\ in\ a\ north/}\)\.{south\ canyon\ about\ 2}\)\.{5\ feet\ across.\
\ The\ }\)\.{floor\ is\\ncovered\ by}\)\.{\ white\ mist\ seeping\ }\)\.{in\
from\ the\ north.\ \ }\)\.{The\ walls\ extend\\nup}\)\.{ward\ for\ well\ over\
1}\)\.{00\ feet.\ \ Suspended\ }\)\.{from\ some\ unseen\ poi}\)\.{nt\ far%
\\nabove\ you,\ a}\)\.{n\ enormous\ two-sided}\)\.{\ mirror\ is\ hanging\ p}\)%
\.{arallel\ to\ and\\nmidw}\)\.{ay\ between\ the\ canyo}\)\.{n\ walls.\ \ (The\
mirro}\)\.{r\ is\ obviously\ provi}\)\.{ded\\nfor\ the\ use\ of\ }\)\.{the\
dwarves,\ who\ as\ }\)\.{you\ know\ are\ extreme}\)\.{ly\ vain.)\\nA\ small\ w}%
\)\.{indow\ can\ be\ seen\ in}\)\.{\ either\ wall,\ some\ f}\)\.{ifty\ feet\
up."}${},{}$\6
\.{"You're\ in\ mirror\ ca}\)\.{nyon."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{abover});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{res}){}$;\5
\\{ditto}(\.{RESERVOIR});\7
${}\\{make\_loc}(\\{res},{}$\6
\.{"You\ are\ at\ the\ edge}\)\.{\ of\ a\ large\ undergro}\)\.{und\ reservoir.\
\ An\ o}\)\.{paque\ cloud\\nof\ whit}\)\.{e\ mist\ fills\ the\ roo}\)\.{m\ and\
rises\ rapidly\ }\)\.{upward.\ \ The\ lake\ is}\)\.{\\nfed\ by\ a\ stream,\ w}%
\)\.{hich\ tumbles\ out\ of\ }\)\.{a\ hole\ in\ the\ wall\ a}\)\.{bout\ 10\
feet\\noverhe}\)\.{ad\ and\ splashes\ nois}\)\.{ily\ into\ the\ water\ s}\)%
\.{omewhere\ within\ the\\}\)\.{nmist.\ \ The\ only\ pas}\)\.{sage\ goes\ back\
towar}\)\.{d\ the\ south."}${},{}$\6
\.{"You're\ at\ reservoir}\)\.{."}${},\39\\{liquid});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{mirror}){}$;\5
\\{ditto}(\.{OUT});\par
\fi

\M[1765 advent.w]{53}Four more secret canyons lead back to the Hall of the
Mountain King.
Three of them are actually the same, but the dragon blocks the
connection between the northern passage (to \PB{\\{abover}}) and the
eastern passage (to \PB{\\{secret}}). Once you've vanquished the dragon,
\PB{\\{scan2}} takes the place of \PB{\\{scan1}} and \PB{\\{scan3}}.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{scan1},{}$\6
\.{"You\ are\ in\ a\ secret}\)\.{\ canyon\ that\ exits\ t}\)\.{o\ the\ north\
and\ east}\)\.{."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{abover}){}$;\5
\\{ditto}(\.{OUT});\6
\\{remark}(\.{"The\ dragon\ looks\ ra}\)\.{ther\ nasty.\ \ You'd\ b}\)\.{est\
not\ try\ to\ get\ b}\)\.{y."});\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{sayit}){}$;\5
\\{ditto}(\.{FORWARD});\7
${}\\{make\_loc}(\\{scan2},\39\\{long\_desc}[\\{scan1}],\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{abover});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{secret}){}$;\7
${}\\{make\_loc}(\\{scan3},\39\\{long\_desc}[\\{scan1}],\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{secret}){}$;\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{sayit}){}$;\5
\\{ditto}(\.{FORWARD});\7
${}\\{make\_loc}(\\{secret},{}$\6
\.{"You\ are\ in\ a\ secret}\)\.{\ canyon,\ which\ here\ }\)\.{runs\ E/W.\ \ It%
\ crosse}\)\.{s\ over\ a\\nvery\ tight}\)\.{\ canyon\ 15\ feet\ belo}\)\.{w.\ \
If\ you\ go\ down\ y}\)\.{ou\ may\ not\ be\ able\\n}\)\.{to\ get\ back\
up."}${},{}$\6
\.{"You're\ in\ secret\ E/}\)\.{W\ canyon\ above\ tight}\)\.{\ canyon."}${},\39%
\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{hmk});{}$\6
${}\\{make\_inst}(\|W,\39\\{not}(\.{DRAGON},\39\T{0}),\39\\{scan2});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{scan3});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{wide}){}$;\par
\fi

\M[1796 advent.w]{54}Below \PB{\\{secret}} there's another way to reach the
cheese.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{wide},{}$\6
\.{"You\ are\ at\ a\ wide\ p}\)\.{lace\ in\ a\ very\ tight}\)\.{\ N/S\
canyon."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{tight});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{tall}){}$;\7
${}\\{make\_loc}(\\{tight},{}$\6
\.{"The\ canyon\ here\ bec}\)\.{omes\ too\ tight\ to\ go}\)\.{\ further\
south."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{wide}){}$;\7
${}\\{make\_loc}(\\{tall},{}$\6
\.{"You\ are\ in\ a\ tall\ E}\)\.{/W\ canyon.\ \ A\ low\ ti}\)\.{ght\ crawl\
goes\ 3\ fee}\)\.{t\ north\ and\\nseems\ t}\)\.{o\ open\ up."}${},{}$\6
\.{"You're\ in\ tall\ E/W\ }\)\.{canyon."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{wide});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{boulders});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{cheese}){}$;\5
\\{ditto}(\.{CRAWL});\7
${}\\{make\_loc}(\\{boulders},{}$\6
\.{"The\ canyon\ runs\ int}\)\.{o\ a\ mass\ of\ boulders}\)\.{\ ---\ dead\
end."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{tall}){}$;\par
\fi

\M[1820 advent.w]{55}If you aren't having fun yet, wait till you meet the
troll. The only way to
get here is to crawl southwest from the \PB{\\{low}} room. And then you have
a new problem to solve; we'll see later that the \PB{\.{TROLL}} and the \PB{%
\.{BRIDGE}}
are here.

(Don Woods got the idea for the mist-covered bridge after an early morning
visit to Mount Diablo; see Steven Levy, {\sl Hackers\/} (New York:\ Delta,
1994), Chapter~7.)

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{scorr},{}$\6
\.{"You\ are\ in\ a\ long\ w}\)\.{inding\ corridor\ slop}\)\.{ing\ out\ of\
sight\ in\ }\)\.{both\\ndirections."}${},{}$\6
\.{"You're\ in\ sloping\ c}\)\.{orridor."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{low});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{swside}){}$;\7
${}\\{make\_loc}(\\{swside},{}$\6
\.{"You\ are\ on\ one\ side}\)\.{\ of\ a\ large,\ deep\ ch}\)\.{asm.\ \ A\
heavy\ white\ }\)\.{mist\ rising\\nup\ from}\)\.{\ below\ obscures\ all\ }\)%
\.{view\ of\ the\ far\ side}\)\.{.\ \ A\ SW\ path\ leads\ a}\)\.{way\\nfrom\
the\ chasm\ }\)\.{into\ a\ winding\ corri}\)\.{dor."}${},{}$\6
\.{"You're\ on\ SW\ side\ o}\)\.{f\ chasm."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{SW},\39\T{0},\39\\{scorr});{}$\6
\\{remark}(\.{"The\ troll\ refuses\ t}\)\.{o\ let\ you\ cross."});\6
${}\\{make\_inst}(\.{OVER},\39\\{sees}(\.{TROLL}),\39\\{sayit}){}$;\5
\\{ditto}(\.{ACROSS});\5
\\{ditto}(\.{CROSS});\5
\\{ditto}(\.{NE});\6
\\{remark}(\.{"There\ is\ no\ longer\ }\)\.{any\ way\ across\ the\ c}\)%
\.{hasm."});\6
${}\\{make\_inst}(\.{OVER},\39\\{not}(\.{BRIDGE},\39\T{0}),\39\\{sayit});{}$\6
${}\\{make\_inst}(\.{OVER},\39\T{0},\39\\{troll});{}$\6
${}\\{make\_inst}(\.{JUMP},\39\\{not}(\.{BRIDGE},\39\T{0}),\39\\{lose});{}$\6
${}\\{make\_inst}(\.{JUMP},\39\T{0},\39\\{bridge\_rmk}){}$;\par
\fi

\M[1853 advent.w]{56}The only things not yet explored on this side of the troll
bridge are
a dozen dead ends. They appear at this place in the ordering of
all locations because of the pirate logic explained later: The pirate
will never go to locations \PB{$\G$ \\{dead3}}.

\Y\B\4\D$\\{max\_pirate\_loc}$ \5
\\{dead2}\par
\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{dead0},\39\\{dead\_end},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{cross}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead1},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like11}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead2},\39\\{dead\_end},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{SE},\39\T{0},\39\\{like13}){}$;\7
${}\\{make\_loc}(\\{dead3},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like4}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead4},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like4}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead5},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{like3}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead6},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{like9}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead7},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{like10}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead8},\39\\{dead\_end},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{brink}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead9},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{like3}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead10},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{like12}){}$;\5
\\{ditto}(\.{OUT});\7
${}\\{make\_loc}(\\{dead11},\39\\{dead\_end},\39\T{0},\39\\{twist\_hint});{}$\6
${}\\{make\_inst}(\|U,\39\T{0},\39\\{like8}){}$;\5
\\{ditto}(\.{OUT});\par
\fi

\M[1897 advent.w]{57}A whole nuther cave with nine sites and additional
treasures
is on tuther side of the troll bridge! This cave was inspired in part
by J.~R.~R. Tolkien's stories.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{neside},{}$\6
\.{"You\ are\ on\ the\ far\ }\)\.{side\ of\ the\ chasm.\ \ }\)\.{A\ NE\ path\
leads\ away}\)\.{\ from\ the\\nchasm\ on\ }\)\.{this\ side."}${},{}$\6
\.{"You're\ on\ NE\ side\ o}\)\.{f\ chasm."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\.{NE},\39\T{0},\39\\{corr});{}$\6
${}\\{make\_inst}(\.{OVER},\39\\{sees}(\.{TROLL}),\39\\{sayit}-\T{1}){}$;\5
\\{ditto}(\.{ACROSS});\5
\\{ditto}(\.{CROSS});\5
\\{ditto}(\.{SW});\6
${}\\{make\_inst}(\.{OVER},\39\T{0},\39\\{troll});{}$\6
${}\\{make\_inst}(\.{JUMP},\39\T{0},\39\\{bridge\_rmk});{}$\6
${}\\{make\_inst}(\.{FORK},\39\T{0},\39\\{fork});{}$\6
${}\\{make\_inst}(\.{VIEW},\39\T{0},\39\\{view});{}$\6
${}\\{make\_inst}(\.{BARREN},\39\T{0},\39\\{fbarr}){}$;\7
${}\\{make\_loc}(\\{corr},{}$\6
\.{"You're\ in\ a\ long\ ea}\)\.{st/west\ corridor.\ \ A}\)\.{\ faint\ rumbling%
\ nois}\)\.{e\ can\ be\\nheard\ in\ t}\)\.{he\ distance."}${},{}$\6
\.{"You're\ in\ corridor.}\)\.{"}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{neside});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{fork}){}$;\5
\\{ditto}(\.{FORK});\6
${}\\{make\_inst}(\.{VIEW},\39\T{0},\39\\{view});{}$\6
${}\\{make\_inst}(\.{BARREN},\39\T{0},\39\\{fbarr}){}$;\7
${}\\{make\_loc}(\\{fork},{}$\6
\.{"The\ path\ forks\ here}\)\.{.\ \ The\ left\ fork\ lea}\)\.{ds\ northeast.\ %
\ A\ dul}\)\.{l\ rumbling\\nseems\ to}\)\.{\ get\ louder\ in\ that\ }\)%
\.{direction.\ \ The\ righ}\)\.{t\ fork\ leads\ southea}\)\.{st\\ndown\ a\
gentle\ sl}\)\.{ope.\ \ The\ main\ corri}\)\.{dor\ enters\ from\ the\ }\)%
\.{west."}${},{}$\6
\.{"You're\ at\ fork\ in\ p}\)\.{ath."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{corr});{}$\6
${}\\{make\_inst}(\.{NE},\39\T{0},\39\\{warm}){}$;\5
\\{ditto}(\|L);\6
${}\\{make\_inst}(\.{SE},\39\T{0},\39\\{lime}){}$;\5
\\{ditto}(\|R);\5
\\{ditto}(\|D);\6
${}\\{make\_inst}(\.{VIEW},\39\T{0},\39\\{view});{}$\6
${}\\{make\_inst}(\.{BARREN},\39\T{0},\39\\{fbarr}){}$;\7
${}\\{make\_loc}(\\{warm},{}$\6
\.{"The\ walls\ are\ quite}\)\.{\ warm\ here.\ \ From\ th}\)\.{e\ north\ can\
be\ heard}\)\.{\ a\ steady\\nroar,\ so\ }\)\.{loud\ that\ the\ entire}\)\.{\
cave\ seems\ to\ be\ tr}\)\.{embling.\ \ Another\\np}\)\.{assage\ leads\ south,%
\ }\)\.{and\ a\ low\ crawl\ goes}\)\.{\ east."}${},{}$\6
\.{"You're\ at\ junction\ }\)\.{with\ warm\ walls."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{fork}){}$;\5
\\{ditto}(\.{FORK});\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{view}){}$;\5
\\{ditto}(\.{VIEW});\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{chamber}){}$;\5
\\{ditto}(\.{CRAWL});\7
${}\\{make\_loc}(\\{view},{}$\6
\.{"You\ are\ on\ the\ edge}\)\.{\ of\ a\ breath-taking\ }\)\.{view.\ \ Far\
below\ you}\)\.{\ is\ an\\nactive\ volca}\)\.{no,\ from\ which\ great}\)\.{\
gouts\ of\ molten\ lav}\)\.{a\ come\ surging\\nout,}\)\.{\ cascading\ back\
down}\)\.{\ into\ the\ depths.\ \ T}\)\.{he\ glowing\ rock\ fill}\)\.{s\ the%
\\nfarthest\ reac}\)\.{hes\ of\ the\ cavern\ wi}\)\.{th\ a\ blood-red\ glare}\)%
\.{,\ giving\ every-\\nthi}\)\.{ng\ an\ eerie,\ macabre}\)\.{\ appearance.\ \
The\ ai}\)\.{r\ is\ filled\ with\ fli}\)\.{ckering\\nsparks\ of\ a}\)\.{sh\ and%
\ a\ heavy\ smell}\)\.{\ of\ brimstone.\ \ The\ }\)\.{walls\ are\ hot\ to\\nth}%
\)\.{e\ touch,\ and\ the\ thu}\)\.{ndering\ of\ the\ volca}\)\.{no\ drowns\ out%
\ all\ ot}\)\.{her\\nsounds.\ \ Embedd}\)\.{ed\ in\ the\ jagged\ roo}\)\.{f\
far\ overhead\ are\ m}\)\.{yriad\ twisted\\nforma}\)\.{tions,\ composed\ of\ p}%
\)\.{ure\ white\ alabaster,}\)\.{\ which\ scatter\ the\ m}\)\.{urky\\nlight\
into\ sin}\)\.{ister\ apparitions\ up}\)\.{on\ the\ walls.\ \ To\ on}\)\.{e\
side\ is\ a\ deep\\ngo}\)\.{rge,\ filled\ with\ a\ b}\)\.{izarre\ chaos\ of\
tort}\)\.{ured\ rock\ that\ seems}\)\.{\ to\ have\\nbeen\ craft}\)\.{ed\ by\
the\ Devil\ hims}\)\.{elf.\ \ An\ immense\ riv}\)\.{er\ of\ fire\ crashes\\n}\)%
\.{out\ from\ the\ depths\ }\)\.{of\ the\ volcano,\ burn}\)\.{s\ its\ way\
through\ th}\)\.{e\ gorge,\\nand\ plumme}\)\.{ts\ into\ a\ bottomless}\)\.{\
pit\ far\ off\ to\ your}\)\.{\ left.\ \ To\ the\\nrigh}\)\.{t,\ an\ immense\
geyser}\)\.{\ of\ blistering\ steam}\)\.{\ erupts\ continuously}\)\.{\\nfrom\ a%
\ barren\ isla}\)\.{nd\ in\ the\ center\ of\ }\)\.{a\ sulfurous\ lake,\ wh}\)%
\.{ich\ bubbles\\nominous}\)\.{ly.\ \ The\ far\ right\ w}\)\.{all\ is\ aflame\
with\ a}\)\.{n\ incandescence\ of\ i}\)\.{ts\\nown,\ which\ lends}\)\.{\ an\
additional\ infer}\)\.{nal\ splendor\ to\ the\ }\)\.{already\\nhellish\ sce}\)%
\.{ne.\ \ A\ dark,\ forebod}\)\.{ing\ passage\ exits\ to}\)\.{\ the\
south."}${},{}$\6
\.{"You're\ at\ breath-ta}\)\.{king\ view."}${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{warm}){}$;\5
\\{ditto}(\.{PASSAGE});\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\.{FORK},\39\T{0},\39\\{fork});{}$\6
\\{remark}(\\{default\_msg}[\.{EAT}]);\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{sayit}){}$;\5
\\{ditto}(\.{JUMP});\7
${}\\{make\_loc}(\\{chamber},{}$\6
\.{"You\ are\ in\ a\ small\ }\)\.{chamber\ filled\ with\ }\)\.{large\ boulders.%
\ \ The}\)\.{\ walls\ are\\nvery\ war}\)\.{m,\ causing\ the\ air\ i}\)\.{n\ the%
\ room\ to\ be\ alm}\)\.{ost\ stifling\ from\ th}\)\.{e\\nheat.\ \ The\ only\
e}\)\.{xit\ is\ a\ crawl\ headi}\)\.{ng\ west,\ through\ whi}\)\.{ch\ a\ low%
\\nrumbling\ n}\)\.{oise\ is\ coming."}${},{}$\6
\.{"You're\ in\ chamber\ o}\)\.{f\ boulders."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{warm}){}$;\5
\\{ditto}(\.{OUT});\5
\\{ditto}(\.{CRAWL});\6
${}\\{make\_inst}(\.{FORK},\39\T{0},\39\\{fork});{}$\6
${}\\{make\_inst}(\.{VIEW},\39\T{0},\39\\{view}){}$;\7
${}\\{make\_loc}(\\{lime},{}$\6
\.{"You\ are\ walking\ alo}\)\.{ng\ a\ gently\ sloping\ }\)\.{north/south\
passage\ }\)\.{lined\ with\\noddly\ sh}\)\.{aped\ limestone\ forma}\)%
\.{tions."}${},{}$\6
\.{"You're\ in\ limestone}\)\.{\ passage."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|N,\39\T{0},\39\\{fork}){}$;\5
\\{ditto}(\|U);\5
\\{ditto}(\.{FORK});\6
${}\\{make\_inst}(\|S,\39\T{0},\39\\{fbarr}){}$;\5
\\{ditto}(\|D);\5
\\{ditto}(\.{BARREN});\6
${}\\{make\_inst}(\.{VIEW},\39\T{0},\39\\{view}){}$;\7
${}\\{make\_loc}(\\{fbarr},{}$\6
\.{"You\ are\ standing\ at}\)\.{\ the\ entrance\ to\ a\ l}\)\.{arge,\ barren\
room.\ \ }\)\.{A\ sign\\nposted\ above}\)\.{\ the\ entrance\ reads:}\)\.{\ \ %
\\"CAUTION!\ \ BEAR\ I}\)\.{N\ ROOM!\\""}${},{}$\6
\.{"You're\ in\ front\ of\ }\)\.{barren\ room."}${},\39\T{0}){}$;\C{ don't
laugh too loud }\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{lime}){}$;\5
\\{ditto}(\|U);\6
${}\\{make\_inst}(\.{FORK},\39\T{0},\39\\{fork});{}$\6
${}\\{make\_inst}(\|E,\39\T{0},\39\\{barr}){}$;\5
\\{ditto}(\.{IN});\5
\\{ditto}(\.{BARREN});\5
\\{ditto}(\.{ENTER});\6
${}\\{make\_inst}(\.{VIEW},\39\T{0},\39\\{view}){}$;\7
${}\\{make\_loc}(\\{barr},{}$\6
\.{"You\ are\ inside\ a\ ba}\)\.{rren\ room.\ \ The\ cent}\)\.{er\ of\ the\
room\ is\ co}\)\.{mpletely\\nempty\ exce}\)\.{pt\ for\ some\ dust.\ \ M}\)%
\.{arks\ in\ the\ dust\ lea}\)\.{d\ away\ toward\ the\\nf}\)\.{ar\ end\ of\ the%
\ room.\ }\)\.{\ The\ only\ exit\ is\ th}\)\.{e\ way\ you\ came\ in."}${},{}$\6
\.{"You're\ in\ barren\ ro}\)\.{om."}${},\39\T{0});{}$\6
${}\\{make\_inst}(\|W,\39\T{0},\39\\{fbarr}){}$;\5
\\{ditto}(\.{OUT});\6
${}\\{make\_inst}(\.{FORK},\39\T{0},\39\\{fork});{}$\6
${}\\{make\_inst}(\.{VIEW},\39\T{0},\39\\{view}){}$;\par
\fi

\M[2006 advent.w]{58}The two storage locations are accessible only from
each other, and they lead only to each other.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{neend},{}$\6
\.{"You\ are\ at\ the\ nort}\)\.{heast\ end\ of\ an\ imme}\)\.{nse\ room,\ even%
\ large}\)\.{r\ than\ the\\nGiant\ Ro}\)\.{om.\ \ It\ appears\ to\ b}\)\.{e\ a\
repository\ for\ t}\)\.{he\ \\"Adventure\\"\\npr}\)\.{ogram.\ \ Massive\ torc}%
\)\.{hes\ far\ overhead\ bat}\)\.{he\ the\ room\ with\ smo}\)\.{ky\\nyellow\
light.\ \ S}\)\.{cattered\ about\ you\ c}\)\.{an\ be\ seen\ a\ pile\ of}\)\.{\
bottles\ (all\\nof\ th}\)\.{em\ empty),\ a\ nursery}\)\.{\ of\ young\
beanstalks}\)\.{\ murmuring\ quietly,\ }\)\.{a\ bed\\nof\ oysters,\ a}\)\.{\
bundle\ of\ black\ rod}\)\.{s\ with\ rusty\ stars\ o}\)\.{n\ their\ ends,\ and%
\\na}\)\.{\ collection\ of\ brass}\)\.{\ lanterns.\ \ Off\ to\ o}\)\.{ne\ side\
a\ great\ many}\)\.{\ dwarves\\nare\ sleepi}\)\.{ng\ on\ the\ floor,\ sno}\)%
\.{ring\ loudly.\ \ A\ sign}\)\.{\ nearby\ reads:\ \ \\"DO}\)\.{\\nNOT\ DISTURB%
\ THE\ DW}\)\.{ARVES!\\"\ \ An\ immense}\)\.{\ mirror\ is\ hanging\ a}\)%
\.{gainst\ one\\nwall,\ an}\)\.{d\ stretches\ to\ the\ o}\)\.{ther\ end\ of\
the\ room}\)\.{,\ where\ various\ othe}\)\.{r\\nsundry\ objects\ ca}\)\.{n\ be\
glimpsed\ dimly\ }\)\.{in\ the\ distance."}${},{}$\6
\.{"You're\ at\ NE\ end."}${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\.{SW},\39\T{0},\39\\{swend}){}$;\7
${}\\{make\_loc}(\\{swend},{}$\6
\.{"You\ are\ at\ the\ sout}\)\.{hwest\ end\ of\ the\ rep}\)\.{ository.\ \ To\
one\ sid}\)\.{e\ is\ a\ pit\\nfull\ of\ }\)\.{fierce\ green\ snakes.}\)\.{\ \
On\ the\ other\ side\ }\)\.{is\ a\ row\ of\ small\\nw}\)\.{icker\ cages,\ each\
of}\)\.{\ which\ contains\ a\ li}\)\.{ttle\ sulking\ bird.\ \ }\)\.{In\ one%
\\ncorner\ is\ a\ }\)\.{bundle\ of\ black\ rods}\)\.{\ with\ rusty\ marks\ on}%
\)\.{\ their\ ends.\\nA\ larg}\)\.{e\ number\ of\ velvet\ p}\)\.{illows\ are\
scattered}\)\.{\ about\ on\ the\ floor.}\)\.{\\nA\ vast\ mirror\ stre}\)%
\.{tches\ off\ to\ the\ nor}\)\.{theast.\ \ At\ your\ fee}\)\.{t\ is\ a\\nlarge%
\ steel\ }\)\.{grate,\ next\ to\ which}\)\.{\ is\ a\ sign\ that\ read}\)\.{s,\ %
\\"TREASURE\\nVAULT}\)\.{.\ \ KEYS\ IN\ MAIN\ OFFI}\)\.{CE.\\""}${},{}$\6
\.{"You're\ at\ SW\ end."}${},\39\\{lighted});{}$\6
${}\\{make\_inst}(\.{NE},\39\T{0},\39\\{neend});{}$\6
${}\\{make\_inst}(\|D,\39\T{0},\39\\{grate\_rmk}){}$;\par
\fi

\M[2038 advent.w]{59}When the current location is \PB{\\{crack}} or higher,
it's a pseudo-location.
In such cases we don't ask you for input; we assume that you have told
us to force another instruction through. For example,
if you try to go through the crack by the small pit
in the upper cave (location \PB{\\{spit}}), the instruction
there sends you to \PB{\\{crack}}, which immediately sends you back to \PB{%
\\{spit}}.

\Y\B\4\D$\\{forced\_move}(\\{loc})$ \5
$(\\{loc}\G\\{min\_forced\_loc}{}$)\par
\B\4\D$\.{FORCE}$ \5
\T{0}\C{ actually any value will do here }\par
\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{crack},{}$\6
\.{"The\ crack\ is\ far\ to}\)\.{o\ small\ for\ you\ to\ f}\)\.{ollow."}${},\39%
\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{spit}){}$;\par
\fi

\M[2053 advent.w]{60}Here are some forced actions that are less pleasant.
\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{neck},{}$\6
\.{"You\ are\ at\ the\ bott}\)\.{om\ of\ the\ pit\ with\ a}\)\.{\ broken\
neck."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{limbo}){}$;\7
${}\\{make\_loc}(\\{lose},\39\.{"You\ didn't\ make\ it.}\)\.{"},\39\T{0},\39%
\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{limbo}){}$;\par
\fi

\M[2062 advent.w]{61}The rest are more-or-less routine, except for \PB{%
\\{check}}---which executes
a {\it conditional\/} forced command.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{make\_loc}(\\{cant},{}$\6
\.{"The\ dome\ is\ unclimb}\)\.{able."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{emist}){}$;\7
${}\\{make\_loc}(\\{climb},{}$\6
\.{"You\ clamber\ up\ the\ }\)\.{plant\ and\ scurry\ thr}\)\.{ough\ the\ hole\
at\ the}\)\.{\ top."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{narrow}){}$;\7
${}\\{make\_loc}(\\{check},\39\.{""},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\\{not}(\.{PLANT},\39\T{2}),\39\\{upnout});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{didit}){}$;\7
${}\\{make\_loc}(\\{snaked},{}$\6
\.{"You\ can't\ get\ by\ th}\)\.{e\ snake."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{hmk}){}$;\7
${}\\{make\_loc}(\\{thru},{}$\6
\.{"You\ have\ crawled\ th}\)\.{rough\ a\ very\ low\ wid}\)\.{e\ passage\
parallel\ t}\)\.{o\ and\ north\\nof\ the\ }\)\.{Hall\ of\ Mists."}${},\39\T{0},%
\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{wmist}){}$;\7
${}\\{make\_loc}(\\{duck},\39\\{long\_desc}[\\{thru}],\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{wfiss}){}$;\7
${}\\{make\_loc}(\\{sewer},{}$\6
\.{"The\ stream\ flows\ ou}\)\.{t\ through\ a\ pair\ of\ }\)\.{1-foot-diameter\
sewe}\)\.{r\ pipes.\\nIt\ would\ b}\)\.{e\ advisable\ to\ use\ t}\)\.{he\
exit."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{house}){}$;\7
${}\\{make\_loc}(\\{upnout},{}$\6
\.{"There\ is\ nothing\ he}\)\.{re\ to\ climb.\ \ Use\ \\"}\)\.{up\\"\ or\ %
\\"out\\"\ to\ l}\)\.{eave\ the\ pit."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{wpit}){}$;\7
${}\\{make\_loc}(\\{didit},{}$\6
\.{"You\ have\ climbed\ up}\)\.{\ the\ plant\ and\ out\ o}\)\.{f\ the\
pit."}${},\39\T{0},\39\T{0});{}$\6
${}\\{make\_inst}(\.{FORCE},\39\T{0},\39\\{w2pit}){}$;\par
\fi

\M[2103 advent.w]{62}The table of instructions ends here; the remaining
``locations''
\PB{\\{ppass}}, \PB{\\{pdrop}}, and \PB{\\{troll}} are special.

\Y\B\4\X23:Build the travel table\X${}\mathrel+\E{}$\6
$\\{start}[\\{ppass}]\K\|q;{}$\6
\&{if} ${}(\|q>{\AND}\\{travels}[\\{travel\_size}]\V\\{rem\_count}>\\{rem%
\_size}){}$\5
${}\{{}$\1\6
\\{printf}(\.{"Oops,\ I'm\ broken!\\n}\)\.{"});\5
${}\\{exit}({-}\T{1});{}$\6
\4${}\}{}$\2\par
\fi

\N[2112 advent.w]{1}{63}Data structures for objects. A fixed universe of
objects was
enumerated in the vocabulary section. Most of the objects can move
or be moved from place to place; so we maintain linked lists of the
objects at each location. The first object at location~\PB{\|l} is \PB{%
\\{first}[\|l]},
then comes \PB{\\{link}[\\{first}[\|l]]}, then \PB{\\{link}[\\{link}[\\{first}[%
\|l]]]}, etc.,
ending with~0 (which is the ``object'' called \PB{\.{NOTHING}}).

Some of the objects are placed in {\it groups\/} of one or more objects.
In such cases \PB{\\{base}[\|t]} is the smallest object in the group containing
object~\PB{\|t}. Objects that belong to groups are immovable; they always
stay in the same location. Other objects have \PB{$\\{base}[\|t]\K\.{NOTHING}$}
and they
are free to leave one list and join another. For example, it turns
out that the \PB{\.{KEYS}} are movable, but the \PB{\.{SNAKE}} is always in the
Hall of the Mountain King; we set \PB{$\\{base}[\.{KEYS}]\K\.{NOTHING}$} and %
\PB{$\\{base}[\.{SNAKE}]\K\.{SNAKE}$}.
Several groups, such as the \PB{\.{GRATE}} and \PB{\.{GRATE\_}}, consist of two
objects.
This program supports operations on groups of more than two objects,
but no such objects actually occur.

Each movable or base object \PB{\|t} has a current property \PB{\\{prop}[\|t]},
which is initially~$-1$ for treasures, otherwise initially~0.
We change \PB{\\{prop}[\|t]} to~0 when you first
see treasure~\PB{\|t}; and property values often change further as the game
progresses. For example, the \PB{\.{PLANT}} can grow. When you see an object,
we usually print a message that corresponds to its current property value.
That message is the string \PB{$\\{note}[\\{prop}[\|t]+\\{offset}[\|t]]$}.

(Exception: When you first see the \PB{\.{RUG}} or the \PB{\.{CHAIN}}, its
property
value is set to~1, not~0. The reason for this hack is that you get
maximum score only if the property values of all treasures are
zero when you finish.)

Each object is in at most one list, \PB{\\{place}[\|t]}.
If you are carrying object~\PB{\|t}, the value of \PB{\\{place}[\|t]} is~\PB{%
\\{inhand}},
which is negative.
The special location \PB{\\{limbo}} has value~0;
we don't maintain a list \PB{\\{first}[\\{limbo}]} for objects that have
\PB{$\\{place}[\|t]\K\\{limbo}$}. Thus object~\PB{\|t} is in a list if and only
if \PB{$\\{place}[\|t]>\T{0}$}.
The global variable \PB{\\{holding}} counts how many objects you are carrying.

One more array completes our set of data structures:
Objects that appear in inventory reports have a name, \PB{\\{name}[\|t]}.

\Y\B\4\D$\\{toting}(\|t)$ \5
$(\\{place}[\|t]<\T{0}{}$)\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{object} ${}\\{first}[\\{max\_loc}+\T{1}]{}$;\C{ the first object present at
a location }\6
\&{object} ${}\\{link}[\\{max\_obj}+\T{1}]{}$;\C{ the next object present in
the same location }\6
\&{object} ${}\\{base}[\\{max\_obj}+\T{2}]{}$;\C{ the smallest object in each
object's group, if any }\6
\&{int} ${}\\{prop}[\\{max\_obj}+\T{1}]{}$;\C{ each object's current property
value }\6
\&{location} ${}\\{place}[\\{max\_obj}+\T{1}]{}$;\C{ each object's current
location }\6
\&{char} ${}{*}\\{name}[\\{max\_obj}+\T{1}]{}$;\C{ name of object for inventory
listing }\6
\&{char} ${}{*}\\{note}[\T{100}]{}$;\C{ descriptions of object properties }\6
\&{int} ${}\\{offset}[\\{max\_obj}+\T{1}]{}$;\C{ where notes for each object
start }\6
\&{int} \\{holding};\C{ how many objects have \PB{$\\{prop}[\|t]<\T{0}$}? }\6
\&{int} \\{note\_ptr}${}\K\T{0}{}$;\C{ how many notes have we stored? }\par
\fi

\M[2168 advent.w]{64}Here then is a simple subroutine to place an object at a
given
location, when the object isn't presently in a list.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{drop}\,\,${}\.{ARGS}((\&{object},\39\&{location}));{}$\7
\&{void} ${}\\{drop}(\|t,\39\|l){}$\1\1\6
\&{object} \|t;\6
\&{location} \|l;\2\2\6
${}\{{}$\1\6
\&{if} (\\{toting}(\|t))\1\5
${}\\{holding}\MM;{}$\2\6
${}\\{place}[\|t]\K\|l;{}$\6
\&{if} ${}(\|l<\T{0}){}$\1\5
${}\\{holding}\PP;{}$\2\6
\&{else} \&{if} ${}(\|l>\T{0}){}$\5
${}\{{}$\1\6
${}\\{link}[\|t]\K\\{first}[\|l];{}$\6
${}\\{first}[\|l]\K\|t;{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M[2186 advent.w]{65}Similarly, we need a subroutine to pick up an object.

\Y\B\4\D$\\{move}(\|t,\|l)$ \5
${}\{{}$\5
\1\\{carry}(\|t);\5
${}\\{drop}(\|t,\39\|l){}$;\5
${}\}{}$\2\par
\B\4\D$\\{destroy}(\|t)$ \5
$\\{move}(\|t,\39\\{limbo}{}$)\par
\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{carry}\,\,\.{ARGS}((\&{object}));\7
\&{void} \\{carry}(\|t)\1\1\6
\&{object} \|t;\2\2\6
${}\{{}$\5
\1\&{register} \&{location} \|l${}\K\\{place}[\|t];{}$\7
\&{if} ${}(\|l\G\\{limbo}){}$\5
${}\{{}$\1\6
${}\\{place}[\|t]\K\\{inhand};{}$\6
${}\\{holding}\PP;{}$\6
\&{if} ${}(\|l>\\{limbo}){}$\5
${}\{{}$\1\6
\&{register} \&{object} \|r${},{}$ \|s;\7
\&{for} ${}(\|r\K\T{0},\39\|s\K\\{first}[\|l];{}$ ${}\|s\I\|t;{}$ ${}\|r\K\|s,%
\39\|s\K\\{link}[\|s]){}$\1\5
;\2\6
\&{if} ${}(\|r\E\T{0}){}$\1\5
${}\\{first}[\|l]\K\\{link}[\|s];{}$\2\6
\&{else}\1\5
${}\\{link}[\|r]\K\\{link}[\|s]{}$;\C{ remove \PB{\|t} from list }\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M[2208 advent.w]{66}The \PB{\\{is\_at\_loc}} subroutine tests if a possibly
multipart object is
at a particular place, represented by the global variable \PB{\\{loc}}.
It uses the fact that multipart objects
have consecutive values, and \PB{$\\{base}[\\{max\_obj}+\T{1}]\E\.{NOTHING}$}.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{boolean} \\{is\_at\_loc}\,\,\.{ARGS}((\&{object}));\7
\&{boolean} \\{is\_at\_loc}(\|t)\1\1\6
\&{object} \|t;\2\2\6
${}\{{}$\1\6
\&{register} \&{object} \\{tt};\7
\&{if} ${}(\\{base}[\|t]\E\.{NOTHING}){}$\1\5
\&{return} \\{place}[\|t]${}\E\\{loc};{}$\2\6
\&{for} ${}(\\{tt}\K\|t;{}$ ${}\\{base}[\\{tt}]\E\|t;{}$ ${}\\{tt}\PP){}$\1\6
\&{if} ${}(\\{place}[\\{tt}]\E\\{loc}){}$\1\5
\&{return} \\{true};\2\2\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\fi

\M[2223 advent.w]{67}A few macros make it easy to get each object started.

\Y\B\4\D$\\{new\_obj}(\|t,\|n,\|b,\|l)$ \6
${}\{{}$\C{ object \PB{\|t} named \PB{\|n} with base \PB{\|b} starts at \PB{%
\|l} }\1\6
${}\\{name}[\|t]\K\|n;{}$\6
${}\\{base}[\|t]\K\|b;{}$\6
${}\\{offset}[\|t]\K\\{note\_ptr};{}$\6
${}\\{prop}[\|t]\K(\\{is\_treasure}(\|t)\?{-}\T{1}:\T{0});{}$\6
${}\\{drop}(\|t,\39\|l);{}$\6
\4${}\}{}$\2\par
\B\4\D$\\{new\_note}(\|n)$ \5
$\\{note}[\\{note\_ptr}\PP]\K{}$\|n\par
\fi

\M[2235 advent.w]{68}\B\X22:Additional local registers\X${}\mathrel+\E{}$\6
\&{register} \&{object} \|t;\par
\fi

\N[2238 advent.w]{1}{69}Object data. Now it's time to build the object
structures just
defined.

We put the objects into their initial locations backwards,
that is, highest first; moreover, we place all two-part objects
before placing the others. Then low-numbered objects will appear first in
the list, and two-part objects will appear last.

Here are the two-part objects, which are mostly unnamed because you won't
be picking them up.

\Y\B\4\X69:Build the object tables\X${}\E{}$\6
$\\{new\_obj}(\.{RUG\_},\39\T{0},\39\.{RUG},\39\\{scan3});{}$\6
${}\\{new\_obj}(\.{RUG},\39\.{"Persian\ rug"},\39\.{RUG},\39\\{scan1});{}$\6
\\{new\_note}(\.{"There\ is\ a\ Persian\ }\)\.{rug\ spread\ out\ on\ th}\)\.{e\
floor!"});\6
\\{new\_note}(\.{"The\ dragon\ is\ spraw}\)\.{led\ out\ on\ a\ Persian}\)\.{\
rug!!"});\6
${}\\{new\_obj}(\.{TROLL2\_},\39\T{0},\39\.{TROLL2},\39\\{limbo});{}$\6
${}\\{new\_obj}(\.{TROLL2},\39\T{0},\39\.{TROLL2},\39\\{limbo});{}$\6
\\{new\_note}(\.{"The\ troll\ is\ nowher}\)\.{e\ to\ be\ seen."});\6
${}\\{new\_obj}(\.{TROLL\_},\39\T{0},\39\.{TROLL},\39\\{neside});{}$\6
${}\\{new\_obj}(\.{TROLL},\39\T{0},\39\.{TROLL},\39\\{swside});{}$\6
\\{new\_note}(\.{"A\ burly\ troll\ stand}\)\.{s\ by\ the\ bridge\ and\ }\)%
\.{insists\ you\ throw\ hi}\)\.{m\ a\\ntreasure\ before}\)\.{\ you\ may\
cross."});\6
\\{new\_note}(\.{"The\ troll\ steps\ out}\)\.{\ from\ beneath\ the\ br}\)%
\.{idge\ and\ blocks\ your}\)\.{\ way."});\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{BRIDGE\_},\39\T{0},\39\.{BRIDGE},\39\\{neside});{}$\6
${}\\{new\_obj}(\.{BRIDGE},\39\T{0},\39\.{BRIDGE},\39\\{swside});{}$\6
\\{new\_note}(\.{"A\ rickety\ wooden\ br}\)\.{idge\ extends\ across\ }\)\.{the\
chasm,\ vanishing}\)\.{\ into\ the\\nmist.\ \ A\ }\)\.{sign\ posted\ on\ the\
b}\)\.{ridge\ reads,\ \\"STOP!}\)\.{\ \ PAY\ TROLL!\\""});\6
\\{new\_note}(\.{"The\ wreckage\ of\ a\ b}\)\.{ridge\ (and\ a\ dead\ be}\)%
\.{ar)\ can\ be\ seen\ at\ t}\)\.{he\ bottom\\nof\ the\ ch}\)\.{asm."});\6
${}\\{new\_obj}(\.{DRAGON\_},\39\T{0},\39\.{DRAGON},\39\\{scan3});{}$\6
${}\\{new\_obj}(\.{DRAGON},\39\T{0},\39\.{DRAGON},\39\\{scan1});{}$\6
\\{new\_note}(\.{"A\ huge\ green\ fierce}\)\.{\ dragon\ bars\ the\ way}\)%
\.{!"});\6
\\{new\_note}(\.{"Congratulations!\ \ Y}\)\.{ou\ have\ just\ vanquis}\)\.{hed\
a\ dragon\ with\ yo}\)\.{ur\ bare\\nhands!\ (Unb}\)\.{elievable,\ isn't\ it?}\)%
\.{)"});\6
\\{new\_note}(\.{"The\ body\ of\ a\ huge\ }\)\.{green\ dead\ dragon\ is}\)\.{\
lying\ off\ to\ one\ si}\)\.{de."});\6
${}\\{new\_obj}(\.{SHADOW\_},\39\T{0},\39\.{SHADOW},\39\\{window});{}$\6
${}\\{new\_obj}(\.{SHADOW},\39\T{0},\39\.{SHADOW},\39\\{windoe});{}$\6
\\{new\_note}(\.{"The\ shadowy\ figure\ }\)\.{seems\ to\ be\ trying\ t}\)\.{o\
attract\ your\ atten}\)\.{tion."});\6
${}\\{new\_obj}(\.{PLANT2\_},\39\T{0},\39\.{PLANT2},\39\\{e2pit});{}$\6
${}\\{new\_obj}(\.{PLANT2},\39\T{0},\39\.{PLANT2},\39\\{w2pit});{}$\6
\\{new\_note}(\T{0});\6
\\{new\_note}(\.{"The\ top\ of\ a\ 12-foo}\)\.{t-tall\ beanstalk\ is\ }\)%
\.{poking\ out\ of\ the\ we}\)\.{st\ pit."});\6
\\{new\_note}(\.{"There\ is\ a\ huge\ bea}\)\.{nstalk\ growing\ out\ o}\)\.{f\
the\ west\ pit\ up\ to}\)\.{\ the\ hole."});\6
${}\\{new\_obj}(\.{CRYSTAL\_},\39\T{0},\39\.{CRYSTAL},\39\\{wfiss});{}$\6
${}\\{new\_obj}(\.{CRYSTAL},\39\T{0},\39\.{CRYSTAL},\39\\{efiss});{}$\6
\\{new\_note}(\T{0});\6
\\{new\_note}(\.{"A\ crystal\ bridge\ no}\)\.{w\ spans\ the\ fissure.}\)\.{"});%
\6
\\{new\_note}(\.{"The\ crystal\ bridge\ }\)\.{has\ vanished!"});\6
${}\\{new\_obj}(\.{TREADS\_},\39\T{0},\39\.{TREADS},\39\\{emist});{}$\6
${}\\{new\_obj}(\.{TREADS},\39\T{0},\39\.{TREADS},\39\\{spit});{}$\6
\\{new\_note}(\.{"Rough\ stone\ steps\ l}\)\.{ead\ down\ the\ pit."});\6
\\{new\_note}(\.{"Rough\ stone\ steps\ l}\)\.{ead\ up\ the\ dome."});\6
${}\\{new\_obj}(\.{GRATE\_},\39\T{0},\39\.{GRATE},\39\\{inside});{}$\6
${}\\{new\_obj}(\.{GRATE},\39\T{0},\39\.{GRATE},\39\\{outside});{}$\6
\\{new\_note}(\.{"The\ grate\ is\ locked}\)\.{."});\6
\\{new\_note}(\.{"The\ grate\ is\ open."});\6
${}\\{new\_obj}(\.{MIRROR\_},\39\T{0},\39\.{MIRROR},\39\\{limbo}){}$;\C{ joins
up with \PB{\.{MIRROR}} later }\par
\A70.
\U200.\fi

\M[2298 advent.w]{70}And here are the one-place objects, some of which are
immovable
(because they are in a group of size one).

\Y\B\4\X69:Build the object tables\X${}\mathrel+\E{}$\6
$\\{new\_obj}(\.{CHAIN},\39\.{"Golden\ chain"},\39\.{CHAIN},\39\\{barr});{}$\6
\\{new\_note}(\.{"There\ is\ a\ golden\ c}\)\.{hain\ lying\ in\ a\ heap}\)\.{\
on\ the\ floor!"});\6
\\{new\_note}(\.{"The\ bear\ is\ locked\ }\)\.{to\ the\ wall\ with\ a\ g}\)%
\.{olden\ chain!"});\6
\\{new\_note}(\.{"There\ is\ a\ golden\ c}\)\.{hain\ locked\ to\ the\ w}\)%
\.{all!"});\6
${}\\{new\_obj}(\.{SPICES},\39\.{"Rare\ spices"},\39\T{0},\39\\{chamber});{}$\6
\\{new\_note}(\.{"There\ are\ rare\ spic}\)\.{es\ here!"});\6
${}\\{new\_obj}(\.{PEARL},\39\.{"Glistening\ pearl"},\39\T{0},\39\\{limbo});{}$%
\6
\\{new\_note}(\.{"Off\ to\ one\ side\ lie}\)\.{s\ a\ glistening\ pearl}\)%
\.{!"});\6
${}\\{new\_obj}(\.{PYRAMID},\39\.{"Platinum\ pyramid"},\39\T{0},\39%
\\{droom});{}$\6
\\{new\_note}(\.{"There\ is\ a\ platinum}\)\.{\ pyramid\ here,\ 8\ inc}\)\.{hes%
\ on\ a\ side!"});\6
${}\\{new\_obj}(\.{EMERALD},\39\.{"Egg-sized\ emerald"},\39\T{0},\39%
\\{proom});{}$\6
\\{new\_note}(\.{"There\ is\ an\ emerald}\)\.{\ here\ the\ size\ of\ a\ }\)%
\.{plover's\ egg!"});\6
${}\\{new\_obj}(\.{VASE},\39\.{"Ming\ vase"},\39\T{0},\39\\{oriental});{}$\6
\\{new\_note}(\.{"There\ is\ a\ delicate}\)\.{,\ precious,\ Ming\ vas}\)\.{e\
here!"});\6
\\{new\_note}(\.{"The\ vase\ is\ now\ res}\)\.{ting,\ delicately,\ on}\)\.{\ a\
velvet\ pillow."});\6
\\{new\_note}(\.{"The\ floor\ is\ litter}\)\.{ed\ with\ worthless\ sh}\)\.{ards%
\ of\ pottery."});\6
\\{new\_note}(\.{"The\ Ming\ vase\ drops}\)\.{\ with\ a\ delicate\ cra}\)%
\.{sh."});\6
${}\\{new\_obj}(\.{TRIDENT},\39\.{"Jeweled\ trident"},\39\T{0},\39%
\\{falls});{}$\6
\\{new\_note}(\.{"There\ is\ a\ jewel-en}\)\.{crusted\ trident\ here}\)\.{!"});%
\6
${}\\{new\_obj}(\.{EGGS},\39\.{"Golden\ eggs"},\39\T{0},\39\\{giant});{}$\6
\\{new\_note}(\.{"There\ is\ a\ large\ ne}\)\.{st\ here,\ full\ of\ gol}\)%
\.{den\ eggs!"});\6
\\{new\_note}(\.{"The\ nest\ of\ golden\ }\)\.{eggs\ has\ vanished!"});\6
\\{new\_note}(\.{"Done!"});\6
${}\\{new\_obj}(\.{CHEST},\39\.{"Treasure\ chest"},\39\T{0},\39\\{limbo});{}$\6
\\{new\_note}(\.{"The\ pirate's\ treasu}\)\.{re\ chest\ is\ here!"});\6
${}\\{new\_obj}(\.{COINS},\39\.{"Rare\ coins"},\39\T{0},\39\\{west});{}$\6
\\{new\_note}(\.{"There\ are\ many\ coin}\)\.{s\ here!"});\6
${}\\{new\_obj}(\.{JEWELS},\39\.{"Precious\ jewelry"},\39\T{0},\39%
\\{south});{}$\6
\\{new\_note}(\.{"There\ is\ precious\ j}\)\.{ewelry\ here!"});\6
${}\\{new\_obj}(\.{SILVER},\39\.{"Bars\ of\ silver"},\39\T{0},\39\\{ns});{}$\6
\\{new\_note}(\.{"There\ are\ bars\ of\ s}\)\.{ilver\ here!"});\6
${}\\{new\_obj}(\.{DIAMONDS},\39\.{"Several\ diamonds"},\39\T{0},\39%
\\{wfiss});{}$\6
\\{new\_note}(\.{"There\ are\ diamonds\ }\)\.{here!"});\6
${}\\{new\_obj}(\.{GOLD},\39\.{"Large\ gold\ nugget"},\39\T{0},\39%
\\{nugget});{}$\6
\\{new\_note}(\.{"There\ is\ a\ large\ sp}\)\.{arkling\ nugget\ of\ go}\)\.{ld\
here!"});\6
${}\\{new\_obj}(\.{MOSS},\39\T{0},\39\.{MOSS},\39\\{soft});{}$\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{BATTERIES},\39\.{"Batteries"},\39\T{0},\39\\{limbo});{}$\6
\\{new\_note}(\.{"There\ are\ fresh\ bat}\)\.{teries\ here."});\6
\\{new\_note}(\.{"Some\ worn-out\ batte}\)\.{ries\ have\ been\ disca}\)\.{rded\
nearby."});\6
${}\\{new\_obj}(\.{PONY},\39\T{0},\39\.{PONY},\39\\{pony});{}$\6
\\{new\_note}(\.{"There\ is\ a\ massive\ }\)\.{vending\ machine\ here}\)\.{.\ \
The\ instructions\ }\)\.{on\ it\ read:\\n\\"Drop\ }\)\.{coins\ here\ to\
receiv}\)\.{e\ fresh\ batteries.\\"}\)\.{"});\6
${}\\{new\_obj}(\.{GEYSER},\39\T{0},\39\.{GEYSER},\39\\{view});{}$\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{MESSAGE},\39\T{0},\39\.{MESSAGE},\39\\{limbo});{}$\6
\\{new\_note}(\.{"There\ is\ a\ message\ }\)\.{scrawled\ in\ the\ dust}\)\.{\
in\ a\ flowery\ script}\)\.{,\ reading:\\n\\"This\ i}\)\.{s\ not\ the\ maze\
where}\)\.{\ the\ pirate\ hides\ hi}\)\.{s\ treasure\ chest.\\""});\6
${}\\{new\_obj}(\.{BEAR},\39\T{0},\39\.{BEAR},\39\\{barr});{}$\6
\\{new\_note}(\.{"There\ is\ a\ ferociou}\)\.{s\ cave\ bear\ eying\ yo}\)\.{u\
from\ the\ far\ end\ o}\)\.{f\ the\ room!"});\6
\\{new\_note}(\.{"There\ is\ a\ gentle\ c}\)\.{ave\ bear\ sitting\ pla}\)%
\.{cidly\ in\ one\ corner.}\)\.{"});\6
\\{new\_note}(\.{"There\ is\ a\ contente}\)\.{d-looking\ bear\ wande}\)\.{ring\
about\ nearby."});\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{PIRATE},\39\T{0},\39\.{PIRATE},\39\\{limbo});{}$\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{ART},\39\T{0},\39\.{ART},\39\\{oriental});{}$\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{AXE},\39\.{"Dwarf's\ axe"},\39\T{0},\39\\{limbo});{}$\6
\\{new\_note}(\.{"There\ is\ a\ little\ a}\)\.{xe\ here."});\6
\\{new\_note}(\.{"There\ is\ a\ little\ a}\)\.{xe\ lying\ beside\ the\ }\)%
\.{bear."});\6
${}\\{new\_obj}(\.{STALACTITE},\39\T{0},\39\.{STALACTITE},\39\\{tite});{}$\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{PLANT},\39\T{0},\39\.{PLANT},\39\\{wpit});{}$\6
\\{new\_note}(\.{"There\ is\ a\ tiny\ lit}\)\.{tle\ plant\ in\ the\ pit}\)\.{,\
murmuring\ \\"Water,}\)\.{\ water,\ ...\\""});\6
\\{new\_note}(\.{"The\ plant\ spurts\ in}\)\.{to\ furious\ growth\ fo}\)\.{r\ a%
\ few\ seconds."});\6
\\{new\_note}(\.{"There\ is\ a\ 12-foot-}\)\.{tall\ beanstalk\ stret}\)\.{ching%
\ up\ out\ of\ the\ }\)\.{pit,\\nbellowing\ \\"Wa}\)\.{ter!!\ \ Water!!\\""});\6
\\{new\_note}(\.{"The\ plant\ grows\ exp}\)\.{losively,\ almost\ fil}\)\.{ling\
the\ bottom\ of\ t}\)\.{he\ pit."});\6
\\{new\_note}(\.{"There\ is\ a\ gigantic}\)\.{\ beanstalk\ stretchin}\)\.{g\
all\ the\ way\ up\ to\ }\)\.{the\ hole."});\6
\\{new\_note}(\.{"You've\ over-watered}\)\.{\ the\ plant!\ \ It's\ sh}\)%
\.{riveling\ up!\ \ It's,\ }\)\.{it's..."});\6
${}\\{new\_obj}(\.{MIRROR},\39\T{0},\39\.{MIRROR},\39\\{mirror});{}$\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{OIL},\39\.{"Oil\ in\ the\ bottle"},\39\T{0},\39%
\\{limbo});{}$\6
${}\\{new\_obj}(\.{WATER},\39\.{"Water\ in\ the\ bottle}\)\.{"},\39\T{0},\39%
\\{limbo});{}$\6
${}\\{new\_obj}(\.{BOTTLE},\39\.{"Small\ bottle"},\39\T{0},\39\\{house});{}$\6
\\{new\_note}(\.{"There\ is\ a\ bottle\ o}\)\.{f\ water\ here."});\6
\\{new\_note}(\.{"There\ is\ an\ empty\ b}\)\.{ottle\ here."});\6
\\{new\_note}(\.{"There\ is\ a\ bottle\ o}\)\.{f\ oil\ here."});\6
${}\\{new\_obj}(\.{FOOD},\39\.{"Tasty\ food"},\39\T{0},\39\\{house});{}$\6
\\{new\_note}(\.{"There\ is\ food\ here.}\)\.{"});\6
${}\\{new\_obj}(\.{KNIFE},\39\T{0},\39\T{0},\39\\{limbo});{}$\6
${}\\{new\_obj}(\.{DWARF},\39\T{0},\39\.{DWARF},\39\\{limbo});{}$\6
${}\\{new\_obj}(\.{MAG},\39\.{"\\"Spelunker\ Today\\"}\)\.{"},\39\T{0},\39%
\\{ante});{}$\6
\\{new\_note}(\.{"There\ are\ a\ few\ rec}\)\.{ent\ issues\ of\ \\"Spel}\)%
\.{unker\ Today\\"\ magazi}\)\.{ne\ here."});\6
${}\\{new\_obj}(\.{OYSTER},\39\.{"Giant\ oyster\ >GROAN}\)\.{!<"},\39\T{0},\39%
\\{limbo});{}$\6
\\{new\_note}(\.{"There\ is\ an\ enormou}\)\.{s\ oyster\ here\ with\ i}\)\.{ts\
shell\ tightly\ clo}\)\.{sed."});\6
\\{new\_note}(\.{"Interesting.\ \ There}\)\.{\ seems\ to\ be\ somethi}\)\.{ng\
written\ on\ the\ un}\)\.{derside\ of\\nthe\ oyst}\)\.{er."});\6
${}\\{new\_obj}(\.{CLAM},\39\.{"Giant\ clam\ >GRUNT!<}\)\.{"},\39\T{0},\39%
\\{shell});{}$\6
\\{new\_note}(\.{"There\ is\ an\ enormou}\)\.{s\ clam\ here\ with\ its}\)\.{\
shell\ tightly\ close}\)\.{d."});\6
${}\\{new\_obj}(\.{TABLET},\39\T{0},\39\.{TABLET},\39\\{droom});{}$\6
\\{new\_note}(\.{"A\ massive\ stone\ tab}\)\.{let\ embedded\ in\ the\ }\)%
\.{wall\ reads:\\n\\"CONGR}\)\.{ATULATIONS\ ON\ BRINGI}\)\.{NG\ LIGHT\ INTO\
THE\ DA}\)\.{RK-ROOM!\\""});\6
${}\\{new\_obj}(\.{SNAKE},\39\T{0},\39\.{SNAKE},\39\\{hmk});{}$\6
\\{new\_note}(\.{"A\ huge\ green\ fierce}\)\.{\ snake\ bars\ the\ way!}\)%
\.{"});\6
\\{new\_note}(\T{0});\6
${}\\{new\_obj}(\.{PILLOW},\39\.{"Velvet\ pillow"},\39\T{0},\39\\{soft});{}$\6
\\{new\_note}(\.{"A\ small\ velvet\ pill}\)\.{ow\ lies\ on\ the\ floor}\)%
\.{."});\6
${}\\{new\_obj}(\.{DOOR},\39\T{0},\39\.{DOOR},\39\\{immense});{}$\6
\\{new\_note}(\.{"The\ way\ north\ is\ ba}\)\.{rred\ by\ a\ massive,\ r}\)%
\.{usty,\ iron\ door."});\6
\\{new\_note}(\.{"The\ way\ north\ leads}\)\.{\ through\ a\ massive,\ }\)%
\.{rusty,\ iron\ door."});\6
${}\\{new\_obj}(\.{BIRD},\39\.{"Little\ bird\ in\ cage}\)\.{"},\39\T{0},\39%
\\{bird});{}$\6
\\{new\_note}(\.{"A\ cheerful\ little\ b}\)\.{ird\ is\ sitting\ here\ }\)%
\.{singing."});\6
\\{new\_note}(\.{"There\ is\ a\ little\ b}\)\.{ird\ in\ the\ cage."});\6
${}\\{new\_obj}(\.{ROD2},\39\.{"Black\ rod"},\39\T{0},\39\\{limbo});{}$\6
\\{new\_note}(\.{"A\ three-foot\ black\ }\)\.{rod\ with\ a\ rusty\ mar}\)\.{k\
on\ an\ end\ lies\ nea}\)\.{rby."});\6
${}\\{new\_obj}(\.{ROD},\39\.{"Black\ rod"},\39\T{0},\39\\{debris});{}$\6
\\{new\_note}(\.{"A\ three-foot\ black\ }\)\.{rod\ with\ a\ rusty\ sta}\)\.{r\
on\ an\ end\ lies\ nea}\)\.{rby."});\6
${}\\{new\_obj}(\.{CAGE},\39\.{"Wicker\ cage"},\39\T{0},\39\\{cobbles});{}$\6
\\{new\_note}(\.{"There\ is\ a\ small\ wi}\)\.{cker\ cage\ discarded\ }\)%
\.{nearby."});\6
${}\\{new\_obj}(\.{LAMP},\39\.{"Brass\ lantern"},\39\T{0},\39\\{house});{}$\6
\\{new\_note}(\.{"There\ is\ a\ shiny\ br}\)\.{ass\ lamp\ nearby."});\6
\\{new\_note}(\.{"There\ is\ a\ lamp\ shi}\)\.{ning\ nearby."});\6
${}\\{new\_obj}(\.{KEYS},\39\.{"Set\ of\ keys"},\39\T{0},\39\\{house});{}$\6
\\{new\_note}(\.{"There\ are\ some\ keys}\)\.{\ on\ the\ ground\ here.}\)%
\.{"});\par
\fi

\N[2418 advent.w]{1}{71}Low-level input. Sometimes we need to ask you a
question, for which
the answer is either yes or no. The subroutine \PB{$\\{yes}(\|q,\|y,\|n)$}
prints~\PB{\|q},
waits for you to answer, and then prints \PB{\|y} or \PB{\|n} depending on your
answer. It returns a nonzero value if your answer was affirmative.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{boolean} \\{yes}\,\,\.{ARGS}((\&{char} ${}{*},\39{}$\&{char} ${}{*},\39{}$%
\&{char} ${}{*}));{}$\7
\&{boolean} ${}\\{yes}(\|q,\39\|y,\39\|n){}$\1\1\6
\&{char} ${}{*}\|q,{}$ ${}{*}\|y,{}$ ${}{*}\|n;\2\2{}$\6
${}\{{}$\1\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\\{printf}(\.{"\%s\\n**\ "},\39\|q){}$;\5
\\{fflush}(\\{stdout});\6
${}\\{fgets}(\\{buffer},\39\\{buf\_size},\39\\{stdin});{}$\6
\&{if} ${}(\\{tolower}({*}\\{buffer})\E\.{'y'}){}$\5
${}\{{}$\1\6
\&{if} (\|y)\1\5
${}\\{printf}(\.{"\%s\\n"},\39\|y){}$;\5
\2\&{return} \\{true};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{tolower}({*}\\{buffer})\E\.{'n'}){}$\5
${}\{{}$\1\6
\&{if} (\|n)\1\5
${}\\{printf}(\.{"\%s\\n"},\39\|n){}$;\5
\2\&{return} \\{false};\6
\4${}\}{}$\2\6
\&{else}\1\5
\\{printf}(\.{"\ Please\ answer\ Yes\ }\)\.{or\ No.\\n"});\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M[2439 advent.w]{72}The only other kind of input is almost as simple. You are
supposed to
tell us what to do next in your adventure, by typing one- or two-word commands.
We put the first word in \PB{\\{word1}} and the (possibly null)
second word in \PB{\\{word2}}. Words are separated by white space; otherwise
white space is ignored.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{listen}\,\,\.{ARGS}((\&{void}));\7
\&{void} \\{listen}(\,)\5
${}\{{}$\1\6
\&{register} \&{char} ${}{*}\|p,{}$ ${}{*}\|q;{}$\7
\&{while} (\T{1})\5
${}\{{}$\1\6
\\{printf}(\.{"*\ "});\5
\\{fflush}(\\{stdout});\6
${}\\{fgets}(\\{buffer},\39\\{buf\_size},\39\\{stdin});{}$\6
\&{for} ${}(\|p\K\\{buffer};{}$ ${}\\{isspace}({*}\|p);{}$ ${}\|p\PP){}$\1\5
;\2\6
\&{if} ${}({*}\|p\E\T{0}){}$\5
${}\{{}$\1\6
\\{printf}(\.{"\ Tell\ me\ to\ do\ some}\)\.{thing.\\n"});\5
\&{continue};\6
\4${}\}{}$\2\6
\&{for} ${}(\|q\K\\{word1};{}$ ${}{*}\|p;{}$ ${}\|p\PP,\39\|q\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{isspace}({*}\|p)){}$\1\5
\&{break};\2\6
${}{*}\|q\K\\{tolower}({*}\|p);{}$\6
\4${}\}{}$\2\6
${}{*}\|q\K\.{'\\0'}{}$;\C{ end of \PB{\\{word1}} }\6
\&{for} ${}(\|p\PP;{}$ ${}\\{isspace}({*}\|p);{}$ ${}\|p\PP){}$\1\5
;\2\6
\&{if} ${}({*}\|p\E\T{0}){}$\5
${}\{{}$\1\6
${}{*}\\{word2}\K\.{'\\0'}{}$;\5
\&{return};\6
\4${}\}{}$\2\6
\&{for} ${}(\|q\K\\{word2};{}$ ${}{*}\|p;{}$ ${}\|p\PP,\39\|q\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{isspace}({*}\|p)){}$\1\5
\&{break};\2\6
${}{*}\|q\K\\{tolower}({*}\|p);{}$\6
\4${}\}{}$\2\6
${}{*}\|q\K\.{'\\0'}{}$;\C{ end of \PB{\\{word2}} }\6
\&{for} ${}(\|p\PP;{}$ ${}\\{isspace}({*}\|p);{}$ ${}\|p\PP){}$\1\5
;\2\6
\&{if} ${}({*}\|p\E\T{0}){}$\1\5
\&{return};\2\6
\\{printf}(\.{"\ Please\ stick\ to\ 1-}\)\.{\ and\ 2-word\ commands}\)\.{.%
\\n"});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M[2474 advent.w]{73}A 20-character buffer would probably be big enough, but
what the heck.

\Y\B\4\D$\\{buf\_size}$ \5
\T{72}\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{char} \\{buffer}[\\{buf\_size}];\C{ your input goes here }\6
\&{char} \\{word1}[\\{buf\_size}]${},{}$ \\{word2}[\\{buf\_size}];\C{ and then
we snarf it to here }\par
\fi

\N[2482 advent.w]{1}{74}The main control loop. Now we've got enough low-level
mechanisms in
place to start thinking of the program from the top down, and to
specify the high-level control.

A global variable \PB{\\{loc}} represents where you currently live in the
simulated cave. Another variable \PB{\\{newloc}} represents where you will
go next, unless something like a dwarf blocks you. We also keep
track of \PB{\\{oldloc}} (the previous value of \PB{\\{loc}}) and \PB{%
\\{oldoldloc}}
(the previous previous value), for use when you ask to `\.{go} \.{back}'.

\Y\B\4\D$\\{here}(\|t)$ \5
$(\\{toting}(\|t)\V\\{place}[\|t]\E\\{loc}{}$)\C{ is object \PB{\|t} present? }%
\par
\B\4\D$\\{water\_here}$ \5
$((\\{flags}[\\{loc}]\AND(\\{liquid}+\\{oil}))\E\\{liquid}{}$)\par
\B\4\D$\\{oil\_here}$ \5
$((\\{flags}[\\{loc}]\AND(\\{liquid}+\\{oil}))\E\\{liquid}+\\{oil}{}$)\par
\B\4\D$\\{no\_liquid\_here}$ \5
$((\\{flags}[\\{loc}]\AND\\{liquid})\E\T{0}{}$)\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{location} \\{oldoldloc}${},{}$ \\{oldloc}${},{}$ \\{loc}${},{}$ \\{newloc};%
\C{ recent and future locations }\par
\fi

\M[2500 advent.w]{75}Here is our overall strategy for administering the game.
It is understood
that the program might \PB{\&{goto} \\{quit}} from within any of the
subsections
named here, even though the section names don't mention this explicitly.
For example, while checking for interference we might find out that
time has run out, or that a dwarf has killed you and no more
reincarnations are possible.

The execution consists of two nested loops: There are ``minor
cycles'' inside of ``major cycles.'' Actions define minor cycles in which
you stay in the same place and we tell you the result of your action.
Motions define major cycles in which you move and we tell you what you
can see at the new place.

\Y\B\4\X75:Simulate an adventure, going to \PB{\\{quit}} when finished\X${}%
\E{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\X153:Check for interference with the proposed move to \PB{\\{newloc}}\X;\6
${}\\{loc}\K\\{newloc}{}$;\C{ hey, we actually moved you }\6
\X161:Possibly move dwarves and the pirate\X;\6
\4\\{commence}:\5
\X86:Report the current state\X;\6
\&{while} (\T{1})\5
${}\{{}$\1\6
\X76:Get user input; \PB{\&{goto} \\{try\_move}} if motion is requested\X;\6
\X79:Perform an action in the current place\X;\6
\4${}\}{}$\2\6
\4\\{try\_move}:\5
\X140:Handle special motion words\X;\6
${}\\{oldoldloc}\K\\{oldloc};{}$\6
${}\\{oldloc}\K\\{loc};{}$\6
\4\\{go\_for\_it}:\5
\X146:Determine the next location, \PB{\\{newloc}}\X;\6
\4${}\}{}$\2\par
\U2.\fi

\M[2529 advent.w]{76}Our main task in the simulation loop is to parse your
input.
Depending on the kind of command you give, the following section
of the program will exit in one of four ways:

\smallskip
\item{$\bullet$} \PB{\&{goto} \\{try\_move}} with \PB{\\{mot}} set to a desired
motion.

\item{$\bullet$} \PB{\&{goto} \\{transitive}} with \PB{\\{verb}} set to a
desired action
and \PB{\\{obj}} set to the object of that motion.

\item{$\bullet$} \PB{\&{goto} \\{intransitive}} with \PB{\\{verb}} set to a
desired action
and \PB{$\\{obj}\K\.{NOTHING}$}; no object has been specified.

\item{$\bullet$} \PB{\&{goto} \\{speakit}} with \PB{$\\{hash\_table}[\|k].%
\\{meaning}$} the
index of a message for a vocabulary word of \PB{\\{message\_type}}.

\smallskip\noindent
Sometimes we have to ask you to complete an ambiguous command before we
know both a verb and its object. In most cases the words can be in
either order; for example, \.{take} \.{rod} is equivalent to \.{rod} \.{take}.
A~motion word overrides a previously given action or object.

Lots of special cases make the program a bit messy. For example,
if the verb is \.{say}, we don't want to look up the object in our
vocabulary; we simply want to ``say'' it.

\Y\B\4\X76:Get user input; \PB{\&{goto} \\{try\_move}} if motion is requested%
\X${}\E{}$\6
$\\{verb}\K\\{oldverb}\K\.{ABSTAIN};{}$\6
${}\\{oldobj}\K\\{obj};{}$\6
${}\\{obj}\K\.{NOTHING};{}$\6
\4\\{cycle}:\5
\X195:Check if a hint applies, and give it if requested\X;\6
\X85:Make special adjustments before looking at new input\X;\6
\\{listen}(\,);\6
\4\\{pre\_parse}:\5
${}\\{turns}\PP;{}$\6
\X82:Handle special cases of input\X;\6
\X178:Check the clocks and the lamp\X;\6
\X83:Handle additional special cases of input\X;\6
\4\\{parse}:\5
\X80:Give advice about going \PB{\.{WEST}}\X;\6
\X78:Look at \PB{\\{word1}} and exit to the right place if it completes a
command\X;\6
\4\\{shift}:\5
${}\\{strcpy}(\\{word1},\39\\{word2}){}$;\5
${}{*}\\{word2}\K\.{'\\0'}{}$;\5
\&{goto} \\{parse};\par
\U75.\fi

\M[2570 advent.w]{77}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{motion} \\{mot};\C{ currently specified motion, if any }\6
\&{action} \\{verb};\C{ currently specified action, if any }\6
\&{action} \\{oldverb};\C{ \PB{\\{verb}} before it was changed }\6
\&{object} \\{obj};\C{ currently specified object, if any }\6
\&{object} \\{oldobj};\C{ former value of \PB{\\{obj}} }\6
\&{wordtype} \\{command\_type};\C{ type of word found in hash table }\6
\&{int} \\{turns};\C{ how many times we've read your commands }\par
\fi

\M[2579 advent.w]{78}The \PB{\\{try\_motion}} macro is often used to end a
major cycle.

\Y\B\4\D$\\{try\_motion}(\|m)$ \5
${}\{{}$\5
\1${}\\{mot}\K\|m{}$;\5
\&{goto} \\{try\_move};\5
${}\}{}$\2\par
\B\4\D$\\{stay\_put}$ \5
\\{try\_motion}(\.{NOWHERE})\par
\Y\B\4\X78:Look at \PB{\\{word1}} and exit to the right place if it completes a
command\X${}\E{}$\6
$\|k\K\\{lookup}(\\{word1});{}$\6
\&{if} ${}(\|k<\T{0}){}$\5
${}\{{}$\C{ Gee, I don't understand }\1\6
${}\\{printf}(\.{"Sorry,\ I\ don't\ know}\)\.{\ the\ word\ \\"\%s\\".\\n"},\39%
\\{word1}){}$;\5
\&{goto} \\{cycle};\6
\4${}\}{}$\2\6
\4\\{branch}:\5
${}\\{command\_type}\K\\{hash\_table}[\|k].\\{word\_type};{}$\6
\&{switch} (\\{command\_type})\5
${}\{{}$\1\6
\4\&{case} \\{motion\_type}:\5
${}\\{try\_motion}(\\{hash\_table}[\|k].\\{meaning});{}$\6
\4\&{case} \\{object\_type}:\5
${}\\{obj}\K\\{hash\_table}[\|k].\\{meaning};{}$\6
\X90:Make sure \PB{\\{obj}} is meaningful at the current location\X;\6
\&{if} ${}({*}\\{word2}){}$\1\5
\&{break};\C{ fall through to \PB{\\{shift}} }\2\6
\&{if} (\\{verb})\1\5
\&{goto} \\{transitive};\2\6
${}\\{printf}(\.{"What\ do\ you\ want\ to}\)\.{\ do\ with\ the\ \%s?\\n"},\39%
\\{word1}){}$;\5
\&{goto} \\{cycle};\6
\4\&{case} \\{action\_type}:\5
${}\\{verb}\K\\{hash\_table}[\|k].\\{meaning};{}$\6
\&{if} ${}(\\{verb}\E\.{SAY}){}$\1\5
${}\\{obj}\K{*}\\{word2};{}$\2\6
\&{else} \&{if} ${}({*}\\{word2}){}$\1\5
\&{break};\C{ fall through to \PB{\\{shift}} }\2\6
\&{if} (\\{obj})\1\5
\&{goto} \\{transitive};\5
\2\&{else}\1\5
\&{goto} \\{intransitive};\2\6
\4\&{case} \\{message\_type}:\5
\&{goto} \\{speakit};\6
\4${}\}{}$\2\par
\U76.\fi

\M[2604 advent.w]{79}Here is the multiway branch where many kinds of actions
can be launched.

If a verb can only be transitive, but no object has been given,
we must go back and ask for an object.

If a verb can only be intransitive, but an object has been given,
we issue the default message for that verb and start over.

The variable \PB{\|k}, initially zero, is used to count various things
in several of the action routines.

The \PB{\\{report}} macro is often used to end a minor cycle.

\Y\B\4\D$\\{report}(\|m)$ \5
${}\{{}$\5
\1${}\\{printf}(\.{"\%s\\n"},\39\|m){}$;\5
\&{continue};\5
${}\}{}$\2\par
\B\4\D$\\{default\_to}(\|v)$ \5
\\{report}(\\{default\_msg}[\|v])\par
\B\4\D$\\{change\_to}(\|v)$ \5
${}\{{}$\5
\1${}\\{oldverb}\K\\{verb}{}$;\5
${}\\{verb}\K\|v{}$;\5
\&{goto} \\{transitive};\5
${}\}{}$\2\par
\Y\B\4\X79:Perform an action in the current place\X${}\E{}$\6
\4\\{intransitive}:\5
${}\|k\K\T{0};{}$\6
\&{switch} (\\{verb})\5
${}\{{}$\1\6
\4\&{case} \.{GO}:\5
\&{case} \.{RELAX}:\5
\&{goto} \\{report\_default};\6
\4\&{case} \.{ON}:\5
\&{case} \.{OFF}:\5
\&{case} \.{POUR}:\5
\&{case} \.{FILL}:\5
\&{case} \.{DRINK}:\5
\&{case} \.{BLAST}:\5
\&{case} \.{KILL}:\5
\&{goto} \\{transitive};\6
\X92:Handle cases of intransitive verbs and \PB{\&{continue}}\X;\6
\4\&{default}:\5
\&{goto} \\{get\_object};\6
\4${}\}{}$\2\6
\4\\{transitive}:\5
${}\|k\K\T{0};{}$\6
\&{switch} (\\{verb})\5
${}\{{}$\1\6
\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X;\6
\4\&{default}:\5
\&{goto} \\{report\_default};\6
\4${}\}{}$\2\6
\4\\{speakit}:\5
${}\\{report}(\\{message}[\\{hash\_table}[\|k].\\{meaning}]);{}$\6
\4\\{report\_default}:\5
\&{if} (\\{default\_msg}[\\{verb}])\1\5
\\{report}(\\{default\_msg}[\\{verb}])\5
\2\&{else}\1\5
\&{continue};\2\6
\4\\{get\_object}:\5
${}\\{word1}[\T{0}]\K\\{toupper}(\\{word1}[\T{0}]){}$;\5
${}\\{printf}(\.{"\%s\ what?\\n"},\39\\{word1});{}$\6
\&{goto} \\{cycle};\6
\4\\{cant\_see\_it}:\5
\&{if} ${}((\\{verb}\E\.{FIND}\V\\{verb}\E\.{INVENTORY})\W{*}\\{word2}\E\.{'%
\\0'}){}$\1\5
\&{goto} \\{transitive};\2\6
${}\\{printf}(\.{"I\ see\ no\ \%s\ here.\\n}\)\.{"},\39\\{word1}){}$;\5
\&{continue};\par
\U75.\fi

\M[2644 advent.w]{80}Here's a freely offered hint that may save you typing.

\Y\B\4\X80:Give advice about going \PB{\.{WEST}}\X${}\E{}$\6
\&{if} ${}(\\{streq}(\\{word1},\39\.{"west"})){}$\5
${}\{{}$\1\6
\&{if} ${}(\PP\\{west\_count}\E\T{10}){}$\1\5
\\{printf}(\.{"\ If\ you\ prefer,\ sim}\)\.{ply\ type\ W\ rather\ th}\)\.{an\
WEST.\\n"});\2\6
\4${}\}{}$\2\par
\U76.\fi

\M[2652 advent.w]{81}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{west\_count};\C{ how many times have we parsed the word `\.{west}'?
}\par
\fi

\M[2655 advent.w]{82}Maybe you said `\.{say}' and we said `\.{Say} \.{what?}'
and you replied
with two things to say. Then we assume you don't really want us to
say anything.

\Y\B\4\X82:Handle special cases of input\X${}\E{}$\6
\&{if} ${}(\\{verb}\E\.{SAY}){}$\5
${}\{{}$\1\6
\&{if} ${}({*}\\{word2}){}$\1\5
${}\\{verb}\K\.{ABSTAIN}{}$;\5
\2\&{else}\1\5
\&{goto} \\{transitive};\2\6
\4${}\}{}$\2\par
\A138.
\U76.\fi

\M[2664 advent.w]{83}The verb `\.{enter}' is listed in our vocabulary as a
motion rather than
an action. Here we deal with cases where you try to use it as an action.
Notice that `\.{H2O}' is not a synonym for `\.{water}' in this context.

\Y\B\4\X83:Handle additional special cases of input\X${}\E{}$\6
\&{if} ${}(\\{streq}(\\{word1},\39\.{"enter"})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{streq}(\\{word2},\39\.{"water"})\V\\{streq}(\\{word2},\39%
\.{"strea"})){}$\5
${}\{{}$\1\6
\&{if} (\\{water\_here})\1\5
\\{report}(\.{"Your\ feet\ are\ now\ w}\)\.{et."});\2\6
\\{default\_to}(\.{GO});\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}({*}\\{word2}){}$\1\5
\&{goto} \\{shift};\2\6
\4${}\}{}$\2\par
\A105.
\U76.\fi

\M[2676 advent.w]{84}Cavers can become cadavers if they don't have light. We
keep a variable
\PB{\\{was\_dark}} to remember how dark things were when you gave your last
command.

\Y\B\4\D$\\{dark}$ \5
$((\\{flags}[\\{loc}]\AND\\{lighted})\E\T{0}\W(\\{prop}[\.{LAMP}]\E\T{0}\V\R%
\\{here}(\.{LAMP})){}$)\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{was\_dark};\C{ you've recently been in the dark }\par
\fi

\M[2684 advent.w]{85}\B\X85:Make special adjustments before looking at new
input\X${}\E{}$\6
$\\{was\_dark}\K\\{dark}{}$;\par
\As158, 169\ETs182.
\U76.\fi

\M[2687 advent.w]{86}After moving to \PB{\\{newloc}}, we act as your eyes.
We print the long description of \PB{\\{newloc}} if you haven't been there
before;
but when you return to a previously seen place, we often use a short form.
The long form is used every 5th time, unless you say `\PB{\.{BRIEF}}', in which
case we use the shortest form we know. You can always ask for the
long form by saying `\PB{\.{LOOK}}'.

\Y\B\4\X86:Report the current state\X${}\E{}$\6
\&{if} ${}(\\{loc}\E\\{limbo}){}$\1\5
\&{goto} \\{death};\2\6
\&{if} ${}(\\{dark}\W\R\\{forced\_move}(\\{loc})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{was\_dark}\W\\{pct}(\T{35})){}$\1\5
\&{goto} \\{pitch\_dark};\2\6
${}\|p\K\\{pitch\_dark\_msg};{}$\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{short\_desc}[\\{loc}]\E\T{0}\V\\{visits}[\\{loc}]\MOD%
\\{interval}\E\T{0}){}$\1\5
${}\|p\K\\{long\_desc}[\\{loc}];{}$\2\6
\&{else}\1\5
${}\|p\K\\{short\_desc}[\\{loc}];{}$\2\6
\&{if} (\\{toting}(\.{BEAR}))\1\5
\\{printf}(\.{"You\ are\ being\ follo}\)\.{wed\ by\ a\ very\ large,}\)\.{\ tame%
\ bear.\\n"});\2\6
${}\\{printf}(\.{"\\n\%s\\n"},\39\|p);{}$\6
\&{if} (\\{forced\_move}(\\{loc}))\1\5
\&{goto} \\{try\_move};\2\6
\X157:Give optional \.{plugh} hint\X;\6
\&{if} ${}(\R\\{dark}){}$\1\5
\X88:Describe the objects at this location\X;\2\par
\U75.\fi

\M[2708 advent.w]{87}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{interval}${}\K\T{5}{}$;\C{ will change to 10000 if you want us to be
\PB{\.{BRIEF}} }\6
\&{char} \\{pitch\_dark\_msg}[\,]${}\K\.{"It\ is\ now\ pitch\ dar}\)\.{k.\ \ If%
\ you\ proceed\ y}\)\.{ou\ will\ most\ likely\ }\)\.{fall\ into\ a\ pit."}{}$;%
\par
\fi

\M[2713 advent.w]{88}If \PB{\.{TREADS}} are present but you have a heavy load,
we don't describe them.
The treads never actually get property value~1; we use the \PB{\\{note}} for
property~1 only when they are seen from above.

The global variable \PB{\\{tally}} counts the number of treasures you haven't
seen.
Another variable, \PB{\\{lost\_treasures}}, counts those you never will see.

\Y\B\4\X88:Describe the objects at this location\X${}\E{}$\6
${}\{{}$\5
\1\&{register} \&{object} \\{tt};\7
${}\\{visits}[\\{loc}]\PP;{}$\6
\&{for} ${}(\|t\K\\{first}[\\{loc}];{}$ \|t; ${}\|t\K\\{link}[\|t]){}$\5
${}\{{}$\1\6
${}\\{tt}\K(\\{base}[\|t]\?\\{base}[\|t]:\|t);{}$\6
\&{if} ${}(\\{prop}[\\{tt}]<\T{0}){}$\5
${}\{{}$\C{ you've spotted a treasure }\1\6
\&{if} (\\{closed})\1\5
\&{continue};\C{ no automatic \PB{\\{prop}} change after hours }\2\6
${}\\{prop}[\\{tt}]\K(\\{tt}\E\.{RUG}\V\\{tt}\E\.{CHAIN}){}$;\C{ initialize the
property value }\6
${}\\{tally}\MM;{}$\6
\X183:Zap the lamp if the remaining treasures are too elusive\X;\6
\4${}\}{}$\2\6
\&{if} ${}(\\{tt}\E\.{TREADS}\W\\{toting}(\.{GOLD})){}$\1\5
\&{continue};\2\6
${}\|p\K\\{note}[\\{prop}[\\{tt}]+\\{offset}[\\{tt}]+(\\{tt}\E\.{TREADS}\W%
\\{loc}\E\\{emist})];{}$\6
\&{if} (\|p)\1\5
${}\\{printf}(\.{"\%s\\n"},\39\|p);{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U86.\fi

\M[2737 advent.w]{89}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{tally}${}\K\T{15}{}$;\C{ treasures awaiting you }\6
\&{int} \\{lost\_treasures};\C{ treasures that you won't find }\par
\fi

\M[2741 advent.w]{90}When you specify an object, it must be at the current
location, unless the
verb is already known to be \PB{\.{FIND}} or \PB{\.{INVENTORY}}. A few other
special cases
also are permitted; for example, water and oil are funny, since they are never
actually dropped at any location, but they might be present inside the bottle
or as a feature of the location.

\Y\B\4\D$\\{object\_in\_bottle}$ \5
$((\\{obj}\E\.{WATER}\W\\{prop}[\.{BOTTLE}]\E\T{0})\V(\\{obj}\E\.{OIL}\W%
\\{prop}[\.{BOTTLE}]\E\T{2}){}$)\par
\Y\B\4\X90:Make sure \PB{\\{obj}} is meaningful at the current location\X${}%
\E{}$\6
\&{if} ${}(\R\\{toting}(\\{obj})\W\R\\{is\_at\_loc}(\\{obj})){}$\1\6
\&{switch} (\\{obj})\5
${}\{{}$\1\6
\4\&{case} \.{GRATE}:\5
\X91:If \PB{\.{GRATE}} is actually a motion word, move to it\X;\6
\&{goto} \\{cant\_see\_it};\6
\4\&{case} \.{DWARF}:\5
\&{if} ${}(\\{dflag}\G\T{2}\W\\{dwarf}(\,)){}$\1\5
\&{break};\5
\2\&{else}\1\5
\&{goto} \\{cant\_see\_it};\2\6
\4\&{case} \.{PLANT}:\5
\&{if} ${}(\\{is\_at\_loc}(\.{PLANT2})\W\\{prop}[\.{PLANT2}]){}$\5
${}\{{}$\1\6
${}\\{obj}\K\.{PLANT2}{}$;\5
\&{break};\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \\{cant\_see\_it};\2\6
\4\&{case} \.{KNIFE}:\5
\&{if} ${}(\\{loc}\I\\{knife\_loc}){}$\1\5
\&{goto} \\{cant\_see\_it};\2\6
${}\\{knife\_loc}\K{-}\T{1};{}$\6
\\{report}(\.{"The\ dwarves'\ knives}\)\.{\ vanish\ as\ they\ stri}\)\.{ke\ the%
\ walls\ of\ the\ }\)\.{cave."});\6
\4\&{case} \.{ROD}:\5
\&{if} ${}(\R\\{here}(\.{ROD2})){}$\1\5
\&{goto} \\{cant\_see\_it};\2\6
${}\\{obj}\K\.{ROD2}{}$;\5
\&{break};\6
\4\&{case} \.{WATER}:\5
\&{case} \.{OIL}:\5
\&{if} ${}(\\{here}(\.{BOTTLE})\W\\{object\_in\_bottle}){}$\1\5
\&{break};\2\6
\&{if} ${}((\\{obj}\E\.{WATER}\W\\{water\_here})\V(\\{obj}\E\.{OIL}\W\\{oil%
\_here})){}$\1\5
\&{break};\2\6
\4\&{default}:\5
\&{goto} \\{cant\_see\_it};\6
\4${}\}{}$\2\2\par
\U78.\fi

\M[2768 advent.w]{91}Henning Makholm has pointed out that the logic here makes %
\PB{\.{GRATE}} a motion
word regardless of the verb.
For example, you can get to the grate by
saying `\.{wave}~\.{grate}' from the \PB{\\{road}} or the \PB{\\{valley}} (but
curiously
not from the \PB{\\{slit}}).

\Y\B\4\X91:If \PB{\.{GRATE}} is actually a motion word, move to it\X${}\E{}$\6
\&{if} ${}(\\{loc}<\\{min\_lower\_loc}){}$\1\6
\&{switch} (\\{loc})\5
${}\{{}$\1\6
\4\&{case} \\{road}:\5
\&{case} \\{valley}:\5
\&{case} \\{slit}:\5
\\{try\_motion}(\.{DEPRESSION});\6
\4\&{case} \\{cobbles}:\5
\&{case} \\{debris}:\5
\&{case} \\{awk}:\5
\&{case} \\{bird}:\5
\&{case} \\{spit}:\5
\\{try\_motion}(\.{ENTRANCE});\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\2\par
\U90.\fi

\N[2783 advent.w]{1}{92}Simple verbs. Let's get experience implementing the
actions by
dispensing with the easy cases first.

First there are several ``intransitive'' verbs that reduce to transitive
when we identify an appropriate object. For example, `\.{take}' makes
sense by itself if there's only one possible thing to take.

\Y\B\4\X92:Handle cases of intransitive verbs and \PB{\&{continue}}\X${}\E{}$\6
\4\&{case} \.{TAKE}:\5
\&{if} ${}(\\{first}[\\{loc}]\E\T{0}\V\\{link}[\\{first}[\\{loc}]]\V\\{dwarf}(%
\,)){}$\1\5
\&{goto} \\{get\_object};\2\6
${}\\{obj}\K\\{first}[\\{loc}]{}$;\5
\&{goto} \\{transitive};\7
\4\&{case} \.{EAT}:\5
\&{if} ${}(\R\\{here}(\.{FOOD})){}$\1\5
\&{goto} \\{get\_object};\2\6
${}\\{obj}\K\.{FOOD}{}$;\5
\&{goto} \\{transitive};\par
\As93, 94, 95\ETs136.
\U79.\fi

\M[2797 advent.w]{93}Only the objects \PB{\.{GRATE}}, \PB{\.{DOOR}}, \PB{$%
\.{CLAM}/\.{OYSTER}$}, and \PB{\.{CHAIN}} can
be opened or closed. And only a few objects can be read.

\Y\B\4\X92:Handle cases of intransitive verbs and \PB{\&{continue}}\X${}%
\mathrel+\E{}$\6
\4\&{case} \.{OPEN}:\5
\&{case} \.{CLOSE}:\5
\&{if} ${}(\\{place}[\.{GRATE}]\E\\{loc}\V\\{place}[\.{GRATE\_}]\E\\{loc}){}$\1%
\5
${}\\{obj}\K\.{GRATE};{}$\2\6
\&{else} \&{if} ${}(\\{place}[\.{DOOR}]\E\\{loc}){}$\1\5
${}\\{obj}\K\.{DOOR};{}$\2\6
\&{else} \&{if} (\\{here}(\.{CLAM}))\1\5
${}\\{obj}\K\.{CLAM};{}$\2\6
\&{else} \&{if} (\\{here}(\.{OYSTER}))\1\5
${}\\{obj}\K\.{OYSTER};{}$\2\6
\&{if} (\\{here}(\.{CHAIN}))\5
${}\{{}$\1\6
\&{if} (\\{obj})\1\5
\&{goto} \\{get\_object};\5
\2\&{else}\1\5
${}\\{obj}\K\.{CHAIN};{}$\2\6
\4${}\}{}$\2\6
\&{if} (\\{obj})\1\5
\&{goto} \\{transitive};\2\6
\\{report}(\.{"There\ is\ nothing\ he}\)\.{re\ with\ a\ lock!"});\7
\4\&{case} \.{READ}:\5
\&{if} (\\{dark})\1\5
\&{goto} \\{get\_object};\C{ can't read in the dark }\2\6
\&{if} (\\{here}(\.{MAG}))\1\5
${}\\{obj}\K\.{MAG};{}$\2\6
\&{if} (\\{here}(\.{TABLET}))\5
${}\{{}$\1\6
\&{if} (\\{obj})\1\5
\&{goto} \\{get\_object};\5
\2\&{else}\1\5
${}\\{obj}\K\.{TABLET};{}$\2\6
\4${}\}{}$\2\6
\&{if} (\\{here}(\.{MESSAGE}))\5
${}\{{}$\1\6
\&{if} (\\{obj})\1\5
\&{goto} \\{get\_object};\5
\2\&{else}\1\5
${}\\{obj}\K\.{MESSAGE};{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{closed}\W\\{toting}(\.{OYSTER})){}$\1\5
${}\\{obj}\K\.{OYSTER};{}$\2\6
\&{if} (\\{obj})\1\5
\&{goto} \\{transitive};\5
\2\&{else}\1\5
\&{goto} \\{get\_object};\2\par
\fi

\M[2822 advent.w]{94}A request for an inventory is pretty simple too.

\Y\B\4\X92:Handle cases of intransitive verbs and \PB{\&{continue}}\X${}%
\mathrel+\E{}$\6
\4\&{case} \.{INVENTORY}:\5
\&{for} ${}(\|t\K\T{1};{}$ ${}\|t\Z\\{max\_obj};{}$ ${}\|t\PP){}$\1\6
\&{if} ${}(\\{toting}(\|t)\W(\\{base}[\|t]\E\.{NOTHING}\V\\{base}[\|t]\E\|t)\W%
\|t\I\.{BEAR}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|k\E\T{0}){}$\1\5
${}\|k\K\T{1},\39\\{printf}(\.{"You\ are\ currently\ h}\)\.{olding\ the\
following}\)\.{:\\n"});{}$\2\6
${}\\{printf}(\.{"\ \%s\\n"},\39\\{name}[\|t]);{}$\6
\4${}\}{}$\2\2\6
\&{if} (\\{toting}(\.{BEAR}))\1\5
\\{report}(\.{"You\ are\ being\ follo}\)\.{wed\ by\ a\ very\ large,}\)\.{\ tame%
\ bear."});\2\6
\&{if} ${}(\|k\E\T{0}){}$\1\5
\\{report}(\.{"You're\ not\ carrying}\)\.{\ anything."});\2\6
\&{continue};\par
\fi

\M[2834 advent.w]{95}Here are other requests about the mechanics of the game.

\Y\B\4\X92:Handle cases of intransitive verbs and \PB{\&{continue}}\X${}%
\mathrel+\E{}$\6
\4\&{case} \.{BRIEF}:\5
${}\\{interval}\K\T{10000};{}$\6
${}\\{look\_count}\K\T{3};{}$\6
\\{report}(\.{"Okay,\ from\ now\ on\ I}\)\.{'ll\ only\ describe\ a\ }\)\.{place%
\ in\ full\ the\ fi}\)\.{rst\ time\\nyou\ come\ t}\)\.{o\ it.\ \ To\ get\ the\
fu}\)\.{ll\ description,\ say\ }\)\.{\\"LOOK\\"."});\7
\4\&{case} \.{SCORE}:\5
${}\\{printf}(\.{"If\ you\ were\ to\ quit}\)\.{\ now,\ you\ would\ scor}\)\.{e\
\%d\\nout\ of\ a\ possi}\)\.{ble\ \%d.\\n"},\39\\{score}(\,)-\T{4},\39\\{max%
\_score});{}$\6
\&{if} ${}(\R\\{yes}(\.{"Do\ you\ indeed\ wish\ }\)\.{to\ quit\ now?"},\39%
\\{ok},\39\\{ok})){}$\1\5
\&{continue};\2\6
\&{goto} \\{give\_up};\7
\4\&{case} \.{QUIT}:\5
\&{if} ${}(\R\\{yes}(\.{"Do\ you\ really\ wish\ }\)\.{to\ quit\ now?"},\39%
\\{ok},\39\\{ok})){}$\1\5
\&{continue};\2\6
\4\\{give\_up}:\5
${}\\{gave\_up}\K\\{true}{}$;\5
\&{goto} \\{quit};\par
\fi

\M[2851 advent.w]{96}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{gave\_up};\C{ did you quit while you were alive? }\par
\fi

\M[2854 advent.w]{97}The \PB{\.{SAY}} routine is just an echo unless you say a
magic word.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\E{}$\6
\4\&{case} \.{SAY}:\5
\&{if} ${}({*}\\{word2}){}$\1\5
${}\\{strcpy}(\\{word1},\39\\{word2});{}$\2\6
${}\|k\K\\{lookup}(\\{word1});{}$\6
\&{switch} ${}(\\{hash\_table}[\|k].\\{meaning}){}$\5
${}\{{}$\1\6
\4\&{case} \.{FEEFIE}:\6
\&{if} ${}(\\{hash\_table}[\|k].\\{word\_type}\I\\{action\_type}){}$\1\5
\&{break};\2\6
\4\&{case} \.{XYZZY}:\5
\&{case} \.{PLUGH}:\5
\&{case} \.{PLOVER}:\5
${}{*}\\{word2}\K\.{'\\0'}{}$;\5
${}\\{obj}\K\.{NOTHING}{}$;\5
\&{goto} \\{branch};\6
\4\&{default}:\5
\&{break};\6
\4${}\}{}$\2\6
${}\\{printf}(\.{"Okay,\ \\"\%s\\".\\n"},\39\\{word1}){}$;\5
\&{continue};\par
\As98, 99, 100, 101, 102, 106, 107, 110, 112, 117, 122, 125, 129, 130\ETs135.
\U79.\fi

\M[2867 advent.w]{98}Hungry?

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{EAT}:\5
\&{switch} (\\{obj})\5
${}\{{}$\1\6
\4\&{case} \.{FOOD}:\5
\\{destroy}(\.{FOOD});\6
\\{report}(\.{"Thank\ you,\ it\ was\ d}\)\.{elicious!"});\6
\4\&{case} \.{BIRD}:\5
\&{case} \.{SNAKE}:\5
\&{case} \.{CLAM}:\5
\&{case} \.{OYSTER}:\5
\&{case} \.{DWARF}:\5
\&{case} \.{DRAGON}:\5
\&{case} \.{TROLL}:\5
\&{case} \.{BEAR}:\5
\\{report}(\.{"I\ think\ I\ just\ lost}\)\.{\ my\ appetite."});\6
\4\&{default}:\5
\&{goto} \\{report\_default};\6
\4${}\}{}$\2\par
\fi

\M[2879 advent.w]{99}Waving to the shadowy figure has no effect; but you might
wave a rod at the fissure. Blasting has no effect unless you've
got dynamite, which is a neat trick! Rubbing yields only snide remarks.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{WAVE}:\5
\&{if} ${}(\\{obj}\I\.{ROD}\V(\\{loc}\I\\{efiss}\W\\{loc}\I\\{wfiss})\V\3{-1}\R%
\\{toting}(\\{obj})\V\\{closing}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{toting}(\\{obj})\V(\\{obj}\E\.{ROD}\W\\{toting}(\.{ROD2}))){}$\1\5
\&{goto} \\{report\_default};\2\6
\\{default\_to}(\.{DROP});\6
\4${}\}{}$\2\6
${}\\{prop}[\.{CRYSTAL}]\K\T{1}-\\{prop}[\.{CRYSTAL}];{}$\6
${}\\{report}(\\{note}[\\{offset}[\.{CRYSTAL}]+\T{2}-\\{prop}[%
\.{CRYSTAL}]]){}$;\7
\4\&{case} \.{BLAST}:\5
\&{if} ${}(\\{closed}\W\\{prop}[\.{ROD2}]\G\T{0}){}$\5
${}\{{}$\1\6
${}\\{bonus}\K(\\{here}(\.{ROD2})\?\T{25}:\\{loc}\E\\{neend}\?\T{30}:%
\T{45});{}$\6
${}\\{printf}(\.{"\%s\\n"},\39\\{message}[\\{bonus}/\T{5}]){}$;\5
\&{goto} \\{quit};\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \\{report\_default};\2\7
\4\&{case} \.{RUB}:\5
\&{if} ${}(\\{obj}\E\.{LAMP}){}$\1\5
\&{goto} \\{report\_default};\2\6
\\{default\_to}(\.{TOSS});\par
\fi

\M[2900 advent.w]{100}If asked to find an object that isn't visible, we give a
caveat.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{FIND}:\5
\&{case} \.{INVENTORY}:\5
\&{if} (\\{toting}(\\{obj}))\1\5
\\{default\_to}(\.{TAKE});\2\6
\&{if} (\\{closed})\1\5
\\{report}(\.{"I\ daresay\ whatever\ }\)\.{you\ want\ is\ around\ h}\)\.{ere\
somewhere."});\2\6
\&{if} ${}(\\{is\_at\_loc}(\\{obj})\V(\\{object\_in\_bottle}\W\\{place}[%
\.{BOTTLE}]\E\\{loc})\V\3{-1}(\\{obj}\E\.{WATER}\W\\{water\_here})\V(\\{obj}\E%
\.{OIL}\W\\{oil\_here})\V\3{-1}(\\{obj}\E\.{DWARF}\W\\{dwarf}(\,))){}$\1\5
\\{report}(\.{"I\ believe\ what\ you\ }\)\.{want\ is\ right\ here\ w}\)\.{ith\
you."});\2\6
\&{goto} \\{report\_default};\par
\fi

\M[2911 advent.w]{101}Breaking and/or waking have no effect until the cave is
closed,
except of course that you might break the vase. The dwarves like
mirrors and hate being awakened.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{BREAK}:\5
\&{if} ${}(\\{obj}\E\.{VASE}\W\\{prop}[\.{VASE}]\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} (\\{toting}(\.{VASE}))\1\5
${}\\{drop}(\.{VASE},\39\\{loc}){}$;\C{ crash }\2\6
\\{printf}(\.{"You\ have\ taken\ the\ }\)\.{vase\ and\ hurled\ it\ d}\)%
\.{elicately\ to\ the\ gro}\)\.{und.\\n"});\6
\4\\{smash}:\5
${}\\{prop}[\.{VASE}]\K\T{2}{}$;\5
${}\\{base}[\.{VASE}]\K\.{VASE}{}$;\C{ it's no longer movable }\6
\&{continue};\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{obj}\I\.{MIRROR}){}$\1\5
\&{goto} \\{report\_default};\2\6
\&{if} (\\{closed})\5
${}\{{}$\1\6
\\{printf}(\.{"You\ strike\ the\ mirr}\)\.{or\ a\ resounding\ blow}\)\.{,\
whereupon\ it\ shatt}\)\.{ers\ into\ a\\nmyriad\ t}\)\.{iny\ fragments."});\5
\&{goto} \\{dwarves\_upset};\6
\4${}\}{}$\2\6
\\{report}(\.{"It\ is\ too\ far\ up\ fo}\)\.{r\ you\ to\ reach."});\7
\4\&{case} \.{WAKE}:\5
\&{if} ${}(\\{closed}\W\\{obj}\E\.{DWARF}){}$\5
${}\{{}$\1\6
\\{printf}(\.{"You\ prod\ the\ neares}\)\.{t\ dwarf,\ who\ wakes\ u}\)\.{p\
grumpily,\ takes\ on}\)\.{e\ look\ at\\nyou,\ curs}\)\.{es,\ and\ grabs\ for\
hi}\)\.{s\ axe.\\n"});\5
\&{goto} \\{dwarves\_upset};\6
\4${}\}{}$\2\6
\&{else}\1\5
\&{goto} \\{report\_default};\2\par
\fi

\M[2935 advent.w]{102}Here we deal with lighting or extinguishing the lamp. The
variable
\PB{\\{limit}} tells how much juice you've got left.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{ON}:\5
\&{if} ${}(\R\\{here}(\.{LAMP})){}$\1\5
\&{goto} \\{report\_default};\2\6
\&{if} ${}(\\{limit}<\T{0}){}$\1\5
\\{report}(\.{"Your\ lamp\ has\ run\ o}\)\.{ut\ of\ power."});\2\6
${}\\{prop}[\.{LAMP}]\K\T{1};{}$\6
\\{printf}(\.{"Your\ lamp\ is\ now\ on}\)\.{.\\n"});\6
\&{if} (\\{was\_dark})\1\5
\&{goto} \\{commence};\2\6
\&{continue};\7
\4\&{case} \.{OFF}:\5
\&{if} ${}(\R\\{here}(\.{LAMP})){}$\1\5
\&{goto} \\{report\_default};\2\6
${}\\{prop}[\.{LAMP}]\K\T{0};{}$\6
\\{printf}(\.{"Your\ lamp\ is\ now\ of}\)\.{f.\\n"});\6
\&{if} (\\{dark})\1\5
${}\\{printf}(\.{"\%s\\n"},\39\\{pitch\_dark\_msg});{}$\2\6
\&{continue};\par
\fi

\M[2952 advent.w]{103}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{limit};\C{ countdown till darkness }\par
\fi

\N[2955 advent.w]{1}{104}Liquid assets. Readers of this program will already
have noticed that
the \PB{\.{BOTTLE}} is a rather complicated object, since it can be empty
or filled with either water or oil.  Let's consider now the main
actions that involve liquids.

When you are carrying a bottle full of water, \PB{\\{place}[\.{WATER}]} will
be \PB{\\{inhand}}; hence both \PB{\\{toting}(\.{WATER})} and \PB{\\{toting}(%
\.{BOTTLE})} are true.
A similar remark applies to a bottle full of oil.

The value of \PB{\\{prop}[\.{BOTTLE}]} is 0 if it holds water, 2 if it holds
oil, otherwise either 1 or~$-2$. (The value $-2$ is used after closing the
cave.)

\Y\B\4\D$\\{bottle\_empty}$ \5
$(\\{prop}[\.{BOTTLE}]\E\T{1}\V\\{prop}[\.{BOTTLE}]<\T{0}{}$)\par
\fi

\M[2970 advent.w]{105}Sometimes `\.{water}' and `\.{oil}' are used as verbs.

\Y\B\4\X83:Handle additional special cases of input\X${}\mathrel+\E{}$\6
\&{if} ${}((\\{streq}(\\{word1},\39\.{"water"})\V\\{streq}(\\{word1},\39%
\.{"oil"}))\W\3{-1}(\\{streq}(\\{word2},\39\.{"plant"})\V\\{streq}(\\{word2},%
\39\.{"door"}))\W\3{-1}(\\{loc}\E\\{place}[\\{hash\_table}[\\{lookup}(%
\\{word2})].\\{meaning}])){}$\1\5
${}\\{strcpy}(\\{word2},\39\.{"pour"}){}$;\2\par
\fi

\M[2977 advent.w]{106}If you ask simply to drink, we assume that you want
water. If there's
water in the bottle, you drink that; otherwise you must be at a
water location.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{DRINK}:\5
\&{if} ${}(\\{obj}\E\.{NOTHING}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{water\_here}\W\R(\\{here}(\.{BOTTLE})\W\\{prop}[\.{BOTTLE}]\E%
\T{0})){}$\1\5
\&{goto} \\{get\_object};\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{obj}\I\.{WATER}){}$\1\5
\\{default\_to}(\.{EAT});\2\6
\&{if} ${}(\R(\\{here}(\.{BOTTLE})\W\\{prop}[\.{BOTTLE}]\E\T{0})){}$\1\5
\&{goto} \\{report\_default};\2\6
${}\\{prop}[\.{BOTTLE}]\K\T{1}{}$;\5
${}\\{place}[\.{WATER}]\K\\{limbo};{}$\6
\\{report}(\.{"The\ bottle\ of\ water}\)\.{\ is\ now\ empty."});\par
\fi

\M[2989 advent.w]{107}Pouring involves liquid from the bottle.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{POUR}:\5
\&{if} ${}(\\{obj}\E\.{NOTHING}\V\\{obj}\E\.{BOTTLE}){}$\5
${}\{{}$\1\6
${}\\{obj}\K(\\{prop}[\.{BOTTLE}]\E\T{0}\?\.{WATER}:\\{prop}[\.{BOTTLE}]\E\T{2}%
\?\.{OIL}:\T{0});{}$\6
\&{if} ${}(\\{obj}\E\.{NOTHING}){}$\1\5
\&{goto} \\{get\_object};\2\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{toting}(\\{obj})){}$\1\5
\&{goto} \\{report\_default};\2\6
\&{if} ${}(\\{obj}\I\.{WATER}\W\\{obj}\I\.{OIL}){}$\1\5
\\{report}(\.{"You\ can't\ pour\ that}\)\.{."});\2\6
${}\\{prop}[\.{BOTTLE}]\K\T{1}{}$;\5
${}\\{place}[\\{obj}]\K\\{limbo};{}$\6
\&{if} ${}(\\{loc}\E\\{place}[\.{PLANT}]){}$\1\5
\X108:Try to water the plant\X;\2\6
\&{if} ${}(\\{loc}\E\\{place}[\.{DOOR}]){}$\1\5
\X109:Pour water or oil on the door\X;\2\6
\\{report}(\.{"Your\ bottle\ is\ empt}\)\.{y\ and\ the\ ground\ is\ }\)%
\.{wet."});\par
\fi

\M[3003 advent.w]{108}\B\X108:Try to water the plant\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{obj}\I\.{WATER}){}$\1\5
\\{report}(\.{"The\ plant\ indignant}\)\.{ly\ shakes\ the\ oil\ of}\)\.{f\ its\
leaves\ and\ ask}\)\.{s,\ \\"Water?\\""});\2\6
${}\\{printf}(\.{"\%s\\n"},\39\\{note}[\\{prop}[\.{PLANT}]+\T{1}+\\{offset}[%
\.{PLANT}]]);{}$\6
${}\\{prop}[\.{PLANT}]\MRL{+{\K}}\T{2}{}$;\5
\&{if} ${}(\\{prop}[\.{PLANT}]>\T{4}){}$\1\5
${}\\{prop}[\.{PLANT}]\K\T{0};{}$\2\6
${}\\{prop}[\.{PLANT2}]\K\\{prop}[\.{PLANT}]\GG\T{1};{}$\6
\\{stay\_put};\6
\4${}\}{}$\2\par
\U107.\fi

\M[3013 advent.w]{109}\B\X109:Pour water or oil on the door\X${}\E{}$\6
\&{switch} (\\{obj})\5
${}\{{}$\1\6
\4\&{case} \.{WATER}:\5
${}\\{prop}[\.{DOOR}]\K\T{0};{}$\6
\\{report}(\.{"The\ hinges\ are\ quit}\)\.{e\ thoroughly\ rusted\ }\)\.{now\
and\ won't\ budge.}\)\.{"});\6
\4\&{case} \.{OIL}:\5
${}\\{prop}[\.{DOOR}]\K\T{1};{}$\6
\\{report}(\.{"The\ oil\ has\ freed\ u}\)\.{p\ the\ hinges\ so\ that}\)\.{\ the%
\ door\ will\ now\ o}\)\.{pen."});\6
\4${}\}{}$\2\par
\U107.\fi

\M[3021 advent.w]{110}You can fill the bottle only when it's empty and liquid
is available.
You can't fill the lamp with oil.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{FILL}:\5
\&{if} ${}(\\{obj}\E\.{VASE}){}$\1\5
\X111:Try to fill the vase\X;\2\6
\&{if} ${}(\R\\{here}(\.{BOTTLE})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{obj}\E\.{NOTHING}){}$\1\5
\&{goto} \\{get\_object};\5
\2\&{else}\1\5
\&{goto} \\{report\_default};\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{obj}\I\.{NOTHING}\W\\{obj}\I\.{BOTTLE}){}$\1\5
\&{goto} \\{report\_default};\2\6
\&{if} ${}(\R\\{bottle\_empty}){}$\1\5
\\{report}(\.{"Your\ bottle\ is\ alre}\)\.{ady\ full."});\2\6
\&{if} (\\{no\_liquid\_here})\1\5
\\{report}(\.{"There\ is\ nothing\ he}\)\.{re\ with\ which\ to\ fil}\)\.{l\ the%
\ bottle."});\2\6
${}\\{prop}[\.{BOTTLE}]\K\\{flags}[\\{loc}]\AND\\{oil};{}$\6
\&{if} (\\{toting}(\.{BOTTLE}))\1\5
${}\\{place}[\\{prop}[\.{BOTTLE}]\?\.{OIL}:\.{WATER}]\K\\{inhand};{}$\2\6
${}\\{printf}(\.{"Your\ bottle\ is\ now\ }\)\.{full\ of\ \%s.\\n"},\39\\{prop}[%
\.{BOTTLE}]\?\.{"oil"}:\.{"water"});{}$\6
\&{continue};\par
\fi

\M[3037 advent.w]{111}Filling the vase is a nasty business.

\Y\B\4\X111:Try to fill the vase\X${}\E{}$\6
${}\{{}$\1\6
\&{if} (\\{no\_liquid\_here})\1\5
\\{report}(\.{"There\ is\ nothing\ he}\)\.{re\ with\ which\ to\ fil}\)\.{l\ the%
\ vase.\\n"});\2\6
\&{if} ${}(\R\\{toting}(\.{VASE})){}$\1\5
\\{report}(\\{default\_msg}[\.{DROP}]);\2\6
\\{printf}(\.{"The\ sudden\ change\ i}\)\.{n\ temperature\ has\ de}\)%
\.{licately\ shattered\ t}\)\.{he\ vase.\\n"});\6
\&{goto} \\{smash};\6
\4${}\}{}$\2\par
\U110.\fi

\M[3048 advent.w]{112}Picking up a liquid depends, of course, on the status of
the bottle.
Other objects need special handling, too, because of various side
effects and the fact that we can't take bird and cage separately
when the bird is in the cage.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{TAKE}:\5
\&{if} (\\{toting}(\\{obj}))\1\5
\&{goto} \\{report\_default};\C{ already carrying it }\2\6
\&{if} (\\{base}[\\{obj}])\5
${}\{{}$\C{ it is immovable }\1\6
\&{if} ${}(\\{obj}\E\.{CHAIN}\W\\{prop}[\.{BEAR}]){}$\1\5
\\{report}(\.{"The\ chain\ is\ still\ }\)\.{locked."});\2\6
\&{if} ${}(\\{obj}\E\.{BEAR}\W\\{prop}[\.{BEAR}]\E\T{1}){}$\1\5
\\{report}(\.{"The\ bear\ is\ still\ c}\)\.{hained\ to\ the\ wall."});\2\6
\&{if} ${}(\\{obj}\E\.{PLANT}\W\\{prop}[\.{PLANT}]\Z\T{0}){}$\1\5
\\{report}(\.{"The\ plant\ has\ excep}\)\.{tionally\ deep\ roots\ }\)\.{and\
cannot\ be\ pulled}\)\.{\ free."});\2\6
\\{report}(\.{"You\ can't\ be\ seriou}\)\.{s!"});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{obj}\E\.{WATER}\V\\{obj}\E\.{OIL}){}$\1\5
\X113:Check special cases for taking a liquid\X;\2\6
\&{if} ${}(\\{holding}\G\T{7}){}$\1\5
\\{report}(\.{"You\ can't\ carry\ any}\)\.{thing\ more.\ \ You'll\ }\)\.{have\
to\ drop\ somethi}\)\.{ng\ first."});\2\6
\&{if} ${}(\\{obj}\E\.{BIRD}\W\\{prop}[\.{BIRD}]\E\T{0}){}$\1\5
\X114:Check special cases for taking a bird\X;\2\6
\&{if} ${}(\\{obj}\E\.{BIRD}\V(\\{obj}\E\.{CAGE}\W\\{prop}[\.{BIRD}])){}$\1\5
${}\\{carry}(\.{BIRD}+\.{CAGE}-\\{obj});{}$\2\6
\\{carry}(\\{obj});\6
\&{if} ${}(\\{obj}\E\.{BOTTLE}\W\R\\{bottle\_empty}){}$\1\5
${}\\{place}[\\{prop}[\.{BOTTLE}]\?\.{OIL}:\.{WATER}]\K\\{inhand};{}$\2\6
\\{default\_to}(\.{RELAX});\C{ OK, we've taken it }\par
\fi

\M[3072 advent.w]{113}\B\X113:Check special cases for taking a liquid\X${}\E{}$%
\6
\&{if} ${}(\\{here}(\.{BOTTLE})\W\\{object\_in\_bottle}){}$\1\5
${}\\{obj}\K\.{BOTTLE};{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{obj}\K\.{BOTTLE};{}$\6
\&{if} (\\{toting}(\.{BOTTLE}))\1\5
\\{change\_to}(\.{FILL});\2\6
\\{report}(\.{"You\ have\ nothing\ in}\)\.{\ which\ to\ carry\ it."});\6
\4${}\}{}$\2\par
\U112.\fi

\M[3080 advent.w]{114}\B\X114:Check special cases for taking a bird\X${}\E{}$\6
${}\{{}$\1\6
\&{if} (\\{toting}(\.{ROD}))\1\5
\\{report}(\.{"The\ bird\ was\ unafra}\)\.{id\ when\ you\ entered,}\)\.{\ but\
as\ you\ approach}\)\.{\ it\ becomes\\ndisturb}\)\.{ed\ and\ you\ cannot\ ca}\)%
\.{tch\ it."});\2\6
\&{if} (\\{toting}(\.{CAGE}))\1\5
${}\\{prop}[\.{BIRD}]\K\T{1};{}$\2\6
\&{else}\1\5
\\{report}(\.{"You\ can\ catch\ the\ b}\)\.{ird,\ but\ you\ cannot\ }\)\.{carry%
\ it."});\2\6
\4${}\}{}$\2\par
\U112.\fi

\M[3089 advent.w]{115}Similarly, when dropping the bottle we must drop also its
liquid contents,
if any.

\Y\B\4\X115:Check special cases for dropping a liquid\X${}\E{}$\6
\&{if} (\\{object\_in\_bottle})\1\5
${}\\{obj}\K\.{BOTTLE};{}$\2\6
\&{if} ${}(\\{obj}\E\.{BOTTLE}\W\R\\{bottle\_empty}){}$\1\5
${}\\{place}[\\{prop}[\.{BOTTLE}]\?\.{OIL}:\.{WATER}]\K\\{limbo}{}$;\2\par
\U117.\fi

\N[3097 advent.w]{1}{116}The other actions. Now that we understand how to write
action routines,
we're ready to complete the set.

\fi

\M[3100 advent.w]{117}Dropping an object has special cases for the bird (which
might attack
the snake or the dragon), the cage, the vase, etc. The verb \PB{\.{THROW}} also
reduces to \PB{\.{DROP}} for most objects.

(The term \PB{\.{PONY}} is a nod to the vending machine once installed in a
room
called The Prancing Pony, part of Stanford's historic AI Laboratory.)

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{DROP}:\5
\&{if} ${}(\\{obj}\E\.{ROD}\W\\{toting}(\.{ROD2})\W\R\\{toting}(\.{ROD})){}$\1\5
${}\\{obj}\K\.{ROD2};{}$\2\6
\&{if} ${}(\R\\{toting}(\\{obj})){}$\1\5
\&{goto} \\{report\_default};\2\6
\&{if} ${}(\\{obj}\E\.{COINS}\W\\{here}(\.{PONY})){}$\1\5
\X118:Put coins in the vending machine\X;\2\6
\&{if} ${}(\\{obj}\E\.{BIRD}){}$\1\5
\X120:Check special cases for dropping the bird\X;\2\6
\&{if} ${}(\\{obj}\E\.{VASE}\W\\{loc}\I\\{soft}){}$\1\5
\X121:Check special cases for dropping the vase\X;\2\6
\&{if} ${}(\\{obj}\E\.{BEAR}\W\\{is\_at\_loc}(\.{TROLL})){}$\1\5
\X119:Chase the troll away\X;\2\6
\X115:Check special cases for dropping a liquid\X;\6
\&{if} ${}(\\{obj}\E\.{BIRD}){}$\1\5
${}\\{prop}[\.{BIRD}]\K\T{0};{}$\2\6
\&{else} \&{if} ${}(\\{obj}\E\.{CAGE}\W\\{prop}[\.{BIRD}]){}$\1\5
${}\\{drop}(\.{BIRD},\39\\{loc});{}$\2\6
${}\\{drop}(\\{obj},\39\\{loc});{}$\6
\&{if} (\|k)\1\5
\&{continue};\5
\2\&{else}\1\5
\\{default\_to}(\.{RELAX});\2\par
\fi

\M[3120 advent.w]{118}\B\X118:Put coins in the vending machine\X${}\E{}$\6
${}\{{}$\1\6
\\{destroy}(\.{COINS});\6
${}\\{drop}(\.{BATTERIES},\39\\{loc});{}$\6
${}\\{prop}[\.{BATTERIES}]\K\T{0};{}$\6
\\{report}(\\{note}[\\{offset}[\.{BATTERIES}]]);\6
\4${}\}{}$\2\par
\U117.\fi

\M[3128 advent.w]{119}\PB{\.{TROLL2}} is the absent troll. We move the troll
bridge up to first in
the list of things at its location.

\Y\B\4\X119:Chase the troll away\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"The\ bear\ lumbers\ to}\)\.{ward\ the\ troll,\ who\ }\)\.{lets\
out\ a\ startled\ }\)\.{shriek\ and\\nscurries}\)\.{\ away.\ \ The\ bear\ soo}%
\)\.{n\ gives\ up\ the\ pursu}\)\.{it\ and\ wanders\ back.}\)\.{\\n"});\6
${}\|k\K\T{1}{}$;\C{ suppress the ``OK'' message }\6
\\{destroy}(\.{TROLL});\5
\\{destroy}(\.{TROLL\_});\6
${}\\{drop}(\.{TROLL2},\39\\{swside}){}$;\5
${}\\{drop}(\.{TROLL2\_},\39\\{neside});{}$\6
${}\\{prop}[\.{TROLL}]\K\T{2};{}$\6
${}\\{move}(\.{BRIDGE},\39\\{swside}){}$;\5
${}\\{move}(\.{BRIDGE\_},\39\\{neside}){}$;\C{ put first in their lists }\6
\4${}\}{}$\2\par
\U117.\fi

\M[3143 advent.w]{120}\B\X120:Check special cases for dropping the bird\X${}%
\E{}$\6
${}\{{}$\1\6
\&{if} (\\{here}(\.{SNAKE}))\5
${}\{{}$\1\6
\\{printf}(\.{"The\ little\ bird\ att}\)\.{acks\ the\ green\ snake}\)\.{,\ and\
in\ an\ astoundi}\)\.{ng\ flurry\\ndrives\ th}\)\.{e\ snake\ away.\\n"});\5
${}\|k\K\T{1};{}$\6
\&{if} (\\{closed})\1\5
\&{goto} \\{dwarves\_upset};\2\6
\\{destroy}(\.{SNAKE});\6
${}\\{prop}[\.{SNAKE}]\K\T{1}{}$;\C{ used in conditional instructions }\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{is\_at\_loc}(\.{DRAGON})\W\\{prop}[\.{DRAGON}]\E%
\T{0}){}$\5
${}\{{}$\1\6
\\{destroy}(\.{BIRD});\5
${}\\{prop}[\.{BIRD}]\K\T{0};{}$\6
\&{if} ${}(\\{place}[\.{SNAKE}]\E\\{hmk}){}$\1\5
${}\\{lost\_treasures}\PP;{}$\2\6
\\{report}(\.{"The\ little\ bird\ att}\)\.{acks\ the\ green\ drago}\)\.{n,\ and%
\ in\ an\ astound}\)\.{ing\ flurry\\ngets\ bur}\)\.{nt\ to\ a\ cinder.\ \ The}%
\)\.{\ ashes\ blow\ away."});\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U117.\fi

\M[3161 advent.w]{121}\B\X121:Check special cases for dropping the vase\X${}%
\E{}$\6
${}\{{}$\1\6
${}\\{prop}[\.{VASE}]\K(\\{place}[\.{PILLOW}]\E\\{loc}\?\T{0}:\T{2});{}$\6
${}\\{printf}(\.{"\%s\\n"},\39\\{note}[\\{offset}[\.{VASE}]+\T{1}+\\{prop}[%
\.{VASE}]]){}$;\5
${}\|k\K\T{1};{}$\6
\&{if} (\\{prop}[\.{VASE}])\1\5
${}\\{base}[\.{VASE}]\K\.{VASE};{}$\2\6
\4${}\}{}$\2\par
\U117.\fi

\M[3168 advent.w]{122}Throwing is like dropping, except that it covers a few
more cases.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{TOSS}:\5
\&{if} ${}(\\{obj}\E\.{ROD}\W\\{toting}(\.{ROD2})\W\R\\{toting}(\.{ROD})){}$\1\5
${}\\{obj}\K\.{ROD2};{}$\2\6
\&{if} ${}(\R\\{toting}(\\{obj})){}$\1\5
\&{goto} \\{report\_default};\2\6
\&{if} ${}(\\{is\_treasure}(\\{obj})\W\\{is\_at\_loc}(\.{TROLL})){}$\1\5
\X124:Snarf a treasure for the troll\X;\2\6
\&{if} ${}(\\{obj}\E\.{FOOD}\W\\{here}(\.{BEAR})){}$\5
${}\{{}$\1\6
${}\\{obj}\K\.{BEAR}{}$;\5
\\{change\_to}(\.{FEED});\6
\4${}\}{}$\2\6
\&{if} ${}(\\{obj}\I\.{AXE}){}$\1\5
\\{change\_to}(\.{DROP});\2\6
\&{if} (\\{dwarf}(\,))\1\5
\X163:Throw the axe at a dwarf\X;\2\6
\&{if} ${}(\\{is\_at\_loc}(\.{DRAGON})\W\\{prop}[\.{DRAGON}]\E\T{0}){}$\1\5
\\{printf}(\.{"The\ axe\ bounces\ har}\)\.{mlessly\ off\ the\ drag}\)\.{on's\
thick\ scales.\\n}\)\.{"});\2\6
\&{else} \&{if} (\\{is\_at\_loc}(\.{TROLL}))\1\5
\\{printf}(\.{"The\ troll\ deftly\ ca}\)\.{tches\ the\ axe,\ exami}\)\.{nes\ it%
\ carefully,\ an}\)\.{d\ tosses\ it\\nback,\ d}\)\.{eclaring,\ \\"Good\ wor}\)%
\.{kmanship,\ but\ it's\ n}\)\.{ot\ valuable\ enough.\\}\)\.{"\\n"});\2\6
\&{else} \&{if} ${}(\\{here}(\.{BEAR})\W\\{prop}[\.{BEAR}]\E\T{0}){}$\1\5
\X123:Throw the axe at the bear\X\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{obj}\K\.{NOTHING};{}$\6
\\{change\_to}(\.{KILL});\6
\4${}\}{}$\2\6
${}\\{drop}(\.{AXE},\39\\{loc}){}$;\5
\\{stay\_put};\par
\fi

\M[3191 advent.w]{123}This'll teach you a lesson.

\Y\B\4\X123:Throw the axe at the bear\X${}\E{}$\6
${}\{{}$\1\6
${}\\{drop}(\.{AXE},\39\\{loc});{}$\6
${}\\{prop}[\.{AXE}]\K\T{1}{}$;\5
${}\\{base}[\.{AXE}]\K\.{AXE}{}$;\C{ it becomes immovable }\6
\&{if} ${}(\\{place}[\.{BEAR}]\E\\{loc}){}$\1\5
${}\\{move}(\.{BEAR},\39\\{loc}){}$;\C{ put bear first in its list }\2\6
\\{report}(\.{"The\ axe\ misses\ and\ }\)\.{lands\ near\ the\ bear\ }\)\.{where%
\ you\ can't\ get\ }\)\.{at\ it."});\6
\4${}\}{}$\2\par
\U122.\fi

\M[3201 advent.w]{124}If you toss the vase, the skillful troll will catch it
before it breaks.

\Y\B\4\X124:Snarf a treasure for the troll\X${}\E{}$\6
${}\{{}$\1\6
${}\\{drop}(\\{obj},\39\\{limbo});{}$\6
\\{destroy}(\.{TROLL});\5
\\{destroy}(\.{TROLL\_});\6
${}\\{drop}(\.{TROLL2},\39\\{swside}){}$;\5
${}\\{drop}(\.{TROLL2\_},\39\\{neside});{}$\6
${}\\{move}(\.{BRIDGE},\39\\{swside}){}$;\5
${}\\{move}(\.{BRIDGE\_},\39\\{neside});{}$\6
\\{report}(\.{"The\ troll\ catches\ y}\)\.{our\ treasure\ and\ scu}\)\.{rries\
away\ out\ of\ si}\)\.{ght."});\6
\4${}\}{}$\2\par
\U122.\fi

\M[3212 advent.w]{125}When you try to attack, the action becomes violent.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{KILL}:\5
\&{if} ${}(\\{obj}\E\.{NOTHING}){}$\1\5
\X126:See if there's a unique object to attack\X;\2\6
\&{switch} (\\{obj})\5
${}\{{}$\1\6
\4\&{case} \T{0}:\5
\\{report}(\.{"There\ is\ nothing\ he}\)\.{re\ to\ attack."});\6
\4\&{case} \.{BIRD}:\5
\X127:Dispatch the poor bird\X;\6
\4\&{case} \.{DRAGON}:\5
\&{if} ${}(\\{prop}[\.{DRAGON}]\E\T{0}){}$\1\5
\X128:Fun stuff for dragon\X;\2\6
\4\\{cry}:\5
\\{report}(\.{"For\ crying\ out\ loud}\)\.{,\ the\ poor\ thing\ is\ }\)%
\.{already\ dead!"});\6
\4\&{case} \.{CLAM}:\5
\&{case} \.{OYSTER}:\5
\\{report}(\.{"The\ shell\ is\ very\ s}\)\.{trong\ and\ impervious}\)\.{\ to\
attack."});\6
\4\&{case} \.{SNAKE}:\5
\\{report}(\.{"Attacking\ the\ snake}\)\.{\ both\ doesn't\ work\ a}\)\.{nd\ is\
very\ dangerous}\)\.{."});\6
\4\&{case} \.{DWARF}:\5
\&{if} (\\{closed})\1\5
\&{goto} \\{dwarves\_upset};\2\6
\\{report}(\.{"With\ what?\ \ Your\ ba}\)\.{re\ hands?"});\6
\4\&{case} \.{TROLL}:\5
\\{report}(\.{"Trolls\ are\ close\ re}\)\.{latives\ with\ the\ roc}\)\.{ks\ and%
\ have\ skin\ as\ }\)\.{tough\ as\\na\ rhinocer}\)\.{os\ hide.\ \ The\ troll\ }%
\)\.{fends\ off\ your\ blows}\)\.{\ effortlessly."});\6
\4\&{case} \.{BEAR}:\5
\&{switch} (\\{prop}[\.{BEAR}])\5
${}\{{}$\1\6
\4\&{case} \T{0}:\5
\\{report}(\.{"With\ what?\ \ Your\ ba}\)\.{re\ hands?\ \ Against\ H}\)\.{IS\
bear\ hands?"});\6
\4\&{case} \T{3}:\5
\&{goto} \\{cry};\6
\4\&{default}:\5
\\{report}(\.{"The\ bear\ is\ confuse}\)\.{d;\ he\ only\ wants\ to\ }\)\.{be\
your\ friend."});\6
\4${}\}{}$\2\6
\4\&{default}:\5
\&{goto} \\{report\_default};\6
\4${}\}{}$\2\par
\fi

\M[3238 advent.w]{126}Attackable objects fall into two categories: enemies
(snake, dwarf, etc.)\
and others (bird, clam).

We might get here when you threw an axe; you can't attack the bird with an axe.

\Y\B\4\X126:See if there's a unique object to attack\X${}\E{}$\6
${}\{{}$\1\6
\&{if} (\\{dwarf}(\,))\1\5
${}\|k\PP,\39\\{obj}\K\.{DWARF};{}$\2\6
\&{if} (\\{here}(\.{SNAKE}))\1\5
${}\|k\PP,\39\\{obj}\K\.{SNAKE};{}$\2\6
\&{if} ${}(\\{is\_at\_loc}(\.{DRAGON})\W\\{prop}[\.{DRAGON}]\E\T{0}){}$\1\5
${}\|k\PP,\39\\{obj}\K\.{DRAGON};{}$\2\6
\&{if} (\\{is\_at\_loc}(\.{TROLL}))\1\5
${}\|k\PP,\39\\{obj}\K\.{TROLL};{}$\2\6
\&{if} ${}(\\{here}(\.{BEAR})\W\\{prop}[\.{BEAR}]\E\T{0}){}$\1\5
${}\|k\PP,\39\\{obj}\K\.{BEAR};{}$\2\6
\&{if} ${}(\|k\E\T{0}){}$\5
${}\{{}$\C{ no enemies present }\1\6
\&{if} ${}(\\{here}(\.{BIRD})\W\\{oldverb}\I\.{TOSS}){}$\1\5
${}\|k\PP,\39\\{obj}\K\.{BIRD};{}$\2\6
\&{if} ${}(\\{here}(\.{CLAM})\V\\{here}(\.{OYSTER})){}$\1\5
${}\|k\PP,\39\\{obj}\K\.{CLAM}{}$;\C{ no harm done to call the oyster a clam in
this case }\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|k>\T{1}){}$\1\5
\&{goto} \\{get\_object};\2\6
\4${}\}{}$\2\par
\U125.\fi

\M[3258 advent.w]{127}\B\X127:Dispatch the poor bird\X${}\E{}$\6
${}\{{}$\1\6
\&{if} (\\{closed})\1\5
\\{report}(\.{"Oh,\ leave\ the\ poor\ }\)\.{unhappy\ bird\ alone."});\2\6
\\{destroy}(\.{BIRD});\5
${}\\{prop}[\.{BIRD}]\K\T{0};{}$\6
\&{if} ${}(\\{place}[\.{SNAKE}]\E\\{hmk}){}$\1\5
${}\\{lost\_treasures}\PP;{}$\2\6
\\{report}(\.{"The\ little\ bird\ is\ }\)\.{now\ dead.\ \ Its\ body\ }\)%
\.{disappears."});\6
\4${}\}{}$\2\par
\U125.\fi

\M[3266 advent.w]{128}Here we impersonate the main dialog loop.
If you insist on attacking the dragon, you win! He dies, the Persian
rug becomes free, and \PB{\\{scan2}} takes the place of \PB{\\{scan1}} and \PB{%
\\{scan3}}.

\Y\B\4\X128:Fun stuff for dragon\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"With\ what?\ \ Your\ ba}\)\.{re\ hands?\\n"});\6
${}\\{verb}\K\.{ABSTAIN}{}$;\5
${}\\{obj}\K\.{NOTHING};{}$\6
\\{listen}(\,);\6
\&{if} ${}(\R(\\{streq}(\\{word1},\39\.{"yes"})\V\\{streq}(\\{word1},\39%
\.{"y"}))){}$\1\5
\&{goto} \\{pre\_parse};\2\6
${}\\{printf}(\.{"\%s\\n"},\39\\{note}[\\{offset}[\.{DRAGON}]+\T{1}]);{}$\6
${}\\{prop}[\.{DRAGON}]\K\T{2}{}$;\C{ dead }\6
${}\\{prop}[\.{RUG}]\K\T{0}{}$;\5
${}\\{base}[\.{RUG}]\K\.{NOTHING}{}$;\C{ now it's a usable treasure }\6
${}\\{base}[\.{DRAGON\_}]\K\.{DRAGON\_};{}$\6
\\{destroy}(\.{DRAGON\_});\C{ inaccessible }\6
${}\\{base}[\.{RUG\_}]\K\.{RUG\_};{}$\6
\\{destroy}(\.{RUG\_});\C{ inaccessible }\6
\&{for} ${}(\|t\K\T{1};{}$ ${}\|t\Z\\{max\_obj};{}$ ${}\|t\PP){}$\1\6
\&{if} ${}(\\{place}[\|t]\E\\{scan1}\V\\{place}[\|t]\E\\{scan3}){}$\1\5
${}\\{move}(\|t,\39\\{scan2});{}$\2\2\6
${}\\{loc}\K\\{scan2}{}$;\5
\\{stay\_put};\6
\4${}\}{}$\2\par
\U125.\fi

\M[3286 advent.w]{129}Feeding various animals leads to various quips. Feeding a
dwarf
is a bad idea. The bear is special.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{FEED}:\5
\&{switch} (\\{obj})\5
${}\{{}$\1\6
\4\&{case} \.{BIRD}:\5
\\{report}(\.{"It's\ not\ hungry\ (it}\)\.{'s\ merely\ pinin'\ for}\)\.{\ the\
fjords).\ \ Besid}\)\.{es,\ you\\nhave\ no\ bir}\)\.{d\ seed."});\6
\4\&{case} \.{TROLL}:\5
\\{report}(\.{"Gluttony\ is\ not\ one}\)\.{\ of\ the\ troll's\ vice}\)\.{s.\ \
Avarice,\ however}\)\.{,\ is."});\6
\4\&{case} \.{DRAGON}:\5
\&{if} (\\{prop}[\.{DRAGON}])\1\5
\\{report}(\\{default\_msg}[\.{EAT}]);\2\6
\&{break};\6
\4\&{case} \.{SNAKE}:\5
\&{if} ${}(\\{closed}\V\R\\{here}(\.{BIRD})){}$\1\5
\&{break};\2\6
\\{destroy}(\.{BIRD});\5
${}\\{prop}[\.{BIRD}]\K\T{0}{}$;\5
${}\\{lost\_treasures}\PP;{}$\6
\\{report}(\.{"The\ snake\ has\ now\ d}\)\.{evoured\ your\ bird."});\6
\4\&{case} \.{BEAR}:\5
\&{if} ${}(\R\\{here}(\.{FOOD})){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{prop}[\.{BEAR}]\E\T{0}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{prop}[\.{BEAR}]\E\T{3}){}$\1\5
\\{change\_to}(\.{EAT});\2\6
\&{goto} \\{report\_default};\6
\4${}\}{}$\2\6
\\{destroy}(\.{FOOD});\5
${}\\{prop}[\.{BEAR}]\K\T{1};{}$\6
${}\\{prop}[\.{AXE}]\K\T{0}{}$;\5
${}\\{base}[\.{AXE}]\K\.{NOTHING}{}$;\C{ axe is movable again }\6
\\{report}(\.{"The\ bear\ eagerly\ wo}\)\.{lfs\ down\ your\ food,\ }\)\.{after\
which\ he\ seems}\)\.{\ to\ calm\\ndown\ consi}\)\.{derably\ and\ even\ bec}\)%
\.{omes\ rather\ friendly}\)\.{."});\6
\4\&{case} \.{DWARF}:\5
\&{if} ${}(\R\\{here}(\.{FOOD})){}$\1\5
\&{goto} \\{report\_default};\2\6
${}\\{dflag}\PP;{}$\6
\\{report}(\.{"You\ fool,\ dwarves\ e}\)\.{at\ only\ coal!\ \ Now\ y}\)\.{ou've%
\ made\ him\ REALL}\)\.{Y\ mad!"});\6
\4\&{default}:\5
\\{report}(\\{default\_msg}[\.{CALM}]);\6
\4${}\}{}$\2\6
\\{report}(\.{"There's\ nothing\ her}\)\.{e\ it\ wants\ to\ eat\ (e}\)\.{xcept\
perhaps\ you)."});\par
\fi

\M[3318 advent.w]{130}Locking and unlocking involves several interesting
special cases.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{OPEN}:\5
\&{case} \.{CLOSE}:\5
\&{switch} (\\{obj})\5
${}\{{}$\1\6
\4\&{case} \.{OYSTER}:\5
${}\|k\K\T{1};{}$\6
\4\&{case} \.{CLAM}:\5
\X134:Open/close clam/oyster\X;\6
\4\&{case} \.{GRATE}:\5
\&{case} \.{CHAIN}:\5
\&{if} ${}(\R\\{here}(\.{KEYS})){}$\1\5
\\{report}(\.{"You\ have\ no\ keys!"});\2\6
\X131:Open/close grate/chain\X;\6
\4\&{case} \.{KEYS}:\5
\\{report}(\.{"You\ can't\ lock\ or\ u}\)\.{nlock\ the\ keys."});\6
\4\&{case} \.{CAGE}:\5
\\{report}(\.{"It\ has\ no\ lock."});\6
\4\&{case} \.{DOOR}:\5
\&{if} (\\{prop}[\.{DOOR}])\1\5
\\{default\_to}(\.{RELAX});\2\6
\\{report}(\.{"The\ door\ is\ extreme}\)\.{ly\ rusty\ and\ refuses}\)\.{\ to\
open."});\6
\4\&{default}:\5
\&{goto} \\{report\_default};\6
\4${}\}{}$\2\par
\fi

\M[3334 advent.w]{131}\B\X131:Open/close grate/chain\X${}\E{}$\6
\&{if} ${}(\\{obj}\E\.{CHAIN}){}$\1\5
\X132:Open/close chain\X;\2\6
\&{if} (\\{closing})\5
${}\{{}$\1\6
\X180:Panic at closing time\X;\5
\&{continue};\6
\4${}\}{}$\2\6
${}\|k\K\\{prop}[\.{GRATE}];{}$\6
${}\\{prop}[\.{GRATE}]\K(\\{verb}\E\.{OPEN});{}$\6
\&{switch} ${}(\|k+\T{2}*\\{prop}[\.{GRATE}]){}$\5
${}\{{}$\1\6
\4\&{case} \T{0}:\5
\\{report}(\.{"It\ was\ already\ lock}\)\.{ed."});\6
\4\&{case} \T{1}:\5
\\{report}(\.{"The\ grate\ is\ now\ lo}\)\.{cked."});\6
\4\&{case} \T{2}:\5
\\{report}(\.{"The\ grate\ is\ now\ un}\)\.{locked."});\6
\4\&{case} \T{3}:\5
\\{report}(\.{"It\ was\ already\ unlo}\)\.{cked."});\6
\4${}\}{}$\2\par
\U130.\fi

\M[3348 advent.w]{132}\B\X132:Open/close chain\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{verb}\E\.{OPEN}){}$\1\5
\X133:Open chain\X;\2\6
\&{if} ${}(\\{loc}\I\\{barr}){}$\1\5
\\{report}(\.{"There\ is\ nothing\ he}\)\.{re\ to\ which\ the\ chai}\)\.{n\ can%
\ be\ locked."});\2\6
\&{if} (\\{prop}[\.{CHAIN}])\1\5
\\{report}(\.{"It\ was\ already\ lock}\)\.{ed."});\2\6
${}\\{prop}[\.{CHAIN}]\K\T{2},\39\\{base}[\.{CHAIN}]\K\.{CHAIN};{}$\6
\&{if} (\\{toting}(\.{CHAIN}))\1\5
${}\\{drop}(\.{CHAIN},\39\\{loc});{}$\2\6
\\{report}(\.{"The\ chain\ is\ now\ lo}\)\.{cked."});\6
\4${}\}{}$\2\par
\U131.\fi

\M[3359 advent.w]{133}\B\X133:Open chain\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{prop}[\.{CHAIN}]\E\T{0}){}$\1\5
\\{report}(\.{"It\ was\ already\ unlo}\)\.{cked."});\2\6
\&{if} ${}(\\{prop}[\.{BEAR}]\E\T{0}){}$\1\5
\\{report}(\.{"There\ is\ no\ way\ to\ }\)\.{get\ past\ the\ bear\ to}\)\.{\
unlock\ the\ chain,\ w}\)\.{hich\ is\\nprobably\ ju}\)\.{st\ as\ well."});\2\6
${}\\{prop}[\.{CHAIN}]\K\T{0},\39\\{base}[\.{CHAIN}]\K\.{NOTHING}{}$;\C{ chain
is free }\6
\&{if} ${}(\\{prop}[\.{BEAR}]\E\T{3}){}$\1\5
${}\\{base}[\.{BEAR}]\K\.{BEAR};{}$\2\6
\&{else}\1\5
${}\\{prop}[\.{BEAR}]\K\T{2},\39\\{base}[\.{BEAR}]\K\.{NOTHING};{}$\2\6
\\{report}(\.{"The\ chain\ is\ now\ un}\)\.{locked."});\6
\4${}\}{}$\2\par
\U132.\fi

\M[3371 advent.w]{134}The clam/oyster is extremely heavy to carry, although not
as heavy as the
gold.

\Y\B\4\D$\\{clam\_oyster}$ \5
$(\\{obj}\E\.{CLAM}\?\.{"clam"}:\.{"oyster"}{}$)\par
\Y\B\4\X134:Open/close clam/oyster\X${}\E{}$\6
\&{if} ${}(\\{verb}\E\.{CLOSE}){}$\1\5
\\{report}(\.{"What?"});\2\6
\&{if} ${}(\R\\{toting}(\.{TRIDENT})){}$\5
${}\{{}$\1\6
${}\\{printf}(\.{"You\ don't\ have\ anyt}\)\.{hing\ strong\ enough\ t}\)\.{o\
open\ the\ \%s"},\39\\{clam\_oyster});{}$\6
\\{report}(\.{"."});\6
\4${}\}{}$\2\6
\&{if} (\\{toting}(\\{obj}))\5
${}\{{}$\1\6
${}\\{printf}(\.{"I\ advise\ you\ to\ put}\)\.{\ down\ the\ \%s\ before\ }\)%
\.{opening\ it.\ \ "},\39\\{clam\_oyster});{}$\6
${}\\{report}(\\{obj}\E\.{CLAM}\?\.{">STRAIN!<"}:\.{">WRENCH!<"});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\\{obj}\E\.{CLAM}){}$\5
${}\{{}$\1\6
\\{destroy}(\.{CLAM});\5
${}\\{drop}(\.{OYSTER},\39\\{loc}){}$;\5
${}\\{drop}(\.{PEARL},\39\\{sac});{}$\6
\\{report}(\.{"A\ glistening\ pearl\ }\)\.{falls\ out\ of\ the\ cla}\)\.{m\ and%
\ rolls\ away.\ \ G}\)\.{oodness,\\nthis\ must\ }\)\.{really\ be\ an\ oyster.}%
\)\.{\ \ (I\ never\ was\ very\ }\)\.{good\ at\ identifying\\}\)\.{nbivalves.)\ %
\ Whateve}\)\.{r\ it\ is,\ it\ has\ now\ }\)\.{snapped\ shut\ again."});\6
\4${}\}{}$\5
\2\&{else}\1\5
\\{report}(\.{"The\ oyster\ creaks\ o}\)\.{pen,\ revealing\ nothi}\)\.{ng\ but\
oyster\ inside}\)\.{.\\nIt\ promptly\ snaps}\)\.{\ shut\ again."});\2\par
\U130.\fi

\M[3394 advent.w]{135}You get little satisfaction from asking us to read,
unless you hold
the oyster---{\it after\/} the cave is closed.

\Y\B\4\X97:Handle cases of transitive verbs and \PB{\&{continue}}\X${}\mathrel+%
\E{}$\6
\4\&{case} \.{READ}:\5
\&{if} (\\{dark})\1\5
\&{goto} \\{cant\_see\_it};\2\6
\&{switch} (\\{obj})\5
${}\{{}$\1\6
\4\&{case} \.{MAG}:\5
\\{report}(\.{"I'm\ afraid\ the\ maga}\)\.{zine\ is\ written\ in\ d}\)%
\.{warvish."});\6
\4\&{case} \.{TABLET}:\5
\\{report}(\.{"\\"CONGRATULATIONS\ O}\)\.{N\ BRINGING\ LIGHT\ INT}\)\.{O\ THE\
DARK-ROOM!\\""});\6
\4\&{case} \.{MESSAGE}:\5
\\{report}(\.{"\\"This\ is\ not\ the\ m}\)\.{aze\ where\ the\ pirate}\)\.{\
hides\ his\ treasure\ }\)\.{chest.\\""});\6
\4\&{case} \.{OYSTER}:\5
\&{if} (\\{hinted}[\T{1}])\5
${}\{{}$\1\6
\&{if} (\\{toting}(\.{OYSTER}))\1\5
\\{report}(\.{"It\ says\ the\ same\ th}\)\.{ing\ it\ did\ before."});\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{closed}\W\\{toting}(\.{OYSTER})){}$\5
${}\{{}$\1\6
\\{offer}(\T{1});\5
\&{continue};\6
\4${}\}{}$\2\6
\4\&{default}:\5
\&{goto} \\{report\_default};\6
\4${}\}{}$\2\par
\fi

\M[3413 advent.w]{136}OK, that just about does it. We're left with only one
more ``action verb'' to
handle, and it is intransitive. In order to penetrate this puzzle, you must
pronounce the magic incantation in its correct order, as it appears on the
wall of the Giant Room. A global variable \PB{\\{foobar}} records your
progress.

\Y\B\4\X92:Handle cases of intransitive verbs and \PB{\&{continue}}\X${}%
\mathrel+\E{}$\6
\4\&{case} \.{FEEFIE}:\5
\&{while} ${}(\R\\{streq}(\\{word1},\39\\{incantation}[\|k])){}$\1\5
${}\|k\PP;{}$\2\6
\&{if} ${}(\\{foobar}\E{-}\|k){}$\1\5
\X139:Proceed foobarically\X;\2\6
\&{if} ${}(\\{foobar}\E\T{0}){}$\1\5
\&{goto} \\{nada\_sucede};\2\6
\\{report}(\.{"What's\ the\ matter,\ }\)\.{can't\ you\ read?\ \ Now}\)\.{\
you'd\ best\ start\ ov}\)\.{er."});\par
\fi

\M[3424 advent.w]{137}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{incantation}[\,]\K\{\.{"fee"},\39\.{"fie"},\39\.{"foe"},\39%
\.{"foo"},\39\.{"fum"}\};{}$\6
\&{int} \\{foobar};\C{ current incantation progress }\par
\fi

\M[3428 advent.w]{138}Just after every command you give, we make the \PB{%
\\{foobar}} counter negative if
you're on track, otherwise we zero it.

\Y\B\4\X82:Handle special cases of input\X${}\mathrel+\E{}$\6
\&{if} ${}(\\{foobar}>\T{0}){}$\1\5
${}\\{foobar}\K{-}\\{foobar};{}$\2\6
\&{else}\1\5
${}\\{foobar}\K\T{0}{}$;\2\par
\fi

\M[3435 advent.w]{139}If you get all the way through, we zip the eggs back to
the Giant Room,
unless they're already there.
The troll returns if you've stolen the eggs back from him.

\Y\B\4\X139:Proceed foobarically\X${}\E{}$\6
${}\{{}$\1\6
${}\\{foobar}\K\|k+\T{1};{}$\6
\&{if} ${}(\\{foobar}\I\T{4}){}$\1\5
\\{default\_to}(\.{RELAX});\2\6
${}\\{foobar}\K\T{0};{}$\6
\&{if} ${}(\\{place}[\.{EGGS}]\E\\{giant}\V(\\{toting}(\.{EGGS})\W\\{loc}\E%
\\{giant})){}$\1\6
\4\\{nada\_sucede}:\5
\\{report}(\\{default\_msg}[\.{WAVE}]);\2\6
\&{if} ${}(\\{place}[\.{EGGS}]\E\\{limbo}\W\\{place}[\.{TROLL}]\E\\{limbo}\W%
\\{prop}[\.{TROLL}]\E\T{0}){}$\1\5
${}\\{prop}[\.{TROLL}]\K\T{1};{}$\2\6
${}\|k\K(\\{loc}\E\\{giant}\?\T{0}:\\{here}(\.{EGGS})\?\T{1}:\T{2});{}$\6
${}\\{move}(\.{EGGS},\39\\{giant});{}$\6
${}\\{report}(\\{note}[\\{offset}[\.{EGGS}]+\|k]);{}$\6
\4${}\}{}$\2\par
\U136.\fi

\N[3453 advent.w]{1}{140}Motions. A major cycle comes to an end when a motion
verb \PB{\\{mot}} has
been given and we have computed the appropriate \PB{\\{newloc}} accordingly.

First, we deal with motions that don't refer directly to the travel table.

\Y\B\4\X140:Handle special motion words\X${}\E{}$\6
$\\{newloc}\K\\{loc}{}$;\C{ by default we will stay put }\6
\&{if} ${}(\\{mot}\E\.{NOWHERE}){}$\1\5
\&{continue};\2\6
\&{if} ${}(\\{mot}\E\.{BACK}){}$\1\5
\X143:Try to go back\X;\2\6
\&{if} ${}(\\{mot}\E\.{LOOK}){}$\1\5
\X141:Repeat the long description and \PB{\&{continue}}\X;\2\6
\&{if} ${}(\\{mot}\E\.{CAVE}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{loc}<\\{min\_in\_cave}){}$\1\5
\\{printf}(\.{"I\ can't\ see\ where\ t}\)\.{he\ cave\ is,\ but\ here}\)%
\.{abouts\ no\ stream\ can}\)\.{\ run\ on\\nthe\ surface}\)\.{\ for\ long.\ \ I%
\ would\ }\)\.{try\ the\ stream.\\n"});\2\6
\&{else}\1\5
\\{printf}(\.{"I\ need\ more\ detaile}\)\.{d\ instructions\ to\ do}\)\.{\ that.%
\\n"});\2\6
\&{continue};\6
\4${}\}{}$\2\par
\U75.\fi

\M[3471 advent.w]{141}When looking around, we pretend that it wasn't dark
(though it may {\it
now\/} be dark), so you won't fall into a pit while staring into the gloom.

\Y\B\4\X141:Repeat the long description and \PB{\&{continue}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\PP\\{look\_count}\Z\T{3}){}$\1\5
\\{printf}(\.{"Sorry,\ but\ I\ am\ not}\)\.{\ allowed\ to\ give\ mor}\)\.{e\
detail.\ \ I\ will\ re}\)\.{peat\ the\\nlong\ descr}\)\.{iption\ of\ your\
locat}\)\.{ion.\\n"});\2\6
${}\\{was\_dark}\K\\{false};{}$\6
${}\\{visits}[\\{loc}]\K\T{0};{}$\6
\&{continue};\6
\4${}\}{}$\2\par
\U140.\fi

\M[3484 advent.w]{142}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{look\_count};\C{ how many times you've asked us to look }\par
\fi

\M[3487 advent.w]{143}If you ask us to go back, we look for a motion that goes
from \PB{\\{loc}}
to \PB{\\{oldloc}}, or to \PB{\\{oldoldloc}} if \PB{\\{oldloc}} has forced
motion.
Otherwise we can't take you back.

\Y\B\4\X143:Try to go back\X${}\E{}$\6
${}\{{}$\1\6
${}\|l\K(\\{forced\_move}(\\{oldloc})\?\\{oldoldloc}:\\{oldloc});{}$\6
${}\\{oldoldloc}\K\\{oldloc};{}$\6
${}\\{oldloc}\K\\{loc};{}$\6
\&{if} ${}(\|l\E\\{loc}){}$\1\5
\X145:Apologize for inability to backtrack\X;\2\6
\&{for} ${}(\|q\K\\{start}[\\{loc}],\39\\{qq}\K\NULL;{}$ ${}\|q<\\{start}[%
\\{loc}+\T{1}];{}$ ${}\|q\PP){}$\5
${}\{{}$\1\6
${}\\{ll}\K\|q\MG\\{dest};{}$\6
\&{if} ${}(\\{ll}\E\|l){}$\1\5
\&{goto} \\{found};\2\6
\&{if} ${}(\\{ll}\Z\\{max\_loc}\W\\{forced\_move}(\\{ll})\W\\{start}[\\{ll}]\MG%
\\{dest}\E\|l){}$\1\5
${}\\{qq}\K\|q;{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\\{qq}\E\NULL){}$\5
${}\{{}$\1\6
\\{printf}(\.{"You\ can't\ get\ there}\)\.{\ from\ here.\\n"});\5
\&{continue};\6
\4${}\}{}$\2\6
\&{else}\1\5
${}\|q\K\\{qq};{}$\2\6
\4\\{found}:\5
${}\\{mot}\K\|q\MG\\{mot};{}$\6
\&{goto} \\{go\_for\_it};\6
\4${}\}{}$\2\par
\U140.\fi

\M[3509 advent.w]{144}\B\X22:Additional local registers\X${}\mathrel+\E{}$\6
\&{register} \&{location} \|l${},{}$ \\{ll};\par
\fi

\M[3512 advent.w]{145}\B\X145:Apologize for inability to backtrack\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"Sorry,\ but\ I\ no\ lon}\)\.{ger\ seem\ to\ remember}\)\.{\ how\
you\ got\ here.\\n}\)\.{"});\6
\&{continue};\6
\4${}\}{}$\2\par
\U143.\fi

\M[3518 advent.w]{146}Now we are ready to interpret the instructions in the
travel table.
The following code implements the conventions of section~\instspecs.

\Y\B\4\X146:Determine the next location, \PB{\\{newloc}}\X${}\E{}$\6
\&{for} ${}(\|q\K\\{start}[\\{loc}];{}$ ${}\|q<\\{start}[\\{loc}+\T{1}];{}$ ${}%
\|q\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{forced\_move}(\\{loc})\V\|q\MG\\{mot}\E\\{mot}){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|q\E\\{start}[\\{loc}+\T{1}]){}$\1\5
\X148:Report on inapplicable motion and \PB{\&{continue}}\X;\2\6
\X147:If the condition of instruction \PB{\|q} isn't satisfied, advance \PB{%
\|q}\X;\6
${}\\{newloc}\K\|q\MG\\{dest};{}$\6
\&{if} ${}(\\{newloc}\Z\\{max\_loc}){}$\1\5
\&{continue};\2\6
\&{if} ${}(\\{newloc}>\\{max\_spec}){}$\5
${}\{{}$\1\6
${}\\{printf}(\.{"\%s\\n"},\39\\{remarks}[\\{newloc}-\\{max\_spec}]);{}$\6
\4\\{stay}:\5
${}\\{newloc}\K\\{loc}{}$;\5
\&{continue};\6
\4${}\}{}$\2\6
\&{switch} (\\{newloc})\5
${}\{{}$\1\6
\4\&{case} \\{ppass}:\5
\X149:Choose \PB{\\{newloc}} via plover-alcove passage\X;\6
\4\&{case} \\{pdrop}:\5
\X150:Drop the emerald during plover transportation\X;\5
\&{goto} \\{no\_good};\6
\4\&{case} \\{troll}:\5
\X151:Cross troll bridge if possible\X;\6
\4${}\}{}$\2\par
\Q19.
\U75.\fi

\M[3539 advent.w]{147}\B\X147:If the condition of instruction \PB{\|q} isn't
satisfied, advance \PB{\|q}\X${}\E{}$\6
\&{while} (\T{1})\5
${}\{{}$\1\6
${}\|j\K\|q\MG\\{cond};{}$\6
\&{if} ${}(\|j>\T{300}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{prop}[\|j\MOD\T{100}]\I(\&{int})((\|j-\T{300})/\T{100})){}$\1\5
\&{break};\2\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\|j\Z\T{100}){}$\5
${}\{{}$\1\6
\&{if} ${}(\|j\E\T{0}\V\\{pct}(\|j)){}$\1\5
\&{break};\2\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\\{toting}(\|j\MOD\T{100})\V(\|j\G\T{200}\W\\{is\_at%
\_loc}(\|j\MOD\T{100}))){}$\1\5
\&{break};\2\6
\4\\{no\_good}:\6
\&{for} ${}(\\{qq}\K\|q\PP{}$;\6
${}\|q\MG\\{dest}\E\\{qq}\MG\\{dest}\W\|q\MG\\{cond}\E\\{qq}\MG\\{cond}{}$;\6
${}\|q\PP){}$\1\5
;\2\6
\4${}\}{}$\2\par
\U146.\fi

\M[3552 advent.w]{148}Here we look at \PB{\\{verb}} just in case you asked us
to `\.{find} \.{gully}'
or something like that.

\Y\B\4\X148:Report on inapplicable motion and \PB{\&{continue}}\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{mot}\E\.{CRAWL}){}$\1\5
\\{printf}(\.{"Which\ way?"});\2\6
\&{else} \&{if} ${}(\\{mot}\E\.{XYZZY}\V\\{mot}\E\.{PLUGH}){}$\1\5
\\{printf}(\\{default\_msg}[\.{WAVE}]);\2\6
\&{else} \&{if} ${}(\\{verb}\E\.{FIND}\V\\{verb}\E\.{INVENTORY}){}$\1\5
\\{printf}(\\{default\_msg}[\.{FIND}]);\2\6
\&{else} \&{if} ${}(\\{mot}\Z\.{FORWARD}){}$\1\6
\&{switch} (\\{mot})\5
${}\{{}$\1\6
\4\&{case} \.{IN}:\5
\&{case} \.{OUT}:\5
\\{printf}(\.{"I\ don't\ know\ in\ fro}\)\.{m\ out\ here.\ \ Use\ com}\)\.{pass%
\ points\ or\ name\ }\)\.{something\\nin\ the\ ge}\)\.{neral\ direction\ you\ }%
\)\.{want\ to\ go."});\5
\&{break};\6
\4\&{case} \.{FORWARD}:\5
\&{case} \|L:\5
\&{case} \|R:\5
\\{printf}(\.{"I\ am\ unsure\ how\ you}\)\.{\ are\ facing.\ \ Use\ co}\)%
\.{mpass\ points\ or\ near}\)\.{by\ objects."});\5
\&{break};\6
\4\&{default}:\5
\\{printf}(\.{"There\ is\ no\ way\ to\ }\)\.{go\ in\ that\ direction}\)\.{."});%
\6
\4${}\}{}$\5
\2\2\&{else}\1\5
\\{printf}(\.{"I\ don't\ know\ how\ to}\)\.{\ apply\ that\ word\ her}\)%
\.{e."});\2\6
\\{printf}(\.{"\\n"});\5
\&{continue};\C{ \PB{$\\{newloc}\K\\{loc}$} }\6
\4${}\}{}$\2\par
\U146.\fi

\M[3571 advent.w]{149}Only the emerald can be toted through the plover-alcove
passage ---
not even the lamp.

\Y\B\4\X149:Choose \PB{\\{newloc}} via plover-alcove passage\X${}\E{}$\6
\&{if} ${}(\\{holding}\E\T{0}\V(\\{toting}(\.{EMERALD})\W\\{holding}\E%
\T{1})){}$\5
${}\{{}$\1\6
${}\\{newloc}\K\\{alcove}+\\{proom}-\\{loc}{}$;\5
\&{continue};\C{ move through the passage }\6
\4${}\}{}$\5
\2\&{else}\5
${}\{{}$\1\6
\\{printf}(\.{"Something\ you're\ ca}\)\.{rrying\ won't\ fit\ thr}\)\.{ough\
the\ tunnel\ with}\)\.{\ you.\\nYou'd\ best\ ta}\)\.{ke\ inventory\ and\ dro}\)%
\.{p\ something.\\n"});\6
\&{goto} \\{stay};\6
\4${}\}{}$\2\par
\U146.\fi

\M[3583 advent.w]{150}The \PB{\\{pdrop}} command applies only when you're
carrying the emerald. We make
you drop it, thereby forcing you to use the plover-alcove passage if
you want to get it out. We don't actually tell you that it was
dropped; we just pretend you weren't carrying it after all.

\Y\B\4\X150:Drop the emerald during plover transportation\X${}\E{}$\6
$\\{drop}(\.{EMERALD},\39\\{loc}){}$;\par
\U146.\fi

\M[3591 advent.w]{151}Troll bridge crossing is treated as a special motion so
that dwarves
won't wander across and encounter the bear.

You can get here only if \PB{\.{TROLL}} is in limbo but \PB{\.{TROLL2}} has
taken
its place. Moreover, if you're on the southwest side, \PB{\\{prop}[\.{TROLL}]}
will be nonzero. If \PB{\\{prop}[\.{TROLL}]} is~1, you've crossed since paying,
or you've stolen away the payment.
Special stuff involves the bear.

\Y\B\4\X151:Cross troll bridge if possible\X${}\E{}$\6
\&{if} ${}(\\{prop}[\.{TROLL}]\E\T{1}){}$\1\5
\X152:Block the troll bridge and stay put\X;\2\6
${}\\{newloc}\K\\{neside}+\\{swside}-\\{loc}{}$;\C{ cross it }\6
\&{if} ${}(\\{prop}[\.{TROLL}]\E\T{0}){}$\1\5
${}\\{prop}[\.{TROLL}]\K\T{1};{}$\2\6
\&{if} ${}(\R\\{toting}(\.{BEAR})){}$\1\5
\&{continue};\2\6
\\{printf}(\.{"Just\ as\ you\ reach\ t}\)\.{he\ other\ side,\ the\ b}\)\.{ridge%
\ buckles\ beneat}\)\.{h\ the\\nweight\ of\ the}\)\.{\ bear,\ who\ was\ still}%
\)\.{\ following\ you\ aroun}\)\.{d.\ \ You\\nscrabble\ de}\)\.{sperately\ for\
suppor}\)\.{t,\ but\ as\ the\ bridge}\)\.{\ collapses\ you\\nstum}\)\.{ble\
back\ and\ fall\ in}\)\.{to\ the\ chasm.\\n"});\6
${}\\{prop}[\.{BRIDGE}]\K\T{1}{}$;\5
${}\\{prop}[\.{TROLL}]\K\T{2};{}$\6
${}\\{drop}(\.{BEAR},\39\\{newloc}){}$;\5
${}\\{base}[\.{BEAR}]\K\.{BEAR}{}$;\5
${}\\{prop}[\.{BEAR}]\K\T{3}{}$;\C{ the bear is dead }\6
\&{if} ${}(\\{prop}[\.{SPICES}]<\T{0}\W\\{place}[\.{SPICES}]\G\\{neside}){}$\1\5
${}\\{lost\_treasures}\PP;{}$\2\6
\&{if} ${}(\\{prop}[\.{CHAIN}]<\T{0}\W\\{place}[\.{CHAIN}]\G\\{neside}){}$\1\5
${}\\{lost\_treasures}\PP;{}$\2\6
${}\\{oldoldloc}\K\\{newloc}{}$;\C{ if you are revived, you got across }\6
\&{goto} \\{death};\par
\U146.\fi

\M[3616 advent.w]{152}\B\X152:Block the troll bridge and stay put\X${}\E{}$\6
${}\{{}$\1\6
${}\\{move}(\.{TROLL},\39\\{swside}){}$;\5
${}\\{move}(\.{TROLL\_},\39\\{neside}){}$;\5
${}\\{prop}[\.{TROLL}]\K\T{0};{}$\6
\\{destroy}(\.{TROLL2});\5
\\{destroy}(\.{TROLL2\_});\6
${}\\{move}(\.{BRIDGE},\39\\{swside}){}$;\5
${}\\{move}(\.{BRIDGE\_},\39\\{neside});{}$\6
${}\\{printf}(\.{"\%s\\n"},\39\\{note}[\\{offset}[\.{TROLL}]+\T{1}]);{}$\6
\&{goto} \\{stay};\6
\4${}\}{}$\2\par
\U151.\fi

\M[3625 advent.w]{153}Obstacles might still arise after the choice of \PB{%
\\{newloc}} has been made.
The following program is executed at the beginning of each major cycle.

\Y\B\4\X153:Check for interference with the proposed move to \PB{\\{newloc}}%
\X${}\E{}$\6
\&{if} ${}(\\{closing}\W\\{newloc}<\\{min\_in\_cave}\W\\{newloc}\I\\{limbo}){}$%
\5
${}\{{}$\1\6
\X180:Panic at closing time\X;\5
${}\\{newloc}\K\\{loc};{}$\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\\{newloc}\I\\{loc}){}$\1\5
\X176:Stay in \PB{\\{loc}} if a dwarf is blocking the way to \PB{\\{newloc}}\X;%
\2\par
\U75.\fi

\N[3634 advent.w]{1}{154}Random numbers. You won't realize it until you have
played the game
for awhile, but adventures in Colossal Cave are not deterministic. Lots of
things can happen differently when you give the same input, because
caves are continually changing, and the dwarves don't have
consistent aim, etc.

A simple linear congruential method is used to provide numbers that
are random enough for our purposes.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{int} \\{ran}\,\,\.{ARGS}((\&{int}));\7
\&{int} \\{ran}(\\{range})\1\1\6
\&{int} \\{range};\C{ for uniform integers between 0 and \PB{$\\{range}-\T{1}$}
}\2\2\6
${}\{{}$\1\6
${}\\{rx}\K(\T{1021}*\\{rx})\AND\T{\^fffff}{}$;\C{ multiply by 1021, modulo
$2^{20}$ }\6
\&{return} ${}(\\{range}*\\{rx})\GG\T{20};{}$\6
\4${}\}{}$\2\par
\fi

\M[3652 advent.w]{155}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{rx};\C{ the last random value generated }\par
\fi

\M[3655 advent.w]{156}Each run is different.

\Y\B\4\X156:Initialize the random number generator\X${}\E{}$\6
$\\{rx}\K{}$(((\&{int}) \\{time}${}(\NULL))\AND\T{\^fffff})\OR\T{1}{}$;\par
\U200.\fi

\M[3660 advent.w]{157}The \PB{\\{pct}} macro returns true a given percentage of
the time.

\Y\B\4\D$\\{pct}(\|r)$ \5
$(\\{ran}(\T{100})<\|r{}$)\par
\Y\B\4\X157:Give optional \.{plugh} hint\X${}\E{}$\6
\&{if} ${}(\\{loc}\E\\{y2}\W\\{pct}(\T{25})\W\R\\{closing}){}$\1\5
\\{printf}(\.{"A\ hollow\ voice\ says}\)\.{\ \\"PLUGH\\".\\n"});\2\par
\U86.\fi

\M[3668 advent.w]{158}We kick the random number generator often, just to add
variety to the chase.

\Y\B\4\X85:Make special adjustments before looking at new input\X${}\mathrel+%
\E{}$\6
$\|k\K\\{ran}(\T{0}){}$;\par
\fi

\N[3673 advent.w]{1}{159}Dwarf stuff. We've said a lot of vague stuff about
dwarves; now is the time
to be explicit. Five dwarves roam about the cave. Initially they are
dormant but eventually they each walk about at random.
A global variable called \PB{\\{dflag}} governs their level of activity:
$$\vcenter{\halign{#\quad&#\hfil\cr
0&no dwarf stuff yet (we wait until you reach the Hall of Mists)\cr
1&you've reached that hall, but haven't met the first dwarf\cr
2&you've met one; the others start moving, but no knives thrown yet\cr
3&a knife has been thrown, but it misses\cr
4&knives will hit you with probability .095\cr
5&knives will hit you with probability .190\cr
6&knives will hit you with probability .285\cr}}$$
and so on. Dwarves get madder and madder as \PB{\\{dflag}} increases; this
increases their accuracy.

A pirate stalks the cave too. He acts a lot like a dwarf with respect to
random walks, so we call him \PB{\\{dwarf}[\T{0}]}, but actually he is quite
different.
He starts at the location of his treasure chest; you won't see that chest
until after you've spotted him.

The present location of \PB{\\{dwarf}[\|i]} is \PB{\\{dloc}[\|i]}; initially no
two
dwarves are adjacent. The value of
\PB{\\{dseen}[\|i]} records whether or not dwarf~\PB{\|i} is following you.

\Y\B\4\D$\\{nd}$ \5
\T{5}\C{ this many dwarves }\par
\B\4\D$\\{chest\_loc}$ \5
\\{dead2}\par
\B\4\D$\\{message\_loc}$ \5
\\{pony}\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{dflag};\C{ how angry are the dwarves? }\6
\&{int} \\{dkill};\C{ how many of them have you killed? }\6
\&{location} ${}\\{dloc}[\\{nd}+\T{1}]\K\{\\{chest\_loc},\39\\{hmk},\39%
\\{wfiss},\39\\{y2},\39\\{like3},\39\\{complex}\}{}$;\C{ dwarf locations }\6
\&{location} ${}\\{odloc}[\\{nd}+\T{1}]{}$;\C{ prior locations }\6
\&{boolean} ${}\\{dseen}[\\{nd}+\T{1}]{}$;\C{ have you been spotted? }\par
\fi

\M[3708 advent.w]{160}The following subroutine is often useful.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{boolean} \\{dwarf}\,\,\.{ARGS}((\&{void}));\7
\&{boolean} \\{dwarf}(\,)\C{ is a dwarf present? }\6
${}\{{}$\1\6
\&{register} \&{int} \|j;\7
\&{if} ${}(\\{dflag}<\T{2}){}$\1\5
\&{return} \\{false};\2\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j\Z\\{nd};{}$ ${}\|j\PP){}$\1\6
\&{if} ${}(\\{dloc}[\|j]\E\\{loc}){}$\1\5
\&{return} \\{true};\2\2\6
\&{return} \\{false};\6
\4${}\}{}$\2\par
\fi

\M[3720 advent.w]{161}Just after you've moved to a new \PB{\\{loc}}, we move
the other guys.
But we bypass all dwarf motion if you are in a place forbidden
to the pirate, or if your next motion is forced. In particular,
this means that the pirate can't steal the return toll, and
dwarves can't meet the bear.  It also means that dwarves won't
follow you into a dead end of the maze, but c'est la vie; they'll
wait for you outside the dead end.

\Y\B\4\X161:Possibly move dwarves and the pirate\X${}\E{}$\6
\&{if} ${}(\\{loc}\Z\\{max\_pirate\_loc}\W\\{loc}\I\\{limbo}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{dflag}\E\T{0}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{loc}\G\\{min\_lower\_loc}){}$\1\5
${}\\{dflag}\K\T{1};{}$\2\6
\4${}\}{}$\2\6
\&{else} \&{if} ${}(\\{dflag}\E\T{1}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{loc}\G\\{min\_lower\_loc}\W\\{pct}(\T{5})){}$\1\5
\X162:Advance \PB{\\{dflag}} to 2\X;\2\6
\4${}\}{}$\2\6
\&{else}\1\5
\X164:Move dwarves and the pirate\X;\2\6
\4${}\}{}$\2\par
\U75.\fi

\M[3737 advent.w]{162}When level 2 is reached, we silently kill 0, 1, or 2 of
the dwarves.
Then if any of the survivors is in the current location, we move him
to \PB{\\{nugget}}; thus no dwarf is presently tracking you. Another
dwarf does, however, toss an axe and grumpily leave the scene.

(The grumpy dwarf might throw the axe while you're in the maze of
all-different twists, even though other dwarves never go in there!)

\Y\B\4\X162:Advance \PB{\\{dflag}} to 2\X${}\E{}$\6
${}\{{}$\1\6
${}\\{dflag}\K\T{2};{}$\6
\&{for} ${}(\|j\K\T{0};{}$ ${}\|j<\T{2};{}$ ${}\|j\PP){}$\1\6
\&{if} (\\{pct}(\T{50}))\1\5
${}\\{dloc}[\T{1}+\\{ran}(\\{nd})]\K\\{limbo};{}$\2\2\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j\Z\\{nd};{}$ ${}\|j\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{dloc}[\|j]\E\\{loc}){}$\1\5
${}\\{dloc}[\|j]\K\\{nugget};{}$\2\6
${}\\{odloc}[\|j]\K\\{dloc}[\|j];{}$\6
\4${}\}{}$\2\6
\\{printf}(\.{"A\ little\ dwarf\ just}\)\.{\ walked\ around\ a\ cor}\)\.{ner,\
saw\ you,\ threw\ }\)\.{a\ little\\naxe\ at\ you}\)\.{,\ cursed,\ and\ ran\ aw}%
\)\.{ay.\ \ (The\ axe\ missed}\)\.{.)\\n"});\6
${}\\{drop}(\.{AXE},\39\\{loc});{}$\6
\4${}\}{}$\2\par
\U161.\fi

\M[3758 advent.w]{163}It turns out that the only way you can get rid of a dwarf
is to
attack him with the axe. You'll hit him 2/3 of the time; in either case,
the axe will be available for reuse.

\Y\B\4\X163:Throw the axe at a dwarf\X${}\E{}$\6
${}\{{}$\1\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j\Z\\{nd};{}$ ${}\|j\PP){}$\1\6
\&{if} ${}(\\{dloc}[\|j]\E\\{loc}){}$\1\5
\&{break};\2\2\6
\&{if} ${}(\\{ran}(\T{3})<\T{2}){}$\5
${}\{{}$\1\6
${}\\{dloc}[\|j]\K\\{limbo}{}$;\5
${}\\{dseen}[\|j]\K\T{0}{}$;\5
${}\\{dkill}\PP;{}$\6
\&{if} ${}(\\{dkill}\E\T{1}){}$\1\5
\\{printf}(\.{"You\ killed\ a\ little}\)\.{\ dwarf.\ \ The\ body\ va}\)%
\.{nishes\ in\ a\ cloud\ of}\)\.{\ greasy\\nblack\ smoke}\)\.{.\\n"});\2\6
\&{else}\1\5
\\{printf}(\.{"You\ killed\ a\ little}\)\.{\ dwarf.\\n"});\2\6
\4${}\}{}$\5
\2\&{else}\1\5
\\{printf}(\.{"You\ attack\ a\ little}\)\.{\ dwarf,\ but\ he\ dodge}\)\.{s\ out%
\ of\ the\ way.\\n"});\2\6
${}\\{drop}(\.{AXE},\39\\{loc}){}$;\5
\\{stay\_put};\6
\4${}\}{}$\2\par
\U122.\fi

\M[3775 advent.w]{164}Now things are in full swing. Dead dwarves don't do much
of anything,
but each live dwarf tends to stay with you
if he's seen you. Otherwise he moves at random, never backing up
unless there's no alternative.

\Y\B\4\X164:Move dwarves and the pirate\X${}\E{}$\6
${}\{{}$\1\6
${}\\{dtotal}\K\\{attack}\K\\{stick}\K\T{0}{}$;\C{ initialize totals for
possible battles }\6
\&{for} ${}(\|j\K\T{0};{}$ ${}\|j\Z\\{nd};{}$ ${}\|j\PP){}$\1\6
\&{if} ${}(\\{dloc}[\|j]\I\\{limbo}){}$\5
${}\{{}$\1\6
\&{register} \&{int} \|i;\7
\X166:Make a table of all potential exits, \PB{\\{ploc}[\T{0}]} through \PB{$%
\\{ploc}[\|i-\T{1}]$}\X;\6
\&{if} ${}(\|i\E\T{0}){}$\1\5
${}\|i\K\T{1},\39\\{ploc}[\T{0}]\K\\{odloc}[\|j];{}$\2\6
${}\\{odloc}[\|j]\K\\{dloc}[\|j];{}$\6
${}\\{dloc}[\|j]\K\\{ploc}[\\{ran}(\|i)]{}$;\C{ this is the random walk }\6
${}\\{dseen}[\|j]\K(\\{dloc}[\|j]\E\\{loc}\V\\{odloc}[\|j]\E\\{loc}\V(%
\\{dseen}[\|j]\W\\{loc}\G\\{min\_lower\_loc}));{}$\6
\&{if} (\\{dseen}[\|j])\1\5
\X167:Make dwarf \PB{\|j} follow\X;\2\6
\4${}\}{}$\2\2\6
\&{if} (\\{dtotal})\1\5
\X170:Make the threatening dwarves attack\X;\2\6
\4${}\}{}$\2\par
\U161.\fi

\M[3795 advent.w]{165}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{dtotal};\C{ this many dwarves are in the room with you }\6
\&{int} \\{attack};\C{ this many have had time to draw their knives }\6
\&{int} \\{stick};\C{ this many have hurled their knives accurately }\6
\&{location} \\{ploc}[\T{19}];\C{ potential locations for the next random step
}\par
\fi

\M[3801 advent.w]{166}Random-moving dwarves think \PB{\\{scan1}}, \PB{%
\\{scan2}}, and \PB{\\{scan3}} are three different
locations, although you will never have that perception.

\Y\B\4\X166:Make a table of all potential exits, \PB{\\{ploc}[\T{0}]} through %
\PB{$\\{ploc}[\|i-\T{1}]$}\X${}\E{}$\6
\&{for} ${}(\|i\K\T{0},\39\|q\K\\{start}[\\{dloc}[\|j]];{}$ ${}\|q<\\{start}[%
\\{dloc}[\|j]+\T{1}];{}$ ${}\|q\PP){}$\5
${}\{{}$\1\6
${}\\{newloc}\K\|q\MG\\{dest};{}$\6
\&{if} ${}(\\{newloc}\G\\{min\_lower\_loc}\W\\{newloc}\I\\{odloc}[\|j]\W%
\\{newloc}\I\\{dloc}[\|j]\W\3{-1}(\|i\E\T{0}\V\\{newloc}\I\\{ploc}[\|i-\T{1}])%
\W\|i<\T{19}\W\|q\MG\\{cond}\I\T{100}\W\3{-1}\\{newloc}\Z(\|j\E\T{0}\?\\{max%
\_pirate\_loc}:\\{min\_forced\_loc}-\T{1})){}$\1\5
${}\\{ploc}[\|i\PP]\K\\{newloc};{}$\2\6
\4${}\}{}$\2\par
\U164.\fi

\M[3813 advent.w]{167}A global variable \PB{\\{knife\_loc}} is used to remember
where dwarves have
most recently thrown knives at you. But as soon as you try to refer to the
knife, we tell you it's pointless to do so; \PB{\\{knife\_loc}} is $-1$
thereafter.

\Y\B\4\X167:Make dwarf \PB{\|j} follow\X${}\E{}$\6
${}\{{}$\1\6
${}\\{dloc}[\|j]\K\\{loc};{}$\6
\&{if} ${}(\|j\E\T{0}){}$\1\5
\X172:Make the pirate track you\X\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{dtotal}\PP;{}$\6
\&{if} ${}(\\{odloc}[\|j]\E\\{dloc}[\|j]){}$\5
${}\{{}$\1\6
${}\\{attack}\PP;{}$\6
\&{if} ${}(\\{knife\_loc}\G\T{0}){}$\1\5
${}\\{knife\_loc}\K\\{loc};{}$\2\6
\&{if} ${}(\\{ran}(\T{1000})<\T{95}*(\\{dflag}-\T{2})){}$\1\5
${}\\{stick}\PP;{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U164.\fi

\M[3831 advent.w]{168}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{knife\_loc};\C{ place where knife was mentioned, or $-1$ }\par
\fi

\M[3834 advent.w]{169}\B\X85:Make special adjustments before looking at new
input\X${}\mathrel+\E{}$\6
\&{if} ${}(\\{knife\_loc}>\\{limbo}\W\\{knife\_loc}\I\\{loc}){}$\1\5
${}\\{knife\_loc}\K\\{limbo}{}$;\2\par
\fi

\M[3837 advent.w]{170}We actually know the results of the attack already; this
is where
we inform you of the outcome, pretending that the battle is
now taking place.

\Y\B\4\X170:Make the threatening dwarves attack\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{dtotal}\E\T{1}){}$\1\5
\\{printf}(\.{"There\ is\ a\ threaten}\)\.{ing\ little\ dwarf"});\2\6
\&{else}\1\5
${}\\{printf}(\.{"There\ are\ \%d\ threat}\)\.{ening\ little\ dwarves}\)\.{"},%
\39\\{dtotal});{}$\2\6
\\{printf}(\.{"\ in\ the\ room\ with\ y}\)\.{ou!\\n"});\6
\&{if} (\\{attack})\5
${}\{{}$\1\6
\&{if} ${}(\\{dflag}\E\T{2}){}$\1\5
${}\\{dflag}\K\T{3};{}$\2\6
\&{if} ${}(\\{attack}\E\T{1}){}$\1\5
${}\|k\K\T{0},\39\\{printf}(\.{"One\ sharp\ nasty\ kni}\)\.{fe\ is\
thrown"});{}$\2\6
\&{else}\1\5
${}\|k\K\T{2},\39\\{printf}(\.{"\ \%d\ of\ them\ throw\ k}\)\.{nives"},\39%
\\{attack});{}$\2\6
\\{printf}(\.{"\ at\ you\ ---\ "});\6
\&{if} ${}(\\{stick}\Z\T{1}){}$\1\5
${}\\{printf}(\.{"\%s!\\n"},\39\\{attack\_msg}[\|k+\\{stick}]);{}$\2\6
\&{else}\1\5
${}\\{printf}(\.{"\%d\ of\ them\ get\ you!}\)\.{\\n"},\39\\{stick});{}$\2\6
\&{if} (\\{stick})\5
${}\{{}$\1\6
${}\\{oldoldloc}\K\\{loc}{}$;\5
\&{goto} \\{death};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U164.\fi

\M[3859 advent.w]{171}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{attack\_msg}[\,]\K\{\.{"it\ misses"},\39\.{"it\ gets\ you"},%
\3{-1}\39\.{"none\ of\ them\ hit\ yo}\)\.{u"},\39\.{"one\ of\ them\ gets\ yo}\)%
\.{u"}\}{}$;\par
\fi

\M[3863 advent.w]{172}The pirate leaves you alone once you have found the
chest. Otherwise he
steals all of the treasures you're carrying, although he ignores a treasure
that's too easy. (The pyramid is too easy,
if you're in the Plover Room or the Dark-Room.)

You spot the pirate if he robs you, or
when you have seen all of the possible treasures (except, of course,
the chest) and the current location has no treasures.
Before you've spotted him, we may give you a vague indication of his
movements.

We use the value of \PB{\\{place}[\.{MESSAGE}]} to determine whether the pirate
has been seen; the condition of \PB{\\{place}[\.{CHEST}]} is not a reliable
indicator, since the chest might be in limbo if you've thrown it
to the troll.

\Y\B\4\D$\\{pirate\_not\_spotted}$ \5
$(\\{place}[\.{MESSAGE}]\E\\{limbo}{}$)\par
\B\4\D$\\{too\_easy}(\|i)$ \5
$(\|i\E\.{PYRAMID}\W(\\{loc}\E\\{proom}\V\\{loc}\E\\{droom}){}$)\par
\Y\B\4\X172:Make the pirate track you\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{loc}\I\\{max\_pirate\_loc}\W\\{prop}[\.{CHEST}]<\T{0}){}$\5
${}\{{}$\1\6
\&{for} ${}(\|i\K\\{min\_treasure},\39\|k\K\T{0};{}$ ${}\|i\Z\\{max\_obj};{}$
${}\|i\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{too\_easy}(\|i)\AND\\{toting}(\|i)){}$\5
${}\{{}$\1\6
${}\|k\K{-}\T{1}{}$;\5
\&{break};\6
\4${}\}{}$\2\6
\&{if} (\\{here}(\|i))\1\5
${}\|k\K\T{1};{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\|k<\T{0}){}$\1\5
\X173:Take booty and hide it in the chest\X\2\6
\&{else} \&{if} ${}(\\{tally}\E\\{lost\_treasures}+\T{1}\W\|k\E\T{0}\W\\{pirate%
\_not\_spotted}\W\\{prop}[\.{LAMP}]\W\\{here}(\.{LAMP})){}$\1\5
\X175:Let the pirate be spotted\X\2\6
\&{else} \&{if} ${}(\\{odloc}[\T{0}]\I\\{dloc}[\T{0}]\W\\{pct}(\T{20})){}$\1\5
\\{printf}(\.{"There\ are\ faint\ rus}\)\.{tling\ noises\ from\ th}\)\.{e\
darkness\ behind\ yo}\)\.{u.\\n"});\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U167.\fi

\M[3899 advent.w]{173}The pirate isn't secretive about the fact that his chest
is somewhere
in a maze. However, he doesn't say which maze he means. Nor does he explain
why he is interested in treasures only when you are carrying them;
evidently he just likes to see you squirm.

\Y\B\4\X173:Take booty and hide it in the chest\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"Out\ from\ the\ shadow}\)\.{s\ behind\ you\ pounces}\)\.{\ a\
bearded\ pirate!\ \ }\)\.{\\"Har,\ har,\\"\\nhe\ ch}\)\.{ortles,\ \\"I'll\ just%
\ }\)\.{take\ all\ this\ booty\ }\)\.{and\ hide\ it\ away\ wit}\)\.{h\ me%
\\nchest\ deep\ in\ }\)\.{the\ maze!\\"\ \ He\ snat}\)\.{ches\ your\ treasure\
a}\)\.{nd\ vanishes\ into\\nth}\)\.{e\ gloom.\\n"});\6
\X174:Snatch all treasures that are snatchable here\X;\6
\&{if} (\\{pirate\_not\_spotted})\5
${}\{{}$\1\6
\4\\{move\_chest}:\5
${}\\{move}(\.{CHEST},\39\\{chest\_loc}){}$;\5
${}\\{move}(\.{MESSAGE},\39\\{message\_loc});{}$\6
\4${}\}{}$\2\6
${}\\{dloc}[\T{0}]\K\\{odloc}[\T{0}]\K\\{chest\_loc}{}$;\5
${}\\{dseen}[\T{0}]\K\\{false};{}$\6
\4${}\}{}$\2\par
\U172.\fi

\M[3918 advent.w]{174}\B\X174:Snatch all treasures that are snatchable here%
\X${}\E{}$\6
\&{for} ${}(\|i\K\\{min\_treasure};{}$ ${}\|i\Z\\{max\_obj};{}$ ${}\|i\PP){}$\1%
\6
\&{if} ${}(\R\\{too\_easy}(\|i)){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{base}[\|i]\E\.{NOTHING}\W\\{place}[\|i]\E\\{loc}){}$\1\5
\\{carry}(\|i);\2\6
\&{if} (\\{toting}(\|i))\1\5
${}\\{drop}(\|i,\39\\{chest\_loc});{}$\2\6
\4${}\}{}$\2\2\par
\U173.\fi

\M[3924 advent.w]{175}The window rooms are slightly lighted, but you don't spot
the pirate there
unless your lamp is on. (And you do spot him even if
the lighted lamp is on the ground.)

\Y\B\4\X175:Let the pirate be spotted\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"There\ are\ faint\ rus}\)\.{tling\ noises\ from\ th}\)\.{e\
darkness\ behind\ yo}\)\.{u.\ \ As\ you\\nturn\ tow}\)\.{ard\ them,\ the\ beam\
o}\)\.{f\ your\ lamp\ falls\ ac}\)\.{ross\ a\ bearded\ pirat}\)\.{e.\\nHe\ is\
carrying\ a}\)\.{\ large\ chest.\ \ \\"Shi}\)\.{ver\ me\ timbers!\\"\ he}\)\.{\
cries,\ \\"I've\\nbeen}\)\.{\ spotted!\ \ I'd\ best\ }\)\.{hie\ meself\ off\ to%
\ th}\)\.{e\ maze\ to\ hide\ me\ ch}\)\.{est!\\"\\nWith\ that,\ h}\)\.{e\
vanishes\ into\ the\ }\)\.{gloom.\\n"});\6
\&{goto} \\{move\_chest};\6
\4${}\}{}$\2\par
\U172.\fi

\M[3938 advent.w]{176}One more loose end related to dwarfs needs to be
addressed here.
If you're coming from a place forbidden to the pirate, so that the dwarves
are rooted in place, we let you get out (and be attacked). Otherwise,
if a dwarf has seen you and has come from where you want to go, he
blocks you.

We use the fact that \PB{$\\{loc}\Z\\{max\_pirate\_loc}$} implies \PB{$\R%
\\{forced\_move}(\\{loc})$}.

\Y\B\4\X176:Stay in \PB{\\{loc}} if a dwarf is blocking the way to \PB{%
\\{newloc}}\X${}\E{}$\6
\&{if} ${}(\\{loc}\Z\\{max\_pirate\_loc}){}$\5
${}\{{}$\1\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j\Z\\{nd};{}$ ${}\|j\PP){}$\1\6
\&{if} ${}(\\{odloc}[\|j]\E\\{newloc}\W\\{dseen}[\|j]){}$\5
${}\{{}$\1\6
\\{printf}(\.{"A\ little\ dwarf\ with}\)\.{\ a\ big\ knife\ blocks\ }\)\.{your\
way.\\n"});\6
${}\\{newloc}\K\\{loc}{}$;\5
\&{break};\6
\4${}\}{}$\2\2\6
\4${}\}{}$\2\par
\U153.\fi

\N[3954 advent.w]{1}{177}Closing the cave. You get to wander around until
you've located all
fifteen treasures, although you need not have taken them yet. After that,
you enter a new level of complexity: A global variable called
\PB{\\{clock1}} starts ticking downwards, every time you take a turn inside the
cave.
When it hits zero, we start closing the cave; then we sit back and
wait for you to try to get out, letting \PB{\\{clock2}} do the ticking.
The initial value of \PB{\\{clock1}} is large enough for you to get outside.

\Y\B\4\D$\\{closing}$ \5
$(\\{clock1}<\T{0}{}$)\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{clock1}${}\K\T{15},{}$ \\{clock2}${}\K\T{30}{}$;\C{ clocks that
govern closing time }\6
\&{boolean} \\{panic}${},{}$ \\{closed};\C{ various stages of closedness }\par
\fi

\M[3968 advent.w]{178}Location Y2 is virtually outside the cave, so \PB{%
\\{clock1}} doesn't tick there.
If you stay outside the cave with all your treasures, and with the lamp
switched off, the game might go on forever; but you wouldn't be having
any fun.

There's an interesting hack by which you can keep \PB{\\{tally}} positive
until you've taken all the treasures out of the cave. Namely, if your
first moves are
$$\vcenter{\halign{\hfil\hbox{#}\hfil\cr
\.{in},\quad \.{take} \.{lamp},\quad \.{plugh},\quad \.{on},\quad \.{drop} %
\.{lamp},\quad \.s,\quad
\.{take} \.{silver},\cr
\.{back},\quad \.{take} \.{lamp},\quad \.{plugh},\quad \.{out},\quad
\.{drop} \.{silver},\quad \.{in},\cr}}$$
the silver bars will be at \PB{\\{road}}; but \PB{\\{prop}[\.{SILVER}]} will
still be~$-1$
and \PB{\\{tally}} will still be~15. You can bring the other 14 treasures to
the
\PB{\\{house}} at your leisure; then the \PB{\\{tally}} will drop to zero when
you step
outside and actually see the silver for the first time.

\Y\B\4\X178:Check the clocks and the lamp\X${}\E{}$\6
\&{if} ${}(\\{tally}\E\T{0}\W\\{loc}\G\\{min\_lower\_loc}\W\\{loc}\I\\{y2}){}$%
\1\5
${}\\{clock1}\MM;{}$\2\6
\&{if} ${}(\\{clock1}\E\T{0}){}$\1\5
\X179:Warn that the cave is closing\X\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{clock1}<\T{0}){}$\1\5
${}\\{clock2}\MM;{}$\2\6
\&{if} ${}(\\{clock2}\E\T{0}){}$\1\5
\X181:Close the cave\X\2\6
\&{else}\1\5
\X184:Check the lamp\X;\2\6
\4${}\}{}$\2\par
\U76.\fi

\M[3995 advent.w]{179}At the time of first warning, we lock the grate, destroy
the crystal bridge,
kill all the dwarves (and the pirate), remove the troll and the bear
(unless dead), and set \PB{\\{closing}} to true. It's too much trouble to move
the dragon, so we leave it. From now on until \PB{\\{clock2}} runs out, you
cannot unlock the grate, move to any location outside the cave, or
create the bridge. Nor can you be resurrected if you die.

\Y\B\4\X179:Warn that the cave is closing\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"A\ sepulchral\ voice,}\)\.{\ reverberating\ throu}\)\.{gh\ the\
cave,\ says,\ \\}\)\.{"Cave\\nclosing\ soon.}\)\.{\ \ All\ adventurers\ ex}\)%
\.{it\ immediately\ throu}\)\.{gh\ main\ office.\\"\\n"});\6
${}\\{clock1}\K{-}\T{1};{}$\6
${}\\{prop}[\.{GRATE}]\K\T{0};{}$\6
${}\\{prop}[\.{CRYSTAL}]\K\T{0};{}$\6
\&{for} ${}(\|j\K\T{0};{}$ ${}\|j\Z\\{nd};{}$ ${}\|j\PP){}$\1\5
${}\\{dseen}[\|j]\K\T{0},\39\\{dloc}[\|j]\K\\{limbo};{}$\2\6
\\{destroy}(\.{TROLL});\5
\\{destroy}(\.{TROLL\_});\6
${}\\{move}(\.{TROLL2},\39\\{swside}){}$;\5
${}\\{move}(\.{TROLL2\_},\39\\{neside});{}$\6
${}\\{move}(\.{BRIDGE},\39\\{swside}){}$;\5
${}\\{move}(\.{BRIDGE\_},\39\\{neside});{}$\6
\&{if} ${}(\\{prop}[\.{BEAR}]\I\T{3}){}$\1\5
\\{destroy}(\.{BEAR});\2\6
${}\\{prop}[\.{CHAIN}]\K\T{0}{}$;\5
${}\\{base}[\.{CHAIN}]\K\.{NOTHING};{}$\6
${}\\{prop}[\.{AXE}]\K\T{0}{}$;\5
${}\\{base}[\.{AXE}]\K\.{NOTHING};{}$\6
\4${}\}{}$\2\par
\U178.\fi

\M[4018 advent.w]{180}If you try to get out while the cave is closing, we
assume that you panic;
we give you a few additional turns to get frantic before we close.

\Y\B\4\X180:Panic at closing time\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\R\\{panic}){}$\1\5
${}\\{clock2}\K\T{15},\39\\{panic}\K\\{true};{}$\2\6
\\{printf}(\.{"A\ mysterious\ record}\)\.{ed\ voice\ groans\ into}\)\.{\ life\
and\ announces:}\)\.{\\n\\"This\ exit\ is\ clo}\)\.{sed.\ \ Please\ leave\ v}\)%
\.{ia\ main\ office.\\"\\n"});\6
\4${}\}{}$\2\par
\Us131\ET153.\fi

\M[4028 advent.w]{181}Finally, after \PB{\\{clock2}} hits zero, we transport
you to the final puzzle,
which takes place in the previously inaccessible storage room. We have to
set everything up anew, in order to use the existing machinery instead
of writing a special program. We are careful not to include keys
in the room, since we don't want to allow you to unlock the grate that
separates you from your treasures. There is no water; otherwise we
would need special code for watering the beanstalks.

The storage room has two locations, \PB{\\{neend}} and \PB{\\{swend}}. At the
northeast
end, we place empty bottles, a nursery of plants, a bed of oysters, a pile
of lamps, rods with stars, sleeping dwarves, and you. At the southwest end
we place a grate, a snake pit, a covey of caged birds, more rods, and
pillows. A mirror stretches across one wall. But we destroy all objects
you might be carrying, lest you have some that could cause trouble,
such as the keys.  We describe the flash of light and trundle back.

From the fact that you've seen all the treasures, we can infer that
the snake is already gone, since the jewels are accessible only from
the Hall of the Mountain King. We also know that you've been in the
Giant Room (to get eggs); you've discovered that the clam is
an oyster (because of the pearl); the dwarves have been activated,
since you've found the chest. Therefore the long descriptions of
\PB{\\{neend}} and \PB{\\{swend}} will make sense to you when you see them.

Dear reader, all the clues to this final puzzle are presented in the
program itself, so you should have no trouble finding the solution.

\Y\B\4\X181:Close the cave\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"The\ sepulchral\ voic}\)\.{e\ intones,\ \\"The\ cav}\)\.{e\ is\
now\ closed.\\"\ \ }\)\.{As\ the\ echoes\\nfade,}\)\.{\ there\ is\ a\ blinding}%
\)\.{\ flash\ of\ light\ (and}\)\.{\ a\ small\ puff\ of\ ora}\)\.{nge\\nsmoke).%
\ .\ .\ .\ \ }\)\.{\ \ Then\ your\ eyes\ ref}\)\.{ocus;\ you\ look\ aroun}\)%
\.{d\ and\ find...\\n"});\6
${}\\{move}(\.{BOTTLE},\39\\{neend}){}$;\5
${}\\{prop}[\.{BOTTLE}]\K{-}\T{2};{}$\6
${}\\{move}(\.{PLANT},\39\\{neend}){}$;\5
${}\\{prop}[\.{PLANT}]\K{-}\T{1};{}$\6
${}\\{move}(\.{OYSTER},\39\\{neend}){}$;\5
${}\\{prop}[\.{OYSTER}]\K{-}\T{1};{}$\6
${}\\{move}(\.{LAMP},\39\\{neend}){}$;\5
${}\\{prop}[\.{LAMP}]\K{-}\T{1};{}$\6
${}\\{move}(\.{ROD},\39\\{neend}){}$;\5
${}\\{prop}[\.{ROD}]\K{-}\T{1};{}$\6
${}\\{move}(\.{DWARF},\39\\{neend}){}$;\5
${}\\{prop}[\.{DWARF}]\K{-}\T{1};{}$\6
${}\\{move}(\.{MIRROR},\39\\{neend}){}$;\5
${}\\{prop}[\.{MIRROR}]\K{-}\T{1};{}$\6
${}\\{loc}\K\\{oldloc}\K\\{neend};{}$\6
${}\\{move}(\.{GRATE},\39\\{swend}){}$;\C{ \PB{\\{prop}[\.{GRATE}]} still zero
}\6
${}\\{move}(\.{SNAKE},\39\\{swend}){}$;\5
${}\\{prop}[\.{SNAKE}]\K{-}\T{2};{}$\6
${}\\{move}(\.{BIRD},\39\\{swend}){}$;\5
${}\\{prop}[\.{BIRD}]\K{-}\T{2};{}$\6
${}\\{move}(\.{CAGE},\39\\{swend}){}$;\5
${}\\{prop}[\.{CAGE}]\K{-}\T{1};{}$\6
${}\\{move}(\.{ROD2},\39\\{swend}){}$;\5
${}\\{prop}[\.{ROD2}]\K{-}\T{1};{}$\6
${}\\{move}(\.{PILLOW},\39\\{swend}){}$;\5
${}\\{prop}[\.{PILLOW}]\K{-}\T{1};{}$\6
${}\\{move}(\.{MIRROR\_},\39\\{swend});{}$\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j\Z\\{max\_obj};{}$ ${}\|j\PP){}$\1\6
\&{if} (\\{toting}(\|j))\1\5
\\{destroy}(\|j);\2\2\6
${}\\{closed}\K\\{true};{}$\6
${}\\{bonus}\K\T{10};{}$\6
\\{stay\_put};\6
\4${}\}{}$\2\par
\U178.\fi

\M[4082 advent.w]{182}Once the cave has closed, we look for objects being toted
with \PB{$\\{prop}<\T{0}$};
their property value is changed to \PB{${-}\T{1}-\\{prop}$}. This means they
won't be
described until they've been picked up and put down, separate from their
respective piles.

\Y\B\4\X85:Make special adjustments before looking at new input\X${}\mathrel+%
\E{}$\6
\&{if} (\\{closed})\5
${}\{{}$\1\6
\&{if} ${}(\\{prop}[\.{OYSTER}]<\T{0}\W\\{toting}(\.{OYSTER})){}$\1\5
${}\\{printf}(\.{"\%s\\n"},\39\\{note}[\\{offset}[\.{OYSTER}]+\T{1}]);{}$\2\6
\&{for} ${}(\|j\K\T{1};{}$ ${}\|j\Z\\{max\_obj};{}$ ${}\|j\PP){}$\1\6
\&{if} ${}(\\{toting}(\|j)\W\\{prop}[\|j]<\T{0}){}$\1\5
${}\\{prop}[\|j]\K{-}\T{1}-\\{prop}[\|j];{}$\2\2\6
\4${}\}{}$\2\par
\fi

\N[4094 advent.w]{1}{183}Death and resurrection. Only the most persistent
adventurers get to
see the closing of the cave, because their lamp gives out first.
For example, if you have lost the ability to find any treasures,
\PB{\\{tally}} will never go to zero.

\Y\B\4\X183:Zap the lamp if the remaining treasures are too elusive\X${}\E{}$\6
\&{if} ${}(\\{tally}\E\\{lost\_treasures}\W\\{tally}>\T{0}\W\\{limit}>%
\T{35}){}$\1\5
${}\\{limit}\K\T{35}{}$;\2\par
\U88.\fi

\M[4102 advent.w]{184}On every turn, we check to see if you are in trouble
lampwise.

\Y\B\4\X184:Check the lamp\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{prop}[\.{LAMP}]\E\T{1}){}$\1\5
${}\\{limit}\MM;{}$\2\6
\&{if} ${}(\\{limit}\Z\T{30}\W\\{here}(\.{BATTERIES})\W\\{prop}[\.{BATTERIES}]%
\E\T{0}\W\\{here}(\.{LAMP})){}$\1\5
\X186:Replace the batteries\X\2\6
\&{else} \&{if} ${}(\\{limit}\E\T{0}){}$\1\5
\X187:Extinguish the lamp\X\2\6
\&{else} \&{if} ${}(\\{limit}<\T{0}\W\\{loc}<\\{min\_in\_cave}){}$\5
${}\{{}$\1\6
\\{printf}(\.{"There's\ not\ much\ po}\)\.{int\ in\ wandering\ aro}\)\.{und\
out\ here,\ and\ yo}\)\.{u\ can't\\nexplore\ the}\)\.{\ cave\ without\ a\ lamp}%
\)\.{.\ \ So\ let's\ just\ cal}\)\.{l\ it\ a\ day.\\n"});\6
\&{goto} \\{give\_up};\6
\4${}\}{}$\5
\2\&{else} \&{if} ${}(\\{limit}\Z\T{30}\W\R\\{warned}\W\\{here}(\.{LAMP})){}$\5
${}\{{}$\1\6
\\{printf}(\.{"Your\ lamp\ is\ gettin}\)\.{g\ dim"});\6
\&{if} ${}(\\{prop}[\.{BATTERIES}]\E\T{1}){}$\1\5
\\{printf}(\.{",\ and\ you're\ out\ of}\)\.{\ spare\ batteries.\ \ Y}\)\.{ou'd%
\\nbest\ start\ wra}\)\.{pping\ this\ up.\\n"});\2\6
\&{else} \&{if} ${}(\\{place}[\.{BATTERIES}]\E\\{limbo}){}$\1\5
\\{printf}(\.{".\ \ You'd\ best\ start}\)\.{\ wrapping\ this\ up,\ u}\)\.{nless%
\\nyou\ can\ find\ }\)\.{some\ fresh\ batteries}\)\.{.\ \ I\ seem\ to\ recall\
}\)\.{that\ there's\\na\ vend}\)\.{ing\ machine\ in\ the\ m}\)\.{aze.\ \ Bring\
some\ coi}\)\.{ns\ with\ you.\\n"});\2\6
\&{else}\1\5
\\{printf}(\.{".\ \ You'd\ best\ go\ ba}\)\.{ck\ for\ those\ batteri}\)\.{es.%
\\n"});\2\6
${}\\{warned}\K\\{true};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U178.\fi

\M[4128 advent.w]{185}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{boolean} \\{warned};\C{ have you been warned about the low power supply? }%
\par
\fi

\M[4131 advent.w]{186}The batteries hold a pretty hefty charge.

\Y\B\4\X186:Replace the batteries\X${}\E{}$\6
${}\{{}$\1\6
\\{printf}(\.{"Your\ lamp\ is\ gettin}\)\.{g\ dim.\ \ I'm\ taking\ t}\)\.{he\
liberty\ of\ replac}\)\.{ing\\nthe\ batteries.\\}\)\.{n"});\6
${}\\{prop}[\.{BATTERIES}]\K\T{1};{}$\6
\&{if} (\\{toting}(\.{BATTERIES}))\1\5
${}\\{drop}(\.{BATTERIES},\39\\{loc});{}$\2\6
${}\\{limit}\K\T{2500};{}$\6
\4${}\}{}$\2\par
\U184.\fi

\M[4142 advent.w]{187}\B\X187:Extinguish the lamp\X${}\E{}$\6
${}\{{}$\1\6
${}\\{limit}\K{-}\T{1}{}$;\5
${}\\{prop}[\.{LAMP}]\K\T{0};{}$\6
\&{if} (\\{here}(\.{LAMP}))\1\5
\\{printf}(\.{"Your\ lamp\ has\ run\ o}\)\.{ut\ of\ power."});\2\6
\4${}\}{}$\2\par
\U184.\fi

\M[4148 advent.w]{188}The easiest way to get killed is to fall into a pit in
pitch darkness.

\Y\B\4\X188:Deal with death and resurrection\X${}\E{}$\6
\4\\{pitch\_dark}:\5
\\{printf}(\.{"You\ fell\ into\ a\ pit}\)\.{\ and\ broke\ every\ bon}\)\.{e\ in%
\ your\ body!\\n"});\6
${}\\{oldoldloc}\K\\{loc}{}$;\par
\As189, 191\ETs192.
\U2.\fi

\M[4154 advent.w]{189}``You're dead, Jim.''

When you die, \PB{\\{newloc}} is undefined (often \PB{\\{limbo}})
and \PB{\\{oldloc}} is what killed you.
So we look at \PB{\\{oldoldloc}}, the last place you were safe.

We generously allow you to die up to three times; \PB{\\{death\_count}} is the
number of deaths you have had so~far.

\Y\B\4\D$\\{max\_deaths}$ \5
\T{3}\par
\Y\B\4\X188:Deal with death and resurrection\X${}\mathrel+\E{}$\6
\4\\{death}:\5
${}\\{death\_count}\PP;{}$\6
\&{if} (\\{closing})\5
${}\{{}$\1\6
\\{printf}(\.{"It\ looks\ as\ though\ }\)\.{you're\ dead.\ \ Well,\ }\)%
\.{seeing\ as\ how\ it's\ s}\)\.{o\ close\\nto\ closing\ }\)\.{time\ anyway,\
let's\ j}\)\.{ust\ call\ it\ a\ day.\\n}\)\.{"});\6
\&{goto} \\{quit};\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{yes}(\\{death\_wishes}[\T{2}*\\{death\_count}-\T{2}],\39%
\\{death\_wishes}[\T{2}*\\{death\_count}-\T{1}],\39\\{ok})\V\\{death\_count}\E%
\\{max\_deaths}){}$\1\5
\&{goto} \\{quit};\2\par
\fi

\M[4176 advent.w]{190}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{death\_count};\C{ how often have you kicked the bucket? }\6
\&{char} ${}{*}\\{death\_wishes}[\T{2}*\\{max\_deaths}]\K\{{}$\6
${}\.{"Oh\ dear,\ you\ seem\ t}\)\.{o\ have\ gotten\ yourse}\)\.{lf\ killed.\ \
I\ might\ }\)\.{be\ able\ to\\nhelp\ you}\)\.{\ out,\ but\ I've\ never}\)\.{\
really\ done\ this\ be}\)\.{fore.\ \ Do\ you\ want\ m}\)\.{e\\nto\ try\ to\
reincar}\)\.{nate\ you?"},{}$\6
\.{"All\ right.\ \ But\ don}\)\.{'t\ blame\ me\ if\ somet}\)\.{hing\ goes\
wr......\\n}\)\.{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ---}\)\.{\ POOF!!\ ---\\nYou%
\ are}\)\.{\ engulfed\ in\ a\ cloud}\)\.{\ of\ orange\ smoke.\ \ C}\)\.{oughing%
\ and\ gasping,}\)\.{\\nyou\ emerge\ from\ th}\)\.{e\ smoke\ and\ find....}\)%
\.{"}${},{}$\6
\.{"You\ clumsy\ oaf,\ you}\)\.{'ve\ done\ it\ again!\ \ }\)\.{I\ don't\ know\
how\ lon}\)\.{g\ I\ can\\nkeep\ this\ u}\)\.{p.\ \ Do\ you\ want\ me\ t}\)\.{o\
try\ reincarnating\ }\)\.{you\ again?"}${},{}$\6
\.{"Okay,\ now\ where\ did}\)\.{\ I\ put\ my\ resurrecti}\)\.{on\ kit?....\ \
>POOF!<}\)\.{\\nEverything\ disappe}\)\.{ars\ in\ a\ dense\ cloud}\)\.{\ of\
orange\ smoke."}${},{}$\6
\.{"Now\ you've\ really\ d}\)\.{one\ it!\ \ I'm\ out\ of\ }\)\.{orange\ smoke!\
\ You\ d}\)\.{on't\ expect\\nme\ to\ d}\)\.{o\ a\ decent\ reincarna}\)\.{tion\
without\ any\ ora}\)\.{nge\ smoke,\ do\ you?"}${},{}$\6
\.{"Okay,\ if\ you're\ so\ }\)\.{smart,\ do\ it\ yoursel}\)\.{f!\ \ I'm\
leaving!"}${}\}{}$;\par
\fi

\M[4194 advent.w]{191}At this point you are reborn. All objects you were
carrying
are dropped at \PB{\\{oldoldloc}} (presumably your last place prior to being
killed), with their properties unchanged. The loop runs backwards, so
that the bird is dropped before the cage. The lamp is a special case,
because we wouldn't want to leave it underground; we turn it off and
leave it outside the building---only if you were carrying it, of course.
You yourself are left {\it inside\/} the building. (Heaven help you
if you try to xyzzy back into the cave without the lamp.) We zap
\PB{\\{oldloc}} so that you can't just go back.

\Y\B\4\X188:Deal with death and resurrection\X${}\mathrel+\E{}$\6
\&{if} (\\{toting}(\.{LAMP}))\1\5
${}\\{prop}[\.{LAMP}]\K\T{0};{}$\2\6
${}\\{place}[\.{WATER}]\K\\{limbo}{}$;\5
${}\\{place}[\.{OIL}]\K\\{limbo}{}$;\C{ must not \PB{\\{drop}} them }\6
\&{for} ${}(\|j\K\\{max\_obj};{}$ ${}\|j>\T{0};{}$ ${}\|j\MM){}$\1\6
\&{if} (\\{toting}(\|j))\1\5
${}\\{drop}(\|j,\39\|j\E\.{LAMP}\?\\{road}:\\{oldoldloc});{}$\2\2\6
${}\\{loc}\K\\{oldloc}\K\\{house};{}$\6
\&{goto} \\{commence};\par
\fi

\M[4211 advent.w]{192}Oh dear, you've disturbed the dwarves.

\Y\B\4\X188:Deal with death and resurrection\X${}\mathrel+\E{}$\6
\4\\{dwarves\_upset}:\5
\\{printf}(\.{"The\ resulting\ rucku}\)\.{s\ has\ awakened\ the\ d}\)\.{warves.%
\ \ There\ are\ n}\)\.{ow\ several\\nthreaten}\)\.{ing\ little\ dwarves\ i}\)%
\.{n\ the\ room\ with\ you!}\)\.{\ \ Most\ of\ them\ throw}\)\.{\\nknives\ at\
you!\ \ Al}\)\.{l\ of\ them\ get\ you!\\n}\)\.{"});\par
\fi

\N[4219 advent.w]{1}{193}Scoring. Here is the scoring algorithm we use:
$$\vcenter{\halign{#\hfil&&\hskip5em\hfil#\cr
\hfil\it Objective&\hidewidth\it Points\hfil\hidewidth
&\hidewidth\it Total possible\hfil\hidewidth\cr
\noalign{\vskip2pt}
Getting well into cave&   25&  25\cr
Each treasure $<$ chest&  12&  60\cr
Treasure chest itself&    14&  14\cr
Each treasure $>$ chest&  16& 144\cr
Each unused death&        10&  30\cr
Not quitting&              4&   4\cr
Reaching Witt's End&       1&   1\cr
Getting to \PB{\\{closing}}&     25&  25\cr
Various additional bonuses& &  45\cr
Round out the total&       2&   2\cr
\noalign{\vskip2pt}
&&\llap{Total:\quad}350\cr
}}$$
Points can also be deducted for using hints. One consequence of these
rules is that you get 32 points just for quitting on your first turn.
And there's a way to get 57 points in just three turns.

Full points for treasures are awarded only if they aren't broken and
you have deposited them in the building. But we give you 2 points just for
seeing a treasure.

\Y\B\4\D$\\{max\_score}$ \5
\T{350}\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{bonus};\C{ extra points awarded for exceptional adventuring skills }%
\par
\fi

\M[4250 advent.w]{194}The hints are table driven, using several arrays:

\item{$\bullet$} \PB{\\{hint\_count}[\|j]}
is the number of recent turns whose location is relevant to hint~\PB{\|j};

\item{$\bullet$} \PB{\\{hint\_thresh}[\|j]} is the number of such turns before
we consider offering that hint;

\item{$\bullet$} \PB{\\{hint\_cost}[\|j]} is the number of points you pay for
it;

\item{$\bullet$} \PB{\\{hint\_prompt}[\|j]} is the way we offer it;

\item{$\bullet$} \PB{\\{hint}[\|j]} is the hint;

\item{$\bullet$} \PB{\\{hinted}[\|j]} is true after we've given it.

\medskip\noindent
Hint 0 is for instructions at the beginning; it costs you 5 points, but
you get extra power in the lamp. The other hints also usually extend the lamp's
power. Hint~1 is for reading the oyster. And hints 2 through~7 are for the
\PB{\\{cave\_hint}}, \PB{\\{bird\_hint}}, \PB{\\{snake\_hint}}, \PB{\\{twist%
\_hint}}, \PB{\\{dark\_hint}},
and \PB{\\{witt\_hint}}, respectively.

Here's the subroutine that handles all eight kinds of hints.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{void} \\{offer}\,\,\.{ARGS}((\&{int}));\7
\&{void} \\{offer}(\|j)\1\1\6
\&{int} \|j;\2\2\6
${}\{{}$\1\6
\&{if} ${}(\|j>\T{1}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{yes}(\\{hint\_prompt}[\|j],\39\.{"\ I\ am\ prepared\ to\ g}\)%
\.{ive\ you\ a\ hint,"},\39\\{ok})){}$\1\5
\&{return};\2\6
${}\\{printf}(\.{"\ but\ it\ will\ cost\ y}\)\.{ou\ \%d\ points.\ \ "},\39%
\\{hint\_cost}[\|j]);{}$\6
${}\\{hinted}[\|j]\K\\{yes}(\.{"Do\ you\ want\ the\ hin}\)\.{t?"},\39\\{hint}[%
\|j],\39\\{ok});{}$\6
\4${}\}{}$\5
\2\&{else}\1\5
${}\\{hinted}[\|j]\K\\{yes}(\\{hint\_prompt}[\|j],\39\\{hint}[\|j],\39%
\\{ok});{}$\2\6
\&{if} ${}(\\{hinted}[\|j]\W\\{limit}>\T{30}){}$\1\5
${}\\{limit}\MRL{+{\K}}\T{30}*\\{hint\_cost}[\|j];{}$\2\6
\4${}\}{}$\2\par
\fi

\M[4288 advent.w]{195}\B\X195:Check if a hint applies, and give it if requested%
\X${}\E{}$\6
\&{for} ${}(\|j\K\T{2},\39\|k\K\\{cave\_hint};{}$ ${}\|j\Z\T{7};{}$ ${}\|j\PP,%
\39\|k\MRL{+{\K}}\|k){}$\1\6
\&{if} ${}(\R\\{hinted}[\|j]){}$\5
${}\{{}$\1\6
\&{if} ${}((\\{flags}[\\{loc}]\AND\|k)\E\T{0}){}$\1\5
${}\\{hint\_count}[\|j]\K\T{0};{}$\2\6
\&{else} \&{if} ${}(\PP\\{hint\_count}[\|j]\G\\{hint\_thresh}[\|j]){}$\5
${}\{{}$\1\6
\&{switch} (\|j)\5
${}\{{}$\1\6
\4\&{case} \T{2}:\5
\&{if} ${}(\\{prop}[\.{GRATE}]\E\T{0}\W\R\\{here}(\.{KEYS})){}$\1\5
\&{break};\5
\2\&{else}\1\5
\&{goto} \\{bypass};\2\6
\4\&{case} \T{3}:\5
\&{if} ${}(\\{here}(\.{BIRD})\W\\{oldobj}\E\.{BIRD}\W\\{toting}(\.{ROD})){}$\1\5
\&{break};\2\6
\&{else}\1\5
\&{continue};\2\6
\4\&{case} \T{4}:\5
\&{if} ${}(\\{here}(\.{SNAKE})\W\R\\{here}(\.{BIRD})){}$\1\5
\&{break};\5
\2\&{else}\1\5
\&{goto} \\{bypass};\2\6
\4\&{case} \T{5}:\5
\&{if} ${}(\\{first}[\\{loc}]\E\T{0}\W\\{first}[\\{oldloc}]\E\T{0}\W\\{first}[%
\\{oldoldloc}]\E\T{0}\W\\{holding}>\T{1}){}$\1\5
\&{break};\2\6
\&{else}\1\5
\&{goto} \\{bypass};\2\6
\4\&{case} \T{6}:\5
\&{if} ${}(\\{prop}[\.{EMERALD}]\I{-}\T{1}\W\\{prop}[\.{PYRAMID}]\E{-}\T{1}){}$%
\1\5
\&{break};\2\6
\&{else}\1\5
\&{goto} \\{bypass};\2\6
\4\&{case} \T{7}:\5
\&{break};\6
\4${}\}{}$\2\6
\\{offer}(\|j);\6
\4\\{bypass}:\5
${}\\{hint\_count}[\|j]\K\T{0};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\2\par
\U76.\fi

\M[4309 advent.w]{196}\B\D$\\{n\_hints}$ \5
\T{8}\par
\Y\B\4\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{hint\_count}[\\{n\_hints}];\C{ how long you have needed this hint }\6
\&{int} \\{hint\_thresh}[\\{n\_hints}]${}\K\{\T{0},\39\T{0},\39\T{4},\39\T{5},%
\39\T{8},\39\T{75},\39\T{25},\39\T{20}\}{}$;\C{ how long we will wait }\6
\&{int} \\{hint\_cost}[\\{n\_hints}]${}\K\{\T{5},\39\T{10},\39\T{2},\39\T{2},%
\39\T{2},\39\T{4},\39\T{5},\39\T{3}\}{}$;\C{ how much we will charge }\6
\&{char} ${}{*}\\{hint\_prompt}[\\{n\_hints}]\K\{{}$\6
${}\.{"Welcome\ to\ Adventur}\)\.{e!!\ \ Would\ you\ like\ }\)%
\.{instructions?"},{}$\6
\.{"Hmmm,\ this\ looks\ li}\)\.{ke\ a\ clue,\ which\ mea}\)\.{ns\ it'll\ cost\
you\ 10}\)\.{\ points\ to\\nread\ it.}\)\.{\ \ Should\ I\ go\ ahead\ }\)\.{and\
read\ it\ anyway?"}${},{}$\6
\.{"Are\ you\ trying\ to\ g}\)\.{et\ into\ the\ cave?"}${},{}$\6
\.{"Are\ you\ trying\ to\ c}\)\.{atch\ the\ bird?"}${},{}$\6
\.{"Are\ you\ trying\ to\ d}\)\.{eal\ somehow\ with\ the}\)\.{\ snake?"}${},{}$%
\6
\.{"Do\ you\ need\ help\ ge}\)\.{tting\ out\ of\ the\ maz}\)\.{e?"}${},{}$\6
\.{"Are\ you\ trying\ to\ e}\)\.{xplore\ beyond\ the\ Pl}\)\.{over\
Room?"}${},{}$\6
\.{"Do\ you\ need\ help\ ge}\)\.{tting\ out\ of\ here?"}${}\};{}$\6
\&{char} ${}{*}\\{hint}[\\{n\_hints}]\K\{{}$\6
${}\.{"Somewhere\ nearby\ is}\)\.{\ Colossal\ Cave,\ wher}\)\.{e\ others\ have\
found\ }\)\.{fortunes\ in\\ntreasur}\)\.{e\ and\ gold,\ though\ i}\)\.{t\ is\
rumored\ that\ so}\)\.{me\ who\ enter\ are\ nev}\)\.{er\\nseen\ again.\ \ Mag}%
\)\.{ic\ is\ said\ to\ work\ i}\)\.{n\ the\ cave.\ \ I\ will\ }\)\.{be\ your\
eyes\\nand\ ha}\)\.{nds.\ \ Direct\ me\ with}\)\.{\ commands\ of\ one\ or\ }\)%
\.{two\ words.\ \ I\ should}\)\.{\\nwarn\ you\ that\ I\ lo}\)\.{ok\ at\ only\
the\ first}\)\.{\ five\ letters\ of\ eac}\)\.{h\ word,\ so\\nyou'll\ h}\)\.{ave%
\ to\ enter\ \\"NORTH}\)\.{EAST\\"\ as\ \\"NE\\"\ to\ }\)\.{distinguish\ it\
from\\}\)\.{n\\"NORTH\\".\ \ Should\ }\)\.{you\ get\ stuck,\ type\ }\)\.{%
\\"HELP\\"\ for\ some\ ge}\)\.{neral\ hints.\\nFor\ in}\)\.{formation\ on\ how\
to\ }\)\.{end\ your\ adventure,\ }\)\.{etc.,\ type\ \\"INFO\\".}\)\.{\\n\ \ \ \
\ \ \ \ \ \ \ \ \ \ \ \ \ \ }\)\.{\ \ \ \ \ \ -\ \ -\ \ -\\nThe\ f}\)\.{irst\
adventure\ progr}\)\.{am\ was\ developed\ by\ }\)\.{Willie\ Crowther.\\nMo}\)%
\.{st\ of\ the\ features\ o}\)\.{f\ the\ current\ progra}\)\.{m\ were\ added\
by\ Don\ }\)\.{Woods;\\nall\ of\ its\ b}\)\.{ugs\ were\ added\ by\ Do}\)\.{n\
Knuth."},{}$\6
\.{"It\ says,\ \\"There\ is}\)\.{\ something\ strange\ a}\)\.{bout\ this\
place,\ suc}\)\.{h\ that\ one\\nof\ the\ w}\)\.{ords\ I've\ always\ kno}\)\.{wn%
\ now\ has\ a\ new\ eff}\)\.{ect.\\""}${},{}$\6
\.{"The\ grate\ is\ very\ s}\)\.{olid\ and\ has\ a\ harde}\)\.{ned\ steel\
lock.\ \ You}\)\.{\ cannot\\nenter\ witho}\)\.{ut\ a\ key,\ and\ there\ }\)%
\.{are\ no\ keys\ in\ sight}\)\.{.\ \ I\ would\ recommend}\)\.{\\nlooking\
elsewhere\ }\)\.{for\ the\ keys."}${},{}$\6
\.{"Something\ seems\ to\ }\)\.{be\ frightening\ the\ b}\)\.{ird\ just\ now\
and\ you}\)\.{\ cannot\\ncatch\ it\ no}\)\.{\ matter\ what\ you\ try}\)\.{.\ \
Perhaps\ you\ might}\)\.{\ try\ later."}${},{}$\6
\.{"You\ can't\ kill\ the\ }\)\.{snake,\ or\ drive\ it\ a}\)\.{way,\ or\ avoid\
it,\ or}\)\.{\ anything\\nlike\ that}\)\.{.\ \ There\ is\ a\ way\ to}\)\.{\ get%
\ by,\ but\ you\ don}\)\.{'t\ have\ the\ necessar}\)\.{y\\nresources\ right\ n}%
\)\.{ow."}${},{}$\6
\.{"You\ can\ make\ the\ pa}\)\.{ssages\ look\ less\ ali}\)\.{ke\ by\ dropping\
thing}\)\.{s."}${},{}$\6
\.{"There\ is\ a\ way\ to\ e}\)\.{xplore\ that\ region\ w}\)\.{ithout\ having\
to\ wor}\)\.{ry\ about\\nfalling\ in}\)\.{to\ a\ pit.\ \ None\ of\ t}\)\.{he\
objects\ available}\)\.{\ is\ immediately\\nuse}\)\.{ful\ for\ discovering\ }\)%
\.{the\ secret."}${},{}$\6
\.{"Don't\ go\ west."}${}\};{}$\6
\&{boolean} \\{hinted}[\\{n\_hints}];\C{ have you seen the hint? }\par
\fi

\M[4359 advent.w]{197}Here's a subroutine that computes the current score.

\Y\B\4\X6:Subroutines\X${}\mathrel+\E{}$\6
\&{int} \\{score}\,\,\.{ARGS}((\&{void}));\7
\&{int} \\{score}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{register} \&{int} \|j${},{}$ \|s${}\K\T{2};{}$\6
\&{register} \&{object} \|k;\7
\&{if} (\\{dflag})\1\5
${}\|s\MRL{+{\K}}\T{25}{}$;\C{ you've gotten well inside }\2\6
\&{for} ${}(\|k\K\\{min\_treasure};{}$ ${}\|k\Z\\{max\_obj};{}$ ${}\|k\PP){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{prop}[\|k]\G\T{0}){}$\5
${}\{{}$\1\6
${}\|s\MRL{+{\K}}\T{2};{}$\6
\&{if} ${}(\\{place}[\|k]\E\\{house}\W\\{prop}[\|k]\E\T{0}){}$\1\5
${}\|s\MRL{+{\K}}(\|k<\.{CHEST}\?\T{10}:\|k\E\.{CHEST}\?\T{12}:\T{14});{}$\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\|s\MRL{+{\K}}\T{10}*(\\{max\_deaths}-\\{death\_count});{}$\6
\&{if} ${}(\R\\{gave\_up}){}$\1\5
${}\|s\MRL{+{\K}}\T{4};{}$\2\6
\&{if} ${}(\\{place}[\.{MAG}]\E\\{witt}){}$\1\5
${}\|s\PP{}$;\C{ proof of your visit }\2\6
\&{if} (\\{closing})\1\5
${}\|s\MRL{+{\K}}\T{25};{}$\2\6
${}\|s\MRL{+{\K}}\\{bonus};{}$\6
\&{for} ${}(\|j\K\T{0};{}$ ${}\|j<\\{n\_hints};{}$ ${}\|j\PP){}$\1\6
\&{if} (\\{hinted}[\|j])\1\5
${}\|s\MRL{-{\K}}\\{hint\_cost}[\|j];{}$\2\2\6
\&{return} \|s;\6
\4${}\}{}$\2\par
\fi

\M[4384 advent.w]{198}The worst possible score is $-3$.
It is possible (but unusual) to earn exactly 1 point.

\Y\B\4\D$\\{highest\_class}$ \5
\T{8}\par
\Y\B\4\X198:Print the score and say adieu\X${}\E{}$\6
$\|k\K\\{score}(\,);{}$\6
${}\\{printf}(\.{"You\ scored\ \%d\ point}\)\.{\%s\ out\ of\ a\ possible}\)\.{\
\%d,\ using\ \%d\ turn\%s}\)\.{.\\n"},\39\|k,\39\|k\E\T{1}\?\.{""}:\.{"s"},\39%
\\{max\_score},\39\\{turns},\39\\{turns}\E\T{1}\?\.{""}:\.{"s"});{}$\6
\&{for} ${}(\|j\K\T{0};{}$ ${}\\{class\_score}[\|j]\Z\|k;{}$ ${}\|j\PP){}$\1\5
;\2\6
${}\\{printf}(\.{"\%s\\nTo\ achieve\ the\ }\)\.{next\ higher\ rating"},\39%
\\{class\_message}[\|j]);{}$\6
\&{if} ${}(\|j<\\{highest\_class}){}$\1\5
${}\\{printf}(\.{",\ you\ need\ \%d\ more\ }\)\.{point\%s.\\n"},\39\\{class%
\_score}[\|j]-\|k,\39\\{class\_score}[\|j]\E\|k+\T{1}\?\.{""}:\.{"s"});{}$\2\6
\&{else}\1\5
\\{printf}(\.{"\ would\ be\ a\ neat\ tr}\)\.{ick!\\nCongratulation}\)\.{s!!%
\\n"});\2\par
\U2.\fi

\M[4400 advent.w]{199}\B\X7:Global variables\X${}\mathrel+\E{}$\6
\&{int} \\{class\_score}[\,]${}\K\{\T{35},\39\T{100},\39\T{130},\39\T{200},\39%
\T{250},\39\T{300},\39\T{330},\39\T{349},\39\T{9999}\};{}$\6
\&{char} ${}{*}\\{class\_message}[\,]\K\{{}$\6
${}\.{"You\ are\ obviously\ a}\)\.{\ rank\ amateur.\ \ Bett}\)\.{er\ luck\ next%
\ time."},{}$\6
\.{"Your\ score\ qualifie}\)\.{s\ you\ as\ a\ novice\ cl}\)\.{ass\
adventurer."}${},{}$\6
\.{"You\ have\ achieved\ t}\)\.{he\ rating\ \\"Experien}\)\.{ced\ Adventurer%
\\"."}${},{}$\6
\.{"You\ may\ now\ conside}\)\.{r\ yourself\ a\ \\"Seaso}\)\.{ned\ Adventurer%
\\"."}${},{}$\6
\.{"You\ have\ reached\ \\"}\)\.{Junior\ Master\\"\ stat}\)\.{us."}${},{}$\6
\.{"Your\ score\ puts\ you}\)\.{\ in\ Master\ Adventure}\)\.{r\ Class\
C."}${},{}$\6
\.{"Your\ score\ puts\ you}\)\.{\ in\ Master\ Adventure}\)\.{r\ Class\
B."}${},{}$\6
\.{"Your\ score\ puts\ you}\)\.{\ in\ Master\ Adventure}\)\.{r\ Class\
A."}${},{}$\6
\.{"All\ of\ Adventuredom}\)\.{\ gives\ tribute\ to\ yo}\)\.{u,\ Adventure\
Grandma}\)\.{ster!"}${}\}{}$;\par
\fi

\N[4413 advent.w]{1}{200}Launching the program. The program is now complete;
all we must
do is put a few of the pieces together.

Most of the initialization takes place while you are reading the opening
message.

\Y\B\4\X200:Initialize all tables\X${}\E{}$\6
\X156:Initialize the random number generator\X;\6
\\{offer}(\T{0});\C{ Give the welcome message and possible instructions }\6
${}\\{limit}\K(\\{hinted}[\T{0}]\?\T{1000}:\T{330}){}$;\C{ set lifetime of lamp
}\6
\X10:Build the vocabulary\X;\6
\X23:Build the travel table\X;\6
\X69:Build the object tables\X;\6
${}\\{oldoldloc}\K\\{oldloc}\K\\{loc}\K\\{newloc}\K\\{road}{}$;\par
\U2.\fi

\N[4428 advent.w]{1}{201}Index. A large cloud of green smoke appears in front
of you. It clears away
to reveal a tall wizard, clothed in grey. He fixes you with a steely glare and
declares, ``This adventure has lasted too long.'' With that he makes a single
pass over you with his hands, and everything around you fades away into a grey
nothingness.


\fi


\inx
\fin
\con
